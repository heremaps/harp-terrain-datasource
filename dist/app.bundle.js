!function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=172)}([function(e,t){e.exports=THREE},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(92)),n(i(93)),n(i(97)),n(i(98)),n(i(99)),n(i(100)),n(i(101)),n(i(102)),n(i(103)),n(i(104)),n(i(105))},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(12)),n(i(115)),n(i(5)),n(i(13)),n(i(48)),n(i(116)),n(i(15)),n(i(30)),n(i(49)),n(i(117)),n(i(50)),n(i(51)),n(i(31)),n(i(118)),n(i(52)),n(i(20)),n(i(53)),n(i(54)),n(i(21)),n(i(119)),n(i(120)),n(i(121)),n(i(122)),n(i(14)),n(i(8)),n(i(7))},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(123)),n(i(57)),n(i(58)),n(i(59)),n(i(124)),n(i(125)),n(i(126)),n(i(127)),n(i(128)),n(i(129))},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(43)),n(i(91)),n(i(109)),n(i(26)),n(i(110)),n(i(111)),n(i(112)),n(i(44)),n(i(113)),n(i(114))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=180/Math.PI,r=Math.PI/180;class s{constructor(e,t,i){this.latitude=e,this.longitude=t,this.altitude=i}static fromDegrees(e,t,i){return new s(e,t,i)}static fromRadians(e,t,i){return new s(e*n,t*n,i)}get latitudeInRadians(){return this.latitude*r}get longitudeInRadians(){return this.longitude*r}get latitudeInDegrees(){return this.latitude}get longitudeInDegrees(){return this.longitude}isValid(){return!isNaN(this.latitude)&&!isNaN(this.longitude)}normalized(){let{latitude:e,longitude:t}=this;if(isNaN(e)||isNaN(t))return this;if(e>90){let i=(e+90)%360;i>=180&&(t+=180,i=360-i),e=i-90}if(e<-90){let i=(e-90)%360;i<=-180&&(t+=180,i=-360-i),e=i+90}return(t<-180||t>180)&&(t=(t+180)%360-180),e===this.latitude&&t===this.longitude?this:new s(e,t,this.altitude)}equals(e){return this.latitude===e.latitude&&this.longitude===e.longitude&&this.altitude===e.altitude}copy(e){return this.latitude=e.latitude,this.longitude=e.longitude,this.altitude=e.altitude,this}clone(){return new s(this.latitude,this.longitude,this.altitude)}}t.GeoCoordinates=s},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(11)),n(i(55)),n(i(10)),n(i(36)),n(i(69)),n(i(153)),n(i(63)),n(i(81)),n(i(154)),n(i(75)),n(i(74)),n(i(22)),n(i(23)),n(i(19)),n(i(68)),n(i(77)),n(i(78)),n(i(29)),n(i(76)),n(i(24)),n(i(71)),n(i(155)),n(i(73)),n(i(82)),n(i(56)),n(i(156)),n(i(83)),n(i(16)),n(i(79)),n(i(67)),n(i(37)),n(i(65)),n(i(40)),n(i(160)),n(i(80))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=Math.PI/180,r=180/Math.PI;!function(e){function t(e){return(e%=360)<0&&(e+=360),e}function i(e,i){const n=(e=t(e))-(i=t(i));return n>180?n-360:n<=-180?n+360:n}e.newEmptyBox3=function(){return{min:{x:1/0,y:1/0,z:1/0},max:{x:-1/0,y:-1/0,z:-1/0}}},e.newVector3=function(e,t,i,n){return void 0===n?{x:e,y:t,z:i}:(n.x=e,n.y=t,n.z=i,n)},e.degToRad=function(e){return e*n},e.radToDeg=function(e){return e*r},e.clamp=function(e,t,i){return e<t?t:e>i?i:e},e.normalizeAngleDeg=t,e.angleDistanceDeg=i,e.interpolateAnglesDeg=function(e,t,n){return(e+i(t,e)*n)%360}}(t.MathUtils||(t.MathUtils={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isOrientedBox3Like=function(e){const t=e;return void 0!==t.position&&void 0!==t.xAxis&&void 0!==t.yAxis&&void 0!==t.zAxis&&void 0!==t.extents}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);var r,s,o,a,l,c,h;!function(e){e[e.Em=0]="Em",e[e.Pixel=1]="Pixel",e[e.Point=2]="Point",e[e.Percent=3]="Percent"}(r=t.FontUnit||(t.FontUnit={})),function(e){e[e.Regular=0]="Regular",e[e.Bold=1]="Bold",e[e.Italic=2]="Italic",e[e.BoldItalic=3]="BoldItalic"}(s=t.FontStyle||(t.FontStyle={})),function(e){e[e.Regular=0]="Regular",e[e.AllCaps=1]="AllCaps",e[e.SmallCaps=2]="SmallCaps"}(o=t.FontVariant||(t.FontVariant={})),function(e){e[e.Above=0]="Above",e[e.Center=-.5]="Center",e[e.Below=-1]="Below"}(a=t.VerticalAlignment||(t.VerticalAlignment={})),function(e){e[e.Left=0]="Left",e[e.Center=-.5]="Center",e[e.Right=-1]="Right"}(l=t.HorizontalAlignment||(t.HorizontalAlignment={})),function(e){e[e.None=0]="None",e[e.Character=1]="Character",e[e.Word=2]="Word"}(c=t.WrappingMode||(t.WrappingMode={})),function(e){e.DEFAULT_FONT_NAME="",e.DEFAULT_FONT_SIZE={unit:Object.freeze(r.Pixel),size:Object.freeze(16),backgroundSize:Object.freeze(0)},e.DEFAULT_FONT_STYLE=s.Regular,e.DEFAULT_FONT_VARIANT=o.Regular,e.DEFAULT_ROTATION=0,e.DEFAULT_COLOR=new n.Color(0),e.DEFAULT_OPACITY=1,e.DEFAULT_BACKGROUND_COLOR=new n.Color(0),e.DEFAULT_BACKGROUND_OPACITY=0,e.DEFAULT_TRACKING=0,e.DEFAULT_LEADING=0,e.DEFAULT_MAX_LINES=1/0,e.DEFAULT_LINE_WIDTH=1/0,e.DEFAULT_LINE_ROTATION=0,e.DEFAULT_WRAPPING_MODE=c.Word,e.DEFAULT_VERTICAL_ALIGNMENT=a.Above,e.DEFAULT_HORIZONTAL_ALIGNMENT=l.Left}(h=t.DefaultTextStyle||(t.DefaultTextStyle={}));class d{constructor(e={}){this.m_params={fontName:void 0!==e.fontName?e.fontName:h.DEFAULT_FONT_NAME,fontSize:void 0!==e.fontSize?e.fontSize:{unit:h.DEFAULT_FONT_SIZE.unit,size:h.DEFAULT_FONT_SIZE.size,backgroundSize:h.DEFAULT_FONT_SIZE.backgroundSize},fontStyle:void 0!==e.fontStyle?e.fontStyle:h.DEFAULT_FONT_STYLE,fontVariant:void 0!==e.fontVariant?e.fontVariant:h.DEFAULT_FONT_VARIANT,rotation:void 0!==e.rotation?e.rotation:h.DEFAULT_ROTATION,color:void 0!==e.color?e.color:new n.Color(h.DEFAULT_COLOR),opacity:void 0!==e.opacity?e.opacity:h.DEFAULT_OPACITY,backgroundColor:void 0!==e.backgroundColor?e.backgroundColor:new n.Color(h.DEFAULT_BACKGROUND_COLOR),backgroundOpacity:void 0!==e.backgroundOpacity?e.backgroundOpacity:h.DEFAULT_BACKGROUND_OPACITY}}get params(){return this.m_params}set params(e){this.m_params=Object.assign({},this.m_params,e)}get fontName(){return this.m_params.fontName}set fontName(e){this.m_params.fontName=e}get fontSize(){return this.m_params.fontSize}set fontSize(e){this.m_params.fontSize=e}get fontStyle(){return this.m_params.fontStyle}set fontStyle(e){this.m_params.fontStyle=e}get fontVariant(){return this.m_params.fontVariant}set fontVariant(e){this.m_params.fontVariant=e}get rotation(){return this.m_params.rotation}set rotation(e){this.m_params.rotation=e}get color(){return this.m_params.color}set color(e){this.m_params.color=e}get backgroundColor(){return this.m_params.backgroundColor}set backgroundColor(e){this.m_params.backgroundColor=e}get opacity(){return this.m_params.opacity}set opacity(e){this.m_params.opacity=e}get backgroundOpacity(){return this.m_params.backgroundOpacity}set backgroundOpacity(e){this.m_params.backgroundOpacity=e}clone(e={}){return new d(Object.assign({},this.m_params,e))}}t.TextRenderStyle=d;class u{constructor(e={}){this.m_params={tracking:void 0!==e.tracking?e.tracking:h.DEFAULT_TRACKING,leading:void 0!==e.leading?e.leading:h.DEFAULT_LEADING,maxLines:void 0!==e.maxLines?e.maxLines:h.DEFAULT_MAX_LINES,lineWidth:void 0!==e.lineWidth?e.lineWidth:h.DEFAULT_LINE_WIDTH,lineRotation:void 0!==e.lineRotation?e.lineRotation:h.DEFAULT_LINE_ROTATION,wrappingMode:void 0!==e.wrappingMode?e.wrappingMode:h.DEFAULT_WRAPPING_MODE,verticalAlignment:void 0!==e.verticalAlignment?e.verticalAlignment:h.DEFAULT_VERTICAL_ALIGNMENT,horizontalAlignment:void 0!==e.horizontalAlignment?e.horizontalAlignment:h.DEFAULT_HORIZONTAL_ALIGNMENT}}get params(){return this.m_params}set params(e){this.m_params=Object.assign({},this.m_params,e)}get tracking(){return this.m_params.tracking}set tracking(e){this.m_params.tracking=e}get leading(){return this.m_params.leading}set leading(e){this.m_params.leading=e}get maxLines(){return this.m_params.maxLines}set maxLines(e){this.m_params.maxLines=e}get lineWidth(){return this.m_params.lineWidth}set lineWidth(e){this.m_params.lineWidth=e}get lineRotation(){return this.m_params.lineRotation}set lineRotation(e){this.m_params.lineRotation=e}get wrappingMode(){return this.m_params.wrappingMode}set wrappingMode(e){this.m_params.wrappingMode=e}get verticalAlignment(){return this.m_params.verticalAlignment}set verticalAlignment(e){this.m_params.verticalAlignment=e}get horizontalAlignment(){return this.m_params.horizontalAlignment}set horizontalAlignment(e){this.m_params.horizontalAlignment=e}clone(e={}){return new u(Object.assign({},this.m_params,e))}}t.TextLayoutStyle=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);class r{constructor(){this.m_map=new Map}static get instance(){return this.m_instance}getColor(e){let t=this.m_map.get(e);return void 0!==t||(t=new n.Color(e),this.m_map.set(e,t)),t}get size(){return this.m_map.size}clear(){this.m_map.clear()}}r.m_instance=new r,t.ColorCache=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),r=i(1),s=i(29);var o;!function(e){e[e.None=0]="None",e[e.Started=1]="Started",e[e.Playing=2]="Playing",e[e.Finished=3]="Finished"}(o=t.AnimatedExtrusionState||(t.AnimatedExtrusionState={}));t.AnimatedExtrusionHandler=class{constructor(e){this.m_mapView=e,this.enabled=!0,this.duration=750,this.forceEnabled=!1,this.m_tileHandlerMap=new Map,this.m_zoomDirection=0,this.m_zoomLevelPrevious=this.m_mapView.zoomLevel}get zoomDirection(){return this.m_zoomDirection}set zoom(e){this.m_zoomLevelPrevious!==e&&(this.m_tileHandlerMap.forEach(t=>{void 0!==this.m_mapView.getDataSourceByName(t.tile.dataSource.name)&&(this.m_zoomDirection=e>this.m_zoomLevelPrevious?1:-1,t.zoomLevelChanged(this.m_zoomDirection))}),this.m_zoomLevelPrevious=e)}get forceAnimatedExtrusion(){return this.m_forceAnimatedExtrusion}set forceAnimatedExtrusion(e){this.m_forceAnimatedExtrusion=e}get forceAnimatedExtrusionDuration(){return this.m_forceAnimatedExtrusionDuration}set forceAnimatedExtrusionDuration(e){this.m_forceAnimatedExtrusionDuration=e}add(e){this.m_tileHandlerMap.set(e.tile,e)}removeTile(e){this.m_tileHandlerMap.delete(e)}find(e){for(const t of this.m_tileHandlerMap)for(const i of e)if(void 0!==i&&t[0].tileKey.mortonCode()===i.mortonCode())return t[1]}};class a{constructor(e,t,i){this.m_tile=e,this.m_animatedExtrusionDuration=i,this.m_extrudedObjects=[],this.m_animatedExtrusionRatio=a.DEFAULT_RATIO_MAX,this.m_animatedExtrusionState=o.None,this.m_animatedExtrusionStartTime=void 0,this.animateExtrusion=e=>{if(this.m_animatedExtrusionState!==o.Playing){if(this.m_animatedExtrusionState!==o.Started)return;this.m_animatedExtrusionState=o.Playing}const t=Date.now();(void 0===this.m_animatedExtrusionStartTime||this.m_animatedExtrusionStartTime<=0)&&(this.m_animatedExtrusionStartTime=t);const i=Math.min(t-this.m_animatedExtrusionStartTime,this.m_animatedExtrusionDuration);this.extrusionRatio=r.MathUtils.easeInOutCubic(a.DEFAULT_RATIO_MIN,a.DEFAULT_RATIO_MAX,i/this.m_animatedExtrusionDuration),i>=this.m_animatedExtrusionDuration&&(this.m_animatedExtrusionState=o.Finished,this.stopExtrusionAnimation()),this.m_tile.dataSource.requestUpdate()},this.m_mapView=e.mapView,this.m_animatedExtrusionHandler=this.m_mapView.animatedExtrusionHandler,t.forEach(e=>{e.materialFeature&&n.ExtrusionFeature.addRenderHelper(e.object),this.m_extrudedObjects.push(e.object)}),this.startExtrusionAnimationIfNeeded(this.m_animatedExtrusionHandler.zoomDirection)}set extrusionRatio(e){this.m_animatedExtrusionRatio=e,this.m_extrudedObjects.forEach(e=>{e.material.extrusionRatio=this.m_animatedExtrusionRatio})}get tile(){return this.m_tile}get animationState(){return this.m_animatedExtrusionState}dispose(){this.stopExtrusionAnimation(),this.m_animatedExtrusionHandler.removeTile(this.m_tile)}zoomLevelChanged(e){!1===this.m_tile.isVisible&&this.m_animatedExtrusionState!==o.None&&(this.m_animatedExtrusionState=o.None,this.stopExtrusionAnimation()),!0===this.m_tile.isVisible&&this.m_animatedExtrusionState===o.None&&this.startExtrusionAnimationIfNeeded(e)}getChildTiles(e){let t=[];return e.forEach(e=>{const i=this.tile.dataSource.getTilingScheme().getSubTileKeys(e);t=t.concat(i)}),t}startExtrusionAnimationIfNeeded(e){const{quadTreeSearchDistanceUp:t,quadTreeSearchDistanceDown:i}=this.tile.mapView.visibleTileSet.options,n=this.m_tile;let r;if(void 0!==e){let s;if(e<0){let e=0,t=[n.tileKey];for(;i>e&&void 0===r;){const i=this.getChildTiles(t);if(void 0!==i){if(s=this.m_animatedExtrusionHandler.find(i),void 0!==s){r=s.m_animatedExtrusionStartTime;break}t=i}e++}}if(e>0){let e=0,i=n.tileKey;for(;t>e&&void 0===r&&0!==i.level;){const t=i.parent();if(s=this.m_animatedExtrusionHandler.find([t]),void 0!==s){r=s.m_animatedExtrusionStartTime;break}i=t,e++}}}this.startExtrusionAnimation(r)}startExtrusionAnimation(e){this.m_animatedExtrusionState=o.Started,this.m_animatedExtrusionStartTime=e,this.animateExtrusion(),this.m_mapView.addEventListener(s.MapViewEventNames.AfterRender,this.animateExtrusion)}stopExtrusionAnimation(){this.m_mapView.removeEventListener(s.MapViewEventNames.AfterRender,this.animateExtrusion)}}a.DEFAULT_RATIO_MIN=.001,a.DEFAULT_RATIO_MAX=1,t.AnimatedExtrusionTileHandler=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(5),r=Math.PI/180;class s{constructor(e,t){this.southWest=e,this.northEast=t}static fromCoordinates(e,t){return new s(e,t)}get minAltitude(){if(void 0!==this.southWest.altitude&&void 0!==this.northEast.altitude)return Math.min(this.southWest.altitude,this.northEast.altitude)}get maxAltitude(){if(void 0!==this.southWest.altitude&&void 0!==this.northEast.altitude)return Math.max(this.southWest.altitude,this.northEast.altitude)}get south(){return this.southWest.latitude}get north(){return this.northEast.latitude}get west(){return this.southWest.longitude}get east(){return this.northEast.longitude}get center(){const e=.5*(this.south+this.north),{west:t,east:i}=this,{minAltitude:r,altitudeSpan:s}=this;let o;if(void 0!==r&&void 0!==s&&(o=r+.5*s),t<i)return new n.GeoCoordinates(e,.5*(t+i),o);let a=.5*(360+i+t);return a>360&&(a-=360),new n.GeoCoordinates(e,a,o)}get latitudeSpanInRadians(){return this.latitudeSpan*r}get longitudeSpanInRadians(){return this.longitudeSpan*r}get latitudeSpan(){return this.north-this.south}get altitudeSpan(){if(void 0!==this.maxAltitude&&void 0!==this.minAltitude)return this.maxAltitude-this.minAltitude}get longitudeSpan(){let e=this.northEast.longitude-this.southWest.longitude;return e<0&&(e+=360),e}get latitudeSpanInDegrees(){return this.latitudeSpan}get longitudeSpanInDegrees(){return this.longitudeSpan}contains(e){if(void 0===e.altitude||void 0===this.minAltitude||void 0===this.maxAltitude)return this.containsHelper(e);const t=this.minAltitude===this.maxAltitude,i=this.minAltitude===e.altitude,n=this.minAltitude<=e.altitude&&this.maxAltitude>e.altitude;return!!(t?i:n)&&this.containsHelper(e)}clone(){return new s(this.southWest,this.northEast)}growToContain(e){this.southWest.latitude=Math.min(this.southWest.latitude,e.latitude),this.southWest.longitude=Math.min(this.southWest.longitude,e.longitude),this.southWest.altitude=void 0!==this.southWest.altitude&&void 0!==e.altitude?Math.min(this.southWest.altitude,e.altitude):void 0!==this.southWest.altitude?this.southWest.altitude:void 0!==e.altitude?e.altitude:void 0,this.northEast.latitude=Math.max(this.northEast.latitude,e.latitude),this.northEast.longitude=Math.max(this.northEast.longitude,e.longitude),this.northEast.altitude=void 0!==this.northEast.altitude&&void 0!==e.altitude?Math.max(this.northEast.altitude,e.altitude):void 0!==this.northEast.altitude?this.northEast.altitude:void 0!==e.altitude?e.altitude:void 0}containsHelper(e){if(e.latitude<this.southWest.latitude||e.latitude>=this.northEast.latitude)return!1;const{west:t,east:i}=this;return i>t?e.longitude>=t&&e.longitude<i:e.longitude>i||e.longitude<=t}}t.GeoBox=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{}n.EQUATORIAL_CIRCUMFERENCE=40075016.68557849,n.EQUATORIAL_RADIUS=6378137,n.MIN_ELEVATION=-433,n.MAX_ELEVATION=8848,t.EarthConstants=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isBox3Like=function(e){const t=e;return void 0!==t.min&&void 0!==t.max}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Planar=0]="Planar",e[e.Spherical=1]="Spherical"}(t.ProjectionType||(t.ProjectionType={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(2),r=i(13),s=i(4),o=i(1),a=i(0),l=i(56),c=o.LoggerManager.instance.create("MapViewUtils");!function(e){const t=new a.Plane(new a.Vector3(0,0,1)),i=new a.Vector3(0,0,0),o=new a.Matrix4,h=new a.Matrix4,d=new a.Raycaster,u=new a.Quaternion,m=new a.Quaternion,p=new a.Vector3(0,0,1),f=new a.Vector3(1,0,0);function g(e,n,r){const s=new a.Vector3(n,r,.5),l=e.worldCenter;i.copy(e.camera.position),o.extractRotation(e.camera.matrixWorld),h.multiplyMatrices(o,h.getInverse(e.camera.projectionMatrix));const c=s.applyMatrix4(h);d.set(i,c.normalize());const u=new a.Vector3,m=d.ray.intersectPlane(t,u);return m?(m.setX(m.x+l.x),m.setY(m.y+l.y),m):null}function _(e,t){const i=y(e.camera.quaternion).pitch,n=r.EarthConstants.EQUATORIAL_CIRCUMFERENCE/Math.pow(2,t);return e.focalLength*n/256*Math.cos(i)}function v(e,t,i){const n=e.worldCenter;n.setX(n.x+t),n.setY(n.y+i),e.update()}function y(e){const t=e.y*e.y,i=2*(e.w*e.x+e.y*e.z),n=1-2*(e.x*e.x+t),r=Math.atan2(i,n);let s=2*(e.w*e.y-e.z*e.x);s=s>1?1:s,s=s<-1?-1:s;const o=Math.asin(s),a=2*(e.w*e.z+e.x*e.y),l=1-2*(t+e.z*e.z);return{yaw:Math.atan2(a,l),pitch:r,roll:o}}function x(e,t,i){if(null===e||void 0===e.image)return;if(void 0!==e.uuid&&!0===i.get(e.uuid))return;i.set(e.uuid,!0);const n=e.image,r=4*n.width*n.height;t.heapSize+=r,t.gpuSize+=r}function w(e,t,i){if(void 0===e.uuid||!0!==i.get(e.uuid))if(i.set(e.uuid,!0),e instanceof a.RawShaderMaterial||e instanceof a.ShaderMaterial){const n=e;for(const e in n.uniforms)if(void 0!==n.uniforms[e]){const r=n.uniforms[e];r instanceof a.Texture&&x(r,t,i)}}else if(e instanceof a.MeshBasicMaterial||e instanceof s.MapMeshBasicMaterial){const n=e;x(n.map,t,i),x(n.aoMap,t,i),x(n.specularMap,t,i),x(n.alphaMap,t,i),x(n.envMap,t,i)}else if(e instanceof s.MapMeshStandardMaterial){const n=e;x(n.map,t,i),x(n.lightMap,t,i),x(n.aoMap,t,i),x(n.emissiveMap,t,i),x(n.bumpMap,t,i),x(n.normalMap,t,i),x(n.displacementMap,t,i),x(n.roughnessMap,t,i),x(n.metalnessMap,t,i),x(n.alphaMap,t,i),x(n.envMap,t,i)}else e instanceof a.LineBasicMaterial||e instanceof a.LineDashedMaterial||c.warn("estimateMeshSize: unidentified material: ",e)}function b(e,t,i,n){if(void 0===e.uuid&&(e.uuid=a.Math.generateUUID()),!0===n.get(e.uuid))return;n.set(e.uuid,!0);let r=0,s=4;void 0!==e.array.BYTES_PER_ELEMENT&&(s=e.array.BYTES_PER_ELEMENT),e instanceof a.InterleavedBufferAttribute||e instanceof a.BufferAttribute?r=s*e.count*e.itemSize:c.warn("estimateMeshSize: unidentified attribute: ",t),i.heapSize+=r+56,i.gpuSize+=r}function T(e){return e.substring(0,2)}e.zoomOnTargetPosition=function(e,t,i,n){const r=g(e,t,i);e.camera.position.setZ(_(e,n)),e.camera.matrixWorldNeedsUpdate=!0;const s=g(e,t,i);if(!r||!s)return;const o=r.sub(s);v(e,o.x,o.y)},e.getCameraCoordinatesFromTargetCoordinates=function(e,t,i,n,r){const s=_(r,t),o=a.Math.degToRad(n),l=s*Math.tan(o),c=a.Math.degToRad(i),h=r.projection.projectPoint(e),d={x:h.x+Math.sin(c)*l,y:h.y-Math.cos(c)*l,z:0};return r.projection.unprojectPoint(d)},e.rayCastWorldCoordinates=g,e.calculateDistanceToGroundFromZoomLevel=_,e.pan=v,e.setRotation=function(e,t,i){u.setFromAxisAngle(p,n.MathUtils.degToRad(t)),m.setFromAxisAngle(f,n.MathUtils.degToRad(i)),u.multiply(m),e.camera.quaternion.copy(u),e.camera.matrixWorldNeedsUpdate=!0},e.extractYawPitchRoll=y,e.rayCastGeoCoordinates=function(e,t,i){const n=g(e,t,i);return n?e.projection.unprojectPoint(n):null},e.calculateZoomLevelFromDistance=function(e,t){const i=256*e/t.focalLength;return n.MathUtils.clamp(Math.log2(r.EarthConstants.EQUATORIAL_CIRCUMFERENCE/i),t.minZoomLevel,t.maxZoomLevel)},e.calculateDepthFromClipDistance=function(e,t){const i=t,n=i.far-i.near,r=e*i.far;return(1-i.near/r)*(i.far/n)},e.cameraToWorldDistance=function(e,t){return e*t.far},e.calculateVerticalFovByHorizontalFov=function(e,t){return 2*Math.atan(Math.tan(e/2)/t)},e.calculateHorizontalFovByVerticalFov=function(e,t){return 2*Math.atan(Math.tan(e/2)*t)},e.calculateFocalLengthByVerticalFov=function(e,t){return t/2/Math.tan(e/2)},e.calculateFovByFocalLength=function(e,t){return n.MathUtils.radToDeg(2*Math.atan(t/2/e))},e.calculateScreenSizeByFocalLength=function(e,t,i){return e*i/t},e.calculateWorldSizeByFocalLength=function(e,t,i){return t*i/e},e.estimateObject3dSize=function e(t,i,n){const r=void 0!==i?i:{heapSize:0,gpuSize:0};if(void 0===n&&(n=new Map),function(e,t,i){if(!e.isObject3D||e instanceof a.Scene)return;if(void 0!==e.uuid&&!0===i.get(e.uuid))return;if(i.set(e.uuid,!0),e.isMesh||e.isLine||e.isPoints){let n=1e3;const r=0,s=e;if(void 0!==s.material)if(Array.isArray(s.material)){const e=s.material;for(const n of e)w(n,t,i)}else{w(s.material,t,i)}void 0!==s.geometry&&function(e,t,i){if(void 0!==e.uuid&&!0===i.get(e.uuid))return;let n;i.set(e.uuid,!0),e instanceof a.Geometry?(t.heapSize+=24*e.vertices.length,t.heapSize+=48*e.faces.length,n=e._bufferGeometry):e instanceof a.BufferGeometry&&(n=e);if(void 0===n)return;const r=n.attributes;if(void 0===r)return void c.warn("estimateGeometrySize: unidentified geometry: ",e);for(const e in r)void 0!==r[e]&&b(r[e],e,t,i);null!==n.index&&b(n.index,"index",t,i)}(s.geometry,t,i);const o=void 0!==e.userData?e.userData.feature:void 0;void 0!==o&&(n+=l.getFeatureDataSize(o)),t.heapSize+=n,t.gpuSize+=r}else c.warn("estimateMeshSize: unidentified object",e)}(t,r,n),t.children.length>0)for(const i of t.children)e(i,r,n);return r},e.getBrowserLanguages=function(){if(void 0!==navigator.languages&&navigator.languages.length>0){const e=[];for(const t of navigator.languages)e.push(T(t));return e}if(void 0!==navigator.language)return[T(navigator.language)]}}(t.MapViewUtils||(t.MapViewUtils={}));const h=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648,4294967296,8589934592,17179869184,34359738368,68719476736,137438953472,274877906944,549755813888,1099511627776,2199023255552,4398046511104,8796093022208,17592186044416,35184372088832,70368744177664,0x800000000000,281474976710656,562949953421312,0x4000000000000,0x8000000000000,4503599627370496];!function(e){function t(e,t,i=4){const n=function(e,t=4){let i=0;const n=h[t];e+=n/2;for(;e<0;)e+=n;for(;e>=n;)e-=n;for(let n=0;n<t&&e>0;n++)1&e&&(i+=h[53-t+n]),e>>>=1;return o.assert(0===e),i}(t,i);return e.mortonCode()+n}function i(e,t=4){let i=0,n=e,r=0;for(;r<t;r++){const e=h[52-r];n>=e&&(n-=e,i+=h[t-1-r])}return i-=h[t-1],{offset:i,mortonCode:n}}e.getKeyForTileKeyAndOffset=t,e.extractOffsetAndMortonKeyFromKey=i,e.getParentKeyFromKey=function(e,r=4){const{offset:s,mortonCode:o}=i(e,r);return t(n.TileKey.fromMortonCode(n.TileKey.parentMortonCode(o)),s,r)}}(t.TileOffsetUtils||(t.TileOffsetUtils={}))},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(130)),n(i(32)),n(i(9)),n(i(61)),n(i(133)),n(i(136)),n(i(62)),n(i(35)),n(i(18))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){let t;e.whiteSpaceRanges=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]],e.isWhiteSpace=function(t){for(const i of e.whiteSpaceRanges)if(t>=i[0]&&t<=i[1])return!0;return!1},e.newLineRanges=[[10,13],[133,133],[8232,8233]],e.isNewLine=function(t){for(const i of e.newLineRanges)if(t>=i[0]&&t<=i[1])return!0;return!1},e.nonPrintableRanges=[[0,31],[127,159]],e.isPrintable=function(t){for(const i of e.nonPrintableRanges)if(t>=i[0]&&t<=i[1])return!1;return!0},function(e){e[e.Neutral=0]="Neutral",e[e.Weak=.5]="Weak",e[e.LTR=1]="LTR",e[e.RTL=-1]="RTL"}(t=e.Direction||(e.Direction={})),e.rtlBlocks=["Hebrew","Alphabetic Presentation Forms","Arabic","Arabic Supplement","Arabic Extended-A","Arabic Presentation Forms-A","Arabic Presentation Forms-B","Arabic Mathematical Alphabetic Symbols","Indic Siyaq Numbers","Rumi Numeral Symbols","Syriac","Syriac Supplement","Samaritan","Mandaic","Thaana","Mende Kikakui","NKo","Adlam","Hanifi Rohingya"],e.neutralBidirectionalRanges=[[32,47],[58,64],[91,96],[123,126]],e.weakBidirectionalRanges=[[48,57],[1632,1641],[1776,1785]],e.getDirection=function(i,n){for(const n of e.weakBidirectionalRanges)if(i>=n[0]&&i<=n[1])return t.Weak;for(const n of e.neutralBidirectionalRanges)if(i>=n[0]&&i<=n[1])return t.Neutral;return void 0!==e.rtlBlocks.find(e=>e===n)?t.RTL:t.LTR},e.rtlMirroredCodePoints=[40,41,60,62,91,93,123,125],e.isRtlMirrored=function(t){return void 0!==e.rtlMirroredCodePoints.find(e=>e===t)}}(t.UnicodeUtils||(t.UnicodeUtils={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(17),r=i(10);t.DEFAULT_TEXT_STYLE_CACHE_ID="Default",t.computeStyleCacheId=function(e,t,i){return`${e}_${t.renderOrder}_${i}`};t.TextRenderStyleCache=class{constructor(){this.m_map=new Map,this.m_map.set(t.DEFAULT_TEXT_STYLE_CACHE_ID,new n.TextRenderStyle({fontSize:{unit:n.FontUnit.Pixel,size:32,backgroundSize:8},color:r.ColorCache.instance.getColor("#6d7477"),backgroundColor:r.ColorCache.instance.getColor("#f7fbfd"),backgroundOpacity:.5}))}get size(){return this.m_map.size}get(e){return this.m_map.get(e)}set(e,t){this.m_map.set(e,t)}clear(){this.m_map.clear(),this.m_map.set(t.DEFAULT_TEXT_STYLE_CACHE_ID,new n.TextRenderStyle({fontSize:{unit:n.FontUnit.Pixel,size:32,backgroundSize:8},color:r.ColorCache.instance.getColor("#6d7477"),backgroundColor:r.ColorCache.instance.getColor("#f7fbfd"),backgroundOpacity:.5}))}};t.TextLayoutStyleCache=class{constructor(){this.m_map=new Map,this.m_map.set(t.DEFAULT_TEXT_STYLE_CACHE_ID,new n.TextLayoutStyle({verticalAlignment:n.VerticalAlignment.Center,horizontalAlignment:n.HorizontalAlignment.Center}))}get size(){return this.m_map.size}get(e){return this.m_map.get(e)}set(e,t){this.m_map.set(e,t)}clear(){this.m_map.clear(),this.m_map.set(t.DEFAULT_TEXT_STYLE_CACHE_ID,new n.TextLayoutStyle({verticalAlignment:n.VerticalAlignment.Center,horizontalAlignment:n.HorizontalAlignment.Center}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648,4294967296,8589934592,17179869184,34359738368,68719476736,137438953472,274877906944,549755813888,1099511627776,2199023255552,4398046511104,8796093022208,17592186044416,35184372088832,70368744177664,0x800000000000,281474976710656,562949953421312,0x4000000000000,0x8000000000000,4503599627370496];class r{constructor(e,t,i){this.row=e,this.column=t,this.level=i}static fromRowColumnLevel(e,t,i){return new r(e,t,i)}static fromQuadKey(e){const t=e.length;let i=0,n=0;for(let r=0;r<e.length;++r){const s=1<<r,o=parseInt(e.charAt(t-r-1),10);1&o&&(n|=s),2&o&&(i|=s)}return r.fromRowColumnLevel(i,n,t)}static fromMortonCode(e){let t=0,i=0,n=0,s=e;for(;s>1;){const e=1<<t;1&s&&(n|=e),2&s&&(i|=e),t++,s=(s-(3&s))/4}const o=r.fromRowColumnLevel(i,n,t);return o.m_mortonCode=e,o}static fromHereTile(e){const t=r.fromMortonCode(parseInt(e,10));return t.m_hereTile=e,t}static columnsAtLevel(e){return Math.pow(2,e)}static rowsAtLevel(e){return Math.pow(2,e)}static atCoords(e,t,i,n,s){return r.fromRowColumnLevel(Math.floor(i/(s/r.rowsAtLevel(e))),Math.floor(t/(n/r.columnsAtLevel(e))),e)}static parentMortonCode(e){return Math.floor(e/4)}parent(){if(0===this.level)throw new Error("Cannot get the parent of the root tile key");return r.fromRowColumnLevel(this.row>>>1,this.column>>>1,this.level-1)}changedLevelBy(e){const t=Math.max(0,this.level+e);let i=this.row,n=this.column;return e>=0?(i<<=e,n<<=e):(i>>>=-e,n>>>=-e),r.fromRowColumnLevel(i,n,t)}changedLevelTo(e){return this.changedLevelBy(e-this.level)}mortonCode(){if(void 0===this.m_mortonCode){let e=this.column,t=this.row,i=n[this.level<<1];for(let r=0;r<this.level;++r)1&e&&(i+=n[2*r]),1&t&&(i+=n[2*r+1]),e>>>=1,t>>>=1;this.m_mortonCode=i}return this.m_mortonCode}toHereTile(){return void 0===this.m_hereTile&&(this.m_hereTile=this.mortonCode().toString()),this.m_hereTile}toQuadKey(){let e="";for(let t=this.level;t>0;--t){const i=1<<t-1,n=0!=(this.column&i),r=0!=(this.row&i);e+=n&&r?"3":r?"2":n?"1":"0"}return e}equals(e){return this.row===e.row&&this.column===e.column&&this.level===e.level}addedSubKey(e){const t=r.fromQuadKey(0===e.length?"-":e),i=this.changedLevelBy(t.level);return r.fromRowColumnLevel(i.row+t.row,i.column+t.column,i.level)}addedSubHereTile(e){const t=r.fromHereTile(e),i=this.changedLevelBy(t.level);return r.fromRowColumnLevel(i.row+t.row,i.column+t.column,i.level)}getSubHereTile(e){const t=1<<2*e;return(this.mortonCode()&t-1|t).toString()}rowCount(){return r.rowsAtLevel(this.level)}columnCount(){return r.columnsAtLevel(this.level)}}t.TileKey=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(50),r=i(53),s=i(54);t.TilingScheme=class{constructor(e,t){this.subdivisionScheme=e,this.projection=t,this.boundingBoxGenerator=new n.FlatTileBoundingBoxGenerator(this),this.tileTreeTraverse=new s.TileTreeTraverse(e)}getSubTileKeys(e){return this.tileTreeTraverse.subTiles(e)}getTileKey(e,t){return r.TileKeyUtils.geoCoordinatesToTileKey(this,e,t)}getTileKeys(e,t){return r.TileKeyUtils.geoRectangleToTileKeys(this,e,t)}getGeoBox(e){return this.boundingBoxGenerator.getGeoBox(e)}getWorldBox(e,t){return this.boundingBoxGenerator.getWorldBox(e,t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),r=i(17),s=i(1),o=i(0);var a;!function(e){e[e.Undefined=0]="Undefined",e[e.FadingIn=1]="FadingIn",e[e.FadedIn=2]="FadedIn",e[e.FadingOut=-1]="FadingOut",e[e.FadedOut=-2]="FadedOut"}(a=t.FadingState||(t.FadingState={})),function(e){e[e.Requested=0]="Requested",e[e.Loaded=1]="Loaded",e[e.Initialized=2]="Initialized"}(t.LoadingState||(t.LoadingState={})),t.DEFAULT_FADE_TIME=800;t.RenderState=class{constructor(e=a.Undefined,i=0,n=0,r=1,s=Number.MIN_SAFE_INTEGER,o=t.DEFAULT_FADE_TIME){this.state=e,this.value=i,this.startTime=n,this.opacity=r,this.lastFrameNumber=s,this.fadingTime=o}reset(){this.state=a.Undefined,this.value=0,this.startTime=0,this.opacity=1,this.lastFrameNumber=Number.MIN_SAFE_INTEGER}isFading(){return this.state===a.FadingIn||this.state===a.FadingOut}isFadingIn(){return this.state===a.FadingIn}isFadingOut(){return this.state===a.FadingOut}isFadedIn(){return this.state===a.FadedIn}isFadedOut(){return this.state===a.FadedOut}isVisible(){return this.state===a.FadingIn||this.state===a.FadedIn||this.state===a.FadingOut}};t.TextElement=class{constructor(e,t,i,n,s=0,o,a,l,c,h,d){this.text=e,this.points=t,this.renderParams=i,this.layoutParams=n,this.priority=s,this.xOffset=o,this.yOffset=a,this.featureId=l,this.style=c,this.fadeNear=h,this.fadeFar=d,this.visible=!0,this.distanceScale=.5,this.renderOrder=0,this.sortPriority=0,i instanceof r.TextRenderStyle&&(this.renderStyle=i),n instanceof r.TextLayoutStyle&&(this.layoutStyle=n)}get position(){return this.points instanceof Array?this.points[0]:this.points instanceof o.Vector3?new o.Vector2(this.points.x,this.points.y):this.points}get position3(){return this.points instanceof o.Vector3?this.points:this.points instanceof Array?new o.Vector3(this.points[0].x,this.points[0].y,0):new o.Vector3(this.points.x,this.points.y,0)}get path(){if(this.points instanceof Array)return this.points}get textMayOverlap(){return!0===this.mayOverlap}set textMayOverlap(e){this.mayOverlap=e}get textReservesSpace(){return!1!==this.reserveSpace}set textReservesSpace(e){this.reserveSpace=e}get isLineMarker(){return void 0!==this.points&&void 0!==this.m_poiInfo&&n.isLineMarkerTechnique(this.m_poiInfo.technique)}get renderDistance(){return!0===this.alwaysOnTop?0:void 0!==this.currentViewDistance?-this.currentViewDistance:0}get poiInfo(){return this.m_poiInfo}set poiInfo(e){if(this.m_poiInfo=e,void 0!==e){const t=void 0!==this.renderOrder?this.renderOrder:0;e.renderOrder=t}}updateMinMaxZoomLevelsFromPoiInfo(){void 0!==this.poiInfo&&(void 0===this.minZoomLevel&&(this.minZoomLevel=s.MathUtils.min2(this.poiInfo.iconMinZoomLevel,this.poiInfo.textMinZoomLevel)),void 0===this.maxZoomLevel&&(this.maxZoomLevel=s.MathUtils.max2(this.poiInfo.iconMaxZoomLevel,this.poiInfo.textMaxZoomLevel)))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(17),r=i(1),s=i(0),o=i(10),a=i(66),l=i(24),c=i(138),h=i(141),d=i(22),u=i(19);t.DEFAULT_TEXT_DISTANCE_SCALE=.5;const m=r.LoggerManager.instance.create("TextElementsRenderer"),p=new s.Box2,f=[],g=new r.Math2D.Box,_=new s.Vector3,v=new s.Vector3(0,0,0),y=new s.Vector2,x=new s.Vector2;class w{constructor(e,t){this.tile=e,this.textElements=t}}class b{constructor(e,t){this.priority=e,this.textElementLists=t}count(){let e=0;for(const t of this.textElementLists)e+=t.textElements.length;return e}}t.TextElementsRenderer=class{constructor(e,t,i,n,r,o,a,l,c,h){this.m_mapView=e,this.m_screenCollisions=t,this.m_screenProjector=i,this.m_minNumGlyphs=n,this.m_maxNumGlyphs=r,this.m_theme=o,this.m_maxNumVisibleLabels=a,this.m_numSecondChanceLabels=l,this.m_maxDistanceRatioForLabels=c,this.m_labelStartScaleDistance=h,this.m_initializedTextElementCount=0,this.m_textRenderers=[],this.m_textStyles=new Map,this.m_defaultStyle={name:"default",fontCatalog:"default",renderParams:this.m_mapView.textRenderStyleCache.get(u.DEFAULT_TEXT_STYLE_CACHE_ID).params,layoutParams:this.m_mapView.textLayoutStyleCache.get(u.DEFAULT_TEXT_STYLE_CACHE_ID).params},this.m_lastRenderedTextElements=[],this.m_secondChanceTextElements=[],this.m_tmpVector=new s.Vector2,this.m_overloaded=!1,this.m_catalogsLoading=0,void 0===this.m_minNumGlyphs&&(this.m_minNumGlyphs=1024),void 0===this.m_maxNumGlyphs&&(this.m_maxNumGlyphs=32768),void 0===this.m_maxNumVisibleLabels&&(this.m_maxNumVisibleLabels=500),void 0===this.m_numSecondChanceLabels&&(this.m_numSecondChanceLabels=300),void 0===this.m_maxDistanceRatioForLabels&&(this.m_maxDistanceRatioForLabels=.99),void 0===this.m_labelStartScaleDistance&&(this.m_labelStartScaleDistance=.4),this.initializeDefaultAssets(),this.initializeTextCanvases()}renderText(e){const t=a.debugContext.getValue("DEBUG_GLYPHS");void 0!==t&&void 0!==this.m_debugGlyphTextureCacheMesh&&void 0!==this.m_debugGlyphTextureCacheWireMesh&&(this.m_debugGlyphTextureCacheMesh.visible=t,this.m_debugGlyphTextureCacheWireMesh.visible=t);for(const t of this.m_textRenderers)t.textCanvas.render(e)}reset(){this.m_screenCollisions.reset();for(const e of this.m_textRenderers)e.textCanvas.clear(),e.poiRenderer.reset();this.m_initializedTextElementCount=0}update(){for(const e of this.m_textRenderers)e.poiRenderer.update()}placeAllTileLabels(){this.placeAllLabels()}movementStarted(){}movementFinished(){this.placeAllLabels()}get defaultStyle(){return this.m_defaultStyle}get overloaded(){return this.m_overloaded}get isDynamicFrame(){const e=this.m_mapView;return e.cameraIsMoving||e.animating||e.updatePending}renderUserTextElements(e,t){const i=this.m_mapView.visibleTileSet.dataSourceTileList,n=this.m_mapView.worldCenter.clone().add(this.m_mapView.camera.position),r=this.m_mapView.zoomLevel;i.forEach(i=>{for(const s of i.visibleTiles){for(const e of s.userTextElements)e.tileCenterX=s.center.x,e.tileCenterY=s.center.y,this.updateViewDistance(n,e);this.renderTextElements(s.userTextElements,e,t,r)}})}renderAllTileText(e,t){const i=this.m_mapView.visibleTileSet.dataSourceTileList,n=this.m_mapView.zoomLevel;if(this.checkIfOverloaded(),0===this.m_lastRenderedTextElements.length){const s=this.overloaded&&this.isDynamicFrame?r.PerformanceTimer.now():void 0;i.forEach(i=>{this.renderTileList(i.renderedTiles,e,t,n,s,this.m_lastRenderedTextElements,this.m_secondChanceTextElements)})}else{const i=this.m_lastRenderedTextElements.concat(this.m_secondChanceTextElements);this.renderTextElements(i,e,t,n)}}renderOverlay(e){void 0!==e&&0!==e.length&&this.renderOverlayTextElements(e)}pickTextElements(e,t){const i=(i,n)=>{const r=i;if(void 0===r)return;let s=!1;if(void 0!==r.featureId&&(s=t.some(e=>void 0!==e&&n===e.type&&(void 0!==e.featureId&&e.featureId===r.featureId||void 0!==e.userData&&e.userData===r.userData)),!s)){const i={type:n,point:e,distance:0,featureId:r.featureId,userData:r.userData,text:r.text};t.push(i)}};for(const t of this.m_textRenderers)t.textCanvas.pickText(e,e=>{i(e,l.PickObjectType.Text)}),t.poiRenderer.pickTextElements(e,e=>{i(e,l.PickObjectType.Icon)})}getTextElementStyle(e){let t;return void 0===e?t=this.m_defaultStyle:(t=this.m_textStyles.get(e),void 0===t&&(t=this.m_defaultStyle)),t}get ready(){return 0===this.m_catalogsLoading&&this.m_textRenderers.length>0}get loading(){let e=this.m_catalogsLoading>0;for(const t of this.m_textRenderers)e=e||t.textCanvas.fontCatalog.isLoading;return e}clearRenderStates(){this.m_mapView.visibleTileSet.dataSourceTileList.forEach(e=>{for(const t of e.visibleTiles)t.userTextElements.forEach(e=>{e.iconRenderState=void 0,e.textRenderState=void 0}),t.textElementGroups.forEach(e=>{e.iconRenderState=void 0,e.textRenderState=void 0})})}getMemoryUsage(){const e={heapSize:0,gpuSize:0};for(const t of this.m_textRenderers)t.textCanvas.getMemoryUsage(e),t.poiRenderer.getMemoryUsage(e);return e}initializeDefaultAssets(){(void 0===this.m_theme.fontCatalogs||Array.isArray(this.m_theme.fontCatalogs)&&0===this.m_theme.fontCatalogs.length)&&(this.m_theme.fontCatalogs=[{name:"default",url:this.m_mapView.defaultFontCatalog}]);const e=this.m_theme.fontCatalogs;let t;if(e.length>0){for(const i of e)if(void 0!==i.name){t=i.name;break}void 0===t&&(t="default",e[0].name=t)}void 0===this.m_theme.textStyles&&(this.m_theme.textStyles=[]);const i=this.m_theme.textStyles,n=i.find(e=>"default"===e.name);void 0!==n?this.m_defaultStyle=this.createTextElementStyle(n,"default"):void 0!==this.m_theme.defaultTextStyle?this.m_defaultStyle=this.createTextElementStyle(this.m_theme.defaultTextStyle,"default"):i.length>0&&(this.m_defaultStyle=this.createTextElementStyle(i[0],"default")),this.m_defaultStyle.fontCatalog=t}createTextElementStyle(e,t){return{name:t,fontCatalog:r.getOptionValue(e.fontCatalogName,"default"),renderParams:{fontSize:{unit:n.FontUnit.Pixel,size:32,backgroundSize:e.backgroundSize||8},fontVariant:!0===e.smallCaps?n.FontVariant.SmallCaps:!0===e.allCaps?n.FontVariant.AllCaps:void 0,fontStyle:!0===e.bold?!0===e.oblique?n.FontStyle.BoldItalic:n.FontStyle.Bold:!0===e.oblique?n.FontStyle.Italic:void 0,color:void 0!==e.color?o.ColorCache.instance.getColor(e.color):void 0,backgroundColor:void 0!==e.backgroundColor?o.ColorCache.instance.getColor(e.backgroundColor):void 0,backgroundOpacity:e.backgroundAlpha},layoutParams:{tracking:e.tracking,verticalAlignment:n.VerticalAlignment.Center,horizontalAlignment:n.HorizontalAlignment.Center}}}initializeTextCanvases(){const e=[];this.m_theme.fontCatalogs.forEach(t=>{this.m_catalogsLoading+=1;const i=n.FontCatalog.load(t.url,1024).then(e=>{this.m_catalogsLoading-=1;const i=new n.TextCanvas({renderer:this.m_mapView.renderer,fontCatalog:e,minGlyphCount:this.m_minNumGlyphs,maxGlyphCount:this.m_maxNumGlyphs});this.m_textRenderers.push({fontCatalog:t.name,textCanvas:i,poiRenderer:new c.PoiRenderer(this.m_mapView,i)})}).catch(e=>{this.m_catalogsLoading-=1,m.error("Failed to load FontCatalog: ",e)});e.push(i)}),Promise.all(e).then(()=>{this.initializeTextElementStyles();const e=this.m_textRenderers[0].textCanvas.fontCatalog,t=new s.PlaneGeometry(e.textureSize.width/2.5,e.textureSize.height/2.5,e.textureSize.width/e.maxWidth,e.textureSize.height/e.maxHeight),i=new s.MeshBasicMaterial({transparent:!0,depthWrite:!1,depthTest:!1,map:e.texture});this.m_debugGlyphTextureCacheMesh=new s.Mesh(t,i),this.m_debugGlyphTextureCacheMesh.renderOrder=1e4,this.m_debugGlyphTextureCacheMesh.visible=!1,this.m_debugGlyphTextureCacheMesh.name="glyphDebug";const r=new s.WireframeGeometry(t),o=new s.LineBasicMaterial({transparent:!0,color:10066329,depthWrite:!1,depthTest:!1});this.m_debugGlyphTextureCacheWireMesh=new s.LineSegments(r,o),this.m_debugGlyphTextureCacheWireMesh.renderOrder=9999,this.m_debugGlyphTextureCacheWireMesh.visible=!1,this.m_debugGlyphTextureCacheWireMesh.name="glyphDebug",this.m_textRenderers[0].textCanvas.getLayer(n.DEFAULT_TEXT_CANVAS_LAYER).storage.scene.add(this.m_debugGlyphTextureCacheMesh,this.m_debugGlyphTextureCacheWireMesh),this.m_mapView.update()})}initializeTextElementStyles(){let e;this.m_textRenderers.forEach(t=>{void 0===e&&(e=t.textCanvas)});const t=new c.PoiRenderer(this.m_mapView,e);if(void 0!==this.m_defaultStyle.fontCatalog){const e=this.m_textRenderers.find(e=>e.fontCatalog===this.m_defaultStyle.fontCatalog);this.m_defaultStyle.textCanvas=void 0!==e?e.textCanvas:void 0,this.m_defaultStyle.poiRenderer=void 0!==e?e.poiRenderer:void 0}void 0===this.m_defaultStyle.textCanvas&&(void 0!==this.m_defaultStyle.fontCatalog&&m.warn(`FontCatalog '${this.m_defaultStyle.fontCatalog}' set in TextStyle '${this.m_defaultStyle.name}' not found, using default fontCatalog(${e.fontCatalog.name}).`),this.m_defaultStyle.textCanvas=e,this.m_defaultStyle.poiRenderer=t),this.m_theme.textStyles.forEach(e=>{this.m_textStyles.set(e.name,this.createTextElementStyle(e,e.name))});for(const[i,n]of this.m_textStyles)if(void 0===n.textCanvas){if(void 0!==n.fontCatalog){const e=this.m_textRenderers.find(e=>e.fontCatalog===n.fontCatalog);n.textCanvas=void 0!==e?e.textCanvas:void 0,n.poiRenderer=void 0!==e?e.poiRenderer:void 0}void 0===n.textCanvas&&(void 0!==n.fontCatalog&&m.warn(`FontCatalog '${n.fontCatalog}' set in TextStyle '${n.name}' not found, using default fontCatalog(${e.fontCatalog.name}).`),n.textCanvas=e,n.poiRenderer=t)}}updateViewDistance(e,t){let i;if(t.points instanceof s.Vector2||t.points instanceof s.Vector3){const n=t.position3;v.x=n.x+t.tileCenterX,v.y=n.y+t.tileCenterY,i=e.distanceTo(v)}else if(Array.isArray(t.points))if(1===t.points.length){const n=t.points[0];v.x=n.x+t.tileCenterX,v.y=n.y+t.tileCenterY,i=e.distanceTo(v)}else if(t.points.length>1){const n=t.points;let r=n[0];v.x=r.x+t.tileCenterX,v.y=r.y+t.tileCenterY;const s=e.distanceTo(v);r=n[n.length-1],v.x=r.x+t.tileCenterX,v.y=r.y+t.tileCenterY;const o=e.distanceTo(v);i=Math.min(s,o)}return t.currentViewDistance=i,i}sortTextElements(e,t){const i=1/e.length*.01;for(let n=0;n<e.length;n++){const r=e[n];r.sortPriority=r.priority+n*i+.1-r.currentViewDistance/t*.1}e.sort((e,t)=>t.sortPriority-e.sortPriority)}placeAllLabels(){const e=this.m_mapView.visibleTileSet.dataSourceTileList,t=this.m_mapView.zoomLevel;this.checkIfOverloaded();const i=this.overloaded&&this.isDynamicFrame?r.PerformanceTimer.now():void 0;e.forEach(e=>{this.placeTextElements(e.dataSource,e.storageLevel,t,e.visibleTiles,i)}),this.m_lastRenderedTextElements.length=0,this.m_secondChanceTextElements.length=0}placeTextElements(e,t,i,n,s){const o=n;o.sort((e,t)=>e.tileKey.mortonCode()-t.tileKey.mortonCode());for(const e of o)this.prepareUserTextElements(e);const a=[];this.createSortedGroupsForSorting(e,t,o,a);const l=[];let c=0;for(const e of a)if(this.selectTextElementsToPlaceByDistance(i,e,l),void 0!==s){if(r.PerformanceTimer.now()-s>5)break;if(c+=e.count(),c>=100)break}}prepareUserTextElements(e){for(const t of e.userTextElements)t.tileCenterX=e.center.x,t.tileCenterY=e.center.y}createSortedGroupsForSorting(e,t,i,n){if(0===this.m_textRenderers.length||0===i.length)return;const r=[];for(const n of i)n.placedTextElements.clear(),e.shouldRenderText(t,n.tileKey)&&r.push(n);const s=new Map;for(const e of r)for(const t of e.textElementGroups.groups.values()){if(0===t.elements.length)continue;const i=s.get(t.priority);void 0===i?s.set(t.priority,new b(t.priority,[new w(e,t.elements)])):i.textElementLists.push(new w(e,t.elements))}if(0===s.size)return;for(const e of s){const t=e[1];n.push(t)}n.sort((e,t)=>t.priority-e.priority)}getMaxDistance(e){return this.m_mapView.camera.far*e}selectTextElementsToPlaceByDistance(e,t,i){const n=this.m_mapView.worldCenter.clone().add(this.m_mapView.camera.position),s=this.m_maxDistanceRatioForLabels,o=this.getMaxDistance(s);for(const i of t.textElementLists){const t=i.tile,s=this.m_mapView.projection.worldExtent(0,0).max.x*t.offset;for(const a of i.textElements){if(!a.visible)continue;if(void 0!==a.poiInfo&&void 0!==a.poiInfo.poiTableName){if(!this.m_mapView.poiManager.updatePoiFromPoiTable(a))continue;a.poiInfo.poiTableName=void 0}if(!a.visible||!r.MathUtils.isClamped(e,a.minZoomLevel,a.maxZoomLevel))continue;a.tileCenterX=t.center.x+s,a.tileCenterY=t.center.y;const i=this.updateViewDistance(n,a);void 0!==i&&i>o||t.placedTextElements.add(a)}}i.push([])}renderOverlayTextElements(e){if(0===this.m_textRenderers.length)return;const t=this.m_mapView.renderer.getSize(this.m_tmpVector),i=-t.width/2,r=t.height/2,o={},a={};for(const l of e){const e=this.getTextElementStyle(l.style),c=e.textCanvas;if(void 0===c)continue;const u=c.getLayer(l.renderOrder||n.DEFAULT_TEXT_CANVAS_LAYER),m=void 0!==l.path&&!l.isLineMarker;if(void 0===l.loadingState&&(l.loadingState=d.LoadingState.Requested,void 0===l.renderStyle&&(l.renderStyle=new n.TextRenderStyle(Object.assign({},e.renderParams,l.renderParams))),void 0===l.layoutStyle&&(l.layoutStyle=new n.TextLayoutStyle(Object.assign({},e.layoutParams,l.layoutParams))),""===l.text?l.loadingState=d.LoadingState.Loaded:c.fontCatalog.loadCharset(l.text,l.renderStyle).then(()=>{l.loadingState=d.LoadingState.Loaded,this.m_mapView.update()})),l.loadingState===d.LoadingState.Loaded&&this.m_initializedTextElementCount<1/0&&(c.textRenderStyle=l.renderStyle,c.textLayoutStyle=l.layoutStyle,l.glyphCaseArray=[],l.glyphs=c.fontCatalog.getGlyphs(l.text,c.textRenderStyle,l.glyphCaseArray),l.loadingState=d.LoadingState.Initialized,++this.m_initializedTextElementCount),l.loadingState!==d.LoadingState.Initialized)continue;if(void 0!==u&&u.storage.drawCount+l.glyphs.length>u.storage.capacity)continue;let p;if(c.textRenderStyle=l.renderStyle,c.textLayoutStyle=l.layoutStyle,m){y.x=i,y.y=r,void 0!==l.xOffset&&(y.x+=l.xOffset),void 0!==l.yOffset&&(y.y-=l.yOffset);const e=[];for(const i of l.path){const n=y.x+i.x*t.width,r=y.y-i.y*t.height;e.push(new s.Vector2(n,r))}p=new h.SimplePath;for(let t=0;t<e.length-1;++t)p.add(new s.LineCurve(e[t],e[t+1]));o.path=p,o.pathOverflow=!0,o.layer=l.renderOrder,o.letterCaseArray=l.glyphCaseArray,c.addText(l.glyphs,_,o)}else y.x=i+l.position.x*t.width,y.y=r-l.position.y*t.height,void 0!==l.xOffset&&(y.x+=l.xOffset),void 0!==l.yOffset&&(y.y-=l.yOffset),_.x=y.x,_.y=y.y,_.z=0,a.position=_,o.layer=l.renderOrder,o.letterCaseArray=l.glyphCaseArray,c.addText(l.glyphs,_,o)}}getDistanceFadingFactor(e,t){let i=1;const n=e.currentViewDistance;if(void 0!==n&&void 0!==e.fadeFar&&e.fadeFar>0){const s=void 0===e.fadeNear?0:e.fadeNear,o=e.fadeFar;o>s&&(i=1-r.MathUtils.clamp((n/t-s)/(o-s),0,1))}return i}renderTextElements(e,t,i,o,a,l){if(0===this.m_textRenderers.length)return 0;const c=void 0===a;e.length;const u=this.m_maxNumVisibleLabels,m=this.m_numSecondChanceLabels,v=this.m_labelStartScaleDistance;let w=0;const b=[],T=this.getMaxDistance(.9),S=this.getMaxDistance(.6),C=this.m_mapView.cameraIsMoving,E=this.m_mapView.camera.far,M=this.m_mapView.worldCenter.clone().add(this.m_mapView.camera.position);let A=!1;const P={},L={},R={},I={};for(const O of e){if(!c&&u>=0&&w>=u)break;const e=this.getTextElementStyle(O.style),F=e.textCanvas,D=e.poiRenderer;if(void 0===F||void 0===D)continue;const V=void 0!==O.path&&!O.isLineMarker;let U;if(V){const e=this.checkForSmallLabels(O);if(void 0===e){!0===O.dbgPathTooSmall&&0;continue}U=e}if(void 0===O.loadingState&&(O.loadingState=d.LoadingState.Requested,void 0===O.renderStyle&&(O.renderStyle=new n.TextRenderStyle(Object.assign({},e.renderParams,O.renderParams))),void 0===O.layoutStyle&&(O.layoutStyle=new n.TextLayoutStyle(Object.assign({},e.layoutParams,O.layoutParams))),""===O.text?O.loadingState=d.LoadingState.Loaded:F.fontCatalog.loadCharset(O.text,O.renderStyle).then(()=>{O.loadingState=d.LoadingState.Loaded,this.m_mapView.update()})),O.loadingState===d.LoadingState.Loaded&&this.m_initializedTextElementCount<1/0&&(F.textRenderStyle=O.renderStyle,F.textLayoutStyle=O.layoutStyle,O.glyphCaseArray=[],O.glyphs=F.fontCatalog.getGlyphs(O.text,F.textRenderStyle,O.glyphCaseArray),V||(O.bounds=new s.Box2,L.letterCaseArray=O.glyphCaseArray,F.measureText(O.glyphs,O.bounds,L)),O.loadingState=d.LoadingState.Initialized,++this.m_initializedTextElementCount),O.loadingState!==d.LoadingState.Initialized){void 0!==l&&l.length<m&&l.push(O);continue}const k=F.getLayer(O.renderOrder||n.DEFAULT_TEXT_CANVAS_LAYER);if(void 0!==k&&k.storage.drawCount+O.glyphs.length>k.storage.capacity){0;continue}F.textRenderStyle=O.renderStyle,F.textLayoutStyle=O.layoutStyle;const z=(e,n,s,c,h)=>{y.x=x.x=h.x,y.y=x.y=h.y,void 0!==e.xOffset&&(y.x+=e.xOffset),void 0!==e.yOffset&&(y.y+=e.yOffset);let d=1,u=1;const p=M.distanceTo(c);if(void 0!==p){if(void 0!==e.fadeFar&&(e.fadeFar<=0||e.fadeFar*E<p))return!1;const t=E*v;p>t&&(u=1-(p-t)/(E-t)*(1-e.distanceScale),d*=u),O.currentViewDistance=p}const f=this.getDistanceFadingFactor(e,E),b=e.poiInfo;let T=!0;const P=void 0===b||r.MathUtils.isClamped(o,b.iconMinZoomLevel,b.iconMaxZoomLevel);if(P&&void 0!==b&&D.prepareRender(e)){if(!1===b.isValid)return!1;if(!D.computeScreenBox(b,x,u,this.m_screenCollisions,g))return void 0!==l&&l.length<m&&l.push(e),n.lastFrameNumber=-1,!1;if(T=D.isSpaceAvailable(this.m_screenCollisions,g),T)(n.lastFrameNumber<i-1||n.isFadingOut()||n.isFadedOut())&&this.startFadeIn(n,i,t);else{if(!n.isVisible())return!1;!0===b.mayOverlap||n.isFadingOut()||(this.startFadeOut(n,i,t),void 0!==s&&s.isVisible()&&this.startFadeOut(s,i,t))}n.isFading()&&this.updateFading(n,t)}if((void 0===b||void 0===o||r.MathUtils.isClamped(o,b.iconMinZoomLevel,b.iconMaxZoomLevel))&&(!0===e.ignoreDistance||void 0===e.currentViewDistance||e.currentViewDistance<S)&&(void 0===b||!0===b.isValid||!1!==b.iconIsOptional)&&""!==O.text){if(_.x=y.x,_.y=y.y,_.z=O.renderDistance,g.x=y.x+e.bounds.min.x*d,g.y=y.y+e.bounds.min.y*d,g.w=(e.bounds.max.x-e.bounds.min.x)*d,g.h=(e.bounds.max.y-e.bounds.min.y)*d,g.x-=4*d,g.y-=2*d,g.w+=8*d,g.h+=4*d,!this.m_screenCollisions.isVisible(g))return void 0!==l&&l.length<m&&l.push(e),!1;const r=void 0!==e.poiInfo&&!0===e.poiInfo.textIsOptional,o=void 0!==s&&s.isFadingIn(),a=void 0!==s&&s.isFadingOut(),c=!this.m_screenCollisions.isAllocated(g);if(e.textMayOverlap||c||o||a){if(void 0===e.textBufferObject&&(e.textBufferObject=F.createTextBufferObject(e.glyphs)),!a&&e.textReservesSpace&&this.m_screenCollisions.allocate(g),(o||a||!C||void 0===b||!0===b.renderTextDuringMovements)&&!n.isFadedOut()){let r=!1;!n.isFadingOut()&&c&&T?r=this.checkStartFadeIn(s,i,t,!0):void 0!==s&&s.isFading()&&(this.updateFading(s,t),r=!0),A=A||a||r;const o=void 0!==s?s.opacity:n.opacity;I.layer=e.renderOrder,I.position=_,I.scale=d,I.opacity=o*f,I.backgroundOpacity=I.opacity*O.renderStyle.backgroundOpacity,F.addTextBufferObject(e.textBufferObject,I)}0}else if(P&&r){if(void 0!==s&&s.isVisible()){const e=this.checkStartFadeOut(s,i,t);A=A||e}}else{if(void 0!==e.poiInfo&&!n.isVisible())return void 0!==l&&l.length<m&&l.push(e),!1;if(void 0!==e.poiInfo&&this.startFadeOut(n,i,t),void 0!==s&&s.isVisible()){const e=this.checkStartFadeOut(s,i,t);A=A||e}this.startFadeOut(n,i,t)}}if(P&&void 0!==b&&D.poiIsRenderable(b)){const e=this.checkStartFadeIn(n,i,t);A=A||e,D.renderPoi(b,x,this.m_screenCollisions,u,!1!==b.reserveSpace,n.opacity*f),n.lastFrameNumber=i}return void 0!==a&&a.push(e),w++,!0},B=e=>{_.x=e.position.x+e.tileCenterX,_.y=e.position.y+e.tileCenterY,_.z=0,void 0!==this.m_screenProjector.project(_,y)&&(void 0===e.iconRenderState&&(e.iconRenderState=new d.RenderState,e.textRenderState=new d.RenderState,this.m_mapView.fadingDisabled&&(e.iconRenderState.fadingTime=0,e.textRenderState.fadingTime=0)),z(e,e.iconRenderState,e.textRenderState,_,y))},N=e=>{const t=e.poiInfo;if(void 0===e.path||0===e.path.length||!D.prepareRender(e))return;let i;if(void 0!==t.shieldGroupIndex&&(i=b[t.shieldGroupIndex],void 0===i&&(i=[],b[t.shieldGroupIndex]=i)),void 0===e.iconRenderStates){const t=new Array;e.path.forEach(()=>{const e=new d.RenderState;e.state=d.FadingState.FadingIn,e.fadingTime=this.m_mapView.fadingDisabled?0:e.fadingTime,t.push(e)}),e.iconRenderStates=t}const n=t.technique,s=void 0!==n.minDistance?n.minDistance*n.minDistance:0;if(s>0&&void 0!==i)for(let t=0;t<e.path.length;t++){const n=e.path[t];if(_.x=n.x+e.tileCenterX,_.y=n.y+e.tileCenterY,_.z=0,void 0!==this.m_screenProjector.project(_,y)){let n=!1;for(let e=0;e<i.length;e+=2){if(n=r.Math2D.distSquared(i[e],i[e+1],y.x,y.y)<s,n)break}n||z(e,e.iconRenderStates[t],void 0,_,y)&&i.push(y.x,y.y)}}else for(let t=0;t<e.path.length;t++){const i=e.path[t];_.x=i.x+e.tileCenterX,_.y=i.y+e.tileCenterY,_.z=0,void 0!==this.m_screenProjector.project(_,y)&&z(e,e.iconRenderStates[t],void 0,_,y)}},j=e=>{if(!(!0===e.ignoreDistance||void 0===e.currentViewDistance||e.currentViewDistance<T))return!1;let n=1;if(void 0!==e.fadeFar&&(e.fadeFar<=0||e.fadeFar*E<e.renderDistance))return!1;let r=F.textRenderStyle.fontSize.size/100,o=1,l=new s.Path;y.copy(U[0]);for(let e=0;e<U.length-1;++e)l.add(new h.SimpleLineCurve(U[e],U[e+1]));if(l.getPoint(.5).x-l.getPoint(.51).x>0){y.copy(U[U.length-1]),l=new s.Path;for(let e=U.length-1;e>0;--e)l.add(new h.SimpleLineCurve(U[e],U[e-1]))}this.updateViewDistance(M,e);const c=e.renderDistance,u=E*v,m=-c;m>u&&(n=1-(m-u)/(E-u)*(1-e.distanceScale),r*=n);const x=F.textRenderStyle.fontSize.size;if(F.textRenderStyle.fontSize.size=100*r,R.path=l,R.outputCharacterBounds=f,R.letterCaseArray=e.glyphCaseArray,!F.measureText(e.glyphs,p,R))return F.textRenderStyle.fontSize.size=x,!1;for(const e of f)if(g.x=y.x+e.min.x,g.y=y.y+e.min.y,g.w=e.max.x-e.min.x,g.h=e.max.y-e.min.y,!this.m_screenCollisions.isVisible(g)||!O.textMayOverlap&&this.m_screenCollisions.isAllocated(g))return F.textRenderStyle.fontSize.size=x,!1;void 0===e.textRenderState&&(e.textRenderState=new d.RenderState,e.textRenderState.fadingTime=this.m_mapView.fadingDisabled?0:e.textRenderState.fadingTime),(e.textRenderState.state===d.FadingState.Undefined||e.textRenderState.lastFrameNumber<i-1)&&this.startFadeIn(e.textRenderState,i,t);const b=this.checkStartFadeIn(e.textRenderState,i,t);A=A||b,e.textRenderState.isFading()&&(o=e.textRenderState.opacity);const S=F.textRenderStyle.opacity,C=F.textRenderStyle.backgroundOpacity,L=this.getDistanceFadingFactor(e,E);return F.textRenderStyle.opacity=o*L,F.textRenderStyle.backgroundOpacity=F.textRenderStyle.opacity*O.renderStyle.backgroundOpacity,_.z=O.renderDistance,P.path=l,P.layer=e.renderOrder,P.letterCaseArray=e.glyphCaseArray,F.addText(e.glyphs,_,P),e.textReservesSpace&&(g.x=y.x+p.min.x,g.y=y.y+p.min.y,g.w=p.max.x-p.min.x,g.h=p.max.y-p.min.y,this.m_screenCollisions.allocate(g)),void 0!==a&&a.push(e),w++,F.textRenderStyle.fontSize.size=x,F.textRenderStyle.opacity=S,F.textRenderStyle.backgroundOpacity=C,!0};void 0===O.path?B(O):O.isLineMarker?N(O):j(O)}return!this.m_mapView.fadingDisabled&&A&&this.m_mapView.update(),w}checkForSmallLabels(e){let t=-1;const i=[];let n=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;const a=e.tileCenterX,l=e.tileCenterY;for(const c of e.path){_.set(c.x+a,c.y+l,0);const e=this.m_screenProjector.projectInPlace(_,y);if(void 0!==e&&(i.push(y.clone()),e.x<n&&(n=e.x),e.x>r&&(r=e.x),e.y<s&&(s=e.y),e.y>o&&(o=e.y),t<0)){const e=i.findIndex(e=>this.m_screenCollisions.screenBounds.contains(e.x,e.y));e>=0&&(t=e)}}if(-1===t)return;const c=5*e.text.length;if(!((r-n)*(r-n)+(o-s)*(o-s)<c*c))return i;e.dbgPathTooSmall=!0}renderTileList(e,t,i,n,s,o,a){if(0===this.m_textRenderers.length||0===e.length)return;const l=new r.GroupedPriorityList;for(const t of e)l.merge(t.placedTextElements);const c=this.m_maxNumVisibleLabels;let h=0;for(const e of l.sortedGroups){const l=e.elements;if(this.sortTextElements(l,this.m_mapView.camera.far),h+=this.renderTextElements(l,t,i,n,o,a),h>c)break;if(void 0!==s){if(r.PerformanceTimer.now()-s>10)return}}}checkIfOverloaded(){const e=this.m_mapView.visibleTileSet.dataSourceTileList;let t=0;return e.forEach(e=>{for(const i of e.renderedTiles)t+=i.textElementGroups.count(),t+=i.userTextElements.length}),this.m_overloaded=t>2e4,this.m_overloaded}checkStartFadeIn(e,t,i,n=!1){let r=!1;return void 0!==e&&((n||e.state===d.FadingState.Undefined||e.lastFrameNumber<t-1)&&this.startFadeIn(e,t,i),e.isFading()&&(this.updateFading(e,i),r=!0),e.lastFrameNumber=t),r}checkStartFadeOut(e,t,i,n=!0){let r=!1;return void 0!==e&&((n||e.state===d.FadingState.Undefined||e.lastFrameNumber<t-1)&&this.startFadeOut(e,t,i),e.isFading()&&(this.updateFading(e,i),r=!0),e.lastFrameNumber=t),r}startFadeIn(e,t,i){e.lastFrameNumber<t-1&&e.reset(),e.state!==d.FadingState.FadingIn&&e.state!==d.FadingState.FadedIn&&(e.state===d.FadingState.FadingOut?(e.value=1-e.value,e.startTime=i-e.value*e.fadingTime):(e.startTime=i,e.value=0,e.opacity=0),e.state=d.FadingState.FadingIn)}startFadeOut(e,t,i){e.lastFrameNumber<t-1&&e.reset(),e.state!==d.FadingState.FadingOut&&e.state!==d.FadingState.FadedOut&&(e.state===d.FadingState.FadingIn?(e.startTime=i-e.value*e.fadingTime,e.value=1-e.value):(e.startTime=i,e.value=0,e.opacity=1),e.state=d.FadingState.FadingOut)}updateFading(e,t){if(e.state!==d.FadingState.FadingIn&&e.state!==d.FadingState.FadingOut)return;0===e.startTime&&(e.startTime=t);const i=t-e.startTime,n=e.state===d.FadingState.FadingIn?0:1,s=e.state===d.FadingState.FadingIn?1:0;i>=e.fadingTime?(e.value=1,e.opacity=s,e.state=e.state===d.FadingState.FadingIn?d.FadingState.FadedIn:d.FadingState.FadedOut):(e.value=i/e.fadingTime,e.opacity=r.MathUtils.clamp(r.MathUtils.smootherStep(n,s,e.value),0,1))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),r=i(0),s=i(36),o=i(137),a=i(67);var l;!function(e){e[e.Unspecified=0]="Unspecified",e[e.Point=1]="Point",e[e.Line=2]="Line",e[e.Area=3]="Area",e[e.Text=4]="Text",e[e.Icon=5]="Icon",e[e.Object3D=6]="Object3D"}(l=t.PickObjectType||(t.PickObjectType={}));t.PickHandler=class{constructor(e,t=!0){this.mapView=e,this.enableRoadPicking=t,this.m_plane=new r.Plane(new r.Vector3(0,0,1)),this.m_rayCaster=new o.PickingRaycaster(e),t&&(this.m_roadPicker=new a.RoadPicker(e))}registerTile(e){return void 0!==this.m_roadPicker?this.m_roadPicker.registerTile(e):void 0}intersectMapObjects(e,t){const i=this.mapView.getNormalizedScreenCoordinates(e,t),s=this.m_rayCaster,o=[];if(void 0!==this.mapView.textElementsRenderer){const{clientWidth:e,clientHeight:t}=this.mapView.canvas,n=i.x*e*.5*this.mapView.pixelRatio,s=i.y*t*.5*this.mapView.pixelRatio,a=new r.Vector2(n,s);this.mapView.textElementsRenderer.pickTextElements(a,o)}s.setFromCamera(i,this.mapView.camera);const a=s.intersectObjects(this.mapView.worldRootObject.children,!0);for(const e of a){const t={type:l.Unspecified,point:e.point,distance:e.distance,intersection:e};if(void 0!==e.object.userData){const i=void 0!==e.object.userData?e.object.userData.feature:void 0;if(void 0===i){o.push(t);continue}if(this.addObjInfo(i,e,t),void 0!==i.ids){const e=1===i.ids.length?i.ids[0]:void 0;t.featureId=e}let r;switch(i.geometryType){case n.GeometryType.Point:case n.GeometryType.Text:r=l.Point;break;case n.GeometryType.Line:case n.GeometryType.ExtrudedLine:case n.GeometryType.SolidLine:case n.GeometryType.TextPath:r=l.Line;break;case n.GeometryType.Polygon:case n.GeometryType.ExtrudedPolygon:r=l.Area;break;case n.GeometryType.Object3D:r=l.Object3D;break;default:r=l.Unspecified}t.type=r,o.push(t)}}if(this.enableRoadPicking){const e=new r.Vector3;s.ray.intersectPlane(this.m_plane,e),e.add(this.mapView.worldCenter);const t=this.mapView.worldCenter.clone().add(this.mapView.camera.position);this.mapView.forEachVisibleTile(i=>{this.m_roadPicker.intersectRoads(i,t,e,o)})}return o.sort((e,t)=>e.distance-t.distance),o}addObjInfo(e,t,i){if(i.intersection.object instanceof s.MapViewPoints)i.userData=e.objInfos[t.index];else if(void 0!==e.objInfos&&void 0!==e.starts&&void 0!==t.faceIndex)if(e.starts.length>1){let n=0;for(const i of e.starts){if(i>t.faceIndex)break;n++}i.userData=e.objInfos[n-1]}else i.userData=e.objInfos[0]}}},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(166)),n(i(88)),n(i(167))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(11),s=i(106),o=i(0),a=i(107),l=i(108);function c(e,t){return e*t.far}var h,d;!function(e){e.DEFAULT_FADE_NEAR=-1,e.DEFAULT_FADE_FAR=-1,e.patchGlobalShaderChunks=function(){void 0===o.ShaderChunk.fading_pars_vertex&&Object.assign(o.ShaderChunk,l.default)},e.updateDistanceFadeFeature=function(e){e.needsUpdate=!0,void 0===e.defines&&(e.defines={}),void 0!==e.fadeFar&&e.fadeFar>0&&(e.defines.FADING_MATERIAL="")},e.onBeforeCompile=function(e,t){if(void 0===e.fadeFar||e.fadeFar<=0)return;const i=t.uniforms;i.fadeNear={value:e.fadeNear},i.fadeFar={value:e.fadeFar},t.vertexShader=s.insertShaderInclude(t.vertexShader,"fog_pars_vertex","fading_pars_vertex"),t.vertexShader=s.insertShaderInclude(t.vertexShader,"fog_vertex","fading_vertex",!0),t.fragmentShader=s.insertShaderInclude(t.fragmentShader,"fog_pars_fragment","fading_pars_fragment"),t.fragmentShader=s.insertShaderInclude(t.fragmentShader,"fog_fragment","fading_fragment",!0)},e.addRenderHelper=function(t,i,r,s,o,a){t.onBeforeRender=n.chainCallbacks(t.onBeforeRender,(t,n,l,h,d,u)=>{s&&(d.transparent=!0);const m=d;if(m.fadeNear=void 0===i?e.DEFAULT_FADE_NEAR:c(i,l),m.fadeFar=void 0===r?e.DEFAULT_FADE_FAR:c(r,l),o){const e=t.properties.get(d);void 0!==e.shader&&void 0!==e.shader.uniforms.fadeNear&&(e.shader.uniforms.fadeNear.value=m.fadeNear,e.shader.uniforms.fadeFar.value=m.fadeFar,m.uniformsNeedUpdate=!0)}void 0!==a&&a(t,d)}),s&&(t.onAfterRender=(e,t,i,n,r)=>{r.transparent=!1})}}(h=t.FadingFeature||(t.FadingFeature={}));class u{constructor(){this.m_fadeNear=h.DEFAULT_FADE_NEAR,this.m_fadeFar=h.DEFAULT_FADE_FAR}getFadeNear(){return this.m_fadeNear}setFadeNear(e){this.needsUpdate=this.needsUpdate||e!==this.m_fadeNear,this.m_fadeNear=e,this.needsUpdate&&h.updateDistanceFadeFeature(this)}getFadeFar(){return this.m_fadeFar}setFadeFar(e){this.needsUpdate=this.needsUpdate||e!==this.m_fadeFar,this.m_fadeFar=e,this.needsUpdate&&h.updateDistanceFadeFeature(this)}addFadingProperties(){Object.defineProperty(this,"fadeNear",{get:()=>this.getFadeNear(),set:e=>{this.setFadeNear(e)}}),Object.defineProperty(this,"fadeFar",{get:()=>this.getFadeFar(),set:e=>{this.setFadeFar(e)}})}applyFadingParameters(e){void 0!==e&&(void 0!==e.fadeNear&&this.setFadeNear(e.fadeNear),void 0!==e.fadeFar&&this.setFadeFar(e.fadeFar)),this.onBeforeCompile=e=>{h.onBeforeCompile(this,e)}}copyFadingParameters(e){return this.setFadeNear(void 0===e.fadeNear?h.DEFAULT_FADE_NEAR:e.fadeNear),this.setFadeFar(void 0===e.fadeFar?h.DEFAULT_FADE_FAR:e.fadeFar),this}}t.FadingFeatureMixin=u,function(e){e.patchGlobalShaderChunks=function(){void 0===o.ShaderChunk.extrusion_pars_vertex&&Object.assign(o.ShaderChunk,a.default)},e.updateExtrusionFeature=function(e){e.needsUpdate=!0,void 0===e.defines&&(e.defines={}),void 0!==e.extrusionRatio&&e.extrusionRatio>=r.AnimatedExtrusionTileHandler.DEFAULT_RATIO_MAX&&(e.defines.EXTRUSION_MATERIAL="")},e.onBeforeCompile=function(e,t){if(void 0===e.extrusionRatio)return;t.uniforms.extrusionRatio={value:e.extrusionRatio},t.vertexShader=s.insertShaderInclude(t.vertexShader,"common","extrusion_pars_vertex"),t.vertexShader=s.insertShaderInclude(t.vertexShader,"begin_vertex","extrusion_vertex",!0),t.fragmentShader=s.insertShaderInclude(t.fragmentShader,"fog_pars_fragment","extrusion_pars_fragment"),t.fragmentShader=s.insertShaderInclude(t.fragmentShader,"fog_fragment","extrusion_fragment",!0)},e.addRenderHelper=function(t){t.onBeforeRender=n.chainCallbacks(t.onBeforeRender,e.onBeforeRender)},e.onBeforeRender=function(e,t,i,n,s,o){const a=s,l=e.properties.get(s);void 0!==l.shader&&void 0!==l.shader.uniforms.extrusionRatio&&(l.shader.uniforms.extrusionRatio.value=a.extrusionRatio||r.AnimatedExtrusionTileHandler.DEFAULT_RATIO_MAX,a.uniformsNeedUpdate=!0)}}(d=t.ExtrusionFeature||(t.ExtrusionFeature={}));class m{constructor(){this.m_extrusion=r.AnimatedExtrusionTileHandler.DEFAULT_RATIO_MAX}getExtrusionRatio(){return this.m_extrusion}setExtrusionRatio(e){this.needsUpdate=this.needsUpdate||e!==this.m_extrusion,this.m_extrusion=e,this.needsUpdate&&d.updateExtrusionFeature(this)}addExtrusionProperties(){Object.defineProperty(this,"extrusionRatio",{get:()=>this.getExtrusionRatio(),set:e=>{this.setExtrusionRatio(e)}})}applyExtrusionParameters(e){void 0!==e&&void 0!==e.extrusionRatio&&this.setExtrusionRatio(e.extrusionRatio),this.onBeforeCompile=e=>{d.onBeforeCompile(this,e)}}copyExtrusionParameters(e){return this.setExtrusionRatio(void 0===e.extrusionRatio?r.AnimatedExtrusionTileHandler.DEFAULT_RATIO_MAX:e.extrusionRatio),this}}t.ExtrusionFeatureMixin=m;class p extends o.MeshBasicMaterial{constructor(e){super(e),h.patchGlobalShaderChunks(),this.addFadingProperties(),this.applyFadingParameters(e),d.patchGlobalShaderChunks(),this.addExtrusionProperties(),this.applyExtrusionParameters(e)}clone(){return(new p).copy(this)}copy(e){return super.copy(e),this.copyFadingParameters(e),this.copyExtrusionParameters(e),this}get fadeNear(){return h.DEFAULT_FADE_NEAR}set fadeNear(e){}get fadeFar(){return h.DEFAULT_FADE_FAR}set fadeFar(e){}get extrusionRatio(){return r.AnimatedExtrusionTileHandler.DEFAULT_RATIO_MAX}set extrusionRatio(e){}addFadingProperties(){}applyFadingParameters(e){}copyFadingParameters(e){}addExtrusionProperties(){}applyExtrusionParameters(e){}copyExtrusionParameters(e){}}t.MapMeshBasicMaterial=p;class f extends o.MeshStandardMaterial{constructor(e){super(e),h.patchGlobalShaderChunks(),this.addFadingProperties(),this.applyFadingParameters(e),d.patchGlobalShaderChunks(),this.addExtrusionProperties(),this.applyExtrusionParameters(e)}clone(){return(new f).copy(this)}copy(e){return super.copy(e),this.copyFadingParameters(e),this.copyExtrusionParameters(e),this}get fadeNear(){return h.DEFAULT_FADE_NEAR}set fadeNear(e){}get fadeFar(){return h.DEFAULT_FADE_FAR}set fadeFar(e){}get extrusionRatio(){return r.AnimatedExtrusionTileHandler.DEFAULT_RATIO_MAX}set extrusionRatio(e){}addFadingProperties(){}applyFadingParameters(e){}copyFadingParameters(e){}addExtrusionProperties(){}applyExtrusionParameters(e){}copyExtrusionParameters(e){}}t.MapMeshStandardMaterial=f,n.applyMixinsWithoutProperties(p,[u]),n.applyMixinsWithoutProperties(f,[u]),n.applyMixinsWithoutProperties(p,[m]),n.applyMixinsWithoutProperties(f,[m])},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Trace=0]="Trace",e[e.Debug=1]="Debug",e[e.Log=2]="Log",e[e.Info=3]="Info",e[e.Warn=4]="Warn",e[e.Error=5]="Error"}(t.LogLevel||(t.LogLevel={}));t.LoggerOptions=class{}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={extrude_line_vert_func:"\nvoid extrudeLine(vec2 segment, vec4 bt, vec3 t, float lineWidth, inout vec3 pos, inout vec2 uv) {\n    float uu = uv.x / 2.0 + 0.5;\n    float ss = mix(segment.x, segment.y, uu);\n\n    float angle = bt.w;\n    vec3 dir = bt.xyz;\n    if (angle != 0.0) {\n        pos += uv.y * lineWidth * dir / cos(angle / 2.0);\n        uv.x = ss + uv.x * lineWidth * uv.y * tan(angle / 2.0);\n    }\n    else {\n        pos += uv.y * lineWidth * dir + uv.x * lineWidth * t;\n        uv.x = ss + uv.x * lineWidth;\n    }\n}\n",join_dist_func:"\nfloat joinDist(vec2 segment, vec2 texcoord) {\n    float d = abs(texcoord.y);\n    float dx = texcoord.x;\n    if (dx < segment.x) {\n        d = max(d, length(texcoord - vec2(segment.x, 0.0)));\n    } else if (dx > segment.y) {\n        d = max(d, length(texcoord - vec2(segment.y, 0.0)));\n    }\n    return d;\n}\n",tile_clip_func:"\nvoid tileClip(vec2 tilePos, vec2 tileSize) {\n    if (tileSize.x > 0.0 && (tilePos.x < -tileSize.x / 2.0 || tilePos.x > tileSize.x / 2.0))\n        discard;\n    if (tileSize.y > 0.0 && (tilePos.y < -tileSize.y / 2.0 || tilePos.y > tileSize.y / 2.0))\n        discard;\n}\n",high_precision_vert_func:"\nvec3 subtractDblEyePos( const in vec3 pos ) {\n    vec3 t1 = positionLow - u_eyepos_lowpart;\n    vec3 e = t1 - positionLow;\n    vec3 t2 = ((-u_eyepos_lowpart - e) + (positionLow - (t1 - e))) + pos - u_eyepos;\n    vec3 high_delta = t1 + t2;\n    vec3 low_delta = t2 - (high_delta - t1);\n    return (high_delta + low_delta);\n}\n"}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(2),r=i(1),s=i(0),o=i(11),a=i(55),l=i(69),c=i(71),h=i(40),d=i(74),u=i(76),m=i(24),p=i(77),f=i(78),g=i(145),_=i(149),v=i(150),y=i(37),x=i(23),w=i(19),b=i(64),T=i(79),S=i(16),C=i(80);var E;!function(e){e.Update="update",e.Render="render",e.AfterRender="didrender",e.FirstFrame="first-render",e.FrameComplete="frame-complete",e.ThemeLoaded="theme-loaded",e.AnimationStarted="animation-started",e.AnimationFinished="animation-finished",e.MovementStarted="movement-started",e.MovementFinished="movement-finished",e.DataSourceConnect="datasource-connect",e.CopyrightChanged="copyright-changed",e.ContextLost="webglcontext-lost",e.ContextRestored="webglcontext-restored"}(E=t.MapViewEventNames||(t.MapViewEventNames={}));const M=r.LoggerManager.instance.create("MapView"),A=new s.Vector3(0,0,-1),P={type:"dynamic",fov:40},L={type:E.Render},R={type:E.AfterRender},I={type:E.FirstFrame},O={type:E.FrameComplete},F={type:E.ThemeLoaded},D={type:E.AnimationStarted},V={type:E.AnimationFinished},U={type:E.MovementStarted},k={type:E.MovementFinished},z={type:E.ContextLost},B={type:E.ContextRestored},N={type:E.CopyrightChanged},j=new s.Vector2;t.MapViewDefaults={projection:n.mercatorProjection,maxVisibleDataSourceTiles:20,extendedFrustumCulling:!0,tileCacheSize:40,resourceComputationType:C.ResourceComputationType.EstimationInMb,quadTreeSearchDistanceUp:3,quadTreeSearchDistanceDown:2,pixelRatio:"undefined"!=typeof window&&void 0!==window.devicePixelRatio?window.devicePixelRatio:1};class G extends s.EventDispatcher{constructor(e){super(),this.defaultFontCatalog="./resources/fonts/Default_FontCatalog.json",this.m_screenProjector=new _.ScreenProjector,this.m_screenCollisions=new g.ScreenCollisions,this.m_visibleTileSetLock=!1,this.m_zoomLevel=1,this.m_minZoomLevel=1,this.m_maxZoomLevel=20,this.m_minCameraHeight=20,this.m_screenCamera=new s.OrthographicCamera(-1,1,1,-1),this.m_tempVector3=new s.Vector3,this.m_scene=new s.Scene,this.m_fog=new u.MapViewFog(this.m_scene),this.m_worldCenter=new s.Vector3,this.m_mapTilesRoot=new s.Object3D,this.m_animationCount=0,this.m_drawing=!1,this.m_updatePending=!1,this.m_frameNumber=0,this.m_maxFps=0,this.m_detectedFps=30,this.m_textRenderStyleCache=new w.TextRenderStyleCache,this.m_textLayoutStyleCache=new w.TextLayoutStyleCache,this.m_overlayTextElements=[],this.m_forceCameraAspect=void 0,this.m_tileDataSources=[],this.m_connectedDataSources=new Set,this.m_raycaster=new s.Raycaster,this.m_plane=new s.Plane(new s.Vector3(0,0,1)),this.m_theme={styles:{}},this.m_firstFrameRendered=!1,this.m_firstFrameComplete=!1,this.m_frameTimeIndex=0,this.m_frameTimeRing=[],this.m_imageCache=new d.MapViewImageCache(this),this.m_poiManager=new p.PoiManager(this),this.m_poiTableManager=new f.PoiTableManager(this),this.m_lastTileIds="",this.m_copyrightInfo=[],this.onWebGLContextLost=e=>{this.dispatchEvent(z),M.log("WebGL context lost",e)},this.onWebGLContextRestored=e=>{this.dispatchEvent(B),void 0!==this.m_theme&&void 0!==this.m_theme.clearColor?this.m_renderer.setClearColor(new s.Color(this.m_theme.clearColor)):this.m_renderer.setClearColor(15722977),this.update(),M.log("WebGL context restored",e)},this.m_options=Object.assign({},e),void 0!==this.m_options.minZoomLevel&&(this.m_minZoomLevel=this.m_options.minZoomLevel),void 0!==this.m_options.maxZoomLevel&&(this.m_maxZoomLevel=this.m_options.maxZoomLevel),void 0!==this.m_options.minCameraHeight&&(this.m_minCameraHeight=this.m_options.minCameraHeight),void 0!==this.m_options.fontCatalog&&(this.defaultFontCatalog=this.m_options.fontCatalog),void 0!==this.m_options.decoderUrl&&(c.ConcurrentDecoderFacade.defaultScriptUrl=this.m_options.decoderUrl),void 0!==this.m_options.decoderCount&&(c.ConcurrentDecoderFacade.defaultWorkerCount=this.m_options.decoderCount),this.m_visibleTileSetOptions=Object.assign({},t.MapViewDefaults),void 0!==e.projection&&(this.m_visibleTileSetOptions.projection=e.projection),void 0!==e.extendedFrustumCulling&&(this.m_visibleTileSetOptions.extendedFrustumCulling=e.extendedFrustumCulling),void 0!==e.maxVisibleDataSourceTiles&&(this.m_visibleTileSetOptions.maxVisibleDataSourceTiles=e.maxVisibleDataSourceTiles),void 0!==e.tileCacheSize&&(this.m_visibleTileSetOptions.tileCacheSize=e.tileCacheSize),void 0!==e.resourceComputationType&&(this.m_visibleTileSetOptions.resourceComputationType=e.resourceComputationType),void 0!==e.quadTreeSearchDistanceUp&&(this.m_visibleTileSetOptions.quadTreeSearchDistanceUp=e.quadTreeSearchDistanceUp),void 0!==e.quadTreeSearchDistanceDown&&(this.m_visibleTileSetOptions.quadTreeSearchDistanceDown=e.quadTreeSearchDistanceDown),this.m_pixelRatio=e.pixelRatio,void 0!==e.maxFps&&(this.m_maxFps=Math.max(0,e.maxFps)),this.m_options.enableStatistics=!0===this.m_options.enableStatistics,this.m_languages=this.m_options.languages||S.MapViewUtils.getBrowserLanguages(),this.handleRequestAnimationFrame=this.renderFunc.bind(this),this.handlePostponedAnimationFrame=this.postponedAnimationFrame.bind(this),this.m_pickHandler=new m.PickHandler(this,!0===this.m_options.enableRoadPicking),this.setupStats(this.m_options.enableStatistics),this.m_renderer=new s.WebGLRenderer({canvas:this.canvas,antialias:!1!==this.m_options.enableNativeWebglAntialias,alpha:this.m_options.alpha,preserveDrawingBuffer:!0===this.m_options.preserveDrawingBuffer}),this.m_renderer.autoClear=!1,this.m_renderer.info.autoReset=!1,this.setupRenderer(),this.m_options.fovCalculation=void 0===this.m_options.fovCalculation?P:this.m_options.fovCalculation,this.m_options.fovCalculation.fov=n.MathUtils.clamp(this.m_options.fovCalculation.fov,10,140);const{width:i,height:r}=this.getCanvasClientSize(),h=i/r;this.m_camera=new s.PerspectiveCamera(this.m_options.fovCalculation.fov,h,.1,4e6),this.m_lookAtDistance=0,this.m_focalLength=0,this.setupCamera(),this.m_movementDetector=new a.CameraMovementDetector(this.m_options.movementThrottleTimeout,()=>this.movementStarted(),()=>this.movementFinished());const v=this.m_options.customAntialiasSettings;this.mapRenderingManager=new l.MapRenderingManager(i,r,this.m_options.dynamicPixelRatio,v),this.m_visibleTiles=new C.VisibleTileSet(this.m_camera,this.m_visibleTileSetOptions),this.m_animatedExtrusionHandler=new o.AnimatedExtrusionHandler(this),this.initTheme(),this.drawFrame(),this.canvas.addEventListener("webglcontextlost",this.onWebGLContextLost),this.canvas.addEventListener("webglcontextrestored",this.onWebGLContextRestored)}get textElementsRenderer(){return this.m_textElementsRenderer}get textRenderStyleCache(){return this.m_textRenderStyleCache}get textLayoutStyleCache(){return this.m_textLayoutStyleCache}get cameraMovementDetector(){return this.m_movementDetector}get animatedExtrusionHandler(){return this.m_animatedExtrusionHandler}dispose(){void 0!==this.m_animationFrameHandle&&(cancelAnimationFrame(this.m_animationFrameHandle),this.m_animationFrameHandle=void 0),this.canvas.removeEventListener("webglcontextlost",this.onWebGLContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onWebGLContextRestored);for(const e of this.m_tileDataSources)e.dispose();this.m_visibleTiles.clearTileCache(),this.m_renderer.dispose(),this.m_imageCache.clear(),this.m_movementDetector.dispose()}get resourceComputationType(){return this.m_visibleTiles.resourceComputationType}set resourceComputationType(e){this.m_visibleTiles.resourceComputationType=e}getCacheSize(){return this.m_visibleTiles.getDataSourceCacheSize()}setCacheSize(e,t){this.m_visibleTiles.setDataSourceCacheSize(e),t=void 0!==t?t:e/2,this.m_visibleTiles.setNumberOfVisibleTiles(Math.floor(t)),this.updateImages(),this.updateLighting(),this.updateTextRenderer(),this.updateSkyBackground(),this.update()}get extendedFrustumCulling(){return void 0===this.m_options.extendedFrustumCulling||this.m_visibleTileSetOptions.extendedFrustumCulling}set extendedFrustumCulling(e){this.m_visibleTileSetOptions.extendedFrustumCulling=e}get lockVisibleTileSet(){return this.m_visibleTileSetLock}set lockVisibleTileSet(e){this.m_visibleTileSetLock=e}get pointOfView(){return this.m_pointOfView}set pointOfView(e){this.m_pointOfView=e,this.update()}get theme(){return this.m_theme}set theme(e){if(this.m_theme.fog=e.fog,this.m_theme.sky=e.sky,this.updateSkyBackground(),this.m_fog.reset(this.m_theme),this.m_theme.lights=e.lights,this.updateLighting(),this.m_theme.clearColor=e.clearColor,this.renderer.setClearColor(new s.Color(e.clearColor)),this.m_theme.images=e.images,this.m_theme.imageTextures=e.imageTextures,this.updateImages(),this.m_theme.poiTables=e.poiTables,this.loadPoiTables(),this.m_theme.textStyles=e.textStyles,this.m_theme.defaultTextStyle=e.defaultTextStyle,this.m_theme.fontCatalogs=e.fontCatalogs,this.m_textRenderStyleCache.clear(),this.m_textLayoutStyleCache.clear(),this.updateTextRenderer(),void 0===this.m_theme.styles&&(this.m_theme.styles={}),void 0!==e.styles)for(const t in e.styles)if(void 0!==e.styles[t]){const i=e.styles[t];this.getDataSourcesByStyleSetName(t).forEach(e=>e.setStyleSet(i)),this.m_theme.styles[t]=i}this.update()}get forceCameraAspect(){return this.m_forceCameraAspect}set forceCameraAspect(e){this.m_forceCameraAspect=e}set maxFps(e){this.m_maxFps=Math.max(0,e)}get maxFps(){return Math.max(0,this.m_maxFps)}get languages(){return this.m_languages}set languages(e){this.m_languages=e,this.m_tileDataSources.forEach(e=>{e.setLanguages(this.m_languages)}),this.update()}get copyrightInfo(){return this.m_copyrightInfo}get fadingDisabled(){return!0===this.m_options.disableFading}get frameNumber(){return this.m_frameNumber}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}get canvas(){return this.m_options.canvas}get collisionDebugCanvas(){return this.m_collisionDebugCanvas}get scene(){return this.m_scene}get camera(){return this.m_camera}get renderer(){return this.m_renderer}get clearColor(){const e=this.m_renderer.getClearColor();return void 0!==e?e.getHex():0}set clearColor(e){this.m_renderer.setClearColor(e)}get projection(){return this.m_visibleTileSetOptions.projection}get focalLength(){return this.m_focalLength}get geoCenter(){return this.projection.unprojectPoint(this.m_worldCenter)}set geoCenter(e){this.projection.projectPoint(e,this.m_worldCenter),this.update()}get worldCenter(){return this.m_worldCenter}set worldCenter(e){this.m_worldCenter.copy(e),this.update()}get worldRootObject(){return this.m_mapTilesRoot}get pickHandler(){return this.m_pickHandler}get imageCache(){return this.m_imageCache}get poiManager(){return this.m_poiManager}get poiTableManager(){return this.m_poiTableManager}get minCameraHeight(){return this.m_minCameraHeight}get minZoomLevel(){return this.m_minZoomLevel}set minZoomLevel(e){this.m_minZoomLevel=e,this.update()}get maxZoomLevel(){return this.m_maxZoomLevel}set maxZoomLevel(e){this.m_maxZoomLevel=e,this.update()}get zoomLevel(){return this.m_zoomLevel}get storageLevel(){return s.Math.clamp(Math.floor(this.m_zoomLevel),this.m_minZoomLevel,this.m_maxZoomLevel)}get viewportHeight(){return this.canvas.height}get nativeWebglAntialiasEnabled(){return!1!==this.m_options.enableNativeWebglAntialias}get dataSources(){return this.m_tileDataSources}setFovCalculation(e){this.m_options.fovCalculation=e,this.calculateFocalLength(this.m_renderer.getSize(j).height),this.updateCameras()}getDataSourceByName(e){return this.m_tileDataSources.find(t=>t.name===e)}getDataSourcesByStyleSetName(e){return this.m_tileDataSources.filter(t=>t.styleSetName===e)}addDataSource(e){if(void 0!==this.getDataSourceByName(e.name))throw new Error(`A DataSource with the name "${e.name}" already exists in this MapView.`);return e.attach(this),this.m_tileDataSources.push(e),e.connect().then(()=>new Promise(e=>{if(void 0!==this.theme)return void e();const t=()=>{this.removeEventListener(E.ThemeLoaded,t),e()};this.addEventListener(E.ThemeLoaded,t)})).then(()=>{if(!(-1===this.m_tileDataSources.indexOf(e))){if(e.addEventListener(E.Update,()=>{this.update()}),void 0!==this.m_theme.styles&&void 0!==e.styleSetName){const t=this.m_theme.styles[e.styleSetName];e.setStyleSet(t,this.m_languages)}this.m_connectedDataSources.add(e.name),this.dispatchEvent({type:E.DataSourceConnect,dataSourceName:e.name}),this.update()}}).catch(t=>{this.dispatchEvent({type:E.DataSourceConnect,dataSourceName:e.name,error:t})})}removeDataSource(e){const t=this.m_tileDataSources.indexOf(e);-1!==t&&(e.detach(this),this.m_visibleTiles.removeDataSource(e.name),this.m_tileDataSources.splice(t,1),this.m_connectedDataSources.delete(e.name),this.update())}get visibleTileSet(){return this.m_visibleTiles}addOverlayText(e){void 0!==this.m_overlayTextElements&&(this.m_overlayTextElements=this.m_overlayTextElements.concat(e)),this.updateTextRenderer(),this.update()}clearOverlayText(){this.m_overlayTextElements=[]}setCameraGeolocationAndZoom(e,t,i,n){void 0!==i&&void 0!==n&&S.MapViewUtils.setRotation(this,i,n),this.geoCenter=e,this.camera.position.set(0,0,0),S.MapViewUtils.zoomOnTargetPosition(this,0,0,t),this.update()}get animating(){return this.m_animationCount>0}beginAnimation(){0==this.m_animationCount++&&(this.m_updatePending||(this.m_updatePending=!0,this.drawFrame()),D.time=Date.now(),this.dispatchEvent(D))}endAnimation(){this.m_animationCount>0&&--this.m_animationCount,0===this.m_animationCount&&(V.time=Date.now(),this.dispatchEvent(V))}get cameraIsMoving(){return this.m_movementDetector.cameraIsMoving}get pixelToWorld(){if(void 0===this.m_pixelToWorld){r.assert(void 0!==this.m_options.fovCalculation);const e=this.m_lookAtDistance;this.m_pixelToWorld=S.MapViewUtils.calculateWorldSizeByFocalLength(this.m_focalLength,e,1)}return this.m_pixelToWorld}get worldToPixel(){return 1/this.pixelToWorld}get pixelRatio(){return void 0!==this.m_pixelRatio?this.m_pixelRatio:"undefined"!=typeof window&&void 0!==window.devicePixelRatio?window.devicePixelRatio:1}set pixelRatio(e){this.m_pixelRatio=e,this.renderer.getPixelRatio()!==this.pixelRatio&&this.renderer.setPixelRatio(this.pixelRatio)}set dynamicPixelRatio(e){this.mapRenderingManager.lowResPixelRatio=e}get dynamicPixelRatio(){return this.mapRenderingManager.lowResPixelRatio}getScreenPosition(e){const t=new s.Vector3;this.projection.projectPoint(e,t);const i=this.m_screenProjector.project(t);if(void 0!==i){const{width:e,height:t}=this.canvas;i.x=(i.x+e/2)/this.pixelRatio,i.y=(t-(i.y+t/2))/this.pixelRatio}return i}getWorldPositionAt(e,t){this.m_raycaster.setFromCamera(this.getNormalizedScreenCoordinates(e,t),this.m_camera);const i=new s.Vector3,n=this.m_raycaster.ray.intersectPlane(this.m_plane,i);return n?(n.add(this.m_worldCenter),n):null}getGeoCoordinatesAt(e,t){const i=this.getWorldPositionAt(e,t);return i?this.projection.unprojectPoint(i):null}getNormalizedScreenCoordinates(e,t){const{width:i,height:n}=this.getCanvasClientSize();return new s.Vector3(e/i*2-1,-t/n*2+1,0)}intersectMapObjects(e,t){return this.m_pickHandler.intersectMapObjects(e,t)}resize(e,t){this.m_renderer.setSize(e,t,!1),this.m_renderer.getPixelRatio()!==this.pixelRatio&&this.m_renderer.setPixelRatio(this.pixelRatio),void 0!==this.mapRenderingManager&&this.mapRenderingManager.setSize(e,t),void 0!==this.collisionDebugCanvas&&(this.collisionDebugCanvas.width=e,this.collisionDebugCanvas.height=t),this.updateCameras(),this.update()}update(){this.m_updatePending||(this.m_updatePending=!0,this.animating||this.drawFrame())}get updatePending(){return this.m_updatePending}requestUpdateIfNeeded(){this.update()}clearTileCache(e){this.m_visibleTiles.clearTileCache(e)}forEachVisibleTile(e){this.m_visibleTiles.forEachVisibleTile(e)}forEachCachedTile(e){this.m_visibleTiles.forEachCachedTile(e)}markTilesDirty(e){this.m_visibleTiles.markTilesDirty(e)}get fog(){return this.m_fog}updateCameras(){const{width:e,height:t}=this.m_renderer.getSize(j);this.m_camera.aspect=void 0!==this.m_forceCameraAspect?this.m_forceCameraAspect:e/t,this.setFovOnCamera(this.m_options.fovCalculation,t);let i=Math.max(.1,.1*this.m_camera.position.z),n=50*i+200;if(void 0!==this.m_options.farPlaneEvaluator){this.camera.getWorldDirection(this.m_tempVector3);const e=s.Math.radToDeg(this.m_tempVector3.angleTo(A)),t=this.m_options.farPlaneEvaluator(this,e,i,n);i=Math.max(.1,t.near),n=Math.max(i+200,t.far)}this.m_camera.near=i,this.m_camera.far=n,this.m_camera.updateProjectionMatrix(),this.m_camera.updateMatrixWorld(!1),this.m_screenCamera.left=e/-2,this.m_screenCamera.right=e/2,this.m_screenCamera.bottom=t/-2,this.m_screenCamera.top=t/2,this.m_screenCamera.updateProjectionMatrix(),this.m_screenCamera.updateMatrixWorld(!1),this.m_screenProjector.update(this.m_camera,this.m_worldCenter,e,t),this.m_screenCollisions.update(e,t),this.m_pixelToWorld=void 0;const r=S.MapViewUtils.extractYawPitchRoll(this.camera.quaternion).pitch,o=Math.abs(this.camera.position.z);this.m_lookAtDistance=o/Math.cos(r);const a=o/Math.cos(Math.min(r,Math.PI/3));this.m_zoomLevel=S.MapViewUtils.calculateZoomLevelFromDistance(a,this)}detectCurrentFps(e){if(void 0!==this.m_previousRequestAnimationTime&&this.m_frameNumber>5){const t=1e3/(e-this.m_previousRequestAnimationTime);this.m_frameTimeRing[this.m_frameTimeIndex%12]=t,this.m_frameTimeIndex++;const i=Math.min(this.m_frameTimeIndex,12);let n=0;for(let e=0;e<i;e++)n+=this.m_frameTimeRing[e];this.m_detectedFps=n/i}this.m_previousRequestAnimationTime=e}drawFrame(){if(this.m_drawing)return;if(void 0!==this.m_animationFrameHandle&&(cancelAnimationFrame(this.m_animationFrameHandle),this.m_animationFrameHandle=void 0),this.m_maxFps<=0)return void(this.m_animationFrameHandle=requestAnimationFrame(this.handleRequestAnimationFrame));const e=1e3/this.m_detectedFps,t=1e3/this.m_maxFps,i=void 0===this.m_previousFrameTimeStamp?0:this.m_previousFrameTimeStamp,n=i+t-e-3;this.m_targetRequestAnimationTime=n,this.postponedAnimationFrame(i)}postponedAnimationFrame(e){void 0!==this.m_targetRequestAnimationTime&&(void 0!==this.m_animationFrameHandle&&(cancelAnimationFrame(this.m_animationFrameHandle),this.m_animationFrameHandle=void 0),this.detectCurrentFps(e),this.m_animationFrameHandle=requestAnimationFrame(e>this.m_targetRequestAnimationTime?this.handleRequestAnimationFrame:this.handlePostponedAnimationFrame))}renderFunc(e){this.render(e)}getEnabledTileDataSources(){const e=[];for(const t of this.m_tileDataSources)t.enabled&&t.ready()&&this.m_connectedDataSources.has(t.name)&&e.push(t);return e}render(e){if(this.m_drawing)return;++this.m_frameNumber;const t=y.PerformanceStatistics.instance,i=t.enabled,n=e;let s,o,a,l,c,h,d;if(L.time=e,this.dispatchEvent(L),i&&(s=t.currentFrame,s.setValue("renderCount.frameNumber",this.m_frameNumber),void 0!==this.m_previousFrameTimeStamp)){const e=n-this.m_previousFrameTimeStamp;i&&(s.setValue("render.fullFrameTime",e),s.setValue("render.fps",1e3/e))}for(this.m_previousFrameTimeStamp=n,this.m_renderer.info.reset(),this.m_updatePending=!1,this.m_thisFrameTilesChanged=void 0,this.m_drawing=!0,this.m_renderer.getPixelRatio()!==this.pixelRatio&&this.m_renderer.setPixelRatio(this.pixelRatio),this.updateCameras(),this.m_fog.update(this.m_camera),this.m_renderer.clear();this.m_mapTilesRoot.children.length>0;)this.m_mapTilesRoot.remove(this.m_mapTilesRoot.children[0]);i&&(o=r.PerformanceTimer.now()),this.lockVisibleTileSet||this.m_visibleTiles.updateRenderList(this.m_worldCenter,this.storageLevel,Math.floor(this.zoomLevel),this.getEnabledTileDataSources()),i&&(a=r.PerformanceTimer.now());const u=this.m_visibleTiles.dataSourceTileList;u.forEach(({zoomLevel:e,renderedTiles:t})=>{t.forEach(t=>{this.renderTileObjects(t,e),t.frameNumLastVisible=this.m_frameNumber})}),this.m_animatedExtrusionHandler.zoom=this.m_zoomLevel,void 0!==s&&(s.addValue("renderCount.numTilesRendered",0),s.addValue("renderCount.numTilesVisible",0),s.addValue("renderCount.numTilesLoading",0),u.forEach(({zoomLevel:e,renderedTiles:t,visibleTiles:i,numTilesLoading:n})=>{s.addValue("renderCount.numTilesRendered",t.length),s.addValue("renderCount.numTilesVisible",i.length),s.addValue("renderCount.numTilesLoading",n)})),this.m_movementDetector.checkCameraMoved(this,e);const m=void 0!==this.m_pointOfView?this.m_pointOfView:this.m_camera;this.prepareRenderTextElements(e),i&&(l=r.PerformanceTimer.now()),void 0!==this.m_skyBackground&&this.m_skyBackground.update(this.m_camera);const p=this.cameraIsMoving||this.animating||this.m_updatePending;this.mapRenderingManager.render(this.m_renderer,this.m_scene,m,!p),i&&(c=r.PerformanceTimer.now()),this.finishRenderTextElements(),i&&(h=r.PerformanceTimer.now()),this.m_firstFrameRendered||(this.m_firstFrameRendered=!0,i&&t.appResults.set("firstFrame",e),I.time=e,this.dispatchEvent(I)),this.m_firstFrameComplete||!this.m_visibleTiles.allVisibleTilesLoaded||this.m_connectedDataSources.size!==this.m_tileDataSources.length||this.m_updatePending||this.animating||void 0===this.m_textElementsRenderer||this.m_textElementsRenderer.loading||(this.m_firstFrameComplete=!0,i&&t.appResults.set("firstFrameComplete",e),O.time=e,this.dispatchEvent(O)),this.m_visibleTiles.disposePendingTiles(),this.m_drawing=!1,(this.animating||this.m_updatePending)&&this.drawFrame(),this.checkCopyrightUpdates(),void 0!==s&&(d=r.PerformanceTimer.now(),s.setValue("render.setupTime",o-n),s.setValue("render.cullTime",a-o),s.setValue("render.textPlacementTime",l-a),s.setValue("render.drawTime",c-l),s.setValue("render.textDrawTime",h-c),s.setValue("render.cleanupTime",d-h),s.setValue("render.frameRenderTime",d-n),y.PerformanceStatistics.instance.storeFrameInfo(this.m_renderer.info)),R.time=e,this.dispatchEvent(R)}renderTileObjects(e,t){const i=this.projection.worldExtent(0,0).max.x*e.offset;if(e.willRender(t))for(const t of e.objects)t.position.copy(e.center),void 0!==t.displacement&&t.position.add(t.displacement),t.position.x+=i,t.position.sub(this.m_worldCenter),this.m_mapTilesRoot.add(t);e.didRender()}prepareRenderTextElements(e){const t=void 0!==this.m_pointOfView;if(void 0===this.m_textElementsRenderer||!this.m_textElementsRenderer.ready||t)return;let i;(this.checkIfTextElementsChanged()||this.checkIfTilesChanged())&&this.m_textElementsRenderer.placeAllTileLabels(),this.camera.getWorldDirection(this.m_tempVector3);const n=s.Math.radToDeg(this.m_tempVector3.angleTo(A));if(void 0!==this.m_options.labelVisibilityEvaluator)i=this.m_options.labelVisibilityEvaluator(this,n);else{i=n<(void 0===this.m_options.maxLabelAngle?90:this.m_options.maxLabelAngle)}this.m_textElementsRenderer.reset(),i&&(this.m_textElementsRenderer.renderUserTextElements(e,this.m_frameNumber),this.m_textElementsRenderer.renderAllTileText(e,this.m_frameNumber)),this.m_textElementsRenderer.renderOverlay(this.m_overlayTextElements),this.m_textElementsRenderer.update()}finishRenderTextElements(){void 0===this.m_pointOfView&&this.m_textElementsRenderer&&(this.m_screenCamera.far=this.camera.far,this.m_textElementsRenderer.renderText(this.m_screenCamera))}initTheme(){if(void 0===this.m_options.theme)return;("string"==typeof this.m_options.theme?T.ThemeLoader.loadAsync(this.m_options.theme):Promise.resolve(this.m_options.theme)).then(e=>{F.time=Date.now(),this.dispatchEvent(F),this.theme=e})}setupCamera(){const{width:e,height:t}=this.getCanvasClientSize();this.m_scene.add(this.m_camera),this.m_camera.position.set(0,0,3e3),this.m_camera.lookAt(new s.Vector3(0,0,0)),this.m_lookAtDistance=3e3,this.calculateFocalLength(t),this.m_visibleTiles=new C.VisibleTileSet(this.m_camera,this.m_visibleTileSetOptions),this.resize(e,t),this.geoCenter=new n.GeoCoordinates(52.518611,13.376111,0),this.m_screenCamera.position.z=1,this.m_screenCamera.near=0}updateSkyBackground(){if(void 0===this.m_theme)return;const e=this.m_theme;if(this.m_skyBackground instanceof v.SkyBackground&&void 0!==e.sky)this.updateSkyBackgroundColors(e.sky,e.clearColor);else{if(void 0===this.m_skyBackground&&void 0!==e.sky)return void this.addNewSkyBackground(e.sky,e.clearColor);this.m_skyBackground instanceof v.SkyBackground&&void 0===e.sky&&this.removeSkyBackGround()}}addNewSkyBackground(e,t){const i=void 0===e.groundColor?t:e.groundColor;this.m_skyBackground=new v.SkyBackground(new s.Color(e.colorTop),new s.Color(e.colorBottom),new s.Color(i),this.camera,e.monomialPower),this.m_scene.background=this.m_skyBackground.texture}removeSkyBackGround(){this.m_scene.background=null,void 0!==this.m_skyBackground&&(this.m_skyBackground.texture.dispose(),this.m_skyBackground=void 0)}updateSkyBackgroundColors(e,t){const i=void 0===e.groundColor?t:e.groundColor;void 0!==this.m_skyBackground&&this.m_skyBackground.updateColors(new s.Color(e.colorTop),new s.Color(e.colorBottom),new s.Color(i))}updateLighting(){if(!this.m_theme)return;const e=this.m_theme;void 0!==e.clearColor&&this.m_renderer.setClearColor(new s.Color(e.clearColor)),this.m_createdLights&&this.m_createdLights.forEach(e=>{this.m_scene.remove(e)}),void 0!==e.lights&&(this.m_createdLights=[],e.lights.forEach(e=>{const t=b.createLight(e);t?(this.m_scene.add(t),this.m_createdLights.push(t)):M.log(`MapView: failed to create light ${e.name} of type ${e.type}`)}))}movementStarted(){void 0!==this.m_textElementsRenderer&&this.m_textElementsRenderer.movementStarted(),U.time=Date.now(),this.dispatchEvent(U)}movementFinished(){void 0!==this.m_textElementsRenderer&&this.m_textElementsRenderer.movementFinished(),k.time=Date.now(),this.dispatchEvent(k),this.animating||setTimeout(()=>this.update(),0)}checkIfTextElementsChanged(){const e=this.m_visibleTiles.dataSourceTileList;let t=!1;return e.forEach(({renderedTiles:e})=>{e.forEach(e=>{e.textElementsChanged&&(e.textElementsChanged=!1,t=!0)})}),t}checkIfTilesChanged(){if(void 0!==this.m_thisFrameTilesChanged)return this.m_thisFrameTilesChanged;const e=this.m_visibleTiles.dataSourceTileList,t=[];t.length=0,e.forEach(({dataSource:e,renderedTiles:i})=>{i.forEach(i=>{t.push(e.name+"-"+i.tileKey.mortonCode())})}),t.sort();const i=t.join("#");return i!==this.m_lastTileIds?(this.m_lastTileIds=i,this.m_thisFrameTilesChanged=!0):this.m_thisFrameTilesChanged=!1,this.m_thisFrameTilesChanged}checkCopyrightUpdates(){if(!this.checkIfTilesChanged())return;const e=this.getRenderedTilesCopyrightInfo();if(e!==this.m_copyrightInfo){if(e.length===this.m_copyrightInfo.length){let t=!0;for(let i=0;i<e.length;i++){const n=e[i],r=this.m_copyrightInfo[i];if(n.label!==r.label){t=!1;break}}if(t)return}this.m_copyrightInfo=e,this.dispatchEvent(N)}}getRenderedTilesCopyrightInfo(){let e=[];for(const t of this.m_visibleTiles.dataSourceTileList)for(const i of t.renderedTiles){const t=i.copyrightInfo;void 0!==t&&0!==t.length&&(e=h.CopyrightInfo.mergeArrays(e,t))}return e}updateImages(){if(!this.m_theme)return;const e=this.m_theme;if(this.m_imageCache.clear(),this.poiManager.clear(),void 0!==e.images)for(const t of Object.keys(e.images)){const i=e.images[t];this.m_imageCache.addImage(t,i.url,!0===i.preload),"string"==typeof i.atlas&&this.poiManager.addTextureAtlas(t,i.atlas)}void 0!==e.imageTextures&&e.imageTextures.forEach(e=>{this.poiManager.addImageTexture(e)})}loadPoiTables(){void 0!==this.m_theme&&(this.poiTableManager.clear(),this.poiTableManager.loadPoiTables(this.m_theme))}setupStats(e){new y.PerformanceStatistics(e,1e3)}setupRenderer(){this.m_renderer.setClearColor(15722977),this.m_scene.add(this.m_mapTilesRoot)}updateTextRenderer(){void 0!==this.m_theme.textStyles&&(void 0===this.m_textElementsRenderer&&(this.m_textElementsRenderer=new x.TextElementsRenderer(this,this.m_screenCollisions,this.m_screenProjector,this.m_options.minNumGlyphs,this.m_options.maxNumGlyphs,this.m_theme,this.m_options.maxNumVisibleLabels,this.m_options.numSecondChanceLabels,this.m_options.maxDistanceRatioForLabels,this.m_options.labelStartScaleDistance)),this.m_textElementsRenderer.placeAllTileLabels())}limitFov(e,t){e=n.MathUtils.clamp(e,10,140);let i=n.MathUtils.radToDeg(S.MapViewUtils.calculateHorizontalFovByVerticalFov(n.MathUtils.degToRad(e),t));return(i>140||i<10)&&(i=n.MathUtils.clamp(i,10,140),e=n.MathUtils.radToDeg(S.MapViewUtils.calculateVerticalFovByHorizontalFov(n.MathUtils.degToRad(i),t))),e}setFovOnCamera(e,t){let i=0;"fixed"===e.type?(this.calculateFocalLength(t),i=e.fov):(r.assert(0!==this.m_focalLength),i=S.MapViewUtils.calculateFovByFocalLength(this.m_focalLength,t)),this.m_camera.fov=this.limitFov(i,this.m_camera.aspect)}calculateFocalLength(e){r.assert(void 0!==this.m_options.fovCalculation),this.m_focalLength=S.MapViewUtils.calculateFocalLengthByVerticalFov(n.MathUtils.degToRad(this.m_options.fovCalculation.fov),e)}getCanvasClientSize(){const{clientWidth:e,clientHeight:t}=this.canvas;if(0===e||0===t||"number"!=typeof e||"number"!=typeof t){const e=this.m_renderer.getPixelRatio();return{width:Math.round(this.canvas.width/e),height:Math.round(this.canvas.height/e)}}return{width:e,height:t}}}t.MapView=G},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(12),r=i(5),s=i(14),o=i(7),a=i(8),l=i(13),c=i(15);class h{constructor(){this.type=c.ProjectionType.Planar}static clamp(e,t,i){return Math.min(Math.max(t,e),i)}static latitudeClamp(e){return h.clamp(e,-h.MAXIMUM_LATITUDE,h.MAXIMUM_LATITUDE)}static latitudeProject(e){return Math.log(Math.tan(.25*Math.PI+.5*e))/Math.PI}static latitudeClampProject(e){return h.latitudeProject(h.latitudeClamp(e))}static unprojectLatitude(e){return 2*Math.atan(Math.exp(Math.PI*e))-.5*Math.PI}getScaleFactor(e){return Math.cosh(2*Math.PI*(e.y/l.EarthConstants.EQUATORIAL_CIRCUMFERENCE-.5))}worldExtent(e,t,i){return i||(i=o.MathUtils.newEmptyBox3()),i.min.x=0,i.min.y=0,i.min.z=e,i.max.x=l.EarthConstants.EQUATORIAL_CIRCUMFERENCE,i.max.y=l.EarthConstants.EQUATORIAL_CIRCUMFERENCE,i.max.z=t,i}projectPoint(e,t){let i;return i=e instanceof r.GeoCoordinates?e:new r.GeoCoordinates(e.latitude,e.longitude,e.altitude),t||(t={x:0,y:0,z:0}),t.x=(i.longitude+180)/360*l.EarthConstants.EQUATORIAL_CIRCUMFERENCE,t.y=(.5*h.latitudeClampProject(i.latitudeInRadians)+.5)*l.EarthConstants.EQUATORIAL_CIRCUMFERENCE,t.z=i.altitude||0,t}unprojectPoint(e){return r.GeoCoordinates.fromRadians(h.unprojectLatitude(2*(e.y/l.EarthConstants.EQUATORIAL_CIRCUMFERENCE-.5)),e.x/l.EarthConstants.EQUATORIAL_CIRCUMFERENCE*2*Math.PI-Math.PI,e.z)}projectBox(e,t){const i=this.projectPoint(e.center),n=(.5*h.latitudeClampProject(e.northEast.latitudeInRadians)+.5)*l.EarthConstants.EQUATORIAL_CIRCUMFERENCE,r=(.5*h.latitudeClampProject(e.southWest.latitudeInRadians)+.5)*l.EarthConstants.EQUATORIAL_CIRCUMFERENCE,c=.5*(n+r);i.y=c;const d=n-r,u=e.longitudeSpan/360*l.EarthConstants.EQUATORIAL_CIRCUMFERENCE;if(t||(t=o.MathUtils.newEmptyBox3()),s.isBox3Like(t)){t.min.x=i.x-.5*u,t.min.y=i.y-.5*d,t.max.x=i.x+.5*u,t.max.y=i.y+.5*d;const n=e.altitudeSpan;void 0!==n?(t.min.z=i.z-.5*n,t.max.z=i.z+.5*n):(t.min.z=0,t.max.z=0)}else{if(!a.isOrientedBox3Like(t))throw new Error("invalid bounding box");o.MathUtils.newVector3(1,0,0,t.xAxis),o.MathUtils.newVector3(0,1,0,t.yAxis),o.MathUtils.newVector3(0,0,1,t.zAxis),t.position.x=i.x,t.position.y=i.y,t.position.z=i.z,t.extents.x=.5*u,t.extents.y=.5*d,t.extents.z=Math.max(Number.EPSILON,.5*(e.altitudeSpan||0))}return t}unprojectBox(e){const t=this.unprojectPoint(e.min),i=this.unprojectPoint(e.max);return n.GeoBox.fromCoordinates(t,i)}groundDistance(e){return e.z}scalePointToSurface(e){return e.z=0,e}}h.MAXIMUM_LATITUDE=1.4844222297453322,t.MercatorProjection=h,t.mercatorProjection=new h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.quadTreeSubdivisionScheme=new class{getSubdivisionX(){return 2}getSubdivisionY(){return 2}getLevelDimensionX(e){return 1<<e}getLevelDimensionY(e){return 1<<e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(18);class s{constructor(e,t,i,s,o,a,l,c,h,d,u,m,p){this.codePoint=e,this.block=t,this.width=i,this.height=s,this.advanceX=o,this.offsetX=a,this.offsetY=l,this.texture=m,this.font=p,this.positions=[],this.sourceTextureCoordinates=[],this.dynamicTextureCoordinates=[],this.copyIndex=0,this.isInCache=!1,this.character=String.fromCodePoint(e),this.direction=r.UnicodeUtils.getDirection(e,t);const f=this.offsetX,g=f+this.width,_=p.metrics.lineHeight-this.offsetY,v=_-this.height;this.positions.push(new n.Vector3(f,v,1),new n.Vector3(g,v,1),new n.Vector3(f,_,1),new n.Vector3(g,_,1)),this.sourceTextureCoordinates.push(new n.Vector2(c,h),new n.Vector2(d,h),new n.Vector2(c,u),new n.Vector2(d,u)),this.dynamicTextureCoordinates.push(new n.Vector2(0,0),new n.Vector2(1,0),new n.Vector2(0,1),new n.Vector2(1,1))}clone(){return new s(this.codePoint,this.block,this.width,this.height,this.advanceX,this.offsetX,this.offsetY,this.sourceTextureCoordinates[0].x,this.sourceTextureCoordinates[0].y,this.sourceTextureCoordinates[3].x,this.sourceTextureCoordinates[3].y,this.texture,this.font)}}t.GlyphData=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}(i(132))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);t.MAX_CAPACITY=65536,t.VERTEX_BUFFER_STRIDE=16,t.INDEX_BUFFER_STRIDE=1,t.VERTICES_PER_QUAD=4,t.INDICES_PER_QUAD=6,t.QUAD_VERTEX_MEMORY_FOOTPRINT=t.VERTICES_PER_QUAD*t.VERTEX_BUFFER_STRIDE,t.QUAD_INDEX_MEMORY_FOOTPRINT=t.INDICES_PER_QUAD*t.INDEX_BUFFER_STRIDE;t.TextGeometry=class{constructor(e,i,r,s,o){this.scene=e,this.capacity=Math.min(o,t.MAX_CAPACITY),this.m_currentCapacity=Math.min(s,o),this.m_drawCount=0,this.m_updateOffset=0,this.m_pickingCount=0,this.m_vertexBuffer=new n.InterleavedBuffer(new Float32Array(this.m_currentCapacity*t.QUAD_VERTEX_MEMORY_FOOTPRINT),t.VERTEX_BUFFER_STRIDE),this.m_vertexBuffer.setDynamic(!0),this.m_positionAttribute=new n.InterleavedBufferAttribute(this.m_vertexBuffer,4,0),this.m_uvAttribute=new n.InterleavedBufferAttribute(this.m_vertexBuffer,4,4),this.m_colorAttribute=new n.InterleavedBufferAttribute(this.m_vertexBuffer,4,8),this.m_bgColorAttribute=new n.InterleavedBufferAttribute(this.m_vertexBuffer,4,12),this.m_indexBuffer=new n.BufferAttribute(new Uint32Array(this.m_currentCapacity*t.QUAD_INDEX_MEMORY_FOOTPRINT),t.INDEX_BUFFER_STRIDE),this.m_indexBuffer.setDynamic(!0),this.m_geometry=new n.BufferGeometry,this.m_geometry.addAttribute("position",this.m_positionAttribute),this.m_geometry.addAttribute("uv",this.m_uvAttribute),this.m_geometry.addAttribute("color",this.m_colorAttribute),this.m_geometry.addAttribute("bgColor",this.m_bgColorAttribute),this.m_geometry.setIndex(this.m_indexBuffer),this.m_pickingDataArray=new Array(this.m_currentCapacity),this.m_mesh=new n.Mesh(this.m_geometry,i),this.m_bgMesh=new n.Mesh(this.m_geometry,r),this.m_mesh.renderOrder=Number.MAX_SAFE_INTEGER,this.m_bgMesh.renderOrder=Number.MAX_SAFE_INTEGER-1,this.scene.add(this.m_bgMesh,this.m_mesh)}get drawCount(){return this.m_drawCount}get mesh(){return this.m_mesh}get backgroundMesh(){return this.m_bgMesh}dispose(){this.scene.remove(this.m_bgMesh,this.m_mesh),this.m_geometry.dispose()}clear(){this.m_drawCount=0,this.m_updateOffset=0,this.m_pickingCount=0}update(){this.drawCount>this.m_updateOffset&&(this.m_vertexBuffer.needsUpdate=!0,this.m_vertexBuffer.updateRange.offset=this.m_updateOffset*t.QUAD_VERTEX_MEMORY_FOOTPRINT,this.m_vertexBuffer.updateRange.count=(this.m_drawCount-this.m_updateOffset)*t.QUAD_VERTEX_MEMORY_FOOTPRINT,this.m_indexBuffer.needsUpdate=!0,this.m_indexBuffer.updateRange.offset=this.m_updateOffset*t.QUAD_INDEX_MEMORY_FOOTPRINT,this.m_indexBuffer.updateRange.count=(this.m_drawCount-this.m_updateOffset)*t.QUAD_INDEX_MEMORY_FOOTPRINT),this.m_updateOffset=this.m_drawCount,this.m_geometry.setDrawRange(0,this.m_drawCount*t.INDICES_PER_QUAD)}add(e,i,n,r,s,o){if(this.m_drawCount>=this.capacity)return!1;if(this.m_drawCount>=this.m_currentCapacity){const e=Math.min(2*this.m_currentCapacity,this.capacity);this.resizeBuffers(e)}const a=this.m_drawCount*t.VERTICES_PER_QUAD,l=this.m_drawCount*t.INDICES_PER_QUAD;for(let l=0;l<t.VERTICES_PER_QUAD;++l){this.m_positionAttribute.setXYZW(a+l,i[l].x,i[l].y,i[l].z,(s?-1:1)*o.rotation);const t=s?(l+1)%2+2*Math.floor(l/2):l;this.m_uvAttribute.setXYZW(a+l,e.dynamicTextureCoordinates[t].x,e.dynamicTextureCoordinates[t].y,n,r),this.m_colorAttribute.setXYZW(a+l,o.color.r,o.color.g,o.color.b,o.opacity),this.m_bgColorAttribute.setXYZW(a+l,o.backgroundColor.r,o.backgroundColor.g,o.backgroundColor.b,o.backgroundOpacity)}return this.m_indexBuffer.setX(l,a),this.m_indexBuffer.setX(l+1,a+1),this.m_indexBuffer.setX(l+2,a+2),this.m_indexBuffer.setX(l+3,a+2),this.m_indexBuffer.setX(l+4,a+1),this.m_indexBuffer.setX(l+5,a+3),++this.m_drawCount,!0}addToBuffer(e,i,n,r,s,o,a,l){for(let c=0;c<t.VERTICES_PER_QUAD;++c){const h=i+t.VERTEX_BUFFER_STRIDE*c;e[h]=r[c].x,e[h+1]=r[c].y,e[h+2]=r[c].z,e[h+3]=(a?-1:1)*l.rotation;const d=a?(c+1)%2+2*Math.floor(c/2):c;e[h+4]=n.dynamicTextureCoordinates[d].x,e[h+5]=n.dynamicTextureCoordinates[d].y,e[h+6]=s,e[h+7]=o,e[h+8]=l.color.r,e[h+9]=l.color.g,e[h+10]=l.color.b,e[h+11]=l.opacity,e[h+12]=l.backgroundColor.r,e[h+13]=l.backgroundColor.g,e[h+14]=l.backgroundColor.b,e[h+15]=l.backgroundOpacity}}addTextBufferObject(e,i,n,r,s,o,a,l){if(this.m_drawCount+e.glyphs.length>=this.capacity)return!1;if(this.m_drawCount+e.glyphs.length>=this.m_currentCapacity){const e=Math.min(2*this.m_currentCapacity,this.capacity);this.resizeBuffers(e)}const c=n||1,h=r||0,d=Math.cos(h),u=Math.sin(h),m=void 0!==i?i.x:0,p=void 0!==i?i.y:0,f=void 0!==i?i.z:0,g=e.buffer,_=g[3]<0?-1:1,v=void 0!==s?s.r:g[8],y=void 0!==s?s.g:g[9],x=void 0!==s?s.b:g[10],w=void 0!==o?o:g[11],b=void 0!==a?a.r:g[12],T=void 0!==a?a.g:g[13],S=void 0!==a?a.b:g[14],C=void 0!==l?l:g[15],E=this.m_drawCount*t.VERTICES_PER_QUAD;for(let i=0;i<e.glyphs.length;++i){const n=i*t.QUAD_VERTEX_MEMORY_FOOTPRINT,r=e.glyphs[i];if(!r.isInCache)return!1;const s=g[n+4]>g[n+t.VERTEX_BUFFER_STRIDE+4],o=g[n+6],a=g[n+7];for(let e=0;e<t.VERTICES_PER_QUAD;++e){const l=g[n+e*t.VERTEX_BUFFER_STRIDE],M=g[n+e*t.VERTEX_BUFFER_STRIDE+1];this.m_positionAttribute.setXYZW(E+i*t.VERTICES_PER_QUAD+e,l*c*d+M*c*-u+m,l*c*u+M*c*d+p,g[n+e*t.VERTEX_BUFFER_STRIDE+2]+f,g[n+e*t.VERTEX_BUFFER_STRIDE+3]+_*h);const A=s?(e+1)%2+2*Math.floor(e/2):e;this.m_uvAttribute.setXYZW(E+i*t.VERTICES_PER_QUAD+e,r.dynamicTextureCoordinates[A].x,r.dynamicTextureCoordinates[A].y,o,(a-o)/c+o),this.m_colorAttribute.setXYZW(E+i*t.VERTICES_PER_QUAD+e,v,y,x,w),this.m_bgColorAttribute.setXYZW(E+i*t.VERTICES_PER_QUAD+e,b,T,S,C)}this.m_indexBuffer.setX((this.m_drawCount+i)*t.INDICES_PER_QUAD,(this.m_drawCount+i)*t.VERTICES_PER_QUAD),this.m_indexBuffer.setX((this.m_drawCount+i)*t.INDICES_PER_QUAD+1,(this.m_drawCount+i)*t.VERTICES_PER_QUAD+1),this.m_indexBuffer.setX((this.m_drawCount+i)*t.INDICES_PER_QUAD+2,(this.m_drawCount+i)*t.VERTICES_PER_QUAD+2),this.m_indexBuffer.setX((this.m_drawCount+i)*t.INDICES_PER_QUAD+3,(this.m_drawCount+i)*t.VERTICES_PER_QUAD+2),this.m_indexBuffer.setX((this.m_drawCount+i)*t.INDICES_PER_QUAD+4,(this.m_drawCount+i)*t.VERTICES_PER_QUAD+1),this.m_indexBuffer.setX((this.m_drawCount+i)*t.INDICES_PER_QUAD+5,(this.m_drawCount+i)*t.VERTICES_PER_QUAD+3)}return this.m_drawCount+=e.glyphs.length,!0}addPickingData(e,t,i){return!(this.m_pickingCount>=this.m_currentCapacity)&&(this.m_pickingDataArray[this.m_pickingCount]={start:Math.min(e,this.capacity),end:Math.min(t,this.capacity),data:i},++this.m_pickingCount,!0)}pick(e,i){for(const n of this.m_pickingDataArray){if(void 0===n)return;for(let r=n.start;r<n.end;++r){const s=r*t.VERTICES_PER_QUAD,o=Math.min(this.m_positionAttribute.getX(s+2),this.m_positionAttribute.getX(s+1));if(e.x<o)continue;const a=Math.max(this.m_positionAttribute.getX(s+2),this.m_positionAttribute.getX(s+1));if(e.x>a)continue;const l=Math.min(this.m_positionAttribute.getY(s+2),this.m_positionAttribute.getY(s+1));if(e.y<l)continue;const c=Math.max(this.m_positionAttribute.getY(s+2),this.m_positionAttribute.getY(s+1));if(!(e.y>c)){i(n.data);break}}}}updateMemoryUsage(e){const t=4*this.m_vertexBuffer.count+4*this.m_indexBuffer.count;e.heapSize+=t,e.gpuSize+=t}resizeBuffers(e){this.m_currentCapacity=e;const i=new Float32Array(e*t.QUAD_VERTEX_MEMORY_FOOTPRINT);i.set(this.m_vertexBuffer.array),this.m_vertexBuffer=new n.InterleavedBuffer(i,t.VERTEX_BUFFER_STRIDE),this.m_vertexBuffer.setDynamic(!0),this.m_positionAttribute=new n.InterleavedBufferAttribute(this.m_vertexBuffer,4,0),this.m_uvAttribute=new n.InterleavedBufferAttribute(this.m_vertexBuffer,4,4),this.m_colorAttribute=new n.InterleavedBufferAttribute(this.m_vertexBuffer,4,8),this.m_bgColorAttribute=new n.InterleavedBufferAttribute(this.m_vertexBuffer,4,12);const r=new Uint32Array(e*t.QUAD_INDEX_MEMORY_FOOTPRINT);r.set(this.m_indexBuffer.array),this.m_indexBuffer=new n.BufferAttribute(r,t.INDEX_BUFFER_STRIDE),this.m_indexBuffer.setDynamic(!0),this.m_geometry.dispose(),this.m_geometry=new n.BufferGeometry,this.m_geometry.addAttribute("position",this.m_positionAttribute),this.m_geometry.addAttribute("uv",this.m_uvAttribute),this.m_geometry.addAttribute("color",this.m_colorAttribute),this.m_geometry.addAttribute("bgColor",this.m_bgColorAttribute),this.m_geometry.setIndex(this.m_indexBuffer),this.m_pickingDataArray.length=this.m_currentCapacity,this.scene.remove(this.m_bgMesh,this.m_mesh),this.m_mesh=new n.Mesh(this.m_geometry,this.m_mesh.material),this.m_bgMesh=new n.Mesh(this.m_geometry,this.m_bgMesh.material),this.m_mesh.renderOrder=Number.MAX_SAFE_INTEGER,this.m_bgMesh.renderOrder=Number.MAX_SAFE_INTEGER-1,this.scene.add(this.m_bgMesh,this.m_mesh)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(9),s=i(18);!function(e){e.EM_TO_PX=16,e.PT_TO_PX=1.25,e.OBLIQUE_ANGLE=.174533,e.OBLIQUE_OFFSET=Math.tan(e.OBLIQUE_ANGLE),e.getPixelSize=function(t,i,n){let s=t;switch(i){case r.FontUnit.Em:s*=e.EM_TO_PX;break;case r.FontUnit.Point:s*=e.PT_TO_PX;break;case r.FontUnit.Percent:s*=.01*n}return s},e.getSmallCapsScale=function(e,t,i,n){return t[i]&&n===r.FontVariant.SmallCaps?e[i].font.metrics.xHeight/e[i].font.metrics.capHeight:1},e.getDirection=function(e,t){let i=s.UnicodeUtils.Direction.LTR,n=t;for(;e[n].direction!==s.UnicodeUtils.Direction.LTR&&e[n].direction!==s.UnicodeUtils.Direction.RTL&&n<e.length-1;)++n;return 1===Math.abs(e[n].direction)&&(i=e[n].direction),i},e.computeGlyphTransform=function(e,t,i,n,r){const s=Math.cos(n),o=Math.sin(n),a=Math.cos(r),l=Math.sin(r);e.set(i*a,i*-l,s*t.x-o*t.y,i*l,i*a,o*t.x+s*t.y,0,0,1)},e.updateBounds=function(e,t,i){const r=Math.min(e[0].x,e[1].x,e[2].x,e[3].x),s=Math.max(e[0].x,e[1].x,e[2].x,e[3].x),o=Math.min(e[0].y,e[1].y,e[2].y,e[3].y),a=Math.max(e[0].y,e[1].y,e[2].y,e[3].y);void 0!==i&&(void 0!==i.array[i.offset]?(i.array[i.offset].min.set(r,o),i.array[i.offset].max.set(s,a)):i.array.push(new n.Box2(new n.Vector2(r,o),new n.Vector2(s,a))),++i.offset),t.min.set(Math.min(t.min.x,r),Math.min(t.min.y,o)),t.max.set(Math.max(t.max.x,s),Math.max(t.max.y,a))}}(t.TypesettingUtils||(t.TypesettingUtils={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);class r extends n.Points{constructor(){super(...arguments),this.enableRayTesting=!0}raycast(e,t){if(!this.enableRayTesting)return;const i=this.geometry,r=this.matrixWorld,o=e.ray.origin.clone().add(e.ray.direction).project(e.mapView.camera),{clientWidth:a,clientHeight:l}=e.mapView.canvas,c=new n.Vector2(Math.ceil((o.x+1)/2*a),Math.ceil((1-o.y)/2*l));if(i instanceof n.BufferGeometry){const o=new n.Vector3,h=i.index,d=i.attributes.position.array;if(null!==h){const i=h.array;for(let n=0,h=i.length;n<h;n++){const h=i[n];o.fromArray(d,3*h);const u=s(o,r,e,a,l);u.pointIsOnScreen&&this.testPoint(o,u.absoluteScreenPosition,c,n,u.distance,t)}}else for(let i=0,n=d.length/3;i<n;i++){o.fromArray(d,3*i);const n=s(o,r,e,a,l);n.pointIsOnScreen&&this.testPoint(o,n.absoluteScreenPosition,c,i,n.distance,t)}}else{const n=i.vertices;for(let i=0;i<n.length;i++){const o=n[i],h=s(o,r,e,a,l);h.pointIsOnScreen&&this.testPoint(o,h.absoluteScreenPosition,c,i,h.distance,t)}}}}function s(e,t,i,r,s){const o=e.clone();o.applyMatrix4(t);const a=o.distanceTo(i.ray.origin);o.project(i.mapView.camera);const l=new n.Vector2(o.x,o.y),c=l.x<1&&l.x>-1&&l.y<1&&l.y>-1;if(c){return o.x=(o.x+1)/2*r,o.y=(1-o.y)/2*s,{absoluteScreenPosition:new n.Vector2(o.x,o.y),pointIsOnScreen:c,distance:a}}return{pointIsOnScreen:c}}t.MapViewPoints=r;t.Circles=class extends r{testPoint(e,t,i,n,r,s){const o=t.x-i.x,a=t.y-i.y;Math.sqrt(o*o+a*a)<=this.material.size/2&&s.push({point:e,distance:r,index:n,object:this})}};t.Squares=class extends r{testPoint(e,t,i,n,r,s){const o=t.x-i.x,a=t.y-i.y,l=this.material.size/2;Math.abs(o)<=l&&Math.abs(a)<=l&&s.push({point:e,distance:r,index:n,object:this})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=n.LoggerManager.instance.create("Statistics");class s{constructor(e){this.capacity=e,this.buffer=new Array(e),this.capacity=e,this.head=this.tail=this.size=0}clear(){this.head=this.tail=this.size=0}enqOne(e){let t=this.head+1;t>=this.capacity&&(t=0),this.size<this.capacity&&this.size++,this.buffer[this.head]=e,this.head=t,this.size===this.capacity&&(this.tail=this.head)}enq(...e){for(const t of e)this.enqOne(t)}deq(){if(0===this.size)throw new Error("Ringbuffer underrun");const e=this.buffer[this.tail];let t=this.tail+1;return t>=this.capacity&&(t=0),this.size>0&&this.size--,this.tail=t,e}get top(){if(0===this.size)throw new Error("Ringbuffer underrun");return this.buffer[this.tail]}get bottom(){if(0===this.size)throw new Error("Ringbuffer underrun");let e=this.head-1;return e<0&&(e=this.capacity-1),this.buffer[e]}iterator(){return new s.Iterator(this)}asArray(){const e=new Array;for(let t=0;t<this.size;t++)e.push(this.buffer[(this.tail+t)%this.capacity]);return e}}t.RingBuffer=s,function(e){e.Iterator=class{constructor(e,t=0){this.m_buffer=e,this.m_index=t}get value(){return this.m_buffer.buffer[(this.m_buffer.tail+this.m_index)%this.m_buffer.capacity]}next(){return this.m_index++,this.m_index<this.m_buffer.size}}}(s=t.RingBuffer||(t.RingBuffer={}));class o{constructor(e,t){this.statistics=e,this.name=t,this.running=!1}get value(){return this.m_currentValue}setValue(e){this.m_currentValue=e}reset(){this.m_currentValue=void 0}start(){if(!this.statistics.enabled)return-1;if(this.running)throw new Error("Timer '"+this.name+"' is already running");return this.running=!0,this.m_currentValue=n.PerformanceTimer.now()}stop(){if(!this.statistics.enabled)return-1;if(this.running){const e=n.PerformanceTimer.now()-(this.m_currentValue||0);return this.m_currentValue=e,this.setValue(e),this.running=!1,e}throw new Error("Timer '"+this.name+"' has not been started")}now(){if(!this.statistics.enabled)return-1;if(this.running){return n.PerformanceTimer.now()-(this.m_currentValue||0)}throw new Error("Timer '"+this.name+"' has not been started")}}t.SimpleTimer=o;class a extends o{constructor(e,t){super(e,t),this.statistics=e,this.name=t,this.numResets=0,this.maxNumSamples=1e3,this.samples=new s(this.maxNumSamples)}reset(){super.reset(),this.getStats(),this.samples.clear(),this.numResets++}setValue(e){super.setValue(e),void 0!==e&&this.samples.enqOne(e)}getStats(){return l(this.samples.asArray())}}function l(e){if(0===e.length)return;e.sort((e,t)=>e-t);const t=e[0],i=e[e.length-1];let n,r,s,o,a,l;if(1===e.length)r=s=o=a=l=n=e[0];else if(2===e.length)n=.5*e[0]+.5*e[1],r=s=o=a=l=e[1];else{const t=Math.floor(e.length/2);n=e.length%2==0?.5*e[t-1]+.5*e[t]:e[t],r=e[Math.round(.9*e.length)-1],s=e[Math.round(.95*e.length)-1],o=e[Math.round(.97*e.length)-1],a=e[Math.round(.99*e.length)-1],l=e[Math.round(.999*e.length)-1]}let c=0;for(let t=0,i=e.length;t<i;t++)c+=e[t];return{min:t,max:i,avg:c/e.length,median:n,median90:r,median95:s,median97:o,median99:a,median999:l,numSamples:e.length}}t.SampledTimer=a,t.computeArrayStats=l;t.MultiStageTimer=class{constructor(e,t,i){if(this.statistics=e,this.name=t,this.stages=i,i.length<1)throw new Error("MultiStageTimer needs stages");i.forEach(t=>{if(!e.hasTimer(t))throw new Error("Unknown timer: "+t)})}get value(){return this.statistics.getTimer(this.stages[this.stages.length-1]).value}reset(){this.statistics.enabled&&this.stages.forEach(e=>{this.statistics.getTimer(e).reset()})}start(){return this.stage=this.stages[0],this.statistics.getTimer(this.stages[0]).value||-1}stop(){return this.stage=void 0,void 0!==this.value?this.value:-1}get stage(){return this.currentStage}set stage(e){this.currentStage!==e&&(this.statistics.enabled&&void 0!==this.currentStage&&this.statistics.getTimer(this.currentStage).stop(),this.currentStage=e,this.statistics.enabled&&void 0!==this.currentStage&&this.statistics.getTimer(this.currentStage).start())}};t.Statistics=class{constructor(e,t=!1){this.name=e,this.enabled=t,this.timers=new Map,this.nullTimer=new o(this,"<null>")}createTimer(e,t=!0){const i=t?new a(this,e):new o(this,e);return this.addTimer(i)}addTimer(e){if(void 0!==this.timers.get(e.name))throw new Error("Duplicate timer name: '"+e.name+"'");return this.timers.set(e.name,e),e}getTimer(e){if(!this.enabled)return this.nullTimer;const t=this.timers.get(e);return void 0===t?this.nullTimer:t}hasTimer(e){return void 0!==this.timers.get(e)}reset(){this.timers.forEach(e=>{e.reset()})}log(e,t){void 0===e&&void 0===this.name||r.log(void 0!==e?e:this.name);let i=0;this.timers.forEach(e=>{i=Math.max(i,e.name.length)});const n=e=>void 0!==e?e.toFixed(5):"?";this.timers.forEach(e=>{let t=e.name+": "+" ".repeat(i-e.name.length);if(t+=n(e.value),e instanceof a){const i=e.getStats();void 0!==i&&(t+=`  [ min=${n(i.min)}, max=${n(i.max)}, avg=${n(i.avg)}, med=${n(i.median)}, med95=${n(i.median95)}, med99=${n(i.median99)}, N=${n(i.numSamples)} ]`)}r.log(t)}),void 0!==t&&r.log(t)}};class c{constructor(){this.entries=new Map,this.messages=void 0}getValue(e){return this.entries.get(e)}setValue(e,t){this.entries.set(e,t)}addValue(e,t){const i=this.entries.get(e);this.entries.set(e,t+(void 0===i?0:i))}addMessage(e){void 0===this.messages&&(this.messages=[]),this.messages.push(e)}reset(){this.entries.forEach((e,t)=>{this.entries.set(t,0)}),this.messages=void 0}}t.FrameStats=c;class h{constructor(e=0){this.capacity=e,this.frameEntries=new Map,this.messages=new s(e)}get length(){return this.messages.size}reset(){this.frameEntries.forEach((e,t)=>{e.clear()}),this.messages.clear()}addFrame(e){const t=this.length,i=this.frameEntries;e.entries.forEach((e,n)=>{let r=i.get(n);if(void 0===r){r=new s(this.capacity);for(let e=0;e<t;e++)r.enqOne(0);this.frameEntries.set(n,r)}r.enqOne(e)}),this.messages.enq(e.messages)}log(){let e=0;this.frameEntries.forEach((t,i)=>{e=Math.max(e,i.length)});const t=e=>void 0!==e?e.toFixed(5):"?";this.frameEntries.forEach((i,n)=>{let s=n+": "+" ".repeat(e-n.length);const o=l(i.asArray());void 0!==o&&(s+=`  [ min=${t(o.min)}, max=${t(o.max)}, avg=${t(o.avg)}, med=${t(o.median)}, med95=${t(o.median95)}, med99=${t(o.median99)}, N=${t(o.numSamples)} ]`),r.log(s)})}}t.FrameStatsArray=h;class d{constructor(e=!0,t=1e3){this.enabled=e,this.maxNumFrames=t,this.currentFrame=new c,this.appResults=new Map,this.configs=new Map,d.m_instance=this,this.m_frameEvents=new h(t)}get isFull(){return this.m_frameEvents.length>=this.maxNumFrames}static get instance(){return void 0===d.m_instance&&(d.m_instance=new d(!1,0)),d.m_instance}get frameEvents(){return this.m_frameEvents}clear(){this.clearFrames(),this.configs.clear(),this.appResults.clear()}clearFrames(){this.m_frameEvents.reset(),this.currentFrame.reset()}storeFrameInfo(e){if(this.m_frameEvents.length>=this.maxNumFrames)return!1;if(void 0!==e&&(this.currentFrame.setValue("gl.numCalls",e.render.calls),this.currentFrame.setValue("gl.numGeometries",e.memory.geometries),this.currentFrame.setValue("gl.numLines",e.render.lines),this.currentFrame.setValue("gl.numPoints",e.render.points),this.currentFrame.setValue("gl.numPrograms",null===e.programs?0:e.programs.length),this.currentFrame.setValue("gl.numTextures",e.memory.textures),this.currentFrame.setValue("gl.numTriangles",e.render.triangles)),void 0!==window&&void 0!==window.performance){const e=window.performance.memory;void 0!==e&&(this.currentFrame.setValue("memory.totalJSHeapSize",e.totalJSHeapSize),this.currentFrame.setValue("memory.usedJSHeapSize",e.usedJSHeapSize),this.currentFrame.setValue("memory.jsHeapSizeLimit",e.jsHeapSizeLimit))}return this.m_frameEvents.addFrame(this.currentFrame),this.currentFrame.reset(),!0}log(e,t){r.log(void 0!==e?e:"PerformanceStatistics"),this.appResults.forEach((e,t)=>{r.log(t,e)}),this.configs.forEach((e,t)=>{r.log(t,e)}),this.m_frameEvents.log(),void 0!==t&&r.log(t)}getAsPlainObject(){const e={},t={},i={},n={configs:t,appResults:e,frames:i};this.appResults.forEach((t,i)=>{e[i]=t}),this.configs.forEach((e,i)=>{t[i]=e});for(const[e,t]of this.m_frameEvents.frameEntries)i[e]=t.asArray();return n.messages=this.m_frameEvents.messages.asArray(),n}getLastFrameStatistics(){const e={},t={},i={},n={configs:t,appResults:e,frames:i};this.appResults.forEach((t,i)=>{e[i]=t}),this.configs.forEach((e,i)=>{t[i]=e});for(const[e,t]of this.m_frameEvents.frameEntries)i[e]=t.bottom;return n.messages=this.m_frameEvents.messages.asArray(),n}}d.m_instance=void 0,t.PerformanceStatistics=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Pass=class{constructor(){this.enabled=!1,this.renderToScreen=!1}setSize(e,t){}render(e,t,i,n,r,s){}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1);!function(e){e.mergeArrays=function(e,t){const i=[];for(const r of[e,t])if(void 0!==r)for(const e of r){const t=i.find(t=>t.id===e.id||void 0!==t.label&&t.label===e.label);void 0===t?i.push(Object.assign({},e)):(t.year=n.MathUtils.max2(e.year,t.year),t.label=n.getOptionValue(e.label,t.label),t.link=n.getOptionValue(e.link,t.link))}return i},e.formatAsHtml=function(e){if(0===e.length)return"";const t=e.filter(e=>""!==e.label);return 0===t.length?"":"© "+t.map(e=>{const t=void 0!==e.label?e.label:e.id,i=void 0!==e.year?`${e.year} ${t}`:t;return e.link?`<a href="${e.link}">${i}</a>`:""+i}).join(", ")}}(t.CopyrightInfo||(t.CopyrightInfo={}))},function(e,t,i){"use strict";function n(e,t,i,r){if(!(this instanceof n))return new n(e,t,i,r);var s,o,a;e.x?(i=e.w,r=e.h,t=e.y,0!==e.w&&!e.w&&e.x2?(i=e.x2-e.x,r=e.y2-e.y):(i=e.w,r=e.h),e=e.x,s=e+i,o=t+r,a=!(r+i)):(s=e+i,o=t+r,a=!(r+i)),this.x1=this.x=function(){return e},this.y1=this.y=function(){return t},this.x2=function(){return s},this.y2=function(){return o},this.w=function(){return i},this.h=function(){return r},this.p=function(){return a},this.overlap=function(i){return a||i.p()?e<=i.x2()&&s>=i.x()&&t<=i.y2()&&o>=i.y():e<i.x2()&&s>i.x()&&t<i.y2()&&o>i.y()},this.expand=function(n){var a,l,c=n.x(),h=n.y(),d=n.x2(),u=n.y2();return a=e>c?c:e,l=t>h?h:t,i=s>d?s-a:d-a,r=o>u?o-l:u-l,e=a,t=l,this}}n.overlapRectangle=function(e,t){return 0===e.h&&0===e.w||0===t.h&&0===t.w?e.x<=t.x+t.w&&e.x+e.w>=t.x&&e.y<=t.y+t.h&&e.y+e.h>=t.y:e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y},n.containsRectangle=function(e,t){return e.x+e.w<=t.x+t.w&&e.x>=t.x&&e.y+e.h<=t.y+t.h&&e.y>=t.y},n.expandRectangle=function(e,t){var i,n,r=e.x+e.w,s=t.x+t.w,o=e.y+e.h,a=t.y+t.h;return i=e.x>t.x?t.x:e.x,n=e.y>t.y?t.y:e.y,e.w=r>s?r-i:s-i,e.h=o>a?o-n:a-n,e.x=i,e.y=n,e},n.makeMBR=function(e,t){if(!e.length)return{x:0,y:0,w:0,h:0};(t=t||{}).x=e[0].x,t.y=e[0].y,t.w=e[0].w,t.h=e[0].h;for(var i=1,r=e.length;i<r;i++)n.expandRectangle(t,e[i]);return t},n.squarifiedRatio=function(e,t,i){var n=(e+t)/2,r=e*t;return r*i/(r/(n*n))},e.exports=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),r=i(0),s=i(85),o=i(159),a=i(84);!function(e){function t(e){return new r.Vector3(Math.fround(e.x),Math.fround(e.y),Math.fround(e.z))}function i(e,i){const n=(new r.Matrix4).copy(e.projectionMatrix).multiply(e.matrixWorldInverse),s=new r.Vector3(0,0,0).applyMatrix4(i),o=t(s);return{viewProjection:n,eyePosHi:o,eyePosLo:t(s.sub(o))}}function l(e){if(e.length>0){const t=e[0];if(null==t)throw Error("Empty element in positions");const i=new Array,n=new Array,s=(...e)=>{for(const t of e){const e=Math.fround(t);n.push(t-e),i.push(e)}},o=e=>{s(e.x,e.y,e.z)};if(void 0!==t.z)e.forEach(e=>{o(e)});else{if(i.length%3!=0)throw Error("Positions must be 3D, not 2D");e.forEach(e=>{s(e)})}return{positionHigh:new r.Float32BufferAttribute(i,3),positionLow:new r.Float32BufferAttribute(n,3)}}return{positionHigh:new r.Float32BufferAttribute([],3),positionLow:new r.Float32BufferAttribute([],3)}}function c(e,t,i=0){const n=new Array,r=e.length;for(let s=0;s<r;s+=t){for(let t=0;t<i;t++)n.push(e[s+t]);const r=e[s+i],o=e[s+i+1],a=e[s+i+2],l=Math.fround(r),c=r-l,h=Math.fround(o),d=o-h,u=Math.fround(a),m=a-u;n.push(l,h,u,c,d,m);for(let r=i+3;r<t;r++)n.push(e[s+r])}return n}function h(e,t){const i=l(t);return e.bufferGeometry.addAttribute("position",i.positionHigh),e.bufferGeometry.addAttribute("positionLow",i.positionLow),i.positionHigh.itemSize}e.doubleToFloatVec=t,e.makeFloatVec=function(e){const t=Math.fround(e.x),i=Math.fround(e.y),n=Math.fround(e.z),s=new r.Vector3(e.x-t,e.y-i,e.z-n);return e.x=Math.fround(t),e.y=Math.fround(i),e.z=Math.fround(n),s},e.createHighPrecisionCameraPos=i,e.updateHpUniforms=function(e,t,n){const r=i(t,e.matrixWorldInverse),s=r.viewProjection;if(void 0===n||!n.isMaterial)throw Error("High pecision line has no high precision material");if(!(n.uniforms&&n.uniforms.u_mvp&&n.uniforms.u_eyepos&&n.uniforms.u_eyepos_lowpart))throw Error("High pecision material has missing uniforms");n.uniforms.u_mvp.value=new Float32Array(s.elements),n.uniforms.u_eyepos.value=new Float32Array(r.eyePosHi.toArray()),n.uniforms.u_eyepos_lowpart.value=new Float32Array(r.eyePosLo.toArray())},e.createAttributes=l,e.addInterleavedAttributes3=c,e.setPositions=h,e.convertPositions=function(e){if(e.length<=0)return{positions:[]};const t=e[0];if(null==t)throw Error("Empty element in positions");const i=t;if(void 0===i.y&&void 0===i.z)return{positions:e};const n=new Array;return e.forEach(e=>{n.push(e.x,e.y,e.z)}),{positions:n}},e.createLine=function(e,t){const i=void 0!==t.lineWidth?t.lineWidth:5,o=void 0!==t.addCircles&&t.addCircles,l=void 0!==t.wireFrame&&t.wireFrame,h=[],d=[];a.triangulateLine(e,i,h,d,o);const u=new r.BufferGeometry,m=c(h,3),p=new r.InterleavedBuffer(new Float32Array(m),6),f=new r.InterleavedBufferAttribute(p,3,0,!1),g=new r.InterleavedBufferAttribute(p,3,3,!1);u.addAttribute("position",f),u.addAttribute("positionLow",g),u.setIndex(new r.BufferAttribute(new Uint32Array(d),1));const _=new n.HighPrecisionLineMaterial(t),v=l?new s.HighPrecisionWireFrameLine(u,_):new s.HighPrecisionLine(u,_);return v.setupForRendering(),v},e.createPoints=function(e,t){const i=[];for(let t=0;t<e.length;t++)i.push(i.length/3);const s=new r.BufferGeometry,a=n.isHighPrecisionPointMaterial(t)?t:new n.HighPrecisionPointMaterial(t),l=new o.HighPrecisionPoints(s,a);return h(l,e),l.setupForRendering(),l}}(t.HighPrecisionUtils||(t.HighPrecisionUtils={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);t.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n    varying vec2 vUv;\n    void main() {\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    }",fragmentShader:"\n    uniform float opacity;\n    uniform sampler2D tDiffuse;\n    varying vec2 vUv;\n    void main() {\n        vec4 texel = texture2D( tDiffuse, vUv );\n        gl_FragColor = opacity * texel;\n    }"};class r extends n.ShaderMaterial{constructor(e){super({name:"CopyMaterial",uniforms:e,vertexShader:t.CopyShader.vertexShader,fragmentShader:t.CopyShader.fragmentShader,premultipliedAlpha:!0,transparent:!1,blending:n.NoBlending,depthTest:!1,depthWrite:!1})}}t.CopyMaterial=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(26),s=i(28);class o extends n.RawShaderMaterial{constructor(e){Object.assign(n.ShaderChunk,s.default),r.FadingFeature.patchGlobalShaderChunks();const t={DASHED_LINE:0,TILE_CLIP:0},i=void 0!==e&&!0===e.fog;i&&(t.USE_FOG=""),super({name:"SolidLineMaterial",vertexShader:"\n#define SEGMENT_OFFSET 0.1\n\nattribute vec2 texcoord;\nattribute vec3 position;\nattribute vec4 bitangent;\nattribute vec3 tangent;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform float lineWidth;\n\nvarying vec2 vTexcoord;\nvarying vec2 vSegment;\nvarying float vLinewidth;\nvarying vec3 vPosition;\n\n#ifdef USE_COLOR\nattribute vec4 color;\nvarying vec3 vColor;\n#endif\n\n#ifdef USE_FADING\n#include <fading_pars_vertex>\n#endif\n\n#include <fog_pars_vertex>\n\n#include <extrude_line_vert_func>\n\nvoid main() {\n    vLinewidth = lineWidth;\n    vSegment = abs(texcoord) - SEGMENT_OFFSET;\n\n    #ifdef USE_COLOR\n    vColor = color.rgb;\n    #endif\n\n    vec3 pos = position;\n    vec2 uvs = sign(texcoord);\n\n    extrudeLine(vSegment, bitangent, tangent, lineWidth, pos, uvs);\n\n    vPosition = pos;\n    vTexcoord = vec2(uvs.x, uvs.y * lineWidth);\n\n    vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);\n    gl_Position = projectionMatrix * mvPosition;\n\n    #ifdef USE_FADING\n    #include <fading_vertex>\n    #endif\n\n    #include <fog_vertex>\n}",fragmentShader:"\nprecision highp float;\nprecision highp int;\n\nuniform vec3 diffuse;\nuniform float opacity;\nuniform vec2 tileSize;\n#if DASHED_LINE\nuniform float dashSize;\nuniform float gapSize;\n#endif\n\nvarying vec2 vTexcoord;\nvarying vec2 vSegment;\nvarying float vLinewidth;\nvarying vec3 vPosition;\n#ifdef USE_COLOR\nvarying vec3 color;\n#endif\n\n#include <join_dist_func>\n#include <tile_clip_func>\n\n#ifdef USE_FADING\n#include <fading_pars_fragment>\n#endif\n\n#include <fog_pars_fragment>\n\nvoid main() {\n\n    float alpha = opacity;\n\n    #if TILE_CLIP\n    tileClip(vPosition.xy, tileSize);\n    #endif\n\n    #if DASHED_LINE\n    float halfSegment = (dashSize + gapSize) / dashSize * 0.5;\n    float segmentDist = mod(vTexcoord.x, dashSize + gapSize) / dashSize;\n    float dist = 0.5 - distance(segmentDist, halfSegment);\n    float width = fwidth(dist);\n    alpha *= smoothstep(-width, width, dist);\n    #else\n    float dist = joinDist(vSegment, vTexcoord) - vLinewidth;\n    float width = fwidth(dist);\n    alpha *= (1.0 - smoothstep(-width, width, dist));\n    #endif\n\n    #ifdef USE_COLOR\n    gl_FragColor = vec4( diffuse * vColor, alpha );\n    #else\n    gl_FragColor = vec4( diffuse, alpha );\n    #endif\n    #include <fog_fragment>\n\n    #ifdef USE_FADING\n    #include <fading_fragment>\n    #endif\n}",uniforms:n.UniformsUtils.merge([{diffuse:new n.Uniform(new n.Color(o.DEFAULT_COLOR)),lineWidth:new n.Uniform(o.DEFAULT_WIDTH),opacity:new n.Uniform(o.DEFAULT_OPACITY),tileSize:new n.Uniform(new n.Vector2),fadeNear:new n.Uniform(r.FadingFeature.DEFAULT_FADE_NEAR),fadeFar:new n.Uniform(r.FadingFeature.DEFAULT_FADE_FAR)},n.UniformsLib.fog]),defines:t,transparent:!0,fog:!0}),this.extensions.derivatives=!0,void 0!==e&&(void 0!==e.color&&this.color.set(e.color),void 0!==e.lineWidth&&(this.lineWidth=e.lineWidth),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.depthTest&&(this.depthTest=e.depthTest),void 0!==e.depthWrite&&(this.depthWrite=e.depthWrite),void 0!==e.fadeNear&&(this.fadeNear=e.fadeNear),void 0!==e.fadeFar&&(this.fadeFar=e.fadeFar),this.fog=i)}updateFog(e){e?this.defines.USE_FOG="":delete this.defines.USE_FOG}get opacity(){return this.uniforms.opacity.value}set opacity(e){void 0!==this.uniforms&&(this.uniforms.opacity.value=e)}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}get lineWidth(){return this.uniforms.lineWidth.value}set lineWidth(e){this.uniforms.lineWidth.value=e}get fadeNear(){return this.uniforms.fadeNear.value}set fadeNear(e){this.uniforms.fadeNear.value=e}get fadeFar(){return this.uniforms.fadeFar.value}set fadeFar(e){const t=this.uniforms.fadeFar.value;this.uniforms.fadeFar.value=e,void 0!==t&&t>0?this.defines.USE_FADING="":delete this.defines.USE_FADING}}o.DEFAULT_COLOR=16711680,o.DEFAULT_WIDTH=1,o.DEFAULT_OPACITY=1,t.SolidLineMaterial=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ConsoleChannel=class{error(e,...t){console.error(e,...t)}debug(e,...t){console.debug(e,...t)}info(e,...t){console.info(e,...t)}log(e,...t){console.log(e,...t)}trace(e,...t){console.trace(e,...t)}warn(e,...t){console.warn(e,...t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(27);t.Logger=class{constructor(e,t,i){this.name=e,this.m_channel=t,this.enabled=!0,this.level=n.LogLevel.Trace,void 0!==i&&this.update(i)}error(e,...t){this.enabled&&this.level<=n.LogLevel.Error&&this.m_channel.error(this.prefix,e,...t)}debug(e,...t){this.enabled&&this.level<=n.LogLevel.Debug&&this.m_channel.debug(this.prefix,e,...t)}info(e,...t){this.enabled&&this.level<=n.LogLevel.Info&&this.m_channel.info(this.prefix,e,...t)}log(e,...t){this.enabled&&this.level<=n.LogLevel.Log&&this.m_channel.log(this.prefix,e,...t)}trace(e,...t){this.enabled&&this.level<=n.LogLevel.Trace&&this.m_channel.trace(this.prefix,e,...t)}warn(e,...t){this.enabled&&this.level<=n.LogLevel.Warn&&this.m_channel.warn(this.prefix,e,...t)}update(e){this.enabled=void 0===e.enabled?this.enabled:e.enabled,this.level=void 0===e.level?this.level:e.level}get prefix(){return this.name+":"}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(27);t.WORKERCHANNEL_MSG_TYPE="worker-channel-message";t.WorkerChannel=class{error(e,...i){const r={message:[e,...i],type:t.WORKERCHANNEL_MSG_TYPE,level:n.LogLevel.Error};self.postMessage(r)}debug(e,...i){const r={message:[e,...i],type:t.WORKERCHANNEL_MSG_TYPE,level:n.LogLevel.Debug};self.postMessage(r)}info(e,...i){const r={message:[e,...i],type:t.WORKERCHANNEL_MSG_TYPE,level:n.LogLevel.Info};self.postMessage(r)}log(e,...i){const r={message:[e,...i],type:t.WORKERCHANNEL_MSG_TYPE,level:n.LogLevel.Log};self.postMessage(r)}trace(e,...i){const r={message:[e,...i],type:t.WORKERCHANNEL_MSG_TYPE,level:n.LogLevel.Trace};self.postMessage(r)}warn(e,...i){const r={message:[e,...i],type:t.WORKERCHANNEL_MSG_TYPE,level:n.LogLevel.Warn};self.postMessage(r)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(12),r=i(5),s=i(14),o=i(7),a=i(8),l=i(15),c=Math.PI/180;class h{constructor(){this.type=l.ProjectionType.Planar}getScaleFactor(e){return 1}worldExtent(e,t,i){return i||(i=o.MathUtils.newEmptyBox3()),i.min.x=0,i.min.y=0,i.min.z=e,i.max.x=1,i.max.y=.5,i.max.z=t,i}projectPoint(e,t){return void 0===t&&(t={x:0,y:0,z:0}),t.x=(e.longitude*c+Math.PI)*h.geoToWorldScale,t.y=(e.latitude*c+.5*Math.PI)*h.geoToWorldScale,t.z=e.altitude||0,t}unprojectPoint(e){return r.GeoCoordinates.fromRadians(e.y*h.worldToGeoScale-.5*Math.PI,e.x*h.worldToGeoScale-Math.PI,e.z)}projectBox(e,t){const i=this.projectPoint(new r.GeoCoordinates(e.center.latitude,e.center.longitude,0)),{latitudeSpanInRadians:n,longitudeSpanInRadians:l,altitudeSpan:c}=e,d=l*h.geoToWorldScale,u=n*h.geoToWorldScale;return t||(t=o.MathUtils.newEmptyBox3()),s.isBox3Like(t)?(t.min.x=i.x-.5*d,t.min.y=i.y-.5*u,t.max.x=i.x+.5*d,t.max.y=i.y+.5*u,void 0!==c?(t.min.z=i.z-.5*c,t.max.z=i.z+.5*c):(t.min.z=0,t.max.z=0)):a.isOrientedBox3Like(t)&&(o.MathUtils.newVector3(1,0,0,t.xAxis),o.MathUtils.newVector3(0,1,0,t.yAxis),o.MathUtils.newVector3(0,0,1,t.zAxis),t.position.x=i.x,t.position.y=i.y,t.position.z=i.z,t.extents.x=.5*d,t.extents.y=.5*u,t.extents.z=Math.max(Number.EPSILON,.5*(c||0))),t}unprojectBox(e){const t=this.unprojectPoint(e.min),i=this.unprojectPoint(e.max);return n.GeoBox.fromCoordinates(t,i)}groundDistance(e){return e.z}scalePointToSurface(e){return e.z=0,e}}h.geoToWorldScale=1/(2*Math.PI),h.worldToGeoScale=2*Math.PI/1,t.equirectangularProjection=new h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(12),r=i(5),s=i(7),o=i(8),a=i(13),l=i(30);class c extends l.MercatorProjection{projectPoint(e,t){let i;i=e instanceof r.GeoCoordinates?e:new r.GeoCoordinates(e.latitude,e.longitude,e.altitude),t||(t={x:0,y:0,z:0}),t.x=(i.longitude+180)/360*a.EarthConstants.EQUATORIAL_CIRCUMFERENCE;const n=Math.sin(l.MercatorProjection.latitudeClamp(i.latitudeInRadians));return t.y=(.5-Math.log((1+n)/(1-n))/(4*Math.PI))*a.EarthConstants.EQUATORIAL_CIRCUMFERENCE,t.z=i.altitude||0,t}unprojectPoint(e){const t=e.x/a.EarthConstants.EQUATORIAL_CIRCUMFERENCE-.5,i=.5-e.y/a.EarthConstants.EQUATORIAL_CIRCUMFERENCE,n=360*t,s=90-360*Math.atan(Math.exp(2*-i*Math.PI))/Math.PI;return new r.GeoCoordinates(s,n,e.z)}projectBox(e,t){const i=super.projectBox(e,t);return o.isOrientedBox3Like(i)&&(s.MathUtils.newVector3(1,0,0,i.xAxis),s.MathUtils.newVector3(0,-1,0,i.yAxis),s.MathUtils.newVector3(0,0,-1,i.zAxis)),i}unprojectBox(e){const t=this.unprojectPoint(e.min),i=this.unprojectPoint(e.max);return new n.GeoBox(new r.GeoCoordinates(i.latitude,t.longitude,t.altitude),new r.GeoCoordinates(t.latitude,i.longitude,i.altitude))}}c.MAXIMUM_LATITUDE=1.4844222297453322,t.webMercatorProjection=new c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(7);t.FlatTileBoundingBoxGenerator=class{constructor(e,t=0,i=0){this.tilingScheme=e,this.minElevation=t,this.maxElevation=i,this.m_tilingScheme=e,this.m_worldBox=e.projection.worldExtent(t,i);const{min:n,max:r}=this.m_worldBox;this.m_worldDimensions={x:r.x-n.x,y:r.y-n.y,z:r.z-n.z}}get projection(){return this.m_tilingScheme.projection}get subdivisionScheme(){return this.m_tilingScheme.subdivisionScheme}getWorldBox(e,t){const i=e.level,r=this.subdivisionScheme.getLevelDimensionX(i),s=this.subdivisionScheme.getLevelDimensionY(i),o=this.m_worldDimensions.x/r,a=this.m_worldDimensions.y/s,l=this.m_worldBox.min.x+o*e.column,c=this.m_worldBox.min.y+a*e.row;return t||(t=n.MathUtils.newEmptyBox3()),t.min.x=l,t.min.y=c,t.min.z=this.m_worldBox.min.z,t.max.x=l+o,t.max.y=c+a,t.max.z=this.m_worldBox.max.z,t}getGeoBox(e){const t=this.getWorldBox(e);return this.projection.unprojectBox(t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.halfQuadTreeSubdivisionScheme=new class{getSubdivisionX(){return 2}getSubdivisionY(e){return 0===e?1:2}getLevelDimensionX(e){return 1<<e}getLevelDimensionY(e){return 0!==e?1<<e-1:1}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(20);class r{constructor(e,t,i){this.m_tileKey=e,this.m_level=t,this.m_count=1<<(t<<1),this.m_mask=i,this.m_shift=t>2?t-2<<1:0}get length(){return this.m_count}get level(){return this.m_level}get tileKey(){return this.m_tileKey}iterator(){return new r.Iterator(this)}skip(e){if(-1!==this.m_mask)for(;e<this.m_count&&0==(this.m_mask&1<<(e>>this.m_shift));)++e;return e}}t.SubTiles=r,function(e){e.Iterator=class{constructor(e,t=0){this.m_parent=e,this.m_index=e.skip(t)}get value(){const e=this.m_parent.tileKey,t=this.m_parent.level;return n.TileKey.fromRowColumnLevel(e.row<<t|this.m_index>>t,e.column<<t|this.m_index&(1<<t)-1,e.level+t)}next(){this.m_index=this.m_parent.skip(++this.m_index)}}}(r=t.SubTiles||(t.SubTiles={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(5),r=i(20);class s{static geoCoordinatesToTileKey(e,t,i){const n=e.projection,s=e.subdivisionScheme,o=n.projectPoint(t),a=s.getLevelDimensionX(i),l=s.getLevelDimensionY(i),{min:c,max:h}=n.worldExtent(0,0),d=h.x-c.x,u=h.y-c.y;if(o.x<c.x||o.x>h.x)return null;if(o.y<c.y||o.y>h.y)return null;const m=Math.min(a-1,Math.floor(a*(o.x-c.x)/d)),p=Math.min(l-1,Math.floor(l*(o.y-c.y)/u));return r.TileKey.fromRowColumnLevel(p,m,i)}static geoRectangleToTileKeys(e,t,i){const o=(e,t,i)=>e<t?i-(t-e)%(i-t):t+(e-t)%(i-t),a=(e,t,i)=>Math.min(Math.max(e,t),i),l=o(t.southWest.longitudeInRadians,-Math.PI,Math.PI),c=a(t.southWest.latitudeInRadians,-.5*Math.PI,.5*Math.PI),h=o(t.northEast.longitudeInRadians,-Math.PI,Math.PI),d=a(t.northEast.latitudeInRadians,-.5*Math.PI,.5*Math.PI),u=s.geoCoordinatesToTileKey(e,n.GeoCoordinates.fromRadians(c,l),i),m=s.geoCoordinatesToTileKey(e,n.GeoCoordinates.fromRadians(d,h),i),p=e.subdivisionScheme.getLevelDimensionX(i);if(!u||!m)throw new Error("Invalid coordinates");const f=u.column;let g=m.column;l>h&&(g+=g!==f?p:p-1);const _=Math.min(u.row,m.row),v=Math.max(u.row,m.row),y=new Array;for(let e=_;e<=v;++e)for(let t=f;t<=g;++t)y.push(r.TileKey.fromRowColumnLevel(e,t%p,i));return y}}t.TileKeyUtils=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(52);t.TileTreeTraverse=class{constructor(e){this.m_subdivisionScheme=e}subTiles(e){const t=~(-1<<this.m_subdivisionScheme.getSubdivisionX(e.level)*this.m_subdivisionScheme.getSubdivisionY(e.level)),i=new n.SubTiles(e,1,t),r=i.iterator(),s=new Array;for(let e=0;e<i.length;++e)s.push(r.value),r.next();return s}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(16);t.CameraMovementDetector=class{constructor(e,t,i){this.m_throttlingTimeout=e,this.m_movementStartedFunc=t,this.m_movementFinishedFunc=i,this.m_lastCameraPos=new n.Vector3,this.m_newCameraPos=new n.Vector3,this.m_lastWorldCenter=new n.Vector3,this.m_throttlingTimerId=void 0,this.m_movementDetectorDeadline=0,this.onDeadlineTimer=()=>{this.m_throttlingTimerId=void 0;const e=performance.now();e>=this.m_movementDetectorDeadline?this.movementFinished():this.startMovementFinishedTimer(e)},void 0===this.m_throttlingTimeout&&(this.m_throttlingTimeout=300)}checkCameraMoved(e,t){const i=r.MapViewUtils.extractYawPitchRoll(e.camera.quaternion),n=e.camera.getWorldPosition(this.m_newCameraPos),s=void 0===this.m_lastYawPitchRoll||!this.m_lastCameraPos.equals(n)||!this.m_lastWorldCenter.equals(e.worldCenter)||i.yaw!==this.m_lastYawPitchRoll.yaw||i.pitch!==this.m_lastYawPitchRoll.pitch||i.roll!==this.m_lastYawPitchRoll.roll;return s&&(this.m_lastCameraPos.copy(n),this.m_lastWorldCenter.copy(e.worldCenter),this.m_lastYawPitchRoll=i),s!==this.m_cameraMovedLastFrame&&(s&&this.movementStarted(),this.m_cameraMovedLastFrame=s),s&&(this.m_movementDetectorDeadline=t+this.m_throttlingTimeout,this.startMovementFinishedTimer(t)),this.m_cameraMovedLastFrame}clear(e){const t=e.camera.getWorldPosition(this.m_newCameraPos);this.m_lastCameraPos.set(t.x,t.y,t.z)}forceMoved(){this.m_lastCameraPos.set(Number.NaN,Number.NaN,Number.NaN)}get cameraIsMoving(){return void 0!==this.m_throttlingTimerId}dispose(){this.removeMovementFinishedTimer(),this.m_movementStartedFunc=void 0,this.m_movementFinishedFunc=void 0}get cameraMovedLastFrame(){return!0===this.m_cameraMovedLastFrame}movementStarted(){void 0!==this.m_movementStartedFunc&&this.m_movementStartedFunc()}movementFinished(){this.removeMovementFinishedTimer(),void 0!==this.m_movementFinishedFunc&&this.m_movementFinishedFunc()}startMovementFinishedTimer(e){if(void 0===this.m_throttlingTimerId){const t=Math.max(0,this.m_movementDetectorDeadline-e);this.m_throttlingTimerId=setTimeout(this.onDeadlineTimer,t)}}removeMovementFinishedTimer(){void 0!==this.m_throttlingTimerId&&(clearTimeout(this.m_throttlingTimerId),this.m_throttlingTimerId=void 0)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),r=i(2),s=i(4),o=i(17),a=i(1),l=i(0),c=i(11),h=i(10),d=i(63),u=i(65),m=i(37),p=i(22),f=i(23),g=i(19),_=i(16),v={techniques:[],geometries:[]};t.getFeatureDataSize=function(e){let t=100;return void 0!==e.ids&&(t+=8*e.ids.length),void 0!==e.starts&&(t+=8*e.starts.length),void 0!==e.objInfos&&(t+=16*e.objInfos.length),t},function(e){e[e.Initialized=0]="Initialized",e[e.Loading=1]="Loading",e[e.Loaded=2]="Loaded",e[e.Decoding=3]="Decoding",e[e.Ready=4]="Ready",e[e.Canceled=5]="Canceled",e[e.Failed=6]="Failed"}(t.TileLoaderState||(t.TileLoaderState={}));t.Tile=class{constructor(e,t,i=0){this.dataSource=e,this.tileKey=t,this.offset=i,this.objects=[],this.dependencies=new Array,this.boundingBox=new l.Box3,this.center=new l.Vector3,this.frameNumLastRequested=-1,this.frameNumVisible=-1,this.frameNumLastVisible=-1,this.numFramesVisible=0,this.m_disposed=!1,this.m_forceHasGeometry=void 0,this.m_preparedTextPaths=new Array,this.m_userTextElements=[],this.m_textElementGroups=new a.GroupedPriorityList,this.m_placedTextElements=new a.GroupedPriorityList,this.m_textElementsChanged=!1,this.m_colorMap=new Map,this.m_visibleArea=0,this.m_ownedTextures=new WeakSet,this.geoBox=this.dataSource.getTilingScheme().getGeoBox(this.tileKey),this.projection.projectBox(this.geoBox,this.boundingBox),this.boundingBox.getCenter(this.center)}get isVisible(){return this.frameNumLastRequested===this.dataSource.mapView.frameNumber}get projection(){return this.dataSource.projection}get mapView(){return this.dataSource.mapView}get placedTextElements(){return this.m_placedTextElements}get memoryUsage(){return void 0===this.m_resourceInfo&&this.computeResourceInfo(),this.m_resourceInfo.heapSize}getResourceInfo(){return void 0===this.m_resourceInfo&&this.computeResourceInfo(),this.m_resourceInfo}invalidateResourceInfo(){this.m_resourceInfo=void 0}addOwnedTexture(e){this.m_ownedTextures.add(e)}get userTextElements(){return this.m_userTextElements}addUserTextElement(e){this.m_userTextElements.push(e),this.textElementsChanged=!0}removeUserTextElement(e){const t=this.m_userTextElements.indexOf(e);return t>=0&&(this.m_userTextElements.splice(t,1),this.textElementsChanged=!0,!0)}addTextElement(e){this.textElementGroups.add(e),this.textElementsChanged=!0}removeTextElement(e){return!!this.textElementGroups.remove(e)&&(this.textElementsChanged=!0,!0)}get textElementGroups(){return this.m_textElementGroups}get textElementsChanged(){return this.m_textElementsChanged}set textElementsChanged(e){this.m_textElementsChanged=e}prepareForRender(){if(a.assert(this.isVisible),this.m_disposed||void 0===this.m_decodedTile)return;const e=this.m_decodedTile;if(void 0!==e.tileInfo&&(this.roadIntersectionData=this.dataSource.mapView.pickHandler.registerTile(this)),this.m_decodedTile=void 0,this.m_forceHasGeometry&&this.dataSource.addTileBackground)return this.clear(),void this.addGroundPlane();setTimeout(()=>{const t=m.PerformanceStatistics.instance;if(!this.isVisible)return this.mapView.visibleTileSet.disposeTile(this),void(t.enabled&&t.currentFrame.addMessage(`Decoded tile: ${this.dataSource.name} # lvl=${this.tileKey.level} col=${this.tileKey.column} row=${this.tileKey.row} DISCARDED - invisible`));let i=0;if(t.enabled&&(i=a.PerformanceTimer.now()),this.createGeometries(e),t.enabled){const n=a.PerformanceTimer.now()-i,r=t.currentFrame;r.addValue("geometry.geometryCreationTime",n),r.addValue("geometryCount.numGeometries",e.geometries.length),r.addValue("geometryCount.numTechniques",e.techniques.length),r.addValue("geometryCount.numPoiGeometries",void 0!==e.poiGeometries?e.poiGeometries.length:0),r.addValue("geometryCount.numTextGeometries",void 0!==e.textGeometries?e.textGeometries.length:0),r.addValue("geometryCount.numTextPathGeometries",void 0!==e.textPathGeometries?e.textPathGeometries.length:0),r.addMessage(`Decoded tile: ${this.dataSource.name} # lvl=${this.tileKey.level} col=${this.tileKey.column} row=${this.tileKey.row}`)}this.dataSource.requestUpdate()},0)}willRender(e){return!0}didRender(){}get visibleArea(){return this.m_visibleArea}set visibleArea(e){this.m_visibleArea=e,void 0!==this.tileLoader&&this.tileLoader.updatePriority(e)}createGeometries(e){this.clear(),this.preparePois(e),this.createTextElements(e),this.createObjects(e,this.objects),this.countVertices()}get decodedTile(){return this.m_decodedTile}setDecodedTile(e){this.m_decodedTile=e,this.invalidateResourceInfo();const t=m.PerformanceStatistics.instance;t.enabled&&void 0!==e.decodeTime&&t.currentFrame.addValue("decode.decodingTime",e.decodeTime)}shouldDisposeObjectGeometry(e){return!0}shouldDisposeObjectMaterial(e){return!0}shouldDisposeTexture(e){return this.m_ownedTextures.has(e)}get disposed(){return this.m_disposed}get hasGeometry(){return void 0===this.m_forceHasGeometry?0!==this.objects.length:this.m_forceHasGeometry}forceHasGeometry(e){e&&this.setDecodedTile(v),this.m_forceHasGeometry=e}get tileLoader(){return this.m_tileLoader}set tileLoader(e){this.m_tileLoader=e}reload(){this.dataSource.updateTile(this)}clear(){const e=e=>{Object.getOwnPropertyNames(e).forEach(t=>{const i=e[t];if(void 0!==i&&i instanceof l.Texture){const e=i;this.shouldDisposeTexture(e)&&e.dispose()}}),e.dispose()},t=t=>{void 0!==t.geometry&&this.shouldDisposeObjectGeometry(t)&&t.geometry.dispose(),void 0!==t.material&&this.shouldDisposeObjectMaterial(t)&&(t.material instanceof Array?t.material.forEach(t=>{void 0!==t&&e(t)}):e(t.material))};this.objects.forEach(e=>{e.traverse(e=>{t(e)}),t(e)}),this.objects.length=0,this.m_preparedTextPaths&&(this.m_preparedTextPaths=[]),void 0!==this.m_animatedExtrusionTileHandler&&this.m_animatedExtrusionTileHandler.dispose(),this.placedTextElements.clear(),this.textElementGroups.clear(),this.userTextElements.length=0,this.invalidateResourceInfo()}dispose(){this.m_disposed||(this.m_tileLoader&&(this.m_tileLoader.cancel(),this.m_tileLoader=void 0),this.clear(),this.userTextElements.length=0,this.m_disposed=!0,this.frameNumLastRequested=0)}get preparedTextPaths(){return this.m_preparedTextPaths}prepareTextPaths(e){const t=new Array,i=Math.PI/8,n=e.slice(),r=new l.Vector2,s=new l.Vector2,o=new l.Vector2;for(;n.length>0;){const e=n.pop();if(void 0===e)break;let a=-1;for(let t=0;t<e.path.length-3;t+=3){r.set(e.path[t],e.path[t+1]),s.set(e.path[t+3],e.path[t+4]);const n=s.sub(r).normalize();if(t>0){const e=Math.atan2(o.x*n.y-n.x*o.y,n.dot(o));if(Math.abs(e)>i){a=t;break}}o.set(n.x,n.y)}if(a>0){const i={path:e.path.slice(0,a+3),text:e.text,pathLengthSqr:e.pathLengthSqr,technique:e.technique,featureId:e.featureId};t.push(i);const r={path:e.path.slice(a),text:e.text,pathLengthSqr:e.pathLengthSqr,technique:e.technique,featureId:e.featureId};n.push(r)}else t.push(e)}return t}createTextElements(e){const t=Math.floor(this.mapView.zoomLevel);if(void 0!==e.textPathGeometries){this.m_preparedTextPaths=this.prepareTextPaths(e.textPathGeometries);let i=0;for(const t of this.preparedTextPaths){const r=e.techniques[t.technique];n.isTextTechnique(r)&&(t.pathLengthSqr>i&&(i=t.pathLengthSqr))}for(const r of this.preparedTextPaths){const s=e.techniques[r.technique];if(!n.isTextTechnique(s))continue;const c=[];for(let e=0;e<r.path.length;e+=3)c.push(new l.Vector2(r.path[e],r.path[e+1]));const h=a.getOptionValue(n.getPropertyValue(s.priority,t),0)+(i>0?.1*r.pathLengthSqr/i:0),d=new p.TextElement(o.ContextualArabicConverter.instance.convert(r.text),c,this.getRenderStyle(s),this.getLayoutStyle(s),h,void 0!==s.xOffset?s.xOffset:0,void 0!==s.yOffset?s.yOffset:0,r.featureId,s.style,n.getPropertyValue(s.fadeNear,t),n.getPropertyValue(s.fadeFar,t));d.minZoomLevel=void 0!==s.minZoomLevel?s.minZoomLevel:this.mapView.minZoomLevel,d.maxZoomLevel=void 0!==s.maxZoomLevel?s.maxZoomLevel:this.mapView.maxZoomLevel,d.distanceScale=void 0!==s.distanceScale?s.distanceScale:f.DEFAULT_TEXT_DISTANCE_SCALE,d.mayOverlap=!0===s.mayOverlap,d.reserveSpace=!1!==s.reserveSpace,this.addTextElement(d)}}if(void 0!==e.textGeometries)for(const i of e.textGeometries){if(void 0===i.technique||void 0===i.stringCatalog)continue;const r=e.techniques[i.technique];if(!n.isTextTechnique(r))continue;const s=new l.BufferAttribute(new Float32Array(i.positions.buffer),i.positions.itemCount),c=s.count;if(c<1)continue;const h=a.getOptionValue(n.getPropertyValue(r.priority,t),0);for(let e=0;e<c;++e){const a=s.getX(e),c=s.getY(e),d=i.stringCatalog[i.texts[e]];if(void 0===d)continue;const u=new p.TextElement(o.ContextualArabicConverter.instance.convert(d),new l.Vector2(a,c),this.getRenderStyle(r),this.getLayoutStyle(r),h,r.xOffset||0,r.yOffset||0,i.featureId,r.style);u.minZoomLevel=void 0!==r.minZoomLevel?r.minZoomLevel:this.mapView.minZoomLevel,u.maxZoomLevel=void 0!==r.maxZoomLevel?r.maxZoomLevel:this.mapView.maxZoomLevel,u.mayOverlap=!0===r.mayOverlap,u.reserveSpace=!1!==r.reserveSpace,u.fadeNear=n.getPropertyValue(r.fadeNear,t),u.fadeFar=n.getPropertyValue(r.fadeFar,t),this.addTextElement(u)}}}registerTileObject(e){const t=e.userData||{};t.tileKey=this.tileKey,t.dataSource=this.dataSource.name}createPlane(e,t,i,n,r){const o=new l.PlaneGeometry(e,t,1),a=new s.MapMeshBasicMaterial({color:n,visible:r}),c=new l.Mesh(o,a);return c.position.copy(i),c.renderOrder=Number.MIN_SAFE_INTEGER,c}createObjects(e,t){const i=[],o=this.mapView.zoomLevel;this.dataSource.addTileBackground&&this.addGroundPlane();for(const m of e.geometries){const p=m.groups,f=p.length;for(let g=0;g<f;){const _=p[g++],v=_.start,y=_.technique,x=e.techniques[y];let w=_.count;for(;g<f&&p[g].technique===y&&v+w===p[g].start;++g)w+=p[g].count;const b=d.getObjectConstructor(x);if(void 0===b)continue;let T=i[y];if(void 0===T){const e=e=>{this.dataSource.requestUpdate(),void 0!==e&&this.addOwnedTexture(e)};if(T=d.createMaterial({technique:x,level:Math.floor(o),fog:null!==this.mapView.scene.fog},e),void 0===T)continue;i[y]=T}n.isTerrainTechnique(x)&&void 0!==x.heightBasedColors&&void 0!==x.displacementMap&&(T.onBeforeCompile=e=>{e.fragmentShader=e.fragmentShader.replace("#include <map_pars_fragment>","#include <map_pars_fragment>\n    uniform sampler2D displacementMap;\n    uniform float displacementScale;\n    uniform float displacementBias;"),e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>",`#ifdef USE_MAP\n    float minElevation = ${r.EarthConstants.MIN_ELEVATION.toFixed(1)};\n    float maxElevation = ${r.EarthConstants.MAX_ELEVATION.toFixed(1)};\n    float elevationRange = maxElevation - minElevation;\n\n    float disp = texture2D( displacementMap, vUv ).x * displacementScale + displacementBias;\n    vec4 texelColor = texture2D( map, vec2((disp - minElevation) / elevationRange, 0.0) );\n    texelColor = mapTexelToLinear( texelColor );\n    diffuseColor *= texelColor;\n#endif`)});const S=new l.BufferGeometry;if(m.vertexAttributes.forEach(e=>{const t=d.getBufferAttribute(e);S.addAttribute(e.name,t)}),void 0!==m.interleavedVertexAttributes&&m.interleavedVertexAttributes.forEach(e=>{const t=n.getArrayConstructor(e.type),i=new l.InterleavedBuffer(new t(e.buffer),e.stride);e.attributes.forEach(e=>{const t=new l.InterleavedBufferAttribute(i,e.itemSize,e.offset,!1);S.addAttribute(e.name,t)})}),m.index&&S.setIndex(d.getBufferAttribute(m.index)),!S.getAttribute("normal")&&n.needsVertexNormals(x)&&S.computeVertexNormals(),S.addGroup(v,w),n.isSolidLineTechnique(x)||n.isDashedLineTechnique(x)){const e=T;if(e.uniforms.opacity.value=T.opacity,!1!==x.clipping){const t=e.uniforms.tileSize,i=new l.Vector3;this.boundingBox.getSize(i),t.value.x=i.x,t.value.y=i.y,e.defines.TILE_CLIP=1}}const C=n.isExtrudedPolygonTechnique(x)&&void 0!==m.edgeIndex,E=n.isFillTechnique(x)&&void 0!==m.edgeIndex;(C||E)&&(T.polygonOffset=!0,T.polygonOffsetFactor=.75,T.polygonOffsetUnits=4);const M=n.isSolidLineTechnique(x)&&void 0!==x.secondaryWidth,A=new b(S,T);if(A.frustumCulled=!1,A.renderOrder=x.renderOrder,void 0!==_.renderOrderOffset&&(A.renderOrder+=_.renderOrderOffset),void 0!==m.uuid&&(A.userData.geometryId=m.uuid),(n.isCirclesTechnique(x)||n.isSquaresTechnique(x))&&void 0!==x.enablePicking&&(A.enableRayTesting=x.enablePicking),n.isSolidLineTechnique(x)||n.isDashedLineTechnique(x)){const e=this.getFadingParams(x);s.FadingFeature.addRenderHelper(A,e.fadeNear,e.fadeFar,!0,!1,(e,t)=>{const i=t,r="Pixel"===n.getPropertyValue(x.metricUnit,this.tileKey.level)?.5*this.mapView.pixelToWorld:1;if(i.lineWidth=a.getOptionValue(n.getPropertyValue(x.lineWidth,this.mapView.zoomLevel),s.SolidLineMaterial.DEFAULT_WIDTH)*r,n.isDashedLineTechnique(x)){const e=i;e.dashSize=a.getOptionValue(n.getPropertyValue(x.dashSize,this.mapView.zoomLevel),s.DashedLineMaterial.DEFAULT_DASH_SIZE)*r,e.gapSize=a.getOptionValue(n.getPropertyValue(x.gapSize,this.mapView.zoomLevel),s.DashedLineMaterial.DEFAULT_GAP_SIZE)*r}})}if(n.isExtrudedLineTechnique(x)&&void 0!==x.fadeFar){const e=this.getFadingParams(x);s.FadingFeature.addRenderHelper(A,e.fadeNear,e.fadeFar,!0,!0)}if(this.addFeatureData(m,x,A),(n.isExtrudedPolygonTechnique(x)||n.isFillTechnique(x))&&void 0!==x.fadeFar){const e=this.getFadingParams(x);s.FadingFeature.addRenderHelper(A,e.fadeNear,e.fadeFar,!0,!0)}const P=[],L=this.mapView.animatedExtrusionHandler;let R=!1;if(n.isExtrudedPolygonTechnique(x)&&void 0!==L&&(R=void 0!==x.animateExtrusion&&!1===L.forceEnabled?x.animateExtrusion:L.enabled),n.isExtrudedPolygonTechnique(x)&&u.isRenderDepthPrePassEnabled(x)){const e=u.createDepthPrePassMesh(A);t.push(e),R&&P.push({object:e,materialFeature:!0}),u.setDepthPrePassStencil(e,A)}if(this.registerTileObject(A),t.push(A),C){const e=new l.BufferGeometry;e.addAttribute("position",S.getAttribute("position"));const i=S.getAttribute("color");void 0!==i&&e.addAttribute("color",i),e.setIndex(d.getBufferAttribute(m.edgeIndex));const n=x,r=this.getPolygonFadingParams(n),o={color:r.color,colorMix:r.colorMix,fadeNear:r.lineFadeNear,fadeFar:r.lineFadeFar},a=new s.EdgeMaterial(o),c=new l.LineSegments(e,a);c.renderOrder=A.renderOrder+.1,s.FadingFeature.addRenderHelper(c,r.lineFadeNear,r.lineFadeFar,!1,!1),R&&P.push({object:c,materialFeature:!1}),this.registerTileObject(c),t.push(c)}if(n.isExtrudedPolygonTechnique(x)&&R){P.push({object:A,materialFeature:!0});const e=void 0!==x.animateExtrusionDuration&&!1===L.forceEnabled?x.animateExtrusionDuration:L.duration;this.m_animatedExtrusionTileHandler=new c.AnimatedExtrusionTileHandler(this,P,e),this.mapView.animatedExtrusionHandler.add(this.m_animatedExtrusionTileHandler)}if(E){const e=m.edgeIndex;for(const i of e){const e=new l.BufferGeometry;e.addAttribute("position",S.getAttribute("position")),e.setIndex(d.getBufferAttribute(i));const n=x,r=this.getPolygonFadingParams(n),o={color:r.color,colorMix:r.colorMix,fadeNear:r.lineFadeNear,fadeFar:r.lineFadeFar},a=new s.EdgeMaterial(o),c=new l.LineSegments(e,a);c.renderOrder=A.renderOrder+.1,s.FadingFeature.addRenderHelper(c,r.lineFadeNear,r.lineFadeFar,!0,!1),this.registerTileObject(c),t.push(c)}}if(M){const e=x,i=T.clone(),r=h.ColorCache.instance.getColor(a.getOptionValue(n.getPropertyValue(e.secondaryColor,Math.floor(this.mapView.zoomLevel)),"#000000"));i.uniforms.diffuse.value=r;const o=new b(S,i);o.renderOrder=void 0!==e.secondaryRenderOrder?e.secondaryRenderOrder:x.renderOrder-1e-7,void 0!==_.renderOrderOffset&&(o.renderOrder+=_.renderOrderOffset);const l=this.getFadingParams(x);s.FadingFeature.addRenderHelper(o,l.fadeNear,l.fadeFar,!0,!1,(t,i)=>{const r=i,o="Pixel"===n.getPropertyValue(e.metricUnit,this.tileKey.level)?.5*this.mapView.pixelToWorld:1;r.lineWidth=a.getOptionValue(n.getPropertyValue(e.secondaryWidth,this.mapView.zoomLevel),s.SolidLineMaterial.DEFAULT_WIDTH)*o}),this.registerTileObject(o),t.push(o)}}}}countVertices(){let e=0;return this.objects.filter(e=>e instanceof l.Mesh).forEach(t=>{const i=t;i.geometry instanceof l.BufferGeometry&&(void 0!==i.geometry.index&&null!==i.geometry.index?e+=i.geometry.index.count:e+=i.geometry.getAttribute("position").count/3),i.geometry instanceof l.Geometry&&(e=i.geometry.vertices.length)}),e}preparePois(e){void 0!==e.poiGeometries&&this.mapView.poiManager.addPois(this,e)}getRenderStyle(e){const t=g.computeStyleCacheId(this.dataSource.name,e,this.mapView.zoomLevel);let i=this.mapView.textRenderStyleCache.get(t);if(void 0===i){const r=void 0!==this.mapView.textElementsRenderer?this.mapView.textElementsRenderer.defaultStyle.renderParams:{fontSize:{unit:o.FontUnit.Pixel,size:32,backgroundSize:8}},s=a.getOptionValue(n.getPropertyValue(e.size,Math.floor(this.mapView.zoomLevel)),r.fontSize.size),l=a.getOptionValue(n.getPropertyValue(e.backgroundSize,Math.floor(this.mapView.zoomLevel)),r.fontSize.backgroundSize),c=n.getPropertyValue(e.color,Math.floor(this.mapView.zoomLevel));void 0!==c&&this.m_colorMap.set(t,h.ColorCache.instance.getColor(c));const d=a.getOptionValue(this.m_colorMap.get(t),r.color),u=n.getPropertyValue(e.backgroundColor,Math.floor(this.mapView.zoomLevel));void 0!==u&&this.m_colorMap.set(t+"_bg",h.ColorCache.instance.getColor(u));const m=a.getOptionValue(this.m_colorMap.get(t+"_bg"),r.backgroundColor),p=a.getOptionValue(n.getPropertyValue(e.backgroundAlpha,Math.floor(this.mapView.zoomLevel)),r.backgroundOpacity),f=!0===e.smallCaps||r.fontVariant===o.FontVariant.SmallCaps,g=!0===e.allCaps||r.fontVariant===o.FontVariant.AllCaps,_=f?o.FontVariant.SmallCaps:g?o.FontVariant.AllCaps:void 0,v=!0===e.bold?e.oblique?o.FontStyle.BoldItalic:o.FontStyle.Bold:!0===e.oblique?o.FontStyle.Italic:r.fontStyle,y={fontSize:{unit:o.FontUnit.Pixel,size:s,backgroundSize:l},color:d,backgroundColor:m,backgroundOpacity:p,fontVariant:_,fontStyle:v},x=void 0!==this.mapView.textElementsRenderer?this.mapView.textElementsRenderer.getTextElementStyle(e.style).renderParams:{};i=new o.TextRenderStyle(Object.assign({},x,y)),this.mapView.textRenderStyleCache.set(t,i)}return i}getLayoutStyle(e){const t=g.computeStyleCacheId(this.dataSource.name,e,this.mapView.zoomLevel);let i=this.mapView.textLayoutStyleCache.get(t);if(void 0===i){const n=void 0!==this.mapView.textElementsRenderer?this.mapView.textElementsRenderer.defaultStyle.layoutParams:{},r=a.getOptionValue(e.tracking,n.tracking);let s=n.horizontalAlignment;"Left"!==e.hAlignment&&"Center"!==e.hAlignment&&"Right"!==e.hAlignment||(s=o.HorizontalAlignment[e.hAlignment]);let l=n.verticalAlignment;"Above"!==e.vAlignment&&"Center"!==e.vAlignment&&"Below"!==e.vAlignment||(l=o.VerticalAlignment[e.vAlignment]);const c={tracking:r,horizontalAlignment:s,verticalAlignment:l},h=void 0!==this.mapView.textElementsRenderer?this.mapView.textElementsRenderer.getTextElementStyle(e.style).layoutParams:{};i=new o.TextLayoutStyle(Object.assign({},h,c)),this.mapView.textLayoutStyleCache.set(t,i)}return i}computeResourceInfo(){let e=0,t=0,i=0,n=0;const r={heapSize:0,gpuSize:0},s=new Map;for(const e of this.objects)e.visible&&t++,_.MapViewUtils.estimateObject3dSize(e,r,s);for(const e of this.textElementGroups.groups)i+=e[1].elements.length;n=this.userTextElements.length,e+=312*(i+n),void 0!==this.m_decodedTile&&void 0!==this.m_decodedTile.tileInfo&&(r.heapSize+=this.m_decodedTile.tileInfo.numBytes),void 0!==this.roadIntersectionData&&(e+=function(e){let t=100;const i=e.techniqueIndex.length;return t+=132*e.techniqueIndex.length,void 0!==e.ids&&(t+=8*i),void 0!==e.objInfos&&(t+=16*i),t}(this.roadIntersectionData)),this.m_resourceInfo={heapSize:r.heapSize+e,gpuSize:r.gpuSize,num3dObjects:t,numTextElements:i,numUserTextElements:n}}addFeatureData(e,t,i){if((void 0!==e.featureIds&&e.featureIds.length>0||n.isCirclesTechnique(t)||n.isSquaresTechnique(t))&&!n.isSolidLineTechnique(t)&&!n.isDashedLineTechnique(t)){const t={geometryType:e.type,ids:e.featureIds,starts:e.featureStarts};i.userData.feature=t,void 0!==e.objInfos&&(i.userData.feature.objInfos=e.objInfos)}}getFadingParams(e){const t=this.mapView.zoomLevel;return{fadeNear:void 0!==e.fadeNear?n.getPropertyValue(e.fadeNear,t):s.FadingFeature.DEFAULT_FADE_NEAR,fadeFar:void 0!==e.fadeFar?n.getPropertyValue(e.fadeFar,t):s.FadingFeature.DEFAULT_FADE_FAR}}getPolygonFadingParams(e){let t=s.EdgeMaterial.DEFAULT_COLOR,i=s.EdgeMaterial.DEFAULT_COLOR_MIX;if(void 0!==e.lineColor&&(t=e.lineColor,n.isExtrudedPolygonTechnique(e))){const t=e;i=void 0!==t.lineColorMix?t.lineColorMix:s.EdgeMaterial.DEFAULT_COLOR_MIX}const r=this.mapView.zoomLevel,o=void 0!==e.fadeNear?n.getPropertyValue(e.fadeNear,r):s.FadingFeature.DEFAULT_FADE_NEAR,a=void 0!==e.fadeFar?n.getPropertyValue(e.fadeFar,r):s.FadingFeature.DEFAULT_FADE_FAR;return{color:t,colorMix:i,fadeNear:o,fadeFar:a,lineFadeNear:void 0!==e.lineFadeNear?n.getPropertyValue(e.lineFadeNear,r):o,lineFadeFar:void 0!==e.lineFadeFar?n.getPropertyValue(e.lineFadeFar,r):a}}addGroundPlane(){const e=new l.Vector3;this.boundingBox.getSize(e);const t=this.createPlane(e.x,e.y,this.center,void 0===this.dataSource.tileBackgroundColor?this.mapView.clearColor:this.dataSource.tileBackgroundColor,this.dataSource.tileBackgroundIsVisible);this.registerTileObject(t),this.objects.push(t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.TileSpace="tile-space",e.EquirectangularSpace="equirectangular-space"}(t.TextureCoordinateType||(t.TextureCoordinateType={})),function(e){e.Show="show-in-stack",e.Hide="hide-in-stack",e.ShowParent="show-parent"}(t.PoiStackMode||(t.PoiStackMode={})),t.isTextureBuffer=function(e){return e&&e.buffer&&"string"==typeof e.type}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(2),r=i(0),s=[r.DiscreteInterpolant,r.LinearInterpolant,r.CubicInterpolant];function o(e){return void 0!==e&&e.values instanceof Array&&e.values.length>0&&void 0!==e.values[0]&&e.zoomLevels instanceof Array&&e.zoomLevels.length>0&&void 0!==e.zoomLevels[0]&&e.values.length===e.zoomLevels.length}function a(e){return void 0!==e&&void 0!==e.interpolationMode&&void 0!==e.zoomLevels&&void 0!==e.values&&e.values.length>0&&(e.zoomLevels.length===e.values.length/3||e.zoomLevels.length===e.values.length)}t.getPropertyValue=function(e,t){if(a(e)){const i=e.values.length/e.zoomLevels.length,r=i>1,o=new s[e.interpolationMode](e.zoomLevels,e.values,i);o.evaluate(t);let a=r?"#":0;for(const e of o.resultBuffer){a+=r?("0"+(255*n.MathUtils.clamp(e,0,1)|0).toString(16)).slice(-2):e}return a}if(o(e))throw new Error("Invalid property definition");return e},t.isInterpolatedPropertyDefinition=o,t.isInterpolatedProperty=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Discrete=0]="Discrete",e[e.Linear=1]="Linear",e[e.Cubic=2]="Cubic"}(t.InterpolationMode||(t.InterpolationMode={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r={sdf_attributes:"\n        attribute vec4 position;\n        attribute vec4 uv;\n        attribute vec4 color;\n        attribute vec4 bgColor;\n        ",sdf_varying:"\n        varying vec4 vColor;\n        varying float vWeight;\n        varying vec2 vUv;\n        varying float vRotation;\n        ",sdf_varying_computation:"\n        #if BG_TEXT\n        vColor = bgColor;\n        vWeight = uv.w;\n        #else\n        vColor = color;\n        vWeight = uv.z;\n        #endif\n        vUv = vec2(uv.xy);\n        vRotation = position.w;\n        ",sdf_frag_uniforms:"\n        uniform sampler2D sdfTexture;\n        uniform vec4 sdfParams;\n        ",sdf_sampling_functions:"\n        float median(float r, float g, float b) {\n            return max(min(r, g), min(max(r, g), b));\n        }\n\n        float getDistance(vec2 uvOffset) {\n            vec3 sample = texture2D(sdfTexture, vUv.xy + uvOffset).rgb;\n            #if MSDF\n            return median(sample.r, sample.g, sample.b);\n            #else\n            return sample.r;\n            #endif\n        }\n\n        float getOpacity(vec2 uvOffset, float weight) {\n            vec2 uv = vUv + uvOffset;\n            vec2 rotatedUVs = abs(vec2(\n                cos(vRotation) * uv.x - sin(vRotation) * uv.y,\n                sin(vRotation) * uv.x + cos(vRotation) * uv.y));\n\n            float dx = dFdx(rotatedUVs.x) * sdfParams.x;\n            float dy = dFdy(rotatedUVs.y) * sdfParams.y;\n            float toPixels = sdfParams.w * inversesqrt( dx * dx + dy * dy );\n\n            float dist = getDistance(uvOffset) + min(weight, 0.5 - 1.0 / sdfParams.w) - 0.5;\n            return clamp(dist * toPixels + 0.5, 0.0, 1.0);\n        }\n        "};Object.assign(n.ShaderChunk,r);class s extends n.RawShaderMaterial{constructor(){super({name:"GlyphClearMaterial",vertexShader:"\n    attribute vec2 position;\n\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n\n    void main() {\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xy, 0.0, 1.0);\n    }",fragmentShader:"\n    precision highp float;\n    precision highp int;\n\n    void main() {\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n    }",uniforms:{},depthTest:!1,depthWrite:!1})}}t.GlyphClearMaterial=s;class o extends n.RawShaderMaterial{constructor(){super({name:"GlyphCopyMaterial",vertexShader:"\n    attribute vec3 position;\n    attribute vec2 uv;\n\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n\n    varying vec3 vUv;\n\n    void main() {\n        vUv = vec3(uv.xy, position.z);\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xy, 0.0, 1.0);\n    }",fragmentShader:"\n    precision highp float;\n    precision highp int;\n\n    uniform float pageOffset;\n    uniform sampler2D page0;\n    uniform sampler2D page1;\n    uniform sampler2D page2;\n    uniform sampler2D page3;\n    uniform sampler2D page4;\n    uniform sampler2D page5;\n    uniform sampler2D page6;\n    uniform sampler2D page7;\n\n    varying vec3 vUv;\n\n    void main() {\n        vec4 sample = vec4(0.0);\n        if (vUv.z < pageOffset || vUv.z > (pageOffset + 7.0)) discard;\n        else if (vUv.z < pageOffset + 1.0) sample = texture2D(page0, vUv.xy);\n        else if (vUv.z < pageOffset + 2.0) sample = texture2D(page1, vUv.xy);\n        else if (vUv.z < pageOffset + 3.0) sample = texture2D(page2, vUv.xy);\n        else if (vUv.z < pageOffset + 4.0) sample = texture2D(page3, vUv.xy);\n        else if (vUv.z < pageOffset + 5.0) sample = texture2D(page4, vUv.xy);\n        else if (vUv.z < pageOffset + 6.0) sample = texture2D(page5, vUv.xy);\n        else if (vUv.z < pageOffset + 7.0) sample = texture2D(page6, vUv.xy);\n        else sample = texture2D(page7, vUv.xy);\n\n        gl_FragColor = sample;\n    }",uniforms:{pageOffset:new n.Uniform(0),page0:new n.Uniform(n.Texture.DEFAULT_IMAGE),page1:new n.Uniform(n.Texture.DEFAULT_IMAGE),page2:new n.Uniform(n.Texture.DEFAULT_IMAGE),page3:new n.Uniform(n.Texture.DEFAULT_IMAGE),page4:new n.Uniform(n.Texture.DEFAULT_IMAGE),page5:new n.Uniform(n.Texture.DEFAULT_IMAGE),page6:new n.Uniform(n.Texture.DEFAULT_IMAGE),page7:new n.Uniform(n.Texture.DEFAULT_IMAGE)},depthTest:!1,depthWrite:!1})}}t.GlyphCopyMaterial=o;class a extends n.RawShaderMaterial{constructor(e){super({name:"SdfTextMaterial",vertexShader:void 0!==e.vertexSource?e.vertexSource:"\n    #include <sdf_attributes>\n    #include <sdf_varying>\n\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n\n    void main() {\n        #include <sdf_varying_computation>\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xyz, 1.0);\n    }",fragmentShader:void 0!==e.fragmentSource?e.fragmentSource:"\n    precision highp float;\n    precision highp int;\n\n    #include <sdf_varying>\n    #include <sdf_frag_uniforms>\n    #include <sdf_sampling_functions>\n\n    void main() {\n        vec4 color = vColor;\n        color.a *= getOpacity(vec2(0.0), vWeight);\n        if (color.a < 0.05) {\n            discard;\n        }\n        gl_FragColor = color;\n    }",uniforms:{sdfTexture:new n.Uniform(e.texture),sdfParams:new n.Uniform(new n.Vector4(e.textureSize.x,e.textureSize.y,e.size,e.distanceRange))},defines:{MSDF:e.isMsdf?1:0,BG_TEXT:e.isBackground?1:0},depthTest:!0,depthWrite:!0,side:n.DoubleSide,transparent:!0}),this.extensions.derivatives=!0}}t.SdfTextMaterial=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.TextBufferObject=class{constructor(e,t,i,n,r,s){this.glyphs=e,this.buffer=t,this.bounds=i,this.characterBounds=n,this.textRenderStyle=r,this.textLayoutStyle=s}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(60);t.createSdfTextMaterial=function(e){return new n.SdfTextMaterial({texture:e.fontCatalog.texture,textureSize:e.fontCatalog.textureSize,size:e.fontCatalog.size,distanceRange:e.fontCatalog.distanceRange,isMsdf:"msdf"===e.fontCatalog.type,isBackground:!0===e.isBackground,vertexSource:e.vertexSource,fragmentSource:e.fragmentSource})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),r=i(4),s=i(1),o=i(0),a=i(36),l=i(64),c=s.LoggerManager.instance.create("DecodedTileHelpers"),h=[...n.TEXTURE_PROPERTY_KEYS,"mapProperties","normalMapProperties","displacementMapProperties","roughnessMapProperties","emissiveMapProperties","alphaMapProperties","metalnessMapProperties","bumpMapProperties"];function d(e){if(void 0!==e.name)switch(e.name){case"extruded-line":if(!n.isExtrudedLineTechnique(e))throw new Error("Invalid extruded-line technique");return"standard"===e.shading?r.MapMeshStandardMaterial:r.MapMeshBasicMaterial;case"standard":case"terrain":case"extruded-polygon":return r.MapMeshStandardMaterial;case"solid-line":return r.SolidLineMaterial;case"dashed-line":return r.DashedLineMaterial;case"fill":return r.MapMeshBasicMaterial;case"squares":return o.PointsMaterial;case"circles":return r.CirclePointsMaterial;case"line":case"segments":return o.LineBasicMaterial;case"shader":return o.ShaderMaterial;case"text":case"labeled-icon":case"line-marker":return}}function u(e,i,r,s){Object.getOwnPropertyNames(e).forEach(a=>{if(a.startsWith("_")||-1!==t.BASE_TECHNIQUE_NON_MATERIAL_PROPS.indexOf(a)||-1!==h.indexOf(a)||void 0!==s&&-1!==s.indexOf(a))return;const l=a,c=i;let d=e[l];void 0!==c[l]&&(void 0!==r&&n.isInterpolatedProperty(d)&&(d=n.getPropertyValue(d,r)),c[l]instanceof o.Color?c[l].set(d):c[l]=d)})}t.createMaterial=function(e,t){const i=e.technique,s=d(i),a={};if(void 0===s)return;s.prototype instanceof o.RawShaderMaterial&&s!==r.HighPrecisionLineMaterial&&(a.fog=e.fog);const h=new s(a);if(void 0!==i.id&&(h.name=i.id),n.isExtrudedPolygonTechnique(i)&&(h.flatShading=!0),h.depthTest=n.isExtrudedPolygonTechnique(i)&&!1!==i.depthTest,(n.isStandardTechnique(i)||n.isTerrainTechnique(i)||n.isExtrudedPolygonTechnique(i))&&n.TEXTURE_PROPERTY_KEYS.forEach(e=>{const r=i[e];if(void 0===r)return;const s=n=>{const r=i[e+"Properties"];void 0!==r&&(void 0!==r.wrapS&&(n.wrapS=l.toWrappingMode(r.wrapS)),void 0!==r.wrapT&&(n.wrapT=l.toWrappingMode(r.wrapT)),void 0!==r.magFilter&&(n.magFilter=l.toTextureFilter(r.magFilter)),void 0!==r.minFilter&&(n.minFilter=l.toTextureFilter(r.minFilter)),void 0!==r.flipY&&(n.flipY=r.flipY),void 0!==r.repeatU&&(n.repeat.x=r.repeatU),void 0!==r.repeatV&&(n.repeat.y=r.repeatV)),h[e]=n,n.needsUpdate=!0,h.needsUpdate=!0,t&&t(n)},a=e=>{c.error("#createMaterial: Failed to load texture: ",e)};let d;if("string"==typeof r)d=r;else if(n.isTextureBuffer(r))if("image/raw"===r.type){const e=r.dataTextureProperties;if(void 0!==e){s(new o.DataTexture(r.buffer,e.width,e.height,e.format?l.toPixelFormat(e.format):void 0,e.type?l.toTextureDataType(e.type):void 0))}else a("no data texture properties provided.")}else{const e=new Blob([r.buffer],{type:r.type});d=URL.createObjectURL(e)}d&&(new o.TextureLoader).load(d,s,void 0,a)}),n.isShaderTechnique(i)){const e=i.params;Object.getOwnPropertyNames(e).forEach(t=>{const i=t;if("name"===i)return;const n=h;n[i]instanceof o.Color?n[i].set(e[i]):n[i]=e[i]})}else u(i,h,e.level,e.skipExtraProps);return h},t.getBufferAttribute=function(e){switch(e.type){case"float":return new o.BufferAttribute(new Float32Array(e.buffer),e.itemCount);case"uint16":return new o.BufferAttribute(new Uint16Array(e.buffer),e.itemCount);case"uint32":return new o.BufferAttribute(new Uint32Array(e.buffer),e.itemCount);default:throw new Error("unsupported buffer of type "+e.type)}},t.getObjectConstructor=function(e){if(void 0!==e.name)switch(e.name){case"extruded-line":case"standard":case"terrain":case"extruded-polygon":case"fill":case"solid-line":case"dashed-line":return o.Mesh;case"circles":return a.Circles;case"squares":return a.Squares;case"line":case"segments":return o.LineSegments;case"shader":if(!n.isShaderTechnique(e))throw new Error("Invalid technique");switch(e.primitive){case"line":return o.Line;case"segments":return o.LineSegments;case"point":return o.Points;case"mesh":return o.Mesh;default:return}case"text":case"labeled-icon":case"line-marker":return}},t.BASE_TECHNIQUE_NON_MATERIAL_PROPS=["name","id","renderOrder","renderOrderBiasProperty","renderOrderBiasGroup","renderOrderBiasRange","transient"],t.getMaterialConstructor=d,t.applyTechniqueToMaterial=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);t.toPixelFormat=function(e){switch(e){case"Alpha":return n.AlphaFormat;case"RGB":return n.RGBFormat;case"RGBA":return n.RGBAFormat;case"Luminance":return n.LuminanceFormat;case"LuminanceAlpha":return n.LuminanceAlphaFormat;case"RGBE":return n.RGBEFormat;case"Depth":return n.DepthFormat;case"DepthStencil":return n.DepthStencilFormat;case"Red":return n.RedFormat;default:throw new Error("invalid pixel format: "+e)}},t.toTextureDataType=function(e){switch(e){case"UnsignedByte":return n.UnsignedByteType;case"Byte":return n.ByteType;case"Short":return n.ShortType;case"UnsignedShort":return n.UnsignedShortType;case"Int":return n.IntType;case"UnsignedInt":return n.UnsignedIntType;case"Float":return n.FloatType;case"HalfFloat":return n.HalfFloatType;default:throw new Error("invalid texture data type: "+e)}},t.toWrappingMode=function(e){switch(e){case"clamp":return n.ClampToEdgeWrapping;case"repeat":return n.RepeatWrapping;case"mirror":return n.MirroredRepeatWrapping;default:throw new Error("invalid wrapping mode: "+e)}},t.toTextureFilter=function(e){switch(e){case"nearest":return n.NearestFilter;case"nearestMipMapNearest":return n.NearestMipMapNearestFilter;case"nearestMipMapLinear":return n.NearestMipMapLinearFilter;case"linear":return n.LinearFilter;case"linearMipMapNearest":return n.LinearMipMapNearestFilter;case"linearMipMapLinear":return n.LinearMipMapLinearFilter;default:throw new Error("invalid texture filter: "+e)}},t.createLight=function(e){switch(e.type){case"ambient":{const t=new n.AmbientLight(e.color,e.intensity);return t.name=e.name,t}case"directional":{const t=new n.DirectionalLight(e.color,e.intensity);return t.name=e.name,void 0!==e.castShadow&&(t.castShadow=e.castShadow),t.position.set(e.direction.x,e.direction.y,e.direction.z),t.position.normalize(),t}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(0);function s(e){e.depthWrite=!1,e.depthFunc=r.EqualDepth,e.colorWrite=!0,e.transparent=!0;const t=e.clone();return t.depthWrite=!0,t.depthTest=!0,t.depthFunc=r.LessDepth,t.colorWrite=!1,t.transparent=!1,t.opacity=1,t}t.DEPTH_PRE_PASS_STENCIL_MASK=1,t.isRenderDepthPrePassEnabled=function(e){return!1!==e.enableDepthPrePass&&void 0!==e.opacity&&e.opacity>0&&e.opacity<1},t.createDepthPrePassMaterial=s,t.createDepthPrePassMesh=function(e){const t=e.geometry;if(!(t instanceof r.BufferGeometry))throw new Error("#createDepthPassMesh only BufferGeometry is supported");const i=t.getAttribute("position");if(!i)throw new Error("#createDepthPassMesh position attribute not found");const n=new r.BufferGeometry;n.addAttribute("position",i);const o=t.getAttribute("uv");o&&n.addAttribute("uv",o),t.index&&n.setIndex(t.index);for(const e of t.groups){const{start:t,count:i,materialIndex:r}=e;n.addGroup(t,i,r)}const a=e.material instanceof Array?e.material.map(s):s(e.material),l=new r.Mesh(n,a);return l.renderOrder=e.renderOrder,l},t.setDepthPrePassStencil=function(e,i){e.onBeforeRender=n.chainCallbacks(e.onBeforeRender,(e,i,n,r,s,o)=>{const a=e.context;e.state.buffers.stencil.setTest(!0),e.state.buffers.stencil.setMask(t.DEPTH_PRE_PASS_STENCIL_MASK),e.state.buffers.stencil.setOp(a.KEEP,a.KEEP,a.REPLACE),e.state.buffers.stencil.setFunc(a.ALWAYS,255,t.DEPTH_PRE_PASS_STENCIL_MASK)}),i.onBeforeRender=n.chainCallbacks(i.onBeforeRender,(e,i,n,r,s,o)=>{const a=e.context;e.state.buffers.stencil.setTest(!0),e.state.buffers.stencil.setMask(t.DEPTH_PRE_PASS_STENCIL_MASK),e.state.buffers.stencil.setOp(a.KEEP,a.KEEP,a.ZERO),e.state.buffers.stencil.setFunc(a.EQUAL,255,t.DEPTH_PRE_PASS_STENCIL_MASK)}),e.onAfterRender=e=>{e.state.buffers.stencil.setTest(!1),e.state.buffers.stencil.setMask(255)},i.onAfterRender=e=>{e.state.buffers.stencil.setTest(!1),e.state.buffers.stencil.setMask(255)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r="undefined"==typeof window;class s extends n.EventDispatcher{constructor(e){super(),this.value=e}set(e,t){this.value=e,this.dispatchEvent({type:s.SET_EVENT_TYPE,name:t,value:e})}}s.SET_EVENT_TYPE="set";class o{constructor(){if(this.m_optionsMap=new Map,!r&&"undefined"!=typeof window&&window){window.__debugContext=this}}setValue(e,t){let i=this.m_optionsMap.get(e);i?i.set(t,e):(i=new s(t),this.m_optionsMap.set(e,i))}getValue(e){const t=this.m_optionsMap.get(e);return t?t.value:void 0}hasOption(e){return void 0!==this.m_optionsMap.get(e)}addEventListener(e,t){const i=this.m_optionsMap.get(e);if(!i)throw Error("Unknown option: "+e);i.addEventListener(s.SET_EVENT_TYPE,t)}hasEventListener(e,t){const i=this.m_optionsMap.get(e);if(i)return i.hasEventListener(s.SET_EVENT_TYPE,t);throw Error("Unknown option: "+e)}removeEventListener(e,t){const i=this.m_optionsMap.get(e);if(!i)throw Error("Unknown option: "+e);i.removeEventListener(s.SET_EVENT_TYPE,t)}get options(){return this.m_optionsMap}clear(){this.m_optionsMap.forEach(e=>{e.set(void 0,"")})}}t.DebugContext=o,t.debugContext=new o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),r=i(4),s=i(1),o=i(24),a=s.LoggerManager.instance.create("RoadPicker");t.RoadPicker=class{constructor(e){this.m_mapView=e}registerTile(e){if(s.assert(void 0!==e.decodedTile),void 0===e.decodedTile||void 0===e.decodedTile.tileInfo)return;const t=e.decodedTile.tileInfo,i=t.lineGroup;if(void 0===i||0===i.numFeatures)return;const n=[];n.length=i.numFeatures;const r=e.tileKey.level;for(let e=0;e<i.numFeatures;e++){const s=t.techniqueCatalog[i.techniqueIndex[e]],o=this.getLineWidthInWorldUnit(s,r);n[e]=void 0!==o?Math.max(1,o):1}const o=t.lineGroup.userData;return{ids:i.featureIds,techniqueIndex:i.techniqueIndex,starts:i.positionIndex,widths:n,positions:i.positions,techniques:t.techniqueCatalog,objInfos:o}}intersectRoads(e,t,i,n){if(e.boundingBox.distanceToPoint(i)>.01)return!1;const r=e.roadIntersectionData;if(void 0===r)return!1;const l=r.ids,c=r.techniques,h=r.techniqueIndex,d=l.length,u=r.positions,m=r.widths,p=i.x-e.center.x,f=i.y-e.center.y,g=i.distanceTo(t);if(m.length!==l.length||l.length!==h.length||h.length!==r.starts.length)return a.error("The amount of widths, ids, techniqueIndices and starts has to be the same"),!1;for(let e=0;e<d;e++){const t=c[h[e]];if(!0===t.transient)continue;const a=r.starts[e],_=e<d-1?r.starts[e+1]:r.positions.length;let v=u[a],y=u[a+1];const x=m[e]*m[e];let w=Number.MAX_VALUE;for(let e=a+2;e<_;e+=2){const t=u[e],i=u[e+1],n=s.Math2D.distToSegmentSquared(p,f,v,y,t,i);n<x&&n<w&&(w=n),v=t,y=i}if(w<Number.MAX_VALUE){const s={type:o.PickObjectType.Line,point:i,distance:g,distFromCenter:Math.sqrt(w),featureId:l[e],positions:u.slice(a,_),technique:t};this.addUserData(s,e,r.objInfos),n.push(s)}}return!1}addUserData(e,t,i){void 0!==i&&i.length>0&&(e.userData=Object.assign({},i[t]))}getLineWidthInWorldUnit(e,t){const i=e;if("Pixel"===n.getPropertyValue(i.metricUnit,t)){const e=this.m_mapView.renderer.getPixelRatio()*this.m_mapView.pixelToWorld*.5,s=n.getPropertyValue(i.lineWidth,t);return(void 0!==s?s:r.SolidLineMaterial.DEFAULT_WIDTH)*e}{const i=e;return n.getPropertyValue(i.lineWidth,t)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.TopLeft=0]="TopLeft",e[e.BottomLeft=1]="BottomLeft"}(t.ImageOrigin||(t.ImageOrigin={}));t.IconTexture=class{constructor(e){this.image=e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i(142);t.MapRenderingManager=n.MapRenderingManager;var r=i(38);t.Pass=r.Pass;var s=i(70);t.MSAARenderPass=s.MSAARenderPass,t.MSAASampling=s.MSAASampling},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),r=i(0),s=i(38);var o;!function(e){e[e.Level_0=0]="Level_0",e[e.Level_1=1]="Level_1",e[e.Level_2=2]="Level_2",e[e.Level_3=3]="Level_3",e[e.Level_4=4]="Level_4",e[e.Level_5=5]="Level_5"}(o=t.MSAASampling||(t.MSAASampling={}));class a extends s.Pass{constructor(){super(),this.samplingLevel=o.Level_1,this.m_renderTarget=null,this.m_localCamera=new r.OrthographicCamera(-1,1,1,-1,0,1),this.m_quadScene=new r.Scene,this.m_quadUniforms=n.CopyShader.uniforms,this.m_quadMaterial=new n.MSAAMaterial(this.m_quadUniforms),this.m_quad=new r.Mesh(new r.PlaneBufferGeometry(2,2),this.m_quadMaterial),this.m_quad.frustumCulled=!1,this.m_quadScene.add(this.m_quad)}dispose(){null!==this.m_renderTarget&&(this.m_renderTarget.dispose(),this.m_renderTarget=null)}render(e,t,i,n,s){if(!this.enabled)return;null===this.m_renderTarget&&(this.m_renderTarget=new r.WebGLRenderTarget(s.width,s.height,{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat}),this.m_renderTarget.texture.name="MSAARenderPass.sample"),this.m_quadUniforms.tDiffuse.value=this.m_renderTarget.texture;const o=a.OffsetVectors[this.samplingLevel],l=e.getClearColor(),c=void 0!==l?l.getHex():0,h={enabled:null!==i.view&&i.view.enabled,fullWidth:s.width,fullHeight:s.height,x:0,y:0,width:s.width,height:s.height};h.enabled&&null!==i.view&&(h.fullWidth=i.view.fullWidth,h.fullHeight=i.view.fullHeight,h.x=i.view.offsetX,h.y=i.view.offsetY,h.width=i.view.width,h.height=i.view.height);const d=e.getRenderTarget();for(let r=0;r<o.length;r++){const s=o[r];i.setViewOffset(h.fullWidth,h.fullHeight,h.x+s[0]/16,h.y+s[1]/16,h.width,h.height);const a=(r+.5)/o.length-.5,d=1/o.length+a/32;this.m_quadUniforms.opacity.value=d,e.setRenderTarget(this.m_renderTarget),e.clear(),e.render(t,i),e.setRenderTarget(this.renderToScreen?null:n),0===r&&(e.setClearColor(0),e.clear()),e.render(this.m_quadScene,this.m_localCamera),0===r&&void 0!==l&&e.setClearColor(c)}e.setRenderTarget(d),null!==i.view&&(i.view.enabled=h.enabled,i.view.offsetX=h.x,i.view.offsetY=h.y)}setSize(e,t){this.m_renderTarget&&this.m_renderTarget.setSize(e,t)}}a.OffsetVectors=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]],t.MSAARenderPass=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(72),r=i(73);class s{static getTileDecoder(e,t){const i=this.getWorkerSet(t);return new r.WorkerBasedDecoder(i,e)}static getWorkerSet(e){void 0===e&&(e=this.defaultScriptUrl);let t=this.workerSets[e];return void 0===t&&(t=new n.ConcurrentWorkerSet({scriptUrl:e,workerCount:this.defaultWorkerCount}),this.workerSets[e]=t),t}static destroyWorkerSet(e){const t=this.workerSets[e];void 0!==t&&(t.destroy(),delete this.workerSets[e])}static destroy(){Object.keys(this.workerSets).forEach(e=>{this.workerSets[e].destroy()}),this.workerSets={}}}s.defaultScriptUrl="./decoder.bundle.js",s.defaultWorkerCount=void 0,s.workerSets={},t.ConcurrentDecoderFacade=s},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(3),s=i(1),o=i(144),a=s.LoggerManager.instance.create("ConcurrentWorkerSet");function l(e){return e&&"number"==typeof e.level&&e.type===s.WORKERCHANNEL_MSG_TYPE}t.isLoggingMessage=l;t.ConcurrentWorkerSet=class{constructor(e){this.m_options=e,this.m_workerChannelLogger=s.LoggerManager.instance.create("WorkerChannel"),this.m_eventListeners=new Map,this.m_workers=new Array,this.m_workerListeners=new Array,this.m_availableWorkers=new Array,this.m_workerPromises=new Array,this.m_readyPromises=new Map,this.m_requests=new Map,this.m_workerRequestQueue=[],this.m_nextMessageId=0,this.m_stopped=!0,this.m_referenceCount=0,this.onWorkerMessage=(e,t)=>{if(r.WorkerServiceProtocol.isResponseMessage(t.data)){const i=t.data;if(null===i.messageId)return void a.error(`[${this.m_options.scriptUrl}]: Bad ResponseMessage: no messageId`);const n=this.m_requests.get(i.messageId);if(void 0===n)return void a.error(`[${this.m_options.scriptUrl}]: Bad ResponseMessage: invalid messageId`);if(e>=0&&e<this.m_workers.length){const t=this.m_workers[e];this.m_availableWorkers.push(t),this.checkWorkerRequestQueue()}else a.error(`[${this.m_options.scriptUrl}]: onWorkerMessage: invalid workerId`);n.resolver(i.error,i.response)}else if(r.WorkerServiceProtocol.isInitializedMessage(t.data)){const e=this.getReadyPromise(t.data.service);++e.count===this.m_workerPromises.length&&e.resolve()}else if(l(t.data))switch(t.data.level){case s.LogLevel.Trace:this.m_workerChannelLogger.trace(...t.data.message);break;case s.LogLevel.Debug:this.m_workerChannelLogger.debug(...t.data.message);break;case s.LogLevel.Log:this.m_workerChannelLogger.log(...t.data.message);break;case s.LogLevel.Info:this.m_workerChannelLogger.info(...t.data.message);break;case s.LogLevel.Warn:this.m_workerChannelLogger.warn(...t.data.message);break;case s.LogLevel.Error:this.m_workerChannelLogger.error(...t.data.message)}else this.eventHandler(t)},this.start()}addReference(){this.m_referenceCount+=1}removeReference(){this.m_referenceCount-=1,0===this.m_referenceCount&&this.destroy()}start(e){if(void 0!==e&&(this.m_options=e),!this.m_stopped)throw new Error("ConcurrentWorker set already started");const t=s.getOptionValue(this.m_options.workerCount,"undefined"!=typeof navigator&&void 0!==navigator.hardwareConcurrency?s.MathUtils.clamp(navigator.hardwareConcurrency-1,1,4):void 0,4);for(let e=0;e<t;++e){const t=o.WorkerLoader.startWorker(this.m_options.scriptUrl);t.then(t=>{const i=t=>{this.onWorkerMessage(e,t)};this.m_workerListeners.push(i),t.addEventListener("message",i),this.m_workers.push(t),this.m_availableWorkers.push(t)}).catch(t=>{a.error(`failed to load worker ${e}: ${t}`)}),this.m_workerPromises.push(t)}this.m_stopped=!1}stop(){return n(this,void 0,void 0,(function*(){this.m_stopped=!0,yield this.waitForAllResponses().then(()=>{this.terminateWorkers()})}))}destroy(){this.m_stopped=!0,this.m_requests.forEach(e=>{e.resolver(new Error("worker destroyed"))}),this.m_requests.clear(),this.terminateWorkers(),this.m_eventListeners.clear()}connect(e){return this.ensureStarted(),this.getReadyPromise(e).promise}addEventListener(e,t){this.m_eventListeners.set(e,t)}removeEventListener(e){this.m_eventListeners.delete(e)}invokeRequest(e,t,i,n){this.ensureStarted();const s=this.m_nextMessageId++;let o;const a=new Promise((e,t)=>{o=(i,n)=>{this.m_requests.delete(s),void 0!==i?t(new Error(i.toString())):e(n)}});this.m_requests.set(s,{promise:a,resolver:o});const l={service:e,type:r.WorkerServiceProtocol.ServiceMessageName.Request,messageId:s,request:t};return this.postRequestMessage(l,i,n),a}broadcastRequest(e,t,i){this.ensureStarted();const n=[];for(const s of this.m_workers){const o=this.m_nextMessageId++;let a;const l=new Promise((e,t)=>{a=(i,n)=>{this.m_requests.delete(o),void 0!==i?t(new Error(i.toString())):e(n)}});n.push(l),this.m_requests.set(o,{promise:l,resolver:a});const c={service:e,type:r.WorkerServiceProtocol.ServiceMessageName.Request,messageId:o,request:t};s.postMessage(c,i)}return Promise.all(n)}broadcastMessage(e,t){this.ensureStarted(),this.m_workers.forEach(i=>i.postMessage(e,t))}get requestQueueSize(){return this.m_workerRequestQueue.length}get numWorkers(){return this.m_workers.length}get numIdleWorkers(){return this.m_availableWorkers.length}eventHandler(e){"string"==typeof e.data.type&&this.dispatchEvent(e.data.type,e)}postRequestMessage(e,t,i){if(this.ensureStarted(),0===this.m_workers.length)throw new Error("ConcurrentWorkerSet#postMessage: no workers started");if(void 0!==i&&i.signal.aborted){const t=this.m_requests.get(e.messageId);if(void 0===t)return void a.error(`[${this.m_options.scriptUrl}]: Bad RequesMessage: invalid messageId`);const i=new Error("Aborted");return i.name="AbortError",void t.resolver(i,void 0)}if(this.m_availableWorkers.length>0){this.m_availableWorkers.pop().postMessage(e,t)}else void 0===i&&(i=new r.RequestController(0)),0===i.priority&&(i.priority=-this.m_nextMessageId),this.m_workerRequestQueue.unshift({message:e,buffers:t,requestController:i})}ensureStarted(){if(this.m_stopped)throw new Error("ConcurrentWorkerSet stopped")}waitForAllResponses(){return n(this,void 0,void 0,(function*(){const e=new Array;this.m_requests.forEach(t=>{e.push(t.promise)}),yield Promise.all(e)}))}dispatchEvent(e,t){const i=this.m_eventListeners.get(e);void 0!==i&&i(t)}terminateWorkers(){this.m_workerPromises.forEach(e=>{e.then(e=>{const t=this.m_workers.indexOf(e);if(t>=0){const i=this.m_workerListeners[t];e.removeEventListener("message",i)}else a.error(`[${this.m_options.scriptUrl}]: ConcurrentWorkerSet#terminateWorkers: invalid workerId`);e.terminate()}).catch(()=>{})}),this.m_workers=[],this.m_workerListeners=[],this.m_workerPromises=[],this.m_availableWorkers=[],this.m_readyPromises.clear()}getReadyPromise(e){const t=this.m_readyPromises.get(e);if(void 0!==t)return t;const i={count:0,promise:void 0,resolve:()=>{},reject:e=>{i.error=e},error:void 0};return i.promise=new Promise((e,t)=>{const n=i;void 0!==n.error?t(n.error):n.count===this.m_workerPromises.length&&e(),n.resolve=e,n.reject=t}),this.m_readyPromises.set(e,i),i}checkWorkerRequestQueue(){if(0!==this.m_workerRequestQueue.length&&0!==this.m_availableWorkers.length)for(this.m_workerRequestQueue.sort((e,t)=>e.requestController.priority-t.requestController.priority);this.m_availableWorkers.length>0&&this.m_workerRequestQueue.length>0;){const e=this.m_workerRequestQueue.pop();this.postRequestMessage(e.message,e.buffers,e.requestController)}}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(3);let s=0;t.WorkerBasedDecoder=class{constructor(e,t){this.workerSet=e,this.decoderServiceType=t,this.m_serviceCreated=!1,this.workerSet.addReference(),this.serviceId=`${this.decoderServiceType}-${s++}`}dispose(){this.m_serviceCreated&&this.workerSet.broadcastRequest(r.WorkerServiceProtocol.WORKER_SERVICE_MANAGER_SERVICE_ID,{type:r.WorkerServiceProtocol.Requests.DestroyService,targetServiceId:this.serviceId}),this.workerSet.removeReference()}connect(){return n(this,void 0,void 0,(function*(){yield this.workerSet.connect(r.WorkerServiceProtocol.WORKER_SERVICE_MANAGER_SERVICE_ID),this.m_serviceCreated||(yield this.workerSet.broadcastRequest(r.WorkerServiceProtocol.WORKER_SERVICE_MANAGER_SERVICE_ID,{type:r.WorkerServiceProtocol.Requests.CreateService,targetServiceType:this.decoderServiceType,targetServiceId:this.serviceId}),this.m_serviceCreated=!0)}))}decodeTile(e,t,i,n){const s=t.mortonCode(),o={type:r.WorkerDecoderProtocol.Requests.DecodeTileRequest,tileKey:s,data:e,projection:r.getProjectionName(i)},a=e instanceof ArrayBuffer?[e]:void 0;return this.workerSet.invokeRequest(this.serviceId,o,a,n)}getTileInfo(e,t,i,n){const s=t.mortonCode(),o={type:r.WorkerDecoderProtocol.Requests.TileInfoRequest,tileKey:s,data:e,projection:r.getProjectionName(i)},a=e instanceof ArrayBuffer?[e]:void 0;return this.workerSet.invokeRequest(this.serviceId,o,a,n)}configure(e,t,i){const n={service:this.serviceId,type:r.WorkerDecoderProtocol.DecoderMessageName.Configuration,styleSet:e,options:i,languages:t};this.workerSet.broadcastMessage(n)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(75);t.MapViewImageCache=class{constructor(e){this.mapView=e,this.m_name2Url=new Map,this.m_url2Name=new Map}registerImage(e,t,i){if(void 0!==e){if(this.hasName(e))throw new Error("duplicate name in cache");const i=this.m_url2Name.get(t);void 0!==i?i.indexOf(e)<0&&i.push(e):this.m_url2Name.set(t,[e]),this.m_name2Url.set(e,t)}const r=n.ImageCache.instance.findImage(t);return void 0===r?n.ImageCache.instance.registerImage(this.mapView,t,i):r}addImage(e,t,i=!0){const r=this.registerImage(e,t,void 0);return!0===i?n.ImageCache.instance.loadImage(r):r}findImageByName(e){const t=this.m_name2Url.get(e);if(void 0!==t)return n.ImageCache.instance.findImage(t)}findImageByUrl(e){return n.ImageCache.instance.findImage(e)}loadImage(e){return n.ImageCache.instance.loadImage(e)}clear(){n.ImageCache.instance.clear(this.mapView),this.m_name2Url=new Map,this.m_url2Name=new Map}get numberOfNames(){return this.m_name2Url.size}get numberOfUrls(){return this.m_url2Name.size}hasName(e){return void 0!==this.m_name2Url.get(e)}hasUrl(e){return void 0!==this.m_url2Name.get(e)}findNames(e){return this.m_url2Name.get(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(0),s=n.LoggerManager.instance.create("ImageCache");class o{constructor(){this.m_images=new Map}static get instance(){return void 0===o.m_instance&&(o.m_instance=new o),o.m_instance}static dispose(){o.m_instance=void 0}registerImage(e,t,i){let n=this.findImageCacheItem(t);if(void 0!==n)return void 0!==e&&n.mapViews.indexOf(e)<0&&n.mapViews.push(e),n.imageItem;if(n=this.findImageCacheItem(t),void 0!==n)return void 0!==e&&n.mapViews.indexOf(e)<0&&n.mapViews.push(e),n.imageItem;const r=[];return void 0!==e&&r.push(e),n={imageItem:{url:t,imageData:i,loaded:!1},mapViews:r},this.m_images.set(t,n),n.imageItem}addImage(e,t,i=!0){const n=this.registerImage(e,t,void 0);return void 0!==n&&!0===i?this.loadImage(n):n}findImage(e){const t=this.m_images.get(e);if(void 0!==t)return t.imageItem}clear(e){const t=[];this.m_images.forEach(i=>{const n=i.mapViews.indexOf(e);n>=0&&i.mapViews.splice(n,1),0===i.mapViews.length&&t.push(i.imageItem.url)});for(const e of t)this.m_images.delete(e)}clearAll(){this.m_images=new Map}get size(){return this.m_images.size}loadImage(e){if(void 0!==e.imageData)return e;if(void 0!==e.loadingPromise)return e.loadingPromise;const t=new r.ImageLoader;return e.loadingPromise=new Promise(i=>{s.log("Loading image: "+e.url),t.load(e.url,t=>{s.log("... finished loading image: "+e.url),this.renderImage(e,t).then(()=>{e.loadingPromise=void 0,i(e)}).catch(t=>{s.error(`... loading image failed: ${e.url} : ${t}`),i(void 0)})},void 0,t=>{s.error(`... loading image failed: ${e.url} : ${t}`),e.loadingPromise=void 0,i(void 0)})}),e.loadingPromise}findImageCacheItem(e){return this.m_images.get(e)}renderImage(e,t){return new Promise((i,n)=>{if("function"==typeof createImageBitmap){const n={premultiplyAlpha:"default",imageOrientation:"flipY"};s.log("Creating bitmap image: "+e.url),createImageBitmap(t,0,0,t.width,t.height,n).then(t=>{s.log("... finished creating bitmap image: "+e.url),e.loadingPromise=void 0,e.imageData=t,e.loaded=!0,i(t)}).catch(t=>{s.error(`... loading image failed: ${e.url} : ${t}`),i(void 0)})}else try{"undefined"==typeof document&&(s.error("Error: document is not available, cannot generate image"),n(new Error("ImageCache#renderImage: document is not available, cannot render image to create texture")));const r=document.createElement("canvas");r.width=t.width,r.height=t.height;const o=r.getContext("2d");if(null!==o){s.log(`... finished creating bitmap image in canvas: ${e.url} ${t}`),o.drawImage(t,0,0,t.width,t.height,0,0,r.width,r.height);const n=o.getImageData(0,0,t.width,t.height);e.imageData=n,e.loaded=!0,i(n)}else s.error("renderImage: no context found"),n(new Error("ImageCache#renderImage: no context found"))}catch(t){s.error("renderImage failed: "+t),e.imageData=void 0,e.loaded=!0,n(new Error("ImageCache#renderImage failed: "+t))}})}}t.ImageCache=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),r=i(0);t.MapViewFog=class{constructor(e){this.m_scene=e,this.m_enabled=!0,this.m_fog=new r.Fog(0),this.m_fogIsDefined=!1,this.m_cachedTheme={styles:{}}}set enabled(e){this.m_enabled=e,e&&this.m_fogIsDefined&&null===this.m_scene.fog?this.add():e||null===this.m_scene.fog||this.remove()}get enabled(){return this.m_enabled}reset(e){this.m_cachedTheme=e,void 0!==e&&void 0!==e.sky&&void 0!==e.sky.colorBottom&&void 0!==e.fog&&void 0!==e.fog.startRatio?(this.m_fogIsDefined=!0,this.m_fog.color.set(e.sky.colorBottom),this.m_enabled&&null===this.m_scene.fog&&this.add()):(this.m_fogIsDefined=!1,null!==this.m_scene.fog&&this.remove())}update(e){null!==this.m_scene.fog&&void 0!==e.far&&void 0!==this.m_cachedTheme&&this.m_cachedTheme.fog&&void 0!==this.m_cachedTheme.fog.startRatio&&(this.m_fog.far=e.far,this.m_fog.near=e.far*this.m_cachedTheme.fog.startRatio)}add(){this.m_scene.fog=this.m_fog,this.setFogInRawShaderMaterials(!0)}remove(){this.m_scene.fog=null,this.setFogInRawShaderMaterials(!1)}setFogInRawShaderMaterials(e){this.m_scene.traverse(t=>{if(t instanceof r.Mesh&&t.material instanceof r.Material&&t.material instanceof r.Material&&!(t.material instanceof n.HighPrecisionLineMaterial)){if(t.material instanceof n.SolidLineMaterial){t.material.updateFog(e)}t.material.fog=e,t.material.needsUpdate=!0}})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),r=i(17),s=i(1),o=i(0),a=i(10),l=i(22),c=i(23),h=i(19),d=s.LoggerManager.instance.create("PoiManager");class u{constructor(e){this.mapView=e,this.m_imageTextures=new Map,this.m_poiShieldGroups=new Map,this.m_colorMap=new Map}addPois(e,t){const i=s.assertExists(t.poiGeometries);for(const r of i){s.assert(void 0!==r.technique);const i=s.assertExists(r.technique),a=t.techniques[i];if(!n.isLineMarkerTechnique(a)&&!n.isPoiTechnique(a))continue;if(!1===a.showOnMap)continue;const l=new o.BufferAttribute(new Float32Array(r.positions.buffer),r.positions.itemCount);if(n.isLineMarkerTechnique(a)&&l.count>0)this.addLineMarker(e,r,a,i,l);else{const t=a;let n=t.imageTexture;if(void 0===r.stringCatalog)continue;const o=t.poiTable;let c=t.poiName;for(let h=0;h<l.count;++h){const d=l.getX(h),u=l.getY(h);s.assert(r.texts.length>h);let m=r.stringCatalog[r.texts[h]];void 0===m&&(m=""),void 0!==r.stringCatalog&&(void 0!==r.imageTextures&&r.imageTextures[h]>=0?(s.assert(r.imageTextures.length>h),n=r.stringCatalog[r.imageTextures[h]]):n=t.imageTexture,void 0!==o&&(c=void 0===t.poiName?n:t.poiName,n=void 0));const p=this.checkCreateTextElement(e,m,a,i,n,o,c,0,r.featureId,d,u,e.tileKey.level);void 0!==p&&e.addTextElement(p)}}}}addTextureAtlas(e,t){fetch(t).then(e=>{if(!e.ok)throw new Error("addTextureAtlas: Cannot load textureAtlas: "+e.statusText);return e.json()}).then(i=>{if(void 0!==i){try{d.log(`addTextureAtlas: Loading textureAtlas '${t}' for image '${e}'`);for(const t of Object.getOwnPropertyNames(i)){const n=i[t],r={name:t,image:e,xOffset:n.x,yOffset:n.y,width:n.width,height:n.height};this.addImageTexture(r)}}catch(e){d.error(`addTextureAtlas: Failed to load textureAtlas '${t}' : ${e}`)}this.mapView.update()}else d.info("addTextureAtlas: TextureAtlas empty: "+t)}).catch(e=>{d.error(`addTextureAtlas: Failed to load textureAtlas '${t}' : ${e}`)})}addImageTexture(e){void 0!==e.name?(void 0!==this.m_imageTextures.get(e.name)&&d.warn("addImageTexture: Name already used: "+e.name+" (overriding it)"),this.m_imageTextures.set(e.name,e)):d.error("addImageTexture: Name required",e)}getImageTexture(e){return this.m_imageTextures.get(e)}updatePoiFromPoiTable(e){const t=e.poiInfo;if(void 0===t||void 0===t.poiTableName||void 0===t.poiName)return!0;let i=t.poiTableName;const n=this.mapView.poiTableManager.getPoiTable(i);if(void 0!==n&&n.isLoading)return!1;if(void 0===n||!n.loadedOk)return void 0===i&&(i="undefined"),void 0===u.m_missingPoiTableName.get(i)&&(u.m_missingPoiTableName.set(i,!0),void 0===n||n.loadedOk?d.error(`updatePoiFromPoiTable: No POI table with name '${i}' found.`):d.error("Error loading POI table name "+i)),!0;let r=t.poiName;const s=n.poiDict.get(r);return void 0===s?(void 0===r&&(r="undefined"),void 0===u.m_missingPoiName.get(r)&&(u.m_missingPoiName.set(r,!0),d.warn(`Cannot find POI info '${r}' found in table ${i}.`)),!0):(void 0!==s.iconName&&(t.imageTextureName=s.iconName),e.visible=void 0!==s.visible?s.visible:e.visible,e.priority=void 0!==s.priority?s.priority:e.priority,t.iconMinZoomLevel=void 0!==s.iconMinLevel?s.iconMinLevel:t.iconMinZoomLevel,t.iconMaxZoomLevel=void 0!==s.iconMaxLevel?s.iconMaxLevel:t.iconMaxZoomLevel,t.textMinZoomLevel=void 0!==s.textMinLevel?s.textMinLevel:t.textMinZoomLevel,t.textMaxZoomLevel=void 0!==s.textMaxLevel?s.textMaxLevel:t.textMaxZoomLevel,e.updateMinMaxZoomLevelsFromPoiInfo(),!0)}clear(){this.m_imageTextures.clear(),this.m_poiShieldGroups.clear()}addLineMarker(e,t,i,n,r){let s,a=i.imageTexture;void 0!==t.stringCatalog&&void 0!==t.imageTextures&&(a=t.stringCatalog[t.imageTextures[0]],s=t.stringCatalog[t.texts[0]]),void 0===s&&(s="");const l=String(a)+"-"+s;let c=this.m_poiShieldGroups.get(l);void 0===c&&(c=this.m_poiShieldGroups.size,this.m_poiShieldGroups.set(l,c));const h=[];for(let e=0;e<r.count;e+=2)h.push(new o.Vector2(r.getX(e),r.getY(e)));const d=this.checkCreateTextElement(e,s,i,n,a,void 0,void 0,c,t.featureId,h,void 0,e.tileKey.level);void 0!==d&&(d.ignoreDistance=!0,e.addTextElement(d))}checkCreateTextElement(e,t,i,s,a,h,d,u,m,p,f,g){let _;if(void 0===t&&(t=""),void 0!==t){const g=void 0!==i.priority?i.priority:0,v=Array.isArray(p)?p:new o.Vector2(p,f),y=this.mapView.zoomLevel;_=new l.TextElement(r.ContextualArabicConverter.instance.convert(t),v,this.getRenderStyle(e.dataSource.name,i,s),this.getLayoutStyle(e.dataSource.name,i),g,void 0!==i.xOffset?i.xOffset:0,void 0!==i.yOffset?i.yOffset:0,m,i.style,n.getPropertyValue(i.fadeNear,y),n.getPropertyValue(i.fadeFar,y)),_.mayOverlap=!0===i.textMayOverlap,_.reserveSpace=!1!==i.textReserveSpace,_.alwaysOnTop=!0===i.alwaysOnTop;const x=!0===i.textIsOptional,w=!1!==i.iconIsOptional,b=!(!1===i.renderTextDuringMovements),T=void 0===i.iconMayOverlap?_.textMayOverlap:!0===i.iconMayOverlap,S=void 0===i.iconReserveSpace?_.textReservesSpace:!1!==i.iconReserveSpace,C=void 0!==i.distanceScale?i.distanceScale:c.DEFAULT_TEXT_DISTANCE_SCALE;void 0===a&&void 0!==h&&(a=""),void 0!==a?(_.poiInfo={technique:i,imageTextureName:a,poiTableName:h,poiName:d,shieldGroupIndex:u,textElement:_,textIsOptional:x,iconIsOptional:w,renderTextDuringMovements:b,mayOverlap:T,reserveSpace:S,featureId:m,iconMinZoomLevel:i.iconMinZoomLevel,iconMaxZoomLevel:i.iconMaxZoomLevel,textMinZoomLevel:i.textMinZoomLevel,textMaxZoomLevel:i.textMaxZoomLevel},_.updateMinMaxZoomLevelsFromPoiInfo()):(void 0===_.minZoomLevel&&(_.minZoomLevel=i.textMinZoomLevel),void 0===_.maxZoomLevel&&(_.maxZoomLevel=i.textMaxZoomLevel)),_.distanceScale=C}return _}getRenderStyle(e,t,i){const o=h.computeStyleCacheId(e,t,this.mapView.zoomLevel);let l=this.mapView.textRenderStyleCache.get(o);if(void 0===l){const e=this.mapView.textElementsRenderer.defaultStyle.renderParams,i=s.getOptionValue(n.getPropertyValue(t.size,Math.floor(this.mapView.zoomLevel)),e.fontSize.size),c=s.getOptionValue(n.getPropertyValue(t.backgroundSize,Math.floor(this.mapView.zoomLevel)),e.fontSize.backgroundSize),h=n.getPropertyValue(t.color,Math.floor(this.mapView.zoomLevel));void 0!==h&&this.m_colorMap.set(o,a.ColorCache.instance.getColor(h));const d=s.getOptionValue(this.m_colorMap.get(o),e.color),u=n.getPropertyValue(t.backgroundColor,Math.floor(this.mapView.zoomLevel));void 0!==u&&this.m_colorMap.set(o+"_bg",a.ColorCache.instance.getColor(u));const m=s.getOptionValue(this.m_colorMap.get(o+"_bg"),e.backgroundColor),p=s.getOptionValue(n.getPropertyValue(t.backgroundAlpha,Math.floor(this.mapView.zoomLevel)),e.backgroundOpacity),f=!0===t.smallCaps||e.fontVariant===r.FontVariant.SmallCaps,g=!0===t.allCaps||e.fontVariant===r.FontVariant.AllCaps,_=f?r.FontVariant.SmallCaps:g?r.FontVariant.AllCaps:void 0,v=!0===t.bold?t.oblique?r.FontStyle.BoldItalic:r.FontStyle.Bold:!0===t.oblique?r.FontStyle.Italic:e.fontStyle,y={fontSize:{unit:r.FontUnit.Pixel,size:i,backgroundSize:c},color:d,backgroundColor:m,backgroundOpacity:p,fontVariant:_,fontStyle:v},x=void 0!==this.mapView.textElementsRenderer?this.mapView.textElementsRenderer.getTextElementStyle(t.style).renderParams:{};l=new r.TextRenderStyle(Object.assign({},x,y)),this.mapView.textRenderStyleCache.set(o,l)}return l}getLayoutStyle(e,t){const i=h.computeStyleCacheId(e,t,this.mapView.zoomLevel);let n=this.mapView.textLayoutStyleCache.get(i);if(void 0===n){const e=this.mapView.textElementsRenderer.defaultStyle.layoutParams,o=s.getOptionValue(t.tracking,e.tracking);let a=e.horizontalAlignment;"Left"!==t.hAlignment&&"Center"!==t.hAlignment&&"Right"!==t.hAlignment||(a=r.HorizontalAlignment[t.hAlignment]);let l=e.verticalAlignment;"Above"!==t.vAlignment&&"Center"!==t.vAlignment&&"Below"!==t.vAlignment||(l=r.VerticalAlignment[t.vAlignment]);const c={tracking:o,horizontalAlignment:a,verticalAlignment:l},h=void 0!==this.mapView.textElementsRenderer?this.mapView.textElementsRenderer.getTextElementStyle(t.style).layoutParams:{};n=new r.TextLayoutStyle(Object.assign({},h,c)),this.mapView.textLayoutStyleCache.set(i,n)}return n}}u.m_missingPoiTableName=new Map,u.m_missingPoiName=new Map,t.PoiManager=u},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(3),s=i(1),o=s.LoggerManager.instance.create("PoiTable");class a{static verifyJSON(e){let t="string"==typeof e.name&&e.name.length>0&&(void 0===e.altNames||Array.isArray(e.altNames))&&(void 0===e.stackMode||"yes"===e.stackMode||"no"===e.stackMode||"parent"===e.stackMode)&&(void 0===e.visible||"boolean"==typeof e.visible)&&(void 0===e.priority||"number"==typeof e.priority)&&(void 0===e.iconMinLevel||"number"==typeof e.iconMinLevel)&&(void 0===e.iconMaxLevel||"number"==typeof e.iconMaxLevel)&&(void 0===e.textMinLevel||"number"==typeof e.textMinLevel)&&(void 0===e.textMaxLevel||"number"==typeof e.textMaxLevel);if(t&&void 0!==e.altNames){const i=e.altNames;for(const e in i)if("string"!=typeof e){t=!1;break}}return t}setup(e){switch(this.name=e.name,this.altNames=e.altNames,this.iconName=void 0!==e.iconName?e.iconName:"<undefined>",this.visible=e.visible,this.priority=e.priority,this.iconMinLevel=e.iconMinLevel,this.iconMaxLevel=e.iconMaxLevel,this.textMinLevel=e.textMinLevel,this.textMaxLevel=e.textMaxLevel,e.stackMode){case"yes":this.stackMode=r.PoiStackMode.Show;break;case"no":this.stackMode=r.PoiStackMode.Hide;break;case"parent":this.stackMode=r.PoiStackMode.ShowParent}}}class l{constructor(e,t){this.name=e,this.useAltNamesForKey=t,this.poiList=new Array,this.poiDict=new Map,this.m_isLoading=!1,this.m_loadedOk=void 0}get isLoading(){return this.m_isLoading}get loadedOk(){return!0===this.m_loadedOk}load(e){return n(this,void 0,void 0,(function*(){if(void 0!==this.m_loadedOk)return!0;this.m_loadedOk=!1;const t=yield fetch(e);if(!t.ok)throw new Error(`load: Cannot load POI table at ${e}: `+t.statusText);const i=yield t.json();if(void 0===i)return o.info("load: TextureAtlas empty: "+e),!0;this.startLoading();try{if(o.log(`load: Loading POI table '${e}' for table '${this.name}'`),void 0!==i.poiList&&Array.isArray(i.poiList))for(const t of i.poiList)if(a.verifyJSON(t)){const i=new a;if(i.setup(t),this.poiList.push(i),this.useAltNamesForKey)if(void 0!==i.altNames&&i.altNames.length>0)for(const e of i.altNames)this.poiDict.set(e,i);else o.warn(`load: Invalid entry in POI table '${e}' : No alternative names set in entry: ${t.iconName}.`);else void 0===i.name?o.warn(`load: Invalid entry in POI table '${e}' : . No name set in entry: ${t.iconName}.`):this.poiDict.set(i.name,i)}else o.warn(`load: Invalid entry in POI table '${e}' : ${t.iconName}`);this.m_loadedOk=!0,this.finishedLoading()}catch(t){return o.error(`load: Failed to load POI table '${e}' : ${t}`),this.m_loadedOk=!1,this.finishedLoading(),!1}return!0}))}startLoading(){this.m_isLoading=!0}finishedLoading(){this.m_isLoading=!1}}t.PoiTable=l;t.PoiTableManager=class{constructor(e){this.mapView=e,this.m_isLoading=!1,this.m_poiTables=new Map}loadPoiTables(e){return n(this,void 0,void 0,(function*(){return new Promise(t=>{if(this.clear(),void 0!==e.poiTables){this.startLoading();const i=new Array,n=e.url,r=void 0===n?void 0:s.composeUrlResolvers(e=>s.resolveReferenceUrl(n,e),s.defaultUrlResolver);e.poiTables.forEach(e=>{if(void 0!==e&&void 0!==e.name&&"string"==typeof e.name){const t=new l(e.name,!1!==e.useAltNamesForKey);if(void 0!==e.url&&"string"==typeof e.url){this.addTable(t);const n=void 0===r?e.url:r(e.url);i.push(t.load(n))}else o.error("POI table definition has no valid url: "+e)}else o.error("POI table definition has no valid name: "+e)}),i.length>0?Promise.all(i).then(()=>{this.finishLoading(),t()}):(this.finishLoading(),t())}else this.finishLoading(),t()})}))}clear(){this.m_poiTables=new Map}get poiTables(){return this.m_poiTables}addTable(e){this.m_poiTables.set(e.name,e)}getPoiTable(e){return void 0===e?void 0:this.m_poiTables.get(e)}get finishedLoading(){return!this.m_isLoading}startLoading(){this.m_isLoading=!0}finishLoading(){this.m_isLoading=!1}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),i(39);const r=i(1);t.ThemeLoader=class{static loadAsync(e){return n(this,void 0,void 0,(function*(){e=r.defaultUrlResolver(e);const t=yield fetch(e);if(!t.ok)throw new Error("ThemeLoader#loadAsync: cannot load theme: "+t.statusText);const i=yield t.json();if(null===i)throw new Error("ThemeLoader#loadAsync: loaded resource is not valid JSON");return i.url=e,this.resolveUrls(i)}))}static resolveUrls(e){const t=r.composeUrlResolvers(t=>r.resolveReferenceUrl(e.url,t),r.defaultUrlResolver);if(e.images)for(const i of Object.keys(e.images)){const n=e.images[i];n.url=t(n.url),void 0!==n.atlas&&(n.atlas=t(n.atlas))}if(e.fontCatalogs)for(const i of e.fontCatalogs)i.url=t(i.url);if(e.poiTables)for(const i of e.poiTables)i.url=t(i.url);if(e.styles)for(const i in e.styles){if(!e.styles.hasOwnProperty(i))continue;const n=e.styles[i];for(const e of n)e.attr&&["map","normalMap","displacementMap","roughnessMap"].forEach(i=>{const n=e.attr[i];n&&"string"==typeof n&&(e.attr[i]=t(n))})}return e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(2),r=i(33),s=i(0),o=i(81),a=i(152),l=i(16);var c;!function(e){e[e.EstimationInMb=0]="EstimationInMb",e[e.NumberOfTiles=1]="NumberOfTiles"}(c=t.ResourceComputationType||(t.ResourceComputationType={}));class h{constructor(e,t,i=0){this.tileKey=e,this.area=t,this.offset=i}}class d{constructor(e){this.disposedTiles=[],this.resourceComputationType=c.EstimationInMb,this.resourceComputationType=void 0===e.resourceComputationType?c.EstimationInMb:e.resourceComputationType,this.tileCache=new r.LRUCache(e.tileCacheSize,e=>this.resourceComputationType===c.EstimationInMb?e.memoryUsage*(1/1048576):1),this.tileCache.evictionCallback=(e,t)=>{void 0!==t.tileLoader&&t.tileLoader.cancel(),this.disposedTiles.push(t)},this.tileCache.canEvict=(e,t)=>t.frameNumLastRequested!==t.dataSource.mapView.frameNumber}disposeTiles(){this.disposedTiles.forEach(e=>{e.dispose()}),this.disposedTiles.length=0}get(e){return this.tileCache.get(e)}}t.VisibleTileSet=class{constructor(e,t){this.camera=e,this.dataSourceTileList=[],this.allVisibleTilesLoaded=!1,this.m_dataSourceCache=new Map,this.m_viewProjectionMatrix=new s.Matrix4,this.m_frustum=new s.Frustum,this.m_ResourceComputationType=c.EstimationInMb,this.m_mapTileCuller=new a.MapTileCuller(e),this.options=t}getDataSourceCacheSize(){return this.options.tileCacheSize}setDataSourceCacheSize(e,t=c.EstimationInMb){this.options.tileCacheSize=e,this.resourceComputationType=t}getNumberOfVisibleTiles(){return this.options.maxVisibleDataSourceTiles}setNumberOfVisibleTiles(e){this.options.maxVisibleDataSourceTiles=e}get resourceComputationType(){return this.m_ResourceComputationType}set resourceComputationType(e){this.m_ResourceComputationType=e,this.m_dataSourceCache.forEach(t=>{t.tileCache.setCapacity(this.options.tileCacheSize),t.resourceComputationType=e,t.tileCache.shrinkToCapacity()})}updateRenderList(e,t,i,n){this.m_viewProjectionMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.m_frustum.setFromMatrix(this.m_viewProjectionMatrix);const r=[];let s,o=!0;this.options.extendedFrustumCulling&&this.m_mapTileCuller.setup();for(const e of n)if(s=e.getElevationRangeSource(),void 0!==s)break;const a=this.getVisibleTilesForDataSources(e,i,n,s);for(const{dataSource:e,visibleTiles:n}of a.tiles){n.sort((e,t)=>{const i=t.area-e.area,n=.001*(e.area+t.area);return Math.abs(i)<n?t.tileKey.mortonCode()-e.tileKey.mortonCode():i});const s=[];let a=!0,l=0;const c=e.getDisplayZoomLevel(i);for(let t=0;t<n.length&&s.length<this.options.maxVisibleDataSourceTiles;t++){const i=n[t];if(!e.shouldRender(c,i.tileKey))continue;const r=this.getTile(e,i.tileKey,i.offset);void 0!==r&&(r.prepareForRender(),a=a&&r.hasGeometry,r.hasGeometry?(r.numFramesVisible++,r.frameNumVisible<0&&(r.frameNumVisible=e.mapView.frameNumber)):l++,s.push(r),r.visibleArea=i.area)}r.push({dataSource:e,storageLevel:t,zoomLevel:c,allVisibleTileLoaded:a,numTilesLoading:l,visibleTiles:s,renderedTiles:s}),o=o&&a}return this.dataSourceTileList=r,this.allVisibleTilesLoaded=o&&a.allBoundingBoxesFinal,this.fillMissingTilesFromCache(),this.forEachCachedTile(e=>{e.isVisible||void 0===e.tileLoader||e.tileLoader.isFinished||this.disposeTile(e)}),this.dataSourceTileList.forEach(e=>{const t=e.dataSource,i=this.m_dataSourceCache.get(t.name);void 0!==i&&i.tileCache.shrinkToCapacity()}),r}getTile(e,t,i=0){function n(t){void 0!==t&&(t.frameNumLastRequested=e.mapView.frameNumber)}if(!e.cacheable){const i=e.getTile(t);return n(i),i}const{tileCache:r}=this.getOrCreateCache(e),s=l.TileOffsetUtils.getKeyForTileKeyAndOffset(t,i);let o=r.get(s);return void 0!==o&&o.offset===i?(n(o),o):(o=e.getTile(t),void 0!==o&&(o.offset=i,n(o),r.set(s,o)),o)}removeDataSource(e){this.clearTileCache(e),this.dataSourceTileList=this.dataSourceTileList.filter(t=>t.dataSource.name!==e),this.m_dataSourceCache.delete(e)}clearTileCache(e){if(void 0!==e){const t=this.m_dataSourceCache.get(e);t&&t.tileCache.evictAll()}else this.m_dataSourceCache.forEach(e=>{e.tileCache.evictAll()})}markTilesDirty(e){if(void 0===e)this.dataSourceTileList.forEach(e=>{this.markDataSourceTilesDirty(e)});else{const t=this.dataSourceTileList.find(t=>t.dataSource===e);if(void 0===t)return;this.markDataSourceTilesDirty(t)}}disposePendingTiles(){this.m_dataSourceCache.forEach(e=>{e.disposeTiles()})}forEachVisibleTile(e){for(const t of this.dataSourceTileList)t.renderedTiles.forEach(e)}forEachCachedTile(e){this.m_dataSourceCache.forEach(t=>{t.tileCache.forEach(t=>{e(t)})})}disposeTile(e){const t=this.m_dataSourceCache.get(e.dataSource.name);if(t){const i=l.TileOffsetUtils.getKeyForTileKeyAndOffset(e.tileKey,e.offset);t.tileCache.delete(i),e.dispose()}}get projection(){return this.options.projection}get projectionType(){return this.projection.type}get tileWrappingEnabled(){return this.projectionType===n.ProjectionType.Planar}getGeoBox(e,t,i){const n=e.getGeoBox(t),r=360*i;return n.northEast.longitude+=r,n.southWest.longitude+=r,n}createIntersectionCache(e){const t=new Map;for(const i of e)t.set(l.TileOffsetUtils.getKeyForTileKeyAndOffset(i.tileKey,i.offset),1/0);return t}getRequiredInitialRootTileKeys(e){const t=n.TileKey.fromRowColumnLevel(0,0,0);if(!this.tileWrappingEnabled)return[new h(t,0)];const i=this.options.projection.unprojectPoint(e),r=[],o=Math.round(i.longitude/360),a=l.MapViewUtils.extractYawPitchRoll(this.camera.quaternion).pitch,c=this.camera.aspect>1?this.camera.aspect:1/this.camera.aspect,d=n.MathUtils.degToRad(this.camera.fov*c/2)+a,u=Math.tan(d)*this.camera.position.z-Math.tan(a)*this.camera.position.z,m=new s.Vector3(e.x-u,e.y,e.z),p=this.options.projection.unprojectPoint(m),f=n.MathUtils.clamp(Math.ceil(Math.abs((i.longitude-p.longitude)/360)*Math.SQRT2),0,7);for(let e=-f+o;e<=f+o;e++)r.push(new h(t,0,e));return r}fillMissingTilesFromCache(){this.dataSourceTileList.forEach(e=>{const t=e.dataSource,i=t.getTilingScheme(),r=e.zoomLevel,s=new Map,o=new Set;let a;!function(e){e[e.UP=0]="UP",e[e.DOWN=1]="DOWN",e[e.BOTH=2]="BOTH"}(a||(a={}));const c=this.m_dataSourceCache.get(t.name);if(void 0===c)return;const h=this.options.quadTreeSearchDistanceUp>0&&r>t.minZoomLevel,d=this.options.quadTreeSearchDistanceDown>0&&r<t.maxZoomLevel;if(!d&&!h)return;const u=d&&h?a.BOTH:d?a.DOWN:a.UP;let m=new Map;if(e.visibleTiles.forEach(e=>{const t=l.TileOffsetUtils.getKeyForTileKeyAndOffset(e.tileKey,e.offset);e.hasGeometry?s.set(t,e):m.set(t,u)}),0!==m.size){for(;0!==m.size;){const e=new Map;m.forEach((t,h)=>{if(t===a.BOTH||t===a.UP){const t=l.TileOffsetUtils.getParentKeyFromKey(h);if(!o.has(t)&&!s.get(t)){o.add(t);const i=c.get(t);if(void 0!==i&&i.hasGeometry)return void s.set(t,i);const{mortonCode:h}=l.TileOffsetUtils.extractOffsetAndMortonKeyFromKey(t),d=i?i.tileKey:n.TileKey.fromMortonCode(h);Math.abs(r-d.level)<this.options.quadTreeSearchDistanceUp&&e.set(t,a.UP)}}if(t===a.BOTH||t===a.DOWN){const{offset:t,mortonCode:d}=l.TileOffsetUtils.extractOffsetAndMortonKeyFromKey(h),u=n.TileKey.fromMortonCode(d);i.getSubTileKeys(u).forEach(i=>{const n=l.TileOffsetUtils.getKeyForTileKeyAndOffset(i,t);o.add(n);const h=c.get(n);void 0!==h&&h.hasGeometry?s.set(n,h):Math.abs(i.level-r)<this.options.quadTreeSearchDistanceDown&&e.set(n,a.DOWN)})}}),m=e}e.renderedTiles=Array.from(s.values())}})}getOrCreateCache(e){const t=e.name;let i=this.m_dataSourceCache.get(t);return void 0===i&&(i=new d(this.options),this.m_dataSourceCache.set(t,i)),i}markDataSourceTilesDirty(e){const t=this.m_dataSourceCache.get(e.dataSource.name),i=new Set;e.visibleTiles.forEach(e=>{const t=l.TileOffsetUtils.getKeyForTileKeyAndOffset(e.tileKey,e.offset);i.add(t),e.reload()}),e.renderedTiles.forEach(e=>{const t=l.TileOffsetUtils.getKeyForTileKeyAndOffset(e.tileKey,e.offset);i.has(t)||(i.add(t),e.reload())}),void 0!==t&&t.tileCache.forEach((e,n)=>{i.has(n)||(e.dispose(),t.tileCache.delete(n))})}getVisibleTilesForDataSources(e,t,i,n){const r=[];let a=!0;for(const c of i){const i=c.getDisplayZoomLevel(t),d=c.getTilingScheme(),u=void 0!==n&&n.getTilingScheme()===d,m=new s.Box3,p=this.getRequiredInitialRootTileKeys(e),f=[],g=this.createIntersectionCache(p);for(;p.length>0;){const t=p.pop();if(void 0===t)continue;const r=t.tileKey,s=l.TileOffsetUtils.getKeyForTileKeyAndOffset(r,t.offset),_=g.get(s);if(void 0===_)throw new Error("Unexpected tile key");_<=0||r.level>i||(c.shouldRender(i,r)&&f.push(t),d.getSubTileKeys(r).forEach(i=>{const r=t.offset,s=l.TileOffsetUtils.getKeyForTileKeyAndOffset(i,r);if(void 0===g.get(s)){const t=this.getGeoBox(d,i,r);if(u){const e=n.getElevationRange(i);t.southWest.altitude=e.minElevation,t.northEast.altitude=e.maxElevation,a=a&&e.calculationStatus===o.CalculationStatus.FinalPrecise}this.options.projection.projectBox(t,m),m.min.sub(e),m.max.sub(e);const l=this.computeSubTileArea(m);g.set(s,l),l>0&&p.push(new h(i,l,r))}}))}r.push({dataSource:c,visibleTiles:f})}return{tiles:r,allBoundingBoxesFinal:a}}computeSubTileArea(e){if((!this.options.extendedFrustumCulling||this.m_mapTileCuller.frustumIntersectsTileBox(e))&&this.m_frustum.intersectsBox(e)){const t=[new s.Vector3(e.min.x,e.min.y,0).applyMatrix4(this.m_viewProjectionMatrix),new s.Vector3(e.max.x,e.min.y,0).applyMatrix4(this.m_viewProjectionMatrix),new s.Vector3(e.max.x,e.max.y,0).applyMatrix4(this.m_viewProjectionMatrix),new s.Vector3(e.min.x,e.max.y,0).applyMatrix4(this.m_viewProjectionMatrix)];t.push(t[0]);const i=t.length;let n=0;for(let e=i-1,r=0;r<i;e=r++)n+=t[e].x*t[r].y-t[r].x*t[e].y;return Math.abs(.5*n)}return 0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.PendingApproximate=0]="PendingApproximate",e[e.FinalPrecise=1]="FinalPrecise"}(t.CalculationStatus||(t.CalculationStatus={}))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(3);let s=0;t.WorkerBasedTiler=class{constructor(e,t){this.workerSet=e,this.tilerServiceType=t,this.m_serviceCreated=!1,this.workerSet.addReference(),this.serviceId=`${this.tilerServiceType}-${s++}`}dispose(){this.m_serviceCreated&&this.workerSet.broadcastRequest(r.WorkerServiceProtocol.WORKER_SERVICE_MANAGER_SERVICE_ID,{type:r.WorkerServiceProtocol.Requests.DestroyService,targetServiceId:this.serviceId}),this.workerSet.removeReference()}connect(){return n(this,void 0,void 0,(function*(){yield this.workerSet.connect(r.WorkerServiceProtocol.WORKER_SERVICE_MANAGER_SERVICE_ID),this.m_serviceCreated||(yield this.workerSet.broadcastRequest(r.WorkerServiceProtocol.WORKER_SERVICE_MANAGER_SERVICE_ID,{type:r.WorkerServiceProtocol.Requests.CreateService,targetServiceType:this.tilerServiceType,targetServiceId:this.serviceId}),this.m_serviceCreated=!0)}))}registerIndex(e,t){const i={type:r.WorkerTilerProtocol.Requests.RegisterIndex,id:e,input:t instanceof URL?t.href:t};return this.workerSet.invokeRequest(this.serviceId,i)}getTile(e,t){const i=t.mortonCode(),n={type:r.WorkerTilerProtocol.Requests.TileRequest,index:e,tileKey:i};return this.workerSet.invokeRequest(this.serviceId,n)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),r=i(157),s=i(1),o=s.LoggerManager.instance.create("TileGeometry");t.isLineAccessor=function(e){return"function"==typeof e.isLineAccessor&&!0===e.isLineAccessor()},t.isObject3dAccessor=function(e){return"function"==typeof e.isObject3dAccessor&&!0===e.isObject3dAccessor()};class a{constructor(e,t,i){this.object=e,this.geometryType=t,this.bufferGeometry=i,this.start=-1,this.end=-1,this.startCapSize=0,this.endCapSize=0,s.assert(!!e),"BufferGeometry"!==i.type&&o.error("IndexedBufferedGeometryAccessor#constructor: BufferGeometry has wrong type"),s.assert("BufferGeometry"===i.type,"IndexedBufferedGeometryAccessor#constructor: BufferGeometry has wrong type"),this.position=this.bufferGeometry.getAttribute("position"),this.itemSize=this.position.itemSize,this.position||o.warn("BufferedGeometryAccessor#constructor: BufferGeometry has no position attribute"),this.position.array.constructor!==Float32Array&&o.warn("BufferedGeometryAccessor#constructor: BufferGeometry.position: unsupported ArrayBuffer")}getCount(){return this.position.count}get renderOrder(){return this.object.renderOrder}setRange(e,t,i=0,n=0){s.assert(e>=0),s.assert(t>=0),s.assert(e<=t),this.start=e,this.end=t,this.startCapSize=i,this.endCapSize=n}get color(){const e=e=>{const t=e;if("MeshBasicMaterial"===t.type||"MeshStandardMaterial"===t.type)return t.color;if("RawShaderMaterial"===t.type){const t=e;if("SolidLineMaterial"===t.name)return t.uniforms.diffuse.value;o.warn("BufferedGeometryAccessor#color: unknown shader material name",t.name)}else o.warn("BufferedGeometryAccessor#color: unknown material type",t.type)};if(Array.isArray(this.object.material)){const t=new Array,i=this.object.material;for(const n of i)t.push(e(n));return t}return e(this.object.material)}}t.BufferedGeometryAccessorBase=a;class l extends a{constructor(e,t,i,n){super(e,t,i),this.object=e,this.geometryType=t,this.bufferGeometry=i,this.stride=n}clear(){s.assert(this.checkSetUp(),"BufferedGeometryAccessor not setup");const e=this.position.array,t=this.start*this.itemSize,i=this.end*this.itemSize;for(let n=t;n<i;n++)e[n]=0;this.position.needsUpdate=!0}getVertices(){s.assert(this.checkSetUp(),"BufferedGeometryAccessor not setup");const e=this.start,t=this.end;return this.position.array.subarray(e*this.itemSize,t*this.itemSize)}checkSetUp(){return void 0!==this.position&&void 0!==this.start&&void 0!==this.end&&this.start>=0&&this.end<=this.position.count&&this.start<=this.end}}t.BufferedGeometryAccessor=l;t.BufferedGeometryLineAccessor=class extends l{constructor(e,t,i){super(e,t,i,3),this.object=e,this.geometryType=t,this.bufferGeometry=i}isLineAccessor(){return!0}get width(){s.assert(this.checkSetUp(),"RoBufferedGeometryLineAccessor not setup")}};t.BufferedGeometryObject3dAccessor=class extends l{constructor(e,t,i){super(e,t,i,1),this.object=e,this.geometryType=t,this.bufferGeometry=i}isObject3dAccessor(){return!0}getVertices(){return super.getVertices()}};class c extends a{constructor(e,t,i,n,r){super(e,t,i),this.object=e,this.geometryType=t,this.bufferGeometry=i,this.indices=this.bufferGeometry.index.array,this.indices?this.indices instanceof Uint32Array||(o.warn("IndexedBufferedGeometryAccessor#constructor: BufferGeometry index has wrong type"),s.assert(this.indices instanceof Uint32Array)):(o.warn("IndexedBufferedGeometryAccessor#constructor: BufferGeometry has no index"),s.assert(!!this.indices))}getCount(){return this.indices.length}checkSetUp(){return!!this.indices&&void 0!==this.start&&void 0!==this.end&&this.start>=0&&this.end<=this.indices.length&&this.start<=this.end}}t.IndexedBufferedGeometryAccessor=c;t.IndexedBufferedGeometryLineAccessor=class extends c{constructor(e,t,i){super(e,t,i,3),this.object=e,this.geometryType=t,this.bufferGeometry=i}isLineAccessor(){return!0}get width(){if(s.assert(this.checkSetUp(),"RoIndexedBufferedGeometryLineAccessor not setup"),this.geometryType===n.GeometryType.ExtrudedLine){const e=this.start+this.startCapSize,t=this.position.array;return r.reconstructLineWidth(t,e)}}clear(){s.assert(this.checkSetUp(),"RoIndexedBufferedGeometryLineAccessor not setup");const e=this.start,t=this.end;for(let i=e;i<t;i++)this.indices[i]=0;this.bufferGeometry.index.needsUpdate=!0}getVertices(){s.assert(this.checkSetUp(),"RoIndexedBufferedGeometryLineAccessor not setup");const e=this.itemSize,t=this.start,i=this.end,n=new Float32Array((i-t)*e),r=this.position.array;if(2===e)for(let s=t,o=0;s<i;s++,o+=e){const t=this.indices[s];n[o+0]=r[t*e+0],n[o+1]=r[t*e+1]}if(3===e)for(let s=t,o=0;s<i;s++,o+=e){const t=this.indices[s];n[o+0]=r[t*e+0],n[o+1]=r[t*e+1],n[o+2]=r[t*e+2]}else for(let s=t,o=0;s<i;s++,o++){const t=this.indices[s];for(let i=0;i<e;i++)n[o*e+i]=r[t*e+i]}return n}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=new n.Vector3(0,0,1),s=[0,1,2,1,3,2],o=[0,1,3,3,1,2,0,3,4,5,4,3],a=Math.PI/8;function l(e,t,i,n,r,s){const o=r.length/3;r.push(e,t,0);for(let l=0;l<9;++l){const c=a*l+Math.PI/2+i;r.push(e+n*Math.cos(c),t+n*Math.sin(c),0),s.push(o,o+l+1,o+(l+1)%9+1)}}t.numCirclePoints=function(e){return 9},t.triangulateLine=function(e,t,i,a,c=!0,h=c){if(e.length<3)return;const d=new n.Vector2;if(c){const n=3!==e.length?d.set(e[3]-e[0],e[4]-e[1]).angle():0;l(e[0],e[1],n,t,i,a)}const u=i.length/3,m=new n.Vector3,p=new n.Vector3,f=new n.Vector3,g=new n.Vector3,_=new n.Vector3,v=new n.Vector3,y=new n.Vector3,x=new n.Vector3,w=new n.Vector3,b=e.length/3;let T=0;for(let n=0;n<b;++n){let l=!1;if(p.set(e[3*n],e[3*n+1],e[3*n+2]),n+1<b){if(f.set(e[3*(n+1)],e[3*(n+1)+1],e[3*(n+1)+2]),g.copy(f).sub(p).normalize().cross(r),_.copy(g),n>0&&(_.add(m).multiplyScalar(1-.5*g.dot(m)),l=m.angleTo(g)>Math.PI/2,l)){const e=t/Math.cos(g.angleTo(m)/2);v.copy(g).add(m).normalize().multiplyScalar(-e).add(p),y.copy(m).multiplyScalar(t).add(p),x.copy(g).add(m).normalize().multiplyScalar(e).add(p),w.copy(g).multiplyScalar(t).add(p)}l?i.push(v.x,v.y,v.z,y.x,y.y,y.z,x.x,x.y,x.z,w.x,w.y,w.z):(v.copy(_).multiplyScalar(-t).add(p),y.copy(_).multiplyScalar(t).add(p),i.push(v.x,v.y,v.z,y.x,y.y,y.z)),m.copy(g)}else v.copy(m).multiplyScalar(-t).add(p),y.copy(m).multiplyScalar(t).add(p),i.push(v.x,v.y,v.z,y.x,y.y,y.z);n!==b-1&&((l?o:s).forEach(e=>a.push(u+T+e)),T+=l?4:2)}if(h){const n=2!==e.length?d.set(e[3*(b-3)]-e[3*(b-2)],e[3*(b-3)+1]-e[3*(b-2)+1]).angle():Math.PI;l(e[3*(b-2)],e[3*(b-2)+1],n,t,i,a)}},t.reconstructLine=function(e,t){const i=new Float32Array(e.length/2);for(let n=3*t,r=2*n;n<i.length;n+=3,r+=6)i[n]=e[r]+.5*(e[r+3]-e[r]),i[n+1]=e[r+1]+.5*(e[r+3+1]-e[r+1]),i[n+2]=e[r+2]+.5*(e[r+3+2]-e[r+2]);return i},t.reconstructLineWidth=function(e,t){const i=e[2*t+3]-e[2*t],n=e[2*t+3+1]-e[2*t+1],r=e[2*t+3+2]-e[2*t+2];return.5*Math.sqrt(i*i+n*n+r*r)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),r=i(0),s=i(42);class o extends r.Line{constructor(e,t,i,s,o){super(void 0===e?new r.BufferGeometry:e,t),void 0===t&&(t=new n.HighPrecisionLineMaterial({color:s||n.HighPrecisionLineMaterial.DEFAULT_COLOR,opacity:void 0!==o?o:n.HighPrecisionLineMaterial.DEFAULT_OPACITY})),this.matrixWorldInverse=new r.Matrix4,i&&this.setPositions(i)}get bufferGeometry(){return this.geometry}get shaderMaterial(){return this.material}setPositions(e){s.HighPrecisionUtils.setPositions(this,e)}setupForRendering(){this.onBeforeRender=(e,t,i,n,r,o)=>{s.HighPrecisionUtils.updateHpUniforms(this,i,this.shaderMaterial)}}updateMatrixWorld(e){const t=this.matrixWorldNeedsUpdate||e;super.updateMatrixWorld(e),t&&this.matrixWorldInverse.getInverse(this.matrixWorld)}}t.HighPrecisionWireFrameLine=o;class a extends r.Mesh{constructor(e,t,i,s,o){super(void 0===e?new r.BufferGeometry:e,t),void 0===t&&(t=new n.HighPrecisionLineMaterial({color:s||n.HighPrecisionLineMaterial.DEFAULT_COLOR,opacity:void 0!==o?o:n.HighPrecisionLineMaterial.DEFAULT_OPACITY})),this.matrixWorldInverse=new r.Matrix4,i&&this.setPositions(i)}get bufferGeometry(){return this.geometry}get shaderMaterial(){return this.material}setPositions(e){s.HighPrecisionUtils.setPositions(this,e)}setupForRendering(){this.onBeforeRender=(e,t,i,n,r,o)=>{s.HighPrecisionUtils.updateHpUniforms(this,i,this.shaderMaterial)}}updateMatrixWorld(e){const t=this.matrixWorldNeedsUpdate||e;super.updateMatrixWorld(e),t&&this.matrixWorldInverse.getInverse(this.matrixWorld)}}t.HighPrecisionLine=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(2),r=i(6),s=i(0),o=i(87);var a,l,c;!function(e){e[e.NONE=0]="NONE",e[e.PAN=1]="PAN",e[e.ROTATE=2]="ROTATE",e[e.ORBIT=3]="ORBIT",e[e.TOUCH=4]="TOUCH"}(a||(a={})),function(e){e[e.Tilted=0]="Tilted",e[e.Down=1]="Down"}(l=t.TiltState||(t.TiltState={})),function(e){e.Update="update",e.BeginInteraction="begin-interaction",e.EndInteraction="end-interaction"}(c=t.EventNames||(t.EventNames={}));const h={type:c.Update},d={type:c.BeginInteraction},u={type:c.EndInteraction},m=new s.Quaternion,p=new s.Quaternion,f=new s.Vector3(0,0,1),g=new s.Vector3(1,0,0),_=Math.PI/4;class v extends s.EventDispatcher{constructor(e){super(),this.mapView=e,this.rotationMouseDeltaFactor=.1,this.orbitingMouseDeltaFactor=.1,this.orbitingTouchDeltaFactor=.1,this.enabled=!0,this.tiltEnabled=!0,this.rotateEnabled=!0,this.inertiaEnabled=!0,this.zoomInertiaDampingDuration=.5,this.panInertiaDampingDuration=1,this.tiltToggleDuration=.5,this.tiltAngle=Math.PI/4,this.zoomLevelDeltaOnMouseWheel=.2,this.zoomLevelDeltaOnControl=1,this.minZoomLevel=0,this.maxZoomLevel=20,this.minCameraHeight=3,this.m_currentViewDirection=new s.Vector3,this.m_lastMousePosition=new s.Vector2(0,0),this.m_mouseDelta=new s.Vector2(0,0),this.m_needsRenderLastFrame=!0,this.m_panIsAnimated=!1,this.m_panDistanceFrameDelta=new s.Vector3,this.m_panAnimationTime=0,this.m_panAnimationStartTime=0,this.m_lastAveragedPanDistance=0,this.m_currentInertialPanningSpeed=0,this.m_lastPanVector=new s.Vector3,this.m_recentPanDistances=[0,0,0,0,0],this.m_currentPanDistanceIndex=0,this.m_zoomIsAnimated=!1,this.m_zoomDeltaRequested=0,this.m_zoomTargetNormalizedCoordinates=new s.Vector2,this.m_zoomAnimationTime=0,this.m_zoomAnimationStartTime=0,this.m_startZoom=0,this.m_tiltIsAnimated=!1,this.m_pitchRequested=void 0,this.m_tiltAnimationTime=0,this.m_tiltAnimationStartTime=0,this.m_startPitch=0,this.m_state=a.NONE,this.m_tmpVector2=new s.Vector2,this.m_tmpVector3=new s.Vector3,this.m_minPitchAngle=0,this.m_maxPitchAngle=_,this.m_touchState={touches:[],currentRotation:0,initialRotation:0},this.dispose=()=>{},this.camera=e.camera,this.domElement=e.renderer.domElement,this.maxZoomLevel=e.maxZoomLevel,this.minZoomLevel=e.minZoomLevel,this.minCameraHeight=e.minCameraHeight,this.bindInputEvents(this.domElement),this.handleZoom=this.handleZoom.bind(this),this.pan=this.pan.bind(this),this.tilt=this.tilt.bind(this)}static create(e){return new v(e)}rotate(e,t){this.inertiaEnabled&&this.m_zoomIsAnimated&&this.stopZoom();const i=r.MapViewUtils.extractYawPitchRoll(this.camera.quaternion);let s=i.yaw;this.rotateEnabled&&(s-=n.MathUtils.degToRad(e)),m.setFromAxisAngle(f,s);const o=n.MathUtils.degToRad(t),a=this.constrainPitchAngle(i.pitch,o);p.setFromAxisAngle(g,a),m.multiply(p),this.mapView.camera.quaternion.copy(m),this.mapView.camera.matrixWorldNeedsUpdate=!0}get yawPitchRoll(){const e=r.MapViewUtils.extractYawPitchRoll(this.camera.quaternion);return{yaw:n.MathUtils.radToDeg(e.yaw),pitch:n.MathUtils.radToDeg(e.pitch),roll:n.MathUtils.radToDeg(e.roll)}}orbitFocusPoint(e,t){this.inertiaEnabled&&this.m_zoomIsAnimated&&this.stopZoom(),this.mapView.camera.getWorldDirection(this.m_currentViewDirection);const i=o.directionToAzimuthAltitude(this.m_currentViewDirection),n=1/Math.sin(i.altitude)*this.mapView.camera.position.z,s=r.MapViewUtils.rayCastWorldCoordinates(this.mapView,0,0),a=this.getMinDelta(t);this.rotate(e,a),this.mapView.camera.getWorldDirection(this.m_currentViewDirection);const l=o.directionToAzimuthAltitude(this.m_currentViewDirection),c=Math.sin(l.altitude)*n;this.mapView.camera.position.z=c;const h=r.MapViewUtils.rayCastWorldCoordinates(this.mapView,0,0);if(!s||!h)return void this.updateMapView();const d=s.sub(h);r.MapViewUtils.pan(this.mapView,d.x,d.y)}moveAlongTheViewDirection(e){this.mapView.camera.getWorldDirection(this.m_currentViewDirection),this.m_currentViewDirection.multiplyScalar(e),this.mapView.camera.position.z+=this.m_currentViewDirection.z,this.mapView.worldCenter.x+=this.m_currentViewDirection.x,this.mapView.worldCenter.y+=this.m_currentViewDirection.y,this.updateMapView()}setRotation(e,t){r.MapViewUtils.setRotation(this.mapView,e,t)}zoomOnTargetPosition(e,t,i){r.MapViewUtils.zoomOnTargetPosition(this.mapView,e,t,i)}setZoomLevel(e,t={x:0,y:0}){!1!==this.enabled&&(this.dispatchEvent(d),this.m_startZoom=this.currentZoom,this.m_zoomDeltaRequested=e-this.zoomLevelTargetted,this.m_panDistanceFrameDelta.set(0,0,0),this.m_lastAveragedPanDistance=0,this.m_zoomTargetNormalizedCoordinates.set(t.x,t.y),this.m_zoomAnimationStartTime=performance.now(),this.handleZoom(),this.dispatchEvent(u))}toggleTilt(){this.m_startPitch=this.currentPitch;const e=this.m_startPitch<.01||this.m_tiltState===l.Down;this.m_pitchRequested=e?this.tiltAngle:0,this.m_tiltState=e?l.Tilted:l.Down,this.m_tiltAnimationStartTime=performance.now(),this.tilt()}set cameraHeight(e){this.camera.position.setZ(e),this.camera.matrixWorldNeedsUpdate=!0}get cameraHeight(){return this.mapView.camera.position.z}set maxPitchAngle(e){this.m_maxPitchAngle=n.MathUtils.degToRad(e)}get maxPitchAngle(){return n.MathUtils.radToDeg(this.m_maxPitchAngle)}set minPitchAngle(e){this.m_minPitchAngle=n.MathUtils.degToRad(e)}get minPitchAngle(){return n.MathUtils.radToDeg(this.m_minPitchAngle)}get zoomLevelTargetted(){return void 0===this.m_targettedZoom?this.currentZoom:this.m_targettedZoom}get tiltState(){return void 0===this.m_tiltState&&(this.m_tiltState=this.currentPitch<.01||this.m_tiltState===l.Down?l.Tilted:l.Down),this.m_tiltState}set currentZoom(e){this.m_currentZoom=e}get currentZoom(){return void 0!==this.m_currentZoom?this.m_currentZoom:this.mapView.zoomLevel}set currentPitch(e){this.m_currentPitch=e}get currentPitch(){return r.MapViewUtils.extractYawPitchRoll(this.mapView.camera.quaternion).pitch}get targettedPitch(){return void 0===this.m_targettedPitch?void 0===this.m_currentPitch?this.currentPitch:this.m_currentPitch:this.m_targettedPitch}tilt(){if(void 0!==this.m_pitchRequested&&(this.m_targettedPitch=Math.max(Math.min(this.m_pitchRequested,this.maxPitchAngle),this.m_minPitchAngle),this.m_pitchRequested=void 0),this.inertiaEnabled){this.m_tiltIsAnimated||(this.m_tiltIsAnimated=!0,this.mapView.addEventListener(r.MapViewEventNames.AfterRender,this.tilt));const e=performance.now();this.m_tiltAnimationTime=(e-this.m_tiltAnimationStartTime)/1e3,this.m_tiltAnimationTime>this.tiltToggleDuration?this.m_needsRenderLastFrame&&(this.m_needsRenderLastFrame=!1,this.m_tiltAnimationTime=this.tiltToggleDuration,this.stopTilt()):this.m_needsRenderLastFrame=!0}this.m_currentPitch=this.inertiaEnabled?this.easeOutCubic(this.m_startPitch,this.targettedPitch,Math.min(1,this.m_tiltAnimationTime/this.tiltToggleDuration)):this.targettedPitch;const e=this.currentPitch,t=this.m_currentPitch-e,i=this.mapView.camera.position.z/Math.cos(e),s=Math.cos(this.currentPitch)*i;this.orbitFocusPoint(s-this.camera.position.z,n.MathUtils.radToDeg(t)),this.updateMapView()}stopTilt(){this.mapView.removeEventListener(r.MapViewEventNames.AfterRender,this.tilt),this.m_tiltIsAnimated=!1,this.m_targettedPitch=this.m_currentPitch=void 0}easeOutCubic(e,t,i){return e+(t-e)*(--i*i*i+1)}handleZoom(){if(0!==this.m_zoomDeltaRequested&&(this.m_targettedZoom=Math.max(Math.min(this.zoomLevelTargetted+this.m_zoomDeltaRequested,this.maxZoomLevel),this.minZoomLevel),this.m_zoomDeltaRequested=0),this.inertiaEnabled){this.m_zoomIsAnimated||(this.m_zoomIsAnimated=!0,this.mapView.addEventListener(r.MapViewEventNames.AfterRender,this.handleZoom));const e=performance.now();this.m_zoomAnimationTime=(e-this.m_zoomAnimationStartTime)/1e3,this.m_zoomAnimationTime>this.zoomInertiaDampingDuration?this.m_needsRenderLastFrame&&(this.m_needsRenderLastFrame=!1,this.m_zoomAnimationTime=this.zoomInertiaDampingDuration,this.stopZoom()):this.m_needsRenderLastFrame=!0}this.currentZoom=!this.inertiaEnabled||Math.abs(this.zoomLevelTargetted-this.m_startZoom)<.01?this.zoomLevelTargetted:this.easeOutCubic(this.m_startZoom,this.zoomLevelTargetted,Math.min(1,this.m_zoomAnimationTime/this.zoomInertiaDampingDuration)),r.MapViewUtils.zoomOnTargetPosition(this.mapView,this.m_zoomTargetNormalizedCoordinates.x,this.m_zoomTargetNormalizedCoordinates.y,this.currentZoom),this.updateMapView()}stopZoom(){this.mapView.removeEventListener(r.MapViewEventNames.AfterRender,this.handleZoom),this.m_zoomIsAnimated=!1}pan(){if(this.m_state===a.NONE&&0===this.m_lastAveragedPanDistance)return;this.inertiaEnabled&&!this.m_panIsAnimated&&(this.m_panIsAnimated=!0,this.mapView.addEventListener(r.MapViewEventNames.AfterRender,this.pan));const e=this.inertiaEnabled&&this.m_state===a.NONE&&this.m_lastAveragedPanDistance>0;if(e){const e=performance.now();this.m_panAnimationTime=(e-this.m_panAnimationStartTime)/1e3,this.m_panAnimationTime>this.panInertiaDampingDuration?this.m_needsRenderLastFrame&&(this.m_needsRenderLastFrame=!1,this.m_panAnimationTime=this.panInertiaDampingDuration,this.mapView.removeEventListener(r.MapViewEventNames.AfterRender,this.pan),this.m_panIsAnimated=!1):this.m_needsRenderLastFrame=!0;const t=this.m_panAnimationTime/this.panInertiaDampingDuration;this.m_currentInertialPanningSpeed=this.easeOutCubic(this.m_lastAveragedPanDistance,0,Math.min(1,t)),0===this.m_currentInertialPanningSpeed&&(this.m_lastAveragedPanDistance=0),this.m_panDistanceFrameDelta.copy(this.m_lastPanVector).setLength(this.m_currentInertialPanningSpeed)}else{this.m_lastPanVector.copy(this.m_panDistanceFrameDelta);const e=this.m_lastPanVector.length();this.m_currentPanDistanceIndex=(this.m_currentPanDistanceIndex+1)%5,this.m_recentPanDistances[this.m_currentPanDistanceIndex]=e,this.m_lastAveragedPanDistance=this.m_recentPanDistances.reduce((e,t)=>e+t)/5}r.MapViewUtils.pan(this.mapView,this.m_panDistanceFrameDelta.x,this.m_panDistanceFrameDelta.y),e||this.m_panDistanceFrameDelta.set(0,0,0),this.updateMapView()}bindInputEvents(e){const t=this.contextMenu.bind(this),i=this.mouseDown.bind(this),n=this.mouseWheel.bind(this),r=this.touchStart.bind(this),s=this.touchEnd.bind(this),o=this.touchMove.bind(this);e.addEventListener("contextmenu",t,!1),e.addEventListener("mousedown",i,!1),e.addEventListener("wheel",n,!1),e.addEventListener("touchstart",r,!1),e.addEventListener("touchend",s,!1),e.addEventListener("touchmove",o,!1),this.dispose=()=>{e.removeEventListener("contextmenu",t,!1),e.removeEventListener("mousedown",i,!1),e.removeEventListener("wheel",n,!1),e.removeEventListener("touchstart",r,!1),e.removeEventListener("touchend",s,!1),e.removeEventListener("touchmove",o,!1)}}updateMapView(){this.dispatchEvent(h),this.mapView.update()}mouseDown(e){if(!1===this.enabled)return;if(e.shiftKey||e.ctrlKey)return;if(e.preventDefault(),e.stopPropagation(),this.m_state!==a.NONE)return;if(0===e.button)this.m_state=a.PAN;else if(1===e.button)this.m_state=a.ROTATE;else{if(2!==e.button||!this.tiltEnabled)return;this.m_state=a.ORBIT}this.dispatchEvent(d),this.m_lastMousePosition.setX(e.clientX),this.m_lastMousePosition.setY(e.clientY);const t=this.mouseMove.bind(this),i=this.mouseUp.bind(this);window.addEventListener("mousemove",t,!1),window.top.addEventListener("mousemove",t,!1),window.addEventListener("mouseup",i,!1),window.top.addEventListener("mouseup",i,!1),this.m_cleanupMouseEventListeners=()=>{window.removeEventListener("mousemove",t),window.top.removeEventListener("mousemove",t),window.removeEventListener("mouseup",i),window.top.removeEventListener("mouseup",i)}}mouseMove(e){!1!==this.enabled&&(this.m_mouseDelta.set(e.clientX-this.m_lastMousePosition.x,e.clientY-this.m_lastMousePosition.y),this.m_state===a.PAN?this.panFromTo(this.m_lastMousePosition.x,this.m_lastMousePosition.y,e.clientX,e.clientY):this.m_state===a.ROTATE?this.rotate(-this.rotationMouseDeltaFactor*this.m_mouseDelta.x,this.rotationMouseDeltaFactor*this.m_mouseDelta.y):this.m_state===a.ORBIT&&this.orbitFocusPoint(this.orbitingMouseDeltaFactor*this.m_mouseDelta.x,-this.orbitingMouseDeltaFactor*this.m_mouseDelta.y),this.m_lastMousePosition.setX(e.clientX),this.m_lastMousePosition.setY(e.clientY),this.m_zoomAnimationStartTime=performance.now(),this.updateMapView(),e.preventDefault(),e.stopPropagation())}mouseUp(e){!1!==this.enabled&&(this.updateMapView(),e.preventDefault(),e.stopPropagation(),this.m_state=a.NONE,this.m_cleanupMouseEventListeners&&this.m_cleanupMouseEventListeners(),this.dispatchEvent(u))}mouseWheel(e){const{width:t,height:i}=o.getWidthAndHeightFromCanvas(this.domElement),n=o.calculateNormalizedDeviceCoordinates(e.offsetX,e.offsetY,t,i);this.setZoomLevel(this.zoomLevelTargetted+this.zoomLevelDeltaOnMouseWheel*(e.deltaY>0?-1:1),n),e.preventDefault(),e.stopPropagation()}calculateAngleFromTouchPointsInWorldspace(){if(this.m_touchState.touches.length<2)return 0;const e=this.m_touchState.touches[1].currentWorldPosition.x-this.m_touchState.touches[0].currentWorldPosition.x,t=this.m_touchState.touches[1].currentWorldPosition.y-this.m_touchState.touches[0].currentWorldPosition.y;return Math.atan2(t,e)}calculatePinchDistanceInWorldSpace(){if(this.m_touchState.touches.length<2)return 0;const e=this.m_tmpVector3.subVectors(this.m_touchState.touches[0].initialWorldPosition,this.m_touchState.touches[1].initialWorldPosition).length();return this.m_tmpVector3.subVectors(this.m_touchState.touches[0].currentWorldPosition,this.m_touchState.touches[1].currentWorldPosition).length()-e}convertTouchPoint(e){const t=new s.Vector2(e.pageX,e.pageY),{width:i,height:n}=o.getWidthAndHeightFromCanvas(this.domElement),a=o.calculateNormalizedDeviceCoordinates(t.x,t.y,i,n),l=r.MapViewUtils.rayCastWorldCoordinates(this.mapView,a.x,a.y);return null===l?null:{currentTouchPoint:t,lastTouchPoint:t,currentWorldPosition:l,initialWorldPosition:l}}setTouchState(e){this.m_touchState.touches=[];for(let t=0;t<e.length;++t){const i=this.convertTouchPoint(e[t]);i&&this.m_touchState.touches.push(i)}0!==this.m_touchState.touches.length&&(this.updateTouchState(),this.m_touchState.initialRotation=this.m_touchState.currentRotation)}updateTouchState(){this.m_touchState.currentRotation=this.calculateAngleFromTouchPointsInWorldspace()}updateTouches(e){const t=Math.min(e.length,this.m_touchState.touches.length);for(let i=0;i<t;++i){const t=this.m_touchState.touches[i],n=this.convertTouchPoint(e[i]);null!==n&&(n.initialWorldPosition=t.initialWorldPosition,n.lastTouchPoint=t.currentTouchPoint,this.m_touchState.touches[i]=n)}}touchStart(e){!1!==this.enabled&&(this.m_state=a.TOUCH,this.dispatchEvent(d),this.setTouchState(e.touches),e.preventDefault(),e.stopPropagation())}touchMove(e){if(!1!==this.enabled){if(this.updateTouches(e.touches),this.updateTouchState(),this.m_touchState.touches.length<=2&&(this.m_panDistanceFrameDelta.subVectors(this.m_touchState.touches[0].initialWorldPosition,this.m_touchState.touches[0].currentWorldPosition),this.m_startZoom=this.m_targettedZoom=this.currentZoom,this.m_panAnimationStartTime=performance.now(),this.pan()),2===this.m_touchState.touches.length){const e=this.m_touchState.currentRotation-this.m_touchState.initialRotation;this.rotate(n.MathUtils.radToDeg(e),0),this.moveAlongTheViewDirection(this.calculatePinchDistanceInWorldSpace())}if(3===this.m_touchState.touches.length&&this.tiltEnabled){const e=this.m_touchState.touches[0],t=this.m_tmpVector2.subVectors(e.currentTouchPoint,e.lastTouchPoint);this.orbitFocusPoint(this.orbitingTouchDeltaFactor*t.x,-this.orbitingTouchDeltaFactor*t.y)}this.m_zoomAnimationStartTime=performance.now(),this.updateMapView(),e.preventDefault(),e.stopPropagation()}}touchEnd(e){!1!==this.enabled&&(this.m_state=a.NONE,this.setTouchState(e.touches),this.dispatchEvent(u),this.updateMapView(),e.preventDefault(),e.stopPropagation())}contextMenu(e){e.preventDefault()}panFromTo(e,t,i,n){const{width:s,height:a}=o.getWidthAndHeightFromCanvas(this.domElement),l=o.calculateNormalizedDeviceCoordinates(e,t,s,a),c=o.calculateNormalizedDeviceCoordinates(i,n,s,a),h=r.MapViewUtils.rayCastWorldCoordinates(this.mapView,c.x,c.y),d=r.MapViewUtils.rayCastWorldCoordinates(this.mapView,l.x,l.y);h&&d&&(this.m_panDistanceFrameDelta=d.sub(h),this.stopZoom(),this.m_panAnimationStartTime=performance.now(),this.pan())}constrainPitchAngle(e,t){const i=n.MathUtils.clamp(e+t,this.m_minPitchAngle,this.m_maxPitchAngle);return this.tiltEnabled&&i<=this.m_maxPitchAngle&&i>=this.m_minPitchAngle&&(e=i),e}getMinDelta(e){if(this.mapView.camera.position.z<this.minCameraHeight&&e>0)return 0;const t=(e,t)=>{const i=t.position,a=t.quaternion,l=new s.Quaternion,c=new s.Vector3,h=new s.Object3D;h.position.set(i.x,i.y,i.z),h.quaternion.set(a.x,a.y,a.z,a.w),h.getWorldDirection(c);const d=o.directionToAzimuthAltitude(c),u=1/Math.sin(d.altitude)*h.position.z,m=r.MapViewUtils.extractYawPitchRoll(h.quaternion),p=n.MathUtils.degToRad(e),f=this.constrainPitchAngle(m.pitch,p);l.setFromAxisAngle(g,f),h.quaternion.copy(l),h.matrixWorldNeedsUpdate=!0,h.getWorldDirection(c);const _=o.directionToAzimuthAltitude(c);return Math.sin(_.altitude)*u};let i=e;for(let e=0;e<10;e++){if(!(t(i,this.mapView.camera)<this.minCameraHeight))return i;i*=.5}return i}}t.MapControls=v},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);function r(e,t){if(null==e||""===e)return t;if(!e.match(s))return t;const i=Number.parseInt(e,10);return isNaN(i)?t:i}t.calculateNormalizedDeviceCoordinates=function(e,t,i,r){return new n.Vector2(e/i*2-1,-t/r*2+1)},t.directionToAzimuthAltitude=function(e){const t=e.clone().normalize(),i=new n.Vector2(t.x,t.y),r=new n.Vector2(i.length(),t.z).normalize();return{azimuth:Math.atan2(i.x,i.y),altitude:-Math.asin(r.y)}},t.azimuthAltitudeToDirection=function(e,t){e=e,t=t;const i=new n.Vector3,r=Math.cos(t);return i.setX(Math.sin(e)*r),i.setY(Math.cos(e)*r),i.setZ(Math.sin(t)),i},t.safeParseDecimalInt=r;const s=/^\d+$/;t.getWidthAndHeightFromCanvas=function(e){return{width:r(e.style.width,e.clientWidth),height:r(e.style.height,e.clientHeight)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(39);const n=i(3),r=i(6),s=i(1).LoggerManager.instance.create("TileLoader");class o{constructor(e,t,i,n,s){this.dataSource=e,this.tileKey=t,this.dataProvider=i,this.tileDecoder=n,this.priority=s,this.state=r.TileLoaderState.Initialized,this.loadAbortController=new AbortController,this.countRequests=0}loadAndDecode(){switch(this.state){case r.TileLoaderState.Loading:return this.countRequests++,this.donePromise;case r.TileLoaderState.Ready:case r.TileLoaderState.Failed:case r.TileLoaderState.Initialized:case r.TileLoaderState.Canceled:return this.countRequests++,this.ensureLoadingStarted(),this.donePromise;case r.TileLoaderState.Loaded:return this.countRequests++,this.startDecodeTile(),this.donePromise;case r.TileLoaderState.Decoding:return this.cancelDecoding(),this.ensureLoadingStarted(),this.donePromise}}waitSettled(){return this.donePromise?this.donePromise:Promise.resolve(this.state)}cancel(){if(0==--this.countRequests){switch(this.state){case r.TileLoaderState.Loading:this.loadAbortController.abort(),this.loadAbortController=new AbortController;break;case r.TileLoaderState.Decoding:this.requestController&&(this.requestController.abort(),this.requestController=void 0)}this.onDone(r.TileLoaderState.Canceled)}}get isFinished(){return this.state===r.TileLoaderState.Ready||this.state===r.TileLoaderState.Canceled||this.state===r.TileLoaderState.Failed}updatePriority(e){this.priority=e,void 0!==this.requestController&&(this.requestController.priority=e)}ensureLoadingStarted(){switch(this.state){case r.TileLoaderState.Ready:case r.TileLoaderState.Initialized:case r.TileLoaderState.Canceled:return void this.doStartLoad();case r.TileLoaderState.Loading:case r.TileLoaderState.Loaded:return void s.info("reusing already started load operation");case r.TileLoaderState.Decoding:return this.cancelDecoding(),void this.doStartLoad()}}doStartLoad(){const e=this.loadAbortController.signal;this.dataProvider.getTile(this.tileKey,e).then(t=>{if(e.aborted){const e=new Error("Aborted");throw e.name="AbortError",e}this.onLoaded(t)}).catch(e=>{"AbortError"!==e.name&&"AbortError: Aborted"!==e.message&&this.onError(e)}),void 0===this.donePromise&&(this.donePromise=new Promise((e,t)=>{this.resolveDonePromise=e,this.rejectedDonePromise=t})),this.state=r.TileLoaderState.Loading}onLoaded(e){this.state=r.TileLoaderState.Loaded,this.payload=e,(void 0===e.byteLength||0!==e.byteLength)&&e!=={}?this.startDecodeTile():this.onDone(r.TileLoaderState.Ready)}startDecodeTile(){const e=this.payload;if(void 0===e)return void s.error("TileLoader#startDecodeTile: Cannot decode without payload");this.state=r.TileLoaderState.Decoding,this.payload=void 0;const t=new n.RequestController(this.priority);this.requestController=t;const i=this.dataSource;this.tileDecoder.decodeTile(e,this.tileKey,i.projection,t).then(e=>{t.signal.aborted||this.onDecoded(e)}).catch(e=>{"AbortError"!==e.name&&"AbortError: Aborted"!==e.message&&this.onError(e)})}onDecoded(e){this.decodedTile=e,this.onDone(r.TileLoaderState.Ready)}cancelDecoding(){void 0!==this.requestController&&(this.requestController.abort(),this.requestController=void 0)}onDone(e){this.resolveDonePromise&&e===r.TileLoaderState.Ready?this.resolveDonePromise(e):this.rejectedDonePromise&&this.rejectedDonePromise(e),this.resolveDonePromise=void 0,this.rejectedDonePromise=void 0,this.donePromise=void 0,this.state=e}onError(e){const t=this.dataSource;s.error(`[${t.name}]: failed to load tile ${this.tileKey.toHereTile()}`,e),this.error=e,this.onDone(r.TileLoaderState.Failed)}}t.TileLoader=o;t.TileInfoLoader=class extends o{startDecodeTile(){const e=this.payload;if(void 0===e)return void s.error("TileInfoLoader#startDecodeTile: Cannot decode without payload");this.state=r.TileLoaderState.Decoding,this.payload=void 0;const t=new n.RequestController(this.priority);this.requestController=t;const i=this.dataSource;this.tileDecoder.getTileInfo(e,this.tileKey,i.projection,t).then(e=>{t.signal.aborted||(this.tileInfo=e,this.onDone(r.TileLoaderState.Ready))}).catch(e=>{"AbortError"!==e.name&&"AbortError: Aborted"!==e.message&&this.onError(e)})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(e){this.kind=e}static parse(e){return new T(e).parse()}}t.Expr=n;class r{lookup(e){}unmap(){return{}}}t.Env=r;t.MapEnv=class extends r{constructor(e,t){super(),this.entries=e,this.parent=t}lookup(e){const t=this.entries[e];return void 0!==t?t:this.parent?this.parent.lookup(e):void 0}unmap(){const e=this.parent?this.parent.unmap():{};for(const t in this.entries)this.entries.hasOwnProperty(t)&&(e[t]=this.entries[t]);return e}};class s extends n{constructor(e){super("var"),this.name=e}evaluate(e){return e.lookup(this.name)}}class o extends n{constructor(e){super("number"),this.value=e}evaluate(){return this.value}}class a extends n{constructor(e){super("string"),this.value=e}evaluate(){return this.value}}class l extends n{constructor(e){super("has"),this.attribute=e}evaluate(e){return void 0!==e.lookup(this.attribute)}}class c extends n{constructor(e,t){super("in"),this.value=e,this.elements=t}evaluate(e){const t=this.value.evaluate(e);for(const i of this.elements){if(t===i.evaluate(e))return!0}return!1}}class h extends n{constructor(e){super("!"),this.expr=e}evaluate(e){return!this.expr.evaluate(e)}}class d extends n{constructor(e,t,i){super(e),this.op=e,this.left=t,this.right=i}evaluate(e){const t=this.left.evaluate(e),i=this.right.evaluate(e);switch(this.op){case"~=":return"string"==typeof t&&"string"==typeof i&&-1!==t.indexOf(i);case"^=":return"string"==typeof t&&"string"==typeof i&&t.startsWith(i);case"$=":return"string"==typeof t&&"string"==typeof i&&t.endsWith(i);case"==":return t===i;case"!=":return t!==i;case"<":return void 0!==t&&void 0!==i?t<i:void 0;case">":return void 0!==t&&void 0!==i?t>i:void 0;case"<=":return void 0!==t&&void 0!==i?t<=i:void 0;case">=":return void 0!==t&&void 0!==i?t>=i:void 0}throw new Error("invalid relational op "+this.op)}}class u extends n{constructor(e,t,i){super(e),this.op=e,this.left=t,this.right=i}evaluate(e){const t=this.left.evaluate(e);switch(this.op){case"||":return t||this.right.evaluate(e);case"&&":return t&&this.right.evaluate(e)}throw new Error("invalid logical op "+this.op)}}var m,p;function f(e){switch(e){case m.Tab:case m.Lf:case m.Cr:case m.Space:return!0;default:return!1}}function g(e){return e>=m._0&&e<=m._9}function _(e){return e>=m.a&&e<=m.z||e>=m.A&&e<=m.Z}function v(e){return function(e){return _(e)||g(e)}(e)||e===m._||e===m.Dollar||e===m.Dot||e===m.LBracket||e===m.RBracket}function y(e){switch(e){case p.Eof:return"eof";case p.Error:return"error";case p.Identifier:return"identifier";case p.Number:return"number";case p.String:return"string";case p.Comma:return",";case p.LParen:return"(";case p.RParen:return")";case p.LBracket:return"[";case p.RBracket:return"]";case p.Exclaim:return"!";case p.TildeEqual:return"~=";case p.CaretEqual:return"^=";case p.DollarEqual:return"$=";case p.EqualEqual:return"==";case p.ExclaimEqual:return"!=";case p.Less:return"<";case p.Greater:return">";case p.LessEqual:return"<=";case p.GreaterEqual:return">=";case p.BarBar:return"||";case p.AmpAmp:return"&&";default:throw new Error("invalid token "+e)}}!function(e){e[e.Tab=9]="Tab",e[e.Lf=10]="Lf",e[e.Cr=13]="Cr",e[e.Space=32]="Space",e[e.LParen=40]="LParen",e[e.RParen=41]="RParen",e[e.Comma=44]="Comma",e[e.Dot=46]="Dot",e[e.LBracket=91]="LBracket",e[e.Backslash=92]="Backslash",e[e.RBracket=93]="RBracket",e[e._0=48]="_0",e[e._9=57]="_9",e[e._=95]="_",e[e.A=64]="A",e[e.Z=90]="Z",e[e.a=97]="a",e[e.z=122]="z",e[e.DoubleQuote=34]="DoubleQuote",e[e.SingleQuote=39]="SingleQuote",e[e.Exclaim=33]="Exclaim",e[e.Equal=61]="Equal",e[e.Caret=94]="Caret",e[e.Tilde=126]="Tilde",e[e.Dollar=36]="Dollar",e[e.Less=60]="Less",e[e.Greater=62]="Greater",e[e.Bar=124]="Bar",e[e.Amp=38]="Amp"}(m||(m={})),function(e){e[e.Eof=0]="Eof",e[e.Error=1]="Error",e[e.Identifier=2]="Identifier",e[e.Number=3]="Number",e[e.String=4]="String",e[e.Comma=5]="Comma",e[e.LParen=6]="LParen",e[e.RParen=7]="RParen",e[e.LBracket=8]="LBracket",e[e.RBracket=9]="RBracket",e[e.Exclaim=10]="Exclaim",e[e.TildeEqual=11]="TildeEqual",e[e.CaretEqual=12]="CaretEqual",e[e.DollarEqual=13]="DollarEqual",e[e.EqualEqual=14]="EqualEqual",e[e.ExclaimEqual=15]="ExclaimEqual",e[e.Less=16]="Less",e[e.Greater=17]="Greater",e[e.LessEqual=18]="LessEqual",e[e.GreaterEqual=19]="GreaterEqual",e[e.BarBar=20]="BarBar",e[e.AmpAmp=21]="AmpAmp"}(p||(p={}));class x{constructor(e){this.code=e,this.m_token=p.Error,this.m_index=0,this.m_char=m.Lf}token(){return this.m_token}text(){return this.m_text||""}next(){if(this.m_token=this.yylex(),this.m_token===p.Error)throw new Error("unexpected character "+this.m_char);return this.m_token}yyinp(){this.m_char=this.code.codePointAt(this.m_index++)||0}yylex(){for(this.m_text=void 0;f(this.m_char);)this.yyinp();if(0===this.m_char)return p.Eof;const e=this.m_char;switch(this.yyinp(),e){case m.LParen:return p.LParen;case m.RParen:return p.RParen;case m.LBracket:return p.LBracket;case m.RBracket:return p.RBracket;case m.Comma:return p.Comma;case m.SingleQuote:case m.DoubleQuote:{const t=this.m_index-1;for(;this.m_char&&this.m_char!==e;)this.yyinp();if(this.m_char!==e)throw new Error("Unfinished string literal");return this.yyinp(),this.m_text=this.code.substring(t,this.m_index-2),p.String}case m.Exclaim:return this.m_char===m.Equal?(this.yyinp(),p.ExclaimEqual):p.Exclaim;case m.Caret:return this.m_char===m.Equal?(this.yyinp(),p.CaretEqual):p.Error;case m.Tilde:return this.m_char===m.Equal?(this.yyinp(),p.TildeEqual):p.Error;case m.Equal:return this.m_char===m.Equal?(this.yyinp(),p.EqualEqual):p.Error;case m.Less:return this.m_char===m.Equal?(this.yyinp(),p.LessEqual):p.Less;case m.Greater:return this.m_char===m.Equal?(this.yyinp(),p.GreaterEqual):p.Greater;case m.Bar:return this.m_char===m.Bar?(this.yyinp(),p.BarBar):p.Error;case m.Amp:return this.m_char===m.Amp?(this.yyinp(),p.AmpAmp):p.Error;default:{const t=this.m_index-2;if(_(e)||e===m._||e===m.Dollar&&v(this.m_char)){for(;v(this.m_char);)this.yyinp();return this.m_text=this.code.substring(t,this.m_index-1),p.Identifier}if(g(e)){for(;g(this.m_char);)this.yyinp();if(this.m_char===m.Dot)for(this.yyinp();g(this.m_char);)this.yyinp();return this.m_text=this.code.substring(t,this.m_index-1),p.Number}if(e===m.Dollar)return this.m_char===m.Equal?(this.yyinp(),p.DollarEqual):p.Error}}return p.Error}}function w(e){switch(e){case p.TildeEqual:return"~=";case p.CaretEqual:return"^=";case p.DollarEqual:return"$=";case p.EqualEqual:return"==";case p.ExclaimEqual:return"!=";default:return}}function b(e){switch(e){case p.Less:return"<";case p.Greater:return">";case p.LessEqual:return"<=";case p.GreaterEqual:return">=";default:return}}class T{constructor(e){this.lex=new x(e),this.lex.next()}parse(){return this.parseLogicalOr()}yyexpect(e){if(this.lex.token()!==e)throw new Error(`Syntax error: Expected token '${y(e)}' but found '${y(this.lex.token())}'`);this.lex.next()}parsePrimary(){switch(this.lex.token()){case p.Identifier:{const e=this.lex.text();if("has"!==e){const t=new s(e);return this.lex.next(),t}this.lex.next(),this.yyexpect(p.LParen);const t=this.lex.text();return this.yyexpect(p.Identifier),this.yyexpect(p.RParen),new l(t)}case p.Number:{const e=new o(parseFloat(this.lex.text()));return this.lex.next(),e}case p.String:{const e=new a(this.lex.text());return this.lex.next(),e}case p.LParen:{this.lex.next();const e=this.parseLogicalOr();return this.yyexpect(p.RParen),e}}throw new Error("Syntax error")}parseUnary(){return this.lex.token()===p.Exclaim?(this.lex.next(),new h(this.parseUnary())):this.parsePrimary()}parseRelational(){let e=this.parseUnary();for(;;)if(this.lex.token()===p.Identifier&&"in"===this.lex.text()){this.lex.next(),this.yyexpect(p.LBracket);const t=[this.parsePrimary()];for(;this.lex.token()===p.Comma;)this.lex.next(),t.push(this.parsePrimary());this.yyexpect(p.RBracket),e=new c(e,t)}else{const t=b(this.lex.token());if(void 0===t)break;this.lex.next();const i=this.parseUnary();e=new d(t,e,i)}return e}parseEquality(){let e=this.parseRelational();for(;;){const t=w(this.lex.token());if(void 0===t)break;this.lex.next();const i=this.parseRelational();e=new d(t,e,i)}return e}parseLogicalAnd(){let e=this.parseEquality();for(;this.lex.token()===p.AmpAmp;){this.lex.next();const t=this.parseEquality();e=new u("&&",e,t)}return e}parseLogicalOr(){let e=this.parseLogicalAnd();for(;this.lex.token()===p.BarBar;){this.lex.next();const t=this.parseLogicalAnd();e=new u("||",e,t)}return e}}t.Parser=T},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(86)),n(i(161)),n(i(162)),n(i(87)),n(i(163))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(44);class s extends r.SolidLineMaterial{constructor(e){const t={};void 0!==e&&void 0!==e.color&&(t.color=e.color),void 0!==e&&void 0!==e.lineWidth&&(t.lineWidth=e.lineWidth),void 0!==e&&void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e&&void 0!==e.fog&&(t.fog=e.fog),super(t),this.name="DashedLineMaterial",Object.assign(this.uniforms,{dashSize:new n.Uniform(s.DEFAULT_DASH_SIZE),gapSize:new n.Uniform(s.DEFAULT_GAP_SIZE)}),void 0!==e&&(void 0!==e.dashSize&&(this.dashSize=e.dashSize),void 0!==e.gapSize&&(this.gapSize=e.gapSize),void 0!==e.fog&&(this.fog=null!==e.fog))}get dashSize(){return this.uniforms.dashSize.value}set dashSize(e){this.uniforms.dashSize.value=e}get gapSize(){return this.uniforms.gapSize.value}set gapSize(e){this.uniforms.gapSize.value=e,this.updateDashedFeature()}updateDashedFeature(){this.defines.DASHED_LINE=this.gapSize>0?1:0}}s.DEFAULT_DASH_SIZE=1,s.DEFAULT_GAP_SIZE=1,t.DashedLineMaterial=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(e,t=new Array){this.priority=e,this.elements=t}clone(){return new n(this.priority,this.elements.slice())}}t.PriorityListGroup=n;t.GroupedPriorityList=class{constructor(){this.groups=new Map}add(e){this.getGroup(e.priority).elements.push(e)}remove(e){const t=this.getGroup(e.priority);if(void 0!==t){const i=t.elements.indexOf(e);if(i>=0){if(t.elements.splice(i,1),0===t.elements.length){const t=Math.floor(e.priority);this.groups.delete(t)}return!0}}return!1}clear(){this.groups.clear()}merge(e){for(const t of e.groups){const e=this.findGroup(t[1].priority);void 0!==e?e.elements=e.elements.concat(t[1].elements):this.groups.set(Math.floor(t[1].priority),t[1].clone())}return this}get sortedGroups(){const e=[];for(const t of this.groups)e.push(t[1]);return e.sort((e,t)=>t.priority-e.priority),e}forEach(e){for(const t of this.groups)t[1].elements.forEach(e)}count(){let e=0;for(const t of this.groups)e+=t[1].elements.length;return e}findGroup(e){const t=Math.floor(e);return this.groups.get(t)}getGroup(e){let t=this.findGroup(e);if(void 0===t){const i=Math.floor(e);t=new n(i),this.groups.set(i,t)}return t}}},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(45)),n(i(27)),n(i(46)),n(i(94)),n(i(96)),n(i(47))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(95);t.LoggerManager=class{static get instance(){return this.m_instance||(this.m_instance=new n.LoggerManagerImpl)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(45),r=i(46),s=i(47);t.LoggerManagerImpl=class{constructor(){this.m_loggers=[],this.channel="undefined"==typeof self||void 0!==self.document?new n.ConsoleChannel:new s.WorkerChannel}getLoggerNames(){return this.m_loggers.map(e=>e.name)}getLogger(e){return this.m_loggers.find(t=>t.name===e)}create(e,t){const i=new r.Logger(e,this.channel,t);return this.m_loggers.push(i),i}dispose(e){const t=this.m_loggers.indexOf(e);if(t<0)throw new Error(`Cannot unregister "${e}" : no such logger registered.`);this.m_loggers.splice(t,1)}updateAll(e){for(const t of this.m_loggers)t.update(e)}update(e,t){for(const i of this.m_loggers)i.name===e&&i.update(t)}enableAll(e){for(const t of this.m_loggers)t.enabled=e}enable(e,t){this.update(e,{enabled:t})}setLogLevelForAll(e){for(const t of this.m_loggers)t.level=e}setLogLevel(e,t){this.update(e,{level:t})}setChannel(e){this.channel=e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MultiChannel=class{constructor(...e){this.channels=[],this.channels=e}error(e,...t){for(const i of this.channels)i.error(e,...t)}debug(e,...t){for(const i of this.channels)i.debug(e,...t)}info(e,...t){for(const i of this.channels)i.info(e,...t)}log(e,...t){for(const i of this.channels)i.log(e,...t)}trace(e,...t){for(const i of this.channels)i.trace(e,...t)}warn(e,...t){for(const i of this.channels)i.warn(e,...t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){function t(e,t,i,n){return(e-i)*(e-i)+(t-n)*(t-n)}e.Box=class{constructor(e=0,t=0,i=0,n=0){this.x=e,this.y=t,this.w=i,this.h=n}set(e,t,i,n){this.x=e,this.y=t,this.w=i,this.h=n}contains(e,t){return this.x<=e&&this.x+this.w>=e&&this.y<=t&&this.y+this.h>=t}intersects(e){return this.x<=e.x+e.w&&this.x+this.w>=e.x&&this.y<=e.y+e.h&&this.y+this.h>=e.y}},e.distSquared=t,e.computeSquaredLineLength=function(e){let t=0;const i=e.length-4;for(let n=0;n<i;n+=3){const i=e[n+3]-e[n],r=e[n+4]-e[n+1];t+=i*i+r*r}return t},e.distToSegmentSquared=function(e,i,n,r,s,o){const a=t(n,r,s,o);if(0===a)return t(e,i,n,r);let l=((e-n)*(s-n)+(i-r)*(o-r))/a;return l=Math.max(0,Math.min(1,l)),t(e,i,n+l*(s-n),r+l*(o-r))}}(t.Math2D||(t.Math2D={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){function t(e,t,i){return e<t?t:e>i?i:e}e.clamp=t,e.smoothStep=function(e,i,n){return(n=t((n-e)/(i-e),0,1))*n*(3-2*n)},e.smootherStep=function(e,i,n){return(n=t((n-e)/(i-e),0,1))*n*n*(n*(6*n-15)+10)},e.lerp=function(e,t,i,n,r){return(e-t)*(r-n)/(i-t)+n},e.min2=function(e,t){let i;return void 0!==e&&(i=e),void 0!==t&&(i=void 0===i?t:Math.min(i,t)),i},e.max2=function(e,t){let i;return void 0!==e&&(i=e),void 0!==t&&(i=void 0===i?t:Math.max(i,t)),i},e.isClamped=function(e,t,i){return!(void 0!==t&&e<t)&&!(void 0!==i&&e>i)},e.easeInOutCubic=function(e,t,i){return e+(t-e)*(i<.5?4*i*i*i:(i-1)*(2*i-2)*(2*i-2)+1)}}(t.MathUtils||(t.MathUtils={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.applyMixins=function(e,t){t.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(i=>{e.prototype[i]=t.prototype[i]})})},t.applyMixinsWithoutProperties=function(e,t){t.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(i=>{const n=Object.getOwnPropertyDescriptor(t.prototype,i);void 0!==n&&void 0===n.get&&(e.prototype[i]=t.prototype[i])})})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.assert=function(e,t){0},t.assertExists=function(e,t){return e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{static now(){return n.nowFunc()}static getNowFunc(){return"undefined"!=typeof performance&&void 0!==performance.now?()=>performance.now():()=>(new Date).getTime()}}n.instance=new n,n.nowFunc=n.getNowFunc(),t.PerformanceTimer=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOptionValue=function(...e){for(const t of e)if(null!=t)return t},t.mergeWithOptions=function(e,t){const i=Object.assign({},e);if(null==t)return i;for(const n in e)if(e.hasOwnProperty(n)){const e=t[n];null!=e&&(i[n]=e)}return i}},function(e,t,i){"use strict";let n;Object.defineProperty(t,"__esModule",{value:!0}),t.defaultUrlResolver=function(e){return void 0!==n?n(e):e},t.setDefaultUrlResolver=function(e){n=e},t.composeUrlResolvers=function(...e){return t=>e.reduce((e,t)=>void 0!==t?t(e):e,t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.resolveReferenceUrl=function(e,t){if(n.test(t))return t;if(t.startsWith("/")){return s(e)+t}return t.startsWith("./")&&(t=t.substr(2)),r(e)+t};const n=new RegExp("^(?:[a-z]+:)?//","i");function r(e){if(void 0===e)return"./";const t=e.lastIndexOf("/");return-1===t?"./":e.substring(0,t+1)}function s(e){if(void 0===e)return"";const t=o(e);return"file:"===t.protocol?"file://":t.host&&t.protocol?t.protocol+"//"+t.host:t.host?"//"+t.host:t.protocol?t.protocol+"//":""}function o(e){const t=new RegExp(/^(?:([a-z]+:))?\/\/([^\/]*)/,"i"),i=e.match(t);if(!i)throw new Error(`getUrlHostAndProtocol: unable to parse URL '${e}'`);return{protocol:i[1],host:i[2]}}t.baseUrl=r,t.getUrlOrigin=s,t.getUrlHostAndProtocol=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.chainCallbacks=function(e,t){return function(...i){return e&&e.apply(this,i),t.apply(this,i)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.insertShaderInclude=function(e,t,i,n){const r=!0===n?"\t":"";return e.replace(`#include <${t}>`,`#include <${t}>\n${r}#include <${i}>`)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={extrusion_pars_vertex:"\nuniform float extrusionRatio;\n",extrusion_vertex:"\ntransformed.z = transformed.z * extrusionRatio;\n",extrusion_pars_fragment:"\nuniform float extrusionRatio;\n",extrusion_fragment:"\ngl_FragColor.a *= smoothstep( 0.0, 0.25, extrusionRatio );\n"}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={fading_pars_vertex:"\nvarying float fadingDepth;\n",fading_vertex:"\nfadingDepth = -mvPosition.z;\n",fading_pars_fragment:"\nvarying float fadingDepth;\nuniform float fadeNear;\nuniform float fadeFar;\n",fading_fragment:'\n\n// lerp with "hard" edges\n//float fadingFactor = 1.0 - clamp((fadingDepth - fadeNear) / (fadeFar - fadeNear), 0.0, 1.0);\n\n// smooth transitions\nfloat fadingFactor = smoothstep( fadeNear, fadeFar, fadingDepth );\n\ngl_FragColor.a *= 1.0 - fadingFactor;\n\n// debugging color:\n// gl_FragColor = vec4(1., fadingFactor, fadingFactor, 1.0);\n'}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(11),s=i(26);class o extends n.RawShaderMaterial{constructor(e){super({name:"EdgeMaterial",vertexShader:"\nattribute vec3 position;\nattribute vec4 color;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec3 edgeColor;\nuniform float edgeColorMix;\n\nvarying vec3 vColor;\n\n#ifdef USE_EXTRUSION\n#include <extrusion_pars_vertex>\n#endif\n\n#ifdef USE_FADING\n#include <fading_pars_vertex>\n#endif\n\nvoid main() {\n    #ifdef USE_COLOR\n    vColor = mix(edgeColor.rgb, color.rgb, edgeColorMix);\n    #else\n    vColor = edgeColor.rgb;\n    #endif\n\n    vec3 transformed = vec3( position );\n\n    #ifdef USE_EXTRUSION\n    #include <extrusion_vertex>\n    #endif\n\n    vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n\n    gl_Position = projectionMatrix * mvPosition;\n\n    #ifdef USE_FADING\n    #include <fading_vertex>\n    #endif\n}",fragmentShader:"\nprecision highp float;\nprecision highp int;\n\nvarying vec3 vColor;\n\n#ifdef USE_EXTRUSION\n#include <extrusion_pars_fragment>\n#endif\n\n#ifdef USE_FADING\n#include <fading_pars_fragment>\n#endif\n\nvoid main() {\n    float alphaValue = 1.0;\n    gl_FragColor = vec4(vColor, alphaValue);\n\n    #ifdef USE_EXTRUSION\n    #include <extrusion_fragment>\n    #endif\n\n    #ifdef USE_FADING\n    #include <fading_fragment>\n    #endif\n}",uniforms:{edgeColor:new n.Uniform(new n.Color(o.DEFAULT_COLOR)),edgeColorMix:new n.Uniform(o.DEFAULT_COLOR_MIX),fadeNear:new n.Uniform(s.FadingFeature.DEFAULT_FADE_NEAR),fadeFar:new n.Uniform(s.FadingFeature.DEFAULT_FADE_FAR),extrusionRatio:new n.Uniform(r.AnimatedExtrusionTileHandler.DEFAULT_RATIO_MIN)},depthWrite:!1}),this.transparent=!0,s.FadingFeature.patchGlobalShaderChunks(),s.ExtrusionFeature.patchGlobalShaderChunks(),void 0!==e&&(void 0!==e.color&&this.color.set(e.color),void 0!==e.colorMix&&(this.colorMix=e.colorMix),void 0!==e.fadeNear&&(this.fadeNear=e.fadeNear),void 0!==e.fadeFar&&(this.fadeFar=e.fadeFar))}get color(){return this.uniforms.edgeColor.value}set color(e){this.uniforms.edgeColor.value=e}get colorMix(){return this.uniforms.edgeColorMix.value}set colorMix(e){this.uniforms.edgeColorMix.value=e,this.updateColorMixFeature()}updateColorMixFeature(){this.defines.USE_COLOR=this.colorMix>0?1:0}get fadeNear(){return this.uniforms.fadeNear.value}set fadeNear(e){this.uniforms.fadeNear.value=e}get fadeFar(){return this.uniforms.fadeFar.value}set fadeFar(e){this.uniforms.fadeFar.value=e,void 0!==e&&e>0?(this.needsUpdate=this.needsUpdate||void 0===this.defines.USE_FADING,this.defines.USE_FADING=""):(this.needsUpdate=this.needsUpdate||void 0!==this.defines.USE_FADING,delete this.defines.USE_FADING)}get extrusionRatio(){return this.uniforms.extrusionRatio.value}set extrusionRatio(e){this.uniforms.extrusionRatio.value=e,void 0!==e&&e>=r.AnimatedExtrusionTileHandler.DEFAULT_RATIO_MIN?(this.needsUpdate=this.needsUpdate||void 0===this.defines.USE_EXTRUSION,this.defines.USE_EXTRUSION=""):(this.needsUpdate=this.needsUpdate||void 0!==this.defines.USE_EXTRUSION,delete this.defines.USE_EXTRUSION)}}o.DEFAULT_COLOR=0,o.DEFAULT_COLOR_MIX=0,t.EdgeMaterial=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(28);class s extends n.RawShaderMaterial{constructor(e){Object.assign(n.ShaderChunk,r.default);const t={name:"HighPrecisionLineMaterial",vertexShader:"\n#ifdef USE_COLOR\nattribute vec4 color;\nvarying vec3 vColor;\n#endif\n\n// uniforms to implement double-precision\nuniform mat4 u_mvp;             // combined modelView and projection matrix\nuniform vec3 u_eyepos;          // eye position major\nuniform vec3 u_eyepos_lowpart;  // eye position minor ((double) eyepos - (float) eyepos)\n\n// vertex attributes\nattribute vec3 position;        // high part\nattribute vec3 positionLow;     // low part\n\n#include <high_precision_vert_func>\n\nvoid main() {\n    #ifdef USE_COLOR\n    vColor = color.rgb;\n    #endif\n\n    vec3 pos = subtractDblEyePos(position);\n    gl_Position = u_mvp * vec4(pos, 1.0);\n}",fragmentShader:"\nprecision highp float;\nprecision highp int;\n\nuniform vec3 diffuse;\nuniform float opacity;\n\n#ifdef USE_COLOR\nvarying vec3 color;\n#endif\n\nvoid main() {\n    #ifdef USE_COLOR\n    gl_FragColor = vec4( diffuse * vColor, opacity );\n    #else\n    gl_FragColor = vec4( diffuse, opacity );\n    #endif\n}",uniforms:{diffuse:new n.Uniform(new n.Color(s.DEFAULT_COLOR)),opacity:new n.Uniform(s.DEFAULT_OPACITY),u_mvp:new n.Uniform(new n.Matrix4),u_eyepos:new n.Uniform(new n.Vector3),u_eyepos_lowpart:new n.Uniform(new n.Vector3)}};Object.assign(t,e),super(t),this.type="HighPrecisionLineMaterial",this.isHighPrecisionLineMaterial=!0,void 0!==e&&(void 0!==e.color&&this.color.set(e.color),void 0!==e.opacity&&(this.opacity=e.opacity)),this.updateTransparencyFeature()}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}updateTransparencyFeature(){this.transparent=this.opacity<1}}s.DEFAULT_COLOR=80,s.DEFAULT_OPACITY=1,t.HighPrecisionLineMaterial=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(28);class s extends n.PointsMaterial{constructor(e){Object.assign(n.ShaderChunk,r.default),super(e),this.type="HighPrecisionPointMaterial",this.vertexShader="\n#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif\n\nuniform float size;\n\n// uniforms to implement double-precision\nuniform mat4 u_mvp;             // combined modelView and projection matrix\nuniform vec3 u_eyepos;          // eye position major\nuniform vec3 u_eyepos_lowpart;  // eye position minor ((double) eyepos - (float) eyepos)\n\n// vertex attributes\nattribute vec3 positionLow;     // low part\n\n#include <high_precision_vert_func>\n\nvoid main() {\n    #ifdef USE_COLOR\n    vColor = color.rgb;\n    #endif\n\n    vec3 pos = subtractDblEyePos(position);\n    gl_Position = u_mvp * vec4(pos, 1.0);\n\n    // ignore sizeAttenuation for now!\n    gl_PointSize = size;\n}",this.fragmentShader=n.ShaderChunk.points_frag,this.fog=!1,this.uniforms={diffuse:new n.Uniform(new n.Color(s.DEFAULT_COLOR)),opacity:new n.Uniform(s.DEFAULT_OPACITY),size:new n.Uniform(s.DEFAULT_SIZE),scale:new n.Uniform(s.DEFAULT_SCALE),map:new n.Uniform(new n.Texture),uvTransform:new n.Uniform(new n.Matrix3),u_mvp:new n.Uniform(new n.Matrix4),u_eyepos:new n.Uniform(new n.Vector3),u_eyepos_lowpart:new n.Uniform(new n.Vector3)},this.isHighPrecisionPointMaterial=!0,void 0!==e&&(void 0!==e.color&&this.color.set(e.color),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.size&&(this.size=e.size),void 0!==e.scale&&(this.scale=e.scale),void 0!==e.uvTransform&&(this.uvTransform=e.uvTransform),void 0!==e.map&&(this.map=e.map))}get scale(){return this.uniforms.scale.value}set scale(e){this.uniforms.scale.value=e}get uvTransform(){return this.uniforms.uvTransform.value}set uvTransform(e){this.uniforms.uvTransform.value=e}}s.DEFAULT_COLOR=80,s.DEFAULT_OPACITY=1,s.DEFAULT_SIZE=1,s.DEFAULT_SCALE=1,t.HighPrecisionPointMaterial=s,t.isHighPrecisionPointMaterial=function(e){return void 0!==e&&!0===e.isHighPrecisionPointMaterial}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);class r extends n.RawShaderMaterial{constructor(e){super({name:"IconMaterial",vertexShader:"\nattribute vec4 position;\nattribute vec4 color;\nattribute vec2 uv;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\n\nvarying vec4 vColor;\nvarying vec2 vUv;\n\nvoid main() {\n    vUv = uv;\n    vColor = color;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xyz, 1.0);\n}",fragmentShader:"\nprecision highp float;\nprecision highp int;\n\nuniform sampler2D map;\n\nvarying vec4 vColor;\nvarying vec2 vUv;\n\nvoid main() {\n\n    vec4 color = texture2D(map, vUv.xy);\n    color *= vColor.a;\n    if (color.a < 0.05) {\n        discard;\n    }\n    gl_FragColor = color;\n}",uniforms:{map:new n.Uniform(e.map)},depthTest:!0,depthWrite:!0,transparent:!0,vertexColors:n.VertexColors,premultipliedAlpha:!0,blending:n.NormalBlending})}get map(){return this.uniforms.map.value}}t.IconMaterial=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);class r extends n.ShaderMaterial{constructor(e={}){e.depthTest=!1,super(e),this.isCirclePointsMaterial=!0,this.type="CirclePointsMaterial",this.vertexShader="\nuniform float size;\n\nvoid main() {\n    vec3 transformed = vec3(position);\n    vec4 mvPosition = modelViewMatrix * vec4(transformed, 1.0);\n\n    gl_Position = projectionMatrix * mvPosition;\n    gl_PointSize = size;\n}\n",this.fragmentShader="\nuniform vec3 diffuse;\n\nvoid main() {\n    float alpha = 1.0;\n\n    float radius = 0.5;\n    vec2 coords = gl_PointCoord.xy - vec2(0.5);\n    float len = length(coords);\n    float falloff = fwidth(len);\n    float threshold = 1.0 - smoothstep(radius - falloff, radius, len);\n    alpha *= threshold;\n\n    gl_FragColor = vec4(diffuse, alpha);\n}",this.transparent=!0,this.m_size=e.size||1,this.m_color=new n.Color,this.uniforms={diffuse:new n.Uniform(this.m_color),size:new n.Uniform(this.m_size)},this.extensions.derivatives=!0}get size(){return this.m_size}set size(e){this.m_size=e,this.uniforms.size.value=e,this.needsUpdate=!0}get color(){return"#"+this.m_color.getHexString()}set color(e){this.m_color.set(e),this.uniforms.diffuse.value.set(this.m_color),this.needsUpdate=!0}}t.CirclePointsMaterial=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(43);class s extends n.ShaderMaterial{constructor(e){super({uniforms:e,vertexShader:r.CopyShader.vertexShader,fragmentShader:r.CopyShader.fragmentShader,premultipliedAlpha:!0,transparent:!0,blending:n.AdditiveBlending,depthTest:!1,depthWrite:!1})}}t.MSAAMaterial=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isGeoCoordinatesLike=function(e){return e&&"number"==typeof e.latitude&&"number"==typeof e.longitude&&("number"==typeof e.altitude||void 0===e.altitude)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(12),r=i(5),s=i(14),o=i(7),a=i(8),l=i(15),c=Math.PI/180;t.identityProjection=new class{constructor(){this.type=l.ProjectionType.Planar}getScaleFactor(e){return 1}worldExtent(e,t,i){return i||(i=o.MathUtils.newEmptyBox3()),i.min.x=-Math.PI,i.min.y=.5*-Math.PI,i.min.z=e,i.max.x=Math.PI,i.max.y=.5*Math.PI,i.max.z=t,i}projectPoint(e,t){return t||(t={x:0,y:0,z:0}),t.x=e.longitude*c,t.y=e.latitude*c,t.z=e.altitude||0,t}unprojectPoint(e){return r.GeoCoordinates.fromRadians(e.y,e.x,e.z)}projectBox(e,t){t||(t=o.MathUtils.newEmptyBox3());const i=this.projectPoint(new r.GeoCoordinates(e.south,e.west,e.minAltitude)),n=this.projectPoint(new r.GeoCoordinates(e.north,e.east,e.maxAltitude));return s.isBox3Like(t)?(t.min.x=i.x,t.min.y=i.y,t.min.z=i.z,t.max.x=n.x,t.max.y=n.y,t.max.z=n.z):a.isOrientedBox3Like(t)&&(o.MathUtils.newVector3(1,0,0,t.xAxis),o.MathUtils.newVector3(0,1,0,t.yAxis),o.MathUtils.newVector3(0,0,1,t.zAxis),t.position.x=.5*(i.x+n.x),t.position.y=.5*(i.y+n.y),t.position.z=.5*(i.z+n.z),t.extents.x=.5*(n.x-i.x),t.extents.y=.5*(n.y-i.y),t.extents.z=Math.max(Number.EPSILON,.5*(n.z-i.z))),t}unprojectBox(e){const t=this.unprojectPoint(e.min),i=this.unprojectPoint(e.max);return n.GeoBox.fromCoordinates(t,i)}groundDistance(e){return e.z}scalePointToSurface(e){return e.z=0,e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(5),r=i(14),s=i(7),o=i(8),a=i(13),l=i(15);function c(e){const t=1/Math.PI,i=Math.floor(2*(e*t+1));return s.MathUtils.clamp(i,0,4)}function h(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z)}function d(e,t){const i=.5*(a.EarthConstants.EQUATORIAL_RADIUS+(e.maxAltitude||0)),n=s.MathUtils.degToRad(e.west),r=s.MathUtils.degToRad(e.east),o=c(n),l=c(r);let h=Math.cos(n),d=h,u=Math.sin(n),m=u;for(let e=o+1;e<=l;e++){const t=(e+1&1)*((2&e)-1);h=Math.min(t,h),d=Math.max(t,d);const i=(1&e)*((2&e)-1);u=Math.min(i,u),m=Math.max(i,m)}const p=Math.cos(r);h=Math.min(p,h),d=Math.max(p,d);const f=Math.sin(r);u=Math.min(f,u),m=Math.max(f,m);const g=(d+h)*i,_=(d-h)*i,v=(m+u)*i,y=(m-u)*i,x=s.MathUtils.degToRad(e.south),w=s.MathUtils.degToRad(e.north),b=Math.sin(w),T=Math.sin(x),S=(b+T)*i,C=(b-T)*i;return t.min.x=g-_,t.min.y=v-y,t.min.z=S-C,t.max.x=g+_,t.max.y=v+y,t.max.z=S+C,t}t.sphereProjection=new class{constructor(){this.type=l.ProjectionType.Spherical}worldExtent(e,t,i=s.MathUtils.newEmptyBox3()){const n=a.EarthConstants.EQUATORIAL_RADIUS+t;return i.min.x=-n,i.min.y=-n,i.min.z=-n,i.max.x=n,i.max.y=n,i.max.z=n,i}projectPoint(e,t=s.MathUtils.newVector3(0,0,0)){return function(e,t){const i=a.EarthConstants.EQUATORIAL_RADIUS+(e.altitude||0),n=s.MathUtils.degToRad(e.latitude),r=s.MathUtils.degToRad(e.longitude),o=Math.cos(n);return t.x=i*o*Math.cos(r),t.y=i*o*Math.sin(r),t.z=i*Math.sin(n),t}(e,t)}unprojectPoint(e){const t=e.x*e.x+e.y*e.y,i=Math.sqrt(t),r=e.z/i;if(isNaN(r))return n.GeoCoordinates.fromRadians(0,0,-a.EarthConstants.EQUATORIAL_RADIUS);const s=Math.sqrt(t+e.z*e.z);return n.GeoCoordinates.fromRadians(Math.atan(r),Math.atan2(e.y,e.x),s-a.EarthConstants.EQUATORIAL_RADIUS)}projectBox(e,t=s.MathUtils.newEmptyBox3()){if(r.isBox3Like(t))return d(e,t);if(o.isOrientedBox3Like(t)){if(e.longitudeSpan>=90){const i=d(e,s.MathUtils.newEmptyBox3());return s.MathUtils.newVector3(1,0,0,t.xAxis),s.MathUtils.newVector3(0,1,0,t.yAxis),s.MathUtils.newVector3(0,0,1,t.zAxis),t.position.x=.5*(i.max.x+i.min.x),t.position.y=.5*(i.max.y+i.min.y),t.position.z=.5*(i.max.z+i.min.z),t.extents.x=.5*(i.max.x-i.min.x),t.extents.y=.5*(i.max.y-i.min.y),t.extents.z=.5*(i.max.z-i.min.z),t}const{south:i,west:n,north:r,east:o,center:l}=e,c=l.longitude,h=l.latitude,u=Math.cos(s.MathUtils.degToRad(i)),m=Math.sin(s.MathUtils.degToRad(i)),p=Math.cos(s.MathUtils.degToRad(n)),f=Math.sin(s.MathUtils.degToRad(n)),g=Math.cos(s.MathUtils.degToRad(r)),_=Math.sin(s.MathUtils.degToRad(r)),v=Math.cos(s.MathUtils.degToRad(o)),y=Math.sin(s.MathUtils.degToRad(o)),x=Math.cos(s.MathUtils.degToRad(c)),w=Math.sin(s.MathUtils.degToRad(c)),b=Math.cos(s.MathUtils.degToRad(h)),T=Math.sin(s.MathUtils.degToRad(h));let S,C,E;s.MathUtils.newVector3(x*b,w*b,T,t.zAxis),s.MathUtils.newVector3(-w,x,0,t.xAxis),s.MathUtils.newVector3(-x*T,-w*T,b,t.yAxis),i>=0?(S=Math.abs(u*(x*(f-y)+w*(v-p))),C=b*m-T*u,E=b*_-T*g*(x*v+w*y)):(r<=0?(S=Math.abs(g*(x*(f-y)+w*(v-p))),E=b*_-T*g):(S=Math.abs(x*(f-y)+w*(v-p)),E=b*_-T*g*(w*y+x*v)),C=b*m-T*u*(x*v+w*y));const M=.5*(a.EarthConstants.EQUATORIAL_RADIUS+(e.maxAltitude||0)),A=.5*(a.EarthConstants.EQUATORIAL_RADIUS+(e.minAltitude||0)),P=b*(x*v+w*y),L=Math.min(g*P+_*T,u*P+m*T);return s.MathUtils.newVector3(S*M,(E-C)*M,M-L*A,t.extents),s.MathUtils.newVector3(0,(C+E)*M,M+M,t.position),function(e,t,i,n){const r=e.x*n.x+t.x*n.y+i.x*n.z,s=e.y*n.x+t.y*n.y+i.y*n.z,o=e.z*n.x+t.z*n.y+i.z*n.z;n.x=r,n.y=s,n.z=o}(t.xAxis,t.yAxis,t.zAxis,t.position),t.position.x=t.position.x-t.zAxis.x*t.extents.z,t.position.y=t.position.y-t.zAxis.y*t.extents.z,t.position.z=t.position.z-t.zAxis.z*t.extents.z,t}throw new Error("Invalid bounding box")}unprojectBox(e){throw new Error("Method not implemented.")}getScaleFactor(e){return 1}groundDistance(e){return h(e)-a.EarthConstants.EQUATORIAL_RADIUS}scalePointToSurface(e){const t=a.EarthConstants.EQUATORIAL_RADIUS/(h(e)||1);return e.x*=t,e.y*=t,e.z*=t,e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(20);t.QuadTree=class{constructor(e){this.tilingScheme=e}visit(e){this.visitTileKey(n.TileKey.fromRowColumnLevel(0,0,0),e)}visitTileKey(e,t){if(t(e,this.tilingScheme.getGeoBox(e)))for(const i of this.tilingScheme.getSubTileKeys(e))this.visitTileKey(i,t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(48),r=i(51),s=i(21);t.hereTilingScheme=new s.TilingScheme(r.halfQuadTreeSubdivisionScheme,n.equirectangularProjection)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(49),r=i(31),s=i(21);t.webMercatorTilingScheme=new s.TilingScheme(r.quadTreeSubdivisionScheme,n.webMercatorProjection)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(30),r=i(31),s=i(21);t.mercatorTilingScheme=new s.TilingScheme(r.quadTreeSubdivisionScheme,n.mercatorProjection)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isVector3Like=function(e){return e&&"number"==typeof e.x&&"number"==typeof e.y&&"number"==typeof e.z}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(57);function r(e){return"extruded-line"===e.name}function s(e){return r(e)&&"standard"===e.shading}function o(e){return"extruded-polygon"===e.name}function a(e){return"standard"===e.name}function l(e){return"terrain"===e.name}t.TEXTURE_PROPERTY_KEYS=["map","normalMap","displacementMap","roughnessMap","emissiveMap","alphaMap","metalnessMap","bumpMap"],t.isCirclesTechnique=function(e){return"circles"===e.name},t.isSquaresTechnique=function(e){return"squares"===e.name},t.isPoiTechnique=function(e){return"labeled-icon"===e.name},t.isLineMarkerTechnique=function(e){return"line-marker"===e.name},t.isDashedLineTechnique=function(e){return"dashed-line"===e.name},t.isLineTechnique=function(e){return"line"===e.name},t.isSolidLineTechnique=function(e){return"solid-line"===e.name},t.isSegmentsTechnique=function(e){return"segments"===e.name},t.isExtrudedLineTechnique=r,t.isBasicExtrudedLineTechnique=function(e){return r(e)&&"basic"===e.shading},t.isStandardExtrudedLineTechnique=s,t.isFillTechnique=function(e){return"fill"===e.name},t.isExtrudedPolygonTechnique=o,t.isStandardTechnique=a,t.isTerrainTechnique=l,t.isTextTechnique=function(e){return"text"===e.name},t.isShaderTechnique=function(e){return"shader"===e.name},t.needsVertexNormals=function(e){return a(e)||l(e)||s(e)},t.textureCoordinateType=function(e){return a(e)||o(e)||l(e)?e.textureCoordinateType:void 0},t.addBuffersToTransferList=function(e,i=[]){if(a(e)||o(e)||l(e))for(const r of t.TEXTURE_PROPERTY_KEYS){const t=e[r];n.isTextureBuffer(t)&&i.push(t.buffer)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){let t,i;e.WORKER_SERVICE_MANAGER_SERVICE_ID="worker-service-manager",function(e){e.Initialized="initialized",e.Request="request",e.Response="response"}(t=e.ServiceMessageName||(e.ServiceMessageName={})),e.isInitializedMessage=function(e){return e&&"string"==typeof e.service&&"string"==typeof e.type&&e.type===t.Initialized},function(e){e.CreateService="create-service",e.DestroyService="destroy-service"}(i=e.Requests||(e.Requests={})),e.isRequestMessage=function(e){return e&&"string"==typeof e.service&&"string"==typeof e.type&&e.type===t.Request},e.isResponseMessage=function(e){return e&&"string"==typeof e.service&&"string"==typeof e.type&&e.type===t.Response}}(t.WorkerServiceProtocol||(t.WorkerServiceProtocol={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){let t;!function(e){e.RegisterIndex="register-index",e.TileRequest="tile-request"}(t=e.Requests||(e.Requests={})),e.isRegisterIndexRequest=function(e){return e&&"string"==typeof e.type&&e.type===t.RegisterIndex},e.isTileRequest=function(e){return e&&"string"==typeof e.type&&e.type===t.TileRequest}}(t.WorkerTilerProtocol||(t.WorkerTilerProtocol={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.RequestController=class{constructor(e=0,t=new AbortController){this.priority=e,this.abortController=t}get signal(){return this.abortController.signal}abort(){this.abortController.abort()}},function(e){let t,i;!function(e){e.Configuration="configuration"}(t=e.DecoderMessageName||(e.DecoderMessageName={})),e.isConfigurationMessage=function(e){return e&&"string"==typeof e.service&&"string"==typeof e.type&&e.type===t.Configuration},function(e){e.DecodeTileRequest="decode-tile-request",e.TileInfoRequest="tile-info-request"}(i=e.Requests||(e.Requests={})),e.isDecodeTileRequest=function(e){return e&&"string"==typeof e.type&&e.type===i.DecodeTileRequest},e.isTileInfoRequest=function(e){return e&&"string"==typeof e.type&&e.type===i.TileInfoRequest}}(t.WorkerDecoderProtocol||(t.WorkerDecoderProtocol={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(2);t.getArrayConstructor=function(e){switch(e){case"float":return Float32Array;case"uint16":return Uint16Array;case"uint32":return Uint32Array}},function(e){e[e.Unspecified=0]="Unspecified",e[e.Point=1]="Point",e[e.Line=2]="Line",e[e.SolidLine=3]="SolidLine",e[e.Text=4]="Text",e[e.TextPath=5]="TextPath",e[e.ExtrudedLine=6]="ExtrudedLine",e[e.Polygon=7]="Polygon",e[e.ExtrudedPolygon=8]="ExtrudedPolygon",e[e.Object3D=9]="Object3D",e[e.Other=1e3]="Other"}(t.GeometryType||(t.GeometryType={})),t.getProjection=function(e){switch(e){case"mercator":return n.mercatorProjection;case"webMercator":return n.webMercatorProjection;case"sphere":return n.sphereProjection;default:throw new Error("Unknown projection "+e)}},t.getProjectionName=function(e){if(e===n.mercatorProjection)return"mercator";if(e===n.webMercatorProjection)return"webMercator";if(e===n.sphereProjection)return"sphere";throw new Error("Unknown projection")}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1);class r{constructor(e,t=5e3){this.featureIds=new Array,this.numFeatures=0,this.numPositions=0,this.featureIds=new Array(t),this.featureIds.length=t,this.techniqueIndex=new Array(t),this.techniqueIndex.length=t,this.textIndex=new Array(t),this.textIndex.length=t,this.positionIndex=new Array(t),this.positionIndex.length=t,this.positions=new Array(10*t),this.positions.length=10*t,e&&(this.layerIndex=new Array(t),this.layerIndex.length=t,this.classIndex=new Array(t),this.classIndex.length=t,this.typeIndex=new Array(t),this.typeIndex.length=t)}getNumBytes(){return 8*(this.featureIds.length+this.techniqueIndex.length+this.textIndex.length+this.positionIndex.length+this.positions.length+(void 0!==this.layerIndex?this.layerIndex.length:0)+(void 0!==this.classIndex?this.classIndex.length:0)+(void 0!==this.typeIndex?this.typeIndex.length:0))}}t.FeatureGroup=r;class s extends r{constructor(){super(...arguments),this.userData=[]}getNumBytes(){return super.getNumBytes()+8*((void 0!==this.segmentIds?this.segmentIds.length:0)+(void 0!==this.segmentStartOffsets?this.segmentStartOffsets.length:0)+(void 0!==this.segmentEndOffsets?this.segmentEndOffsets.length:0))}}t.LineFeatureGroup=s;class o extends r{constructor(e,t=5e3){super(e,t),this.groupNumRings=0,this.outerRingStartIndex=new Array(t),this.outerRingStartIndex.length=t,this.innerRingIsOuterContour=new Array(t),this.innerRingIsOuterContour.length=t,this.innerRingStartIndex=new Array(t),this.innerRingStartIndex.length=t}getNumBytes(){return super.getNumBytes()+8*((void 0!==this.outerRingStartIndex?this.outerRingStartIndex.length:0)+(void 0!==this.innerRingIsOuterContour?this.innerRingIsOuterContour.length:0)+(void 0!==this.innerRingStartIndex?this.innerRingStartIndex.length:0))}}t.PolygonFeatureGroup=o;class a{constructor(e,t){this.tileKey=e,this.textCatalog=new Array,this.techniqueCatalog=new Array,this.setupTime=0,this.numBytes=0,this.pointGroup=new r(t),this.lineGroup=new s(t),this.polygonGroup=new o(t),t&&(this.layerCatalog=new Array,this.classCatalog=new Array,this.typeCatalog=new Array)}getNumBytes(){let e=100;for(const t of this.textCatalog)e+=2*t.length;if(e+=100*this.techniqueCatalog.length,e+=this.pointGroup.getNumBytes(),e+=this.lineGroup.getNumBytes(),e+=this.polygonGroup.getNumBytes(),void 0!==this.layerCatalog){for(const t of this.layerCatalog)e+=2*t.length;for(const t of this.classCatalog)e+=2*t.length;for(const t of this.typeCatalog)e+=2*t.length}return e}}t.ExtendedTileInfo=a,function(e){function t(e){e.featureIds.length=e.numFeatures,e.techniqueIndex.length=e.numFeatures,e.textIndex.length=e.numFeatures,e.positionIndex.length=e.numFeatures,e.positions.length=e.numPositions,void 0!==e.layerIndex&&(e.layerIndex.length=e.numFeatures),void 0!==e.classIndex&&(e.classIndex.length=e.numFeatures),void 0!==e.typeIndex&&(e.typeIndex.length=e.numFeatures)}function i(e){return e.numPositions===e.positions.length}e.finish=function(e){var i,n;t(e.pointGroup),t(i=e.lineGroup),void 0!==i.segmentIds&&(i.segmentIds.length=i.numFeatures,i.segmentStartOffsets.length=i.numFeatures,i.segmentEndOffsets.length=i.numFeatures),t(n=e.polygonGroup),n.outerRingStartIndex.length=n.numFeatures,n.innerRingIsOuterContour.length=n.groupNumRings,n.innerRingStartIndex.length=n.groupNumRings,e.numBytes=e.getNumBytes()},e.featureGroupSize=function(e){return e.numFeatures},e.featureGroupFinished=i,e.tileInfoFinished=function(e){return i(e.pointGroup)&&i(e.lineGroup)&&i(e.polygonGroup)},e.getFeatureName=function(e,t,i,n){let r;if(t){const t=e.lookup("name:short");if("string"==typeof t&&t.length>0)return t}if(i){const t=e.lookup("iso_code");if("string"==typeof t&&t.length>0)return t}if(void 0!==n)for(const t of n)if(r=e.lookup("name:"+t)||e.lookup("name_"+t),"string"==typeof r&&r.length>0)return r;if(r=e.lookup("name"),"string"==typeof r)return r}}(a=t.ExtendedTileInfo||(t.ExtendedTileInfo={}));t.ExtendedTileInfoWriter=class{constructor(e,t,i){this.tileInfo=e,this.storeExtendedTags=t,this.languages=i,this.techniqueIndexMap=new Map,this.stringMap=new Map,this.layerMap=new Map,this.classMap=new Map,this.typeMap=new Map}addTechnique(e){let t=this.techniqueIndexMap.get(e._index);if(void 0!==t)return t;t=this.tileInfo.techniqueCatalog.length;const i={};return Object.getOwnPropertyNames(e).forEach(t=>{t.startsWith("_")||(i[t]=e[t])}),i._index=e._index,this.techniqueIndexMap.set(e._index,t),this.tileInfo.techniqueCatalog.push(i),t}addFeature(e,t,i,r,s,o){const l=t,c=l.label,h=l.useAbbreviation,d=l.useIsoCode,u="string"==typeof c?i.lookup(c):a.getFeatureName(i,h,d,this.languages);let m=-1;if(u&&"string"==typeof u&&(m=this.addText(u)),e.featureIds[e.numFeatures]=r,e.techniqueIndex[e.numFeatures]=s,e.textIndex[e.numFeatures]=m,e.positionIndex[e.numFeatures]=e.numPositions,o){const t=e;n.assert(void 0!==t.outerRingStartIndex),n.assert(void 0!==t.innerRingStartIndex),n.assert(void 0!==t.innerRingIsOuterContour),t.outerRingStartIndex[e.numFeatures]=t.groupNumRings}this.storeExtendedTags&&(e.layerIndex[e.numFeatures]=this.addLayer(i.lookup("$layer")),e.classIndex[e.numFeatures]=this.addClass(i.lookup("class")),e.typeIndex[e.numFeatures]=this.addType(i.lookup("type"))),e.numFeatures++}addFeaturePoint(e,t,i){e.positions[e.numPositions++]=t,e.positions[e.numPositions++]=i}addFeaturePoints(e,t){const i=e.numPositions,n=t.length,r=e.positions;for(let e=0;e<n;e++)r[i+e]=t[e];e.numPositions+=t.length}addRoadSegments(e,t,i,n){void 0===e.segmentIds&&(e.segmentIds=new Array,e.segmentStartOffsets=new Array,e.segmentEndOffsets=new Array),e.segmentIds[e.numFeatures-1]=t,e.segmentStartOffsets[e.numFeatures-1]=i,e.segmentEndOffsets[e.numFeatures-1]=n}addRingPoints(e,t,i){e.innerRingStartIndex[e.groupNumRings]=e.numPositions,e.innerRingIsOuterContour[e.groupNumRings]=i?1:0,e.groupNumRings++;const n=e.numPositions,r=t.length,s=e.positions;for(let e=0;e<r;e++)s[n+e]=t[e];e.numPositions+=t.length}finish(){a.finish(this.tileInfo)}addText(e){return this.addStringValue(e,this.tileInfo.textCatalog,this.stringMap)}addLayer(e){return this.addStringValue(e,this.tileInfo.layerCatalog,this.layerMap)}addClass(e){return this.addStringValue(e,this.tileInfo.classCatalog,this.classMap)}addType(e){return this.addStringValue(e,this.tileInfo.typeCatalog,this.typeMap)}addStringValue(e,t,i){if(void 0===e)return-1;const n=e.toString();let r=i.get(n);return void 0!==r||(r=t.length,t.push(n),i.set(n,r)),r}};class l{constructor(e){this.tileInfo=e}visitAll(e){this.visitAllPointFeatures(e),this.visitAllLineFeatures(e),this.visitAllPolygonFeatures(e)}visitFeature(e,t){let i=0;const n=this.tileInfo.pointGroup.numFeatures,r=this.tileInfo.pointGroup.featureIds;for(let s=0;s<n;s++)r[s]===e&&(i++,this.visitPointFeature(s,t));const s=this.tileInfo.lineGroup.numFeatures,o=this.tileInfo.lineGroup.featureIds;for(let n=0;n<s;n++)o[n]===e&&(i++,this.visitLineFeature(n,t));const a=this.tileInfo.polygonGroup.numFeatures,l=this.tileInfo.polygonGroup.featureIds;for(let n=0;n<a;n++)l[n]===e&&(i++,this.visitPolygonFeature(n,t));return i}visitAllPointFeatures(e){const t=this.tileInfo.pointGroup.numFeatures;for(let i=0;i<t;i++)this.visitPointFeature(i,e)}visitAllLineFeatures(e){const t=this.tileInfo.lineGroup.numFeatures;for(let i=0;i<t;i++)this.visitLineFeature(i,e)}visitAllPolygonFeatures(e){const t=this.tileInfo.polygonGroup.numFeatures;for(let i=0;i<t;i++)this.visitPolygonFeature(i,e)}getTag(e,t){return void 0!==t&&t[e]>=0?t[e]:-1}visitPointFeature(e,t){const i=this.tileInfo.pointGroup,n=i.positionIndex[e],r=i.positions[n],s=i.positions[n+1];t.acceptPoint&&t.acceptPoint(i.featureIds[e],i.techniqueIndex[e],r,s,i.textIndex[e],this.getTag(e,i.layerIndex),this.getTag(e,i.classIndex),this.getTag(e,i.typeIndex))}visitLineFeature(e,t){const i=this.tileInfo,n=i.lineGroup,r=n.numFeatures,s=n.positionIndex[e],o=e===r-1?n.positions.length-s:n.positionIndex[e+1]-s;let a,l,c;void 0!==n.segmentIds&&(a=n.segmentIds[e],l=n.segmentStartOffsets[e],c=n.segmentEndOffsets[e]),t.acceptLine&&t.acceptLine(n.featureIds[e],n.techniqueIndex[e],n.textIndex[e],this.getTag(e,n.layerIndex),this.getTag(e,n.classIndex),this.getTag(e,n.typeIndex),i.lineGroup.positions,s,o,a,l,c)}visitPolygonFeature(e,t){if(void 0===t.acceptPolygon)return;const i=this.tileInfo.polygonGroup,n=i.numFeatures,r=i.outerRingStartIndex[e],s=e===n-1?i.innerRingStartIndex.length-r:i.outerRingStartIndex[e+1]-r;l.polygonAccessor.setup(i,e,r,s),t.acceptPolygon(i.featureIds[e],i.techniqueIndex[e],i.textIndex[e],this.getTag(e,i.layerIndex),this.getTag(e,i.classIndex),this.getTag(e,i.typeIndex),l.polygonAccessor),l.polygonAccessor.reset()}}l.polygonAccessor=new class{constructor(){this.featureIndex=0,this.ringStart=0,this.numRings=0}setup(e,t,i,n){this.polygons=e,this.featureIndex=t,this.ringStart=i,this.numRings=n}reset(){this.polygons=void 0,this.featureIndex=0,this.ringStart=0,this.numRings=0}isOuterRing(e){if(n.assert(e>=0),n.assert(e<this.numRings),n.assert(void 0!==this.polygons),e<0||e>=this.numRings||void 0===this.polygons)throw new Error("ExtendedTileInfoPolygonAccessor: Invalid ring index");return 0!==this.polygons.innerRingIsOuterContour[this.ringStart+e]}getPoints(e){if(n.assert(e>=0),n.assert(e<this.numRings),n.assert(void 0!==this.polygons),e<0||e>=this.numRings||void 0===this.polygons)throw new Error("ExtendedTileInfoPolygonAccessor: Invalid ring index");const t=this.polygons.innerRingStartIndex[this.ringStart+e];let i;return i=e<this.numRings-1||this.ringStart+e<this.polygons.innerRingStartIndex.length-1?this.polygons.innerRingStartIndex[this.ringStart+e+1]-t:this.polygons.positions.length-t,{points:this.polygons.positions,pointsStart:t,numPointValues:i}}},t.ExtendedTileInfoVisitor=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ThemeVisitor=class{constructor(e){this.theme=e}visitStyles(e){const t=i=>{if(e(i))return!0;if(void 0!==i.styles)for(const e of i.styles)if(t(e))return!0;return!1};if(void 0!==this.theme.styles)for(const e in this.theme.styles)if(void 0!==this.theme.styles[e])for(const i of this.theme.styles[e])if(t(i))return!0;return!1}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(0),s=i(32),o=i(131),a=i(9);class l{constructor(e,t,i,n,r,s,a,l,c,h,d){this.url=e,this.name=t,this.type=i,this.size=n,this.maxWidth=r,this.maxHeight=s,this.distanceRange=a,this.fonts=l,this.unicodeBlocks=c,this.maxCodePointCount=h,this.m_replacementGlyph=d,this.m_glyphTextureCache=new o.GlyphTextureCache(h,this.maxWidth+1,this.maxHeight+1),this.m_loadingJson=new Map,this.m_loadingPages=new Map,this.m_loadingGlyphs=new Map,this.m_loadedJson=new Map,this.m_loadedPages=new Map,this.m_loadedGlyphs=new Map}static load(e,t){return n(this,void 0,void 0,(function*(){const i=new URL(e,window.location.href),n=yield l.loadJSON(i.href),o=new URL(n.name+"_Assets/Extra/",i),a=yield l.loadJSON(o.href+"Specials.json"),c=yield l.loadTexture(o.href+"Specials.png");c.wrapS=r.ClampToEdgeWrapping,c.wrapT=r.ClampToEdgeWrapping,c.minFilter=r.NearestFilter,c.needsUpdate=!0;const h=n.fonts.find(e=>"Extra"===e.name),d=new s.GlyphData(65533,"Specials",a.chars[0].width,a.chars[0].height,a.chars[0].xadvance,a.chars[0].xoffset,a.chars[0].yoffset,0,0,1,1,c,h);return new l(i.href.substr(0,i.href.lastIndexOf("/")),n.name,n.type,n.size,n.maxWidth,n.maxHeight,n.distanceRange,n.fonts,n.supportedBlocks,t,d)}))}static loadTexture(e){return new Promise(t=>{(new r.TextureLoader).load(e,t)})}static loadJSON(e){return n(this,void 0,void 0,(function*(){const t=yield fetch(e);if(!t.ok)throw new Error(`${e} Status Text:  ${t.statusText}`);const i=yield t.text();return JSON.parse(i)}))}dispose(){this.fonts.length=0,this.unicodeBlocks.length=0,this.m_glyphTextureCache.dispose(),this.m_loadingJson.clear(),this.m_loadingPages.clear(),this.m_loadingGlyphs.clear(),this.m_loadedJson.clear(),this.m_loadedPages.clear(),this.m_loadedGlyphs.clear()}clear(){this.m_glyphTextureCache.clear(),this.m_loadingJson.clear(),this.m_loadingPages.clear(),this.m_loadingGlyphs.clear(),this.m_loadedJson.clear(),this.m_loadedPages.clear(),this.m_loadedGlyphs.clear()}update(e){this.m_glyphTextureCache.update(e)}get texture(){return this.m_glyphTextureCache.texture}get textureSize(){return this.m_glyphTextureCache.textureSize}get isLoading(){return this.m_loadingJson.size>0||this.m_loadingPages.size>0||this.m_loadingGlyphs.size>0}loadBlock(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=this.getAssetsPath(i,t),s=`${n}/${e.name.replace(/ /g,"_")}.json`;let o=this.m_loadedJson.get(s);if(void 0===o){let e=this.m_loadingJson.get(s);if(void 0===e)try{e=l.loadJSON(s),this.m_loadingJson.set(s,e),o=yield e,this.m_loadingJson.delete(s),this.m_loadedJson.set(s,o)}catch(e){console.error(e),this.m_loadingJson.delete(s)}else o=yield e}const a=[];if(!0===r)for(const e of o.pages)a.push(this.loadPage(`${n}/${e}`));return yield Promise.all(a),o}))}removeBlock(e,t,i){const n=this.getAssetsPath(i,t),r=`${n}/${e.name.replace(/ /g,"_")}.json`,s=this.m_loadedJson.get(r);if(void 0!==s){for(const e of s.pages){const t=`${n}/${e}`;this.m_loadingPages.delete(t),this.m_loadedPages.delete(t)}this.m_loadingJson.delete(r),this.m_loadedJson.delete(r)}}loadCharset(e,t){return n(this,void 0,void 0,(function*(){const i=t.fontName,n=t.fontStyle,r=(t.fontVariant===a.FontVariant.AllCaps||t.fontVariant===a.FontVariant.SmallCaps?e.toUpperCase():e).replace(/[\s\S](?=([\s\S]+))/g,(e,t)=>t.indexOf(e)+1?"":e),s=[];for(const e of r){const t=e.codePointAt(0),r=this.getFont(t,i),o=`${r.name}_${n}`,a=`${o}_${t}`;let l=this.m_loadedGlyphs.get(o);void 0===l&&(l=new Map,this.m_loadedGlyphs.set(o,l));const c=l.get(t);if(void 0===c){let i=this.m_loadingGlyphs.get(a);if(void 0===i){if(-1===r.charset.indexOf(String.fromCodePoint(t))){const i=this.createReplacementGlyph(t,e,r);l.set(t,i),this.m_glyphTextureCache.add(a,i);continue}let s;for(const e of this.unicodeBlocks)if(t>=e.min&&t<=e.max){s=e;break}i=this.loadAssets(t,n,s,r),this.m_loadingGlyphs.set(a,i),i.then(e=>{this.m_loadingGlyphs.delete(a),l.set(t,e),this.m_glyphTextureCache.add(a,e)})}s.push(i)}else this.m_glyphTextureCache.has(a)||(s.push(Promise.resolve(c)),this.m_glyphTextureCache.add(a,c))}return Promise.all(s)}))}getGlyph(e,t,i){const n=this.m_loadedGlyphs.get(`${t.name}_${i}`);if(void 0!==n)return n.get(e)}getGlyphs(e,t,i){const n=[],r=t.fontName,s=t.fontStyle,o=t.fontVariant,l=o===a.FontVariant.AllCaps||o===a.FontVariant.SmallCaps;for(const t of e){const e=l?t.toUpperCase():t;for(const o of e){const e=o.codePointAt(0),a=this.getFont(e,r),l=this.getGlyph(e,a,s);if(void 0===l)return;n.push(l),void 0!==i&&i.push(o!==t)}}return n}getFont(e,t){let i=this.fonts[0].name;for(const n of this.unicodeBlocks)if(e>=n.min&&e<=n.max){i=void 0!==t&&void 0!==n.fonts.find(e=>e===t)?t:n.fonts[0];break}return this.fonts.find(e=>e.name===i)}updateMemoryUsage(e){let t=0;for(const e of this.unicodeBlocks)t+=2*(e.max-e.min);let i=this.m_glyphTextureCache.textureSize.x*this.m_glyphTextureCache.textureSize.y*4;for(const e in this.m_loadedPages.entries)if(void 0!==this.m_loadedPages.get(e)){const t=this.m_loadedPages.get(e);void 0!==t&&(i+=t.image.width*t.image.height*4)}e.heapSize+=t+i,e.gpuSize+=i}createReplacementGlyph(e,t,i){const n=this.m_replacementGlyph.clone();return n.codePoint=e,n.character=t,n.font=i,n}loadAssets(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=yield this.loadBlock(i,r,t);if(void 0===n)return this.m_replacementGlyph;const o=n.chars.find(t=>t.id===e),a=`${this.getAssetsPath(t,r)}/${n.pages[o.page]}`,l=yield this.loadPage(a);return new s.GlyphData(o.id,i.name,o.width,o.height,o.xadvance,o.xoffset,o.yoffset,o.x/l.image.width,1-(o.y+o.height)/l.image.height,(o.x+o.width)/l.image.width,1-o.y/l.image.height,l,r)}))}loadPage(e){return n(this,void 0,void 0,(function*(){let t=this.m_loadedPages.get(e);if(void 0===t){let i=this.m_loadingPages.get(e);void 0===i?(i=l.loadTexture(e),this.m_loadingPages.set(e,i),t=yield i,t.wrapS=r.ClampToEdgeWrapping,t.wrapT=r.ClampToEdgeWrapping,t.minFilter=r.NearestFilter,t.needsUpdate=!0,this.m_loadingPages.delete(e)&&this.m_loadedPages.set(e,t),this.m_loadingPages.delete(e)):t=yield i}return t}))}getAssetsPath(e,t){let i="_Assets/";switch(e){case a.FontStyle.Bold:void 0!==t.bold&&(i="_BoldAssets/");break;case a.FontStyle.Italic:void 0!==t.italic&&(i="_ItalicAssets/");break;case a.FontStyle.BoldItalic:void 0!==t.boldItalic?i="_BoldItalicAssets/":void 0!==t.italic?i="_ItalicAssets/":void 0!==t.bold&&(i="_BoldAssets/")}return`${this.url}/${this.name}${i}${t.name}`}}t.FontCatalog=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(33),r=i(0),s=i(32),o=i(60);t.GlyphTextureCache=class{constructor(e,t,i){this.capacity=e,this.entryWidth=t,this.entryHeight=i;const s=Math.floor(Math.sqrt(e));this.m_cacheHeight=s*s<e?s+1:s,this.m_cacheWidth=s*this.m_cacheHeight<e?s+1:s,this.m_textureSize=new r.Vector2(this.m_cacheWidth*t,this.m_cacheHeight*i),(this.m_textureSize.y>4096||this.m_textureSize.x>4096)&&console.warn("GlyphTextureCache texture size ("+this.m_textureSize.x+", "+this.m_textureSize.y+") exceeds WebGL's widely supported MAX_TEXTURE_SIZE (4096).\nThis could result in rendering errors on some devices.\nPlease consider reducing its capacity or input assets size."),this.m_entryCache=new n.LRUCache(e),this.initCacheEntries(),this.m_scene=new r.Scene,this.m_camera=new r.OrthographicCamera(0,this.m_textureSize.x,this.m_textureSize.y,0),this.m_camera.position.z=1,this.m_camera.updateMatrixWorld(!1),this.m_rt=new r.WebGLRenderTarget(this.m_textureSize.x,this.m_textureSize.y,{wrapS:r.ClampToEdgeWrapping,wrapT:r.ClampToEdgeWrapping,depthBuffer:!1,stencilBuffer:!1}),this.m_copyTextureSet=new Set,this.m_copyTransform=new r.Matrix3,this.m_copyPositions=[],this.m_copyPositions.push(new r.Vector2,new r.Vector2,new r.Vector2,new r.Vector2),this.m_copyMaterial=new o.GlyphCopyMaterial,this.m_copyVertexBuffer=new r.InterleavedBuffer(new Float32Array(20*e),5),this.m_copyVertexBuffer.setDynamic(!0),this.m_copyPositionAttribute=new r.InterleavedBufferAttribute(this.m_copyVertexBuffer,3,0),this.m_copyUVAttribute=new r.InterleavedBufferAttribute(this.m_copyVertexBuffer,2,3),this.m_copyGeometry=new r.BufferGeometry,this.m_copyGeometry.addAttribute("position",this.m_copyPositionAttribute),this.m_copyGeometry.addAttribute("uv",this.m_copyUVAttribute);const a=new r.BufferAttribute(new Uint32Array(6*e),1);a.setDynamic(!0),this.m_copyGeometry.setIndex(a),this.m_copyMesh=new r.Mesh(this.m_copyGeometry,this.m_copyMaterial),this.m_copyMesh.frustumCulled=!1,this.m_copyGeometryDrawCount=0,this.m_clearMaterial=new o.GlyphClearMaterial,this.m_clearPositionAttribute=new r.BufferAttribute(new Float32Array(8*e),2),this.m_clearPositionAttribute.setDynamic(!0),this.m_clearGeometry=new r.BufferGeometry,this.m_clearGeometry.addAttribute("position",this.m_clearPositionAttribute);const l=new r.BufferAttribute(new Uint32Array(6*e),1);l.setDynamic(!0),this.m_clearGeometry.setIndex(l),this.m_clearMesh=new r.Mesh(this.m_clearGeometry,this.m_clearMaterial),this.m_clearMesh.frustumCulled=!1,this.m_clearGeometryDrawCount=0,this.m_scene.add(this.m_clearMesh,this.m_copyMesh)}dispose(){this.m_entryCache.clear(),this.m_scene.remove(this.m_clearMesh,this.m_copyMesh),this.m_rt.dispose(),this.m_clearMaterial.dispose(),this.m_copyMaterial.dispose(),this.m_copyTextureSet.clear(),this.m_clearGeometry.dispose(),this.m_copyGeometry.dispose()}get texture(){return this.m_rt.texture}get textureSize(){return this.m_textureSize}add(e,t){if(void 0!==this.m_entryCache.get(e))return;const i=this.m_entryCache.oldest;if(null===i)throw new Error("GlyphTextureCache is uninitialized!");this.clearCacheEntry(i.value),this.copyGlyphToCache(e,t,i.value.location)}has(e){return this.m_entryCache.has(e)}get(e){return this.m_entryCache.get(e)}clear(){this.m_copyGeometryDrawCount=0,this.m_clearGeometryDrawCount=0,this.m_entryCache.clear(),this.m_copyTextureSet.clear(),this.initCacheEntries()}update(e){let t=null;const i=this.m_clearGeometryDrawCount>0,n=this.m_copyGeometryDrawCount>0;if((i||n)&&(t=e.getRenderTarget(),e.setRenderTarget(this.m_rt)),i&&(this.m_clearPositionAttribute.needsUpdate=!0,this.m_clearPositionAttribute.updateRange.offset=0,this.m_clearPositionAttribute.updateRange.count=8*this.m_clearGeometryDrawCount,this.m_clearGeometry.index.needsUpdate=!0,this.m_clearGeometry.index.updateRange.offset=0,this.m_clearGeometry.index.updateRange.count=6*this.m_clearGeometryDrawCount,this.m_clearGeometry.setDrawRange(0,6*this.m_clearGeometryDrawCount),this.m_clearMesh.visible=!0,this.m_copyMesh.visible=!1,e.render(this.m_scene,this.m_camera),this.m_clearGeometryDrawCount=0,this.m_clearMesh.visible=!1),n){this.m_copyVertexBuffer.needsUpdate=!0,this.m_copyVertexBuffer.updateRange.offset=0,this.m_copyVertexBuffer.updateRange.count=20*this.m_copyGeometryDrawCount,this.m_copyGeometry.index.needsUpdate=!0,this.m_copyGeometry.index.updateRange.offset=0,this.m_copyGeometry.index.updateRange.count=6*this.m_copyGeometryDrawCount,this.m_copyGeometry.setDrawRange(0,6*this.m_copyGeometryDrawCount),this.m_copyMesh.visible=!0;const t=Array.from(this.m_copyTextureSet),i=Math.ceil(this.m_copyTextureSet.size/8);for(let n=0;n<i;n++){const i=8*n;this.m_copyMaterial.uniforms.pageOffset.value=i;for(let e=0;e<8;e++){const n=i+e;n<this.m_copyTextureSet.size&&(this.m_copyMaterial.uniforms["page"+e].value=t[n])}e.render(this.m_scene,this.m_camera)}this.m_copyTextureSet.clear(),this.m_copyGeometryDrawCount=0}(i||n)&&e.setRenderTarget(t)}initCacheEntries(){const e={name:"",metrics:{size:0,distanceRange:0,base:0,lineHeight:0,lineGap:0,capHeight:0,xHeight:0},charset:""},t=new s.GlyphData(0,"",0,0,0,0,0,0,0,0,0,r.Texture.DEFAULT_IMAGE,e);for(let e=0;e<this.m_cacheHeight;e++)for(let i=0;i<this.m_cacheWidth;i++){const n={glyphData:t,location:new r.Vector2(i,e)};this.m_entryCache.set("Dummy_"+(e*this.m_cacheHeight+i),n)}}copyGlyphToCache(e,t,i){this.m_copyTextureSet.add(t.texture);let n=0;for(const e of this.m_copyTextureSet.values()){if(e===t.texture)break;n++}t.copyIndex=n,this.m_copyTransform.set(1,0,i.x*this.entryWidth-t.offsetX,0,1,i.y*this.entryHeight-t.positions[0].y,0,0,0);for(let e=0;e<4;++e)this.m_copyPositions[e].set(t.positions[e].x,t.positions[e].y),this.m_copyPositions[e].applyMatrix3(this.m_copyTransform);if(this.m_copyGeometryDrawCount>=this.capacity)return;const r=4*this.m_copyGeometryDrawCount,s=6*this.m_copyGeometryDrawCount;for(let e=0;e<4;++e)this.m_copyPositionAttribute.setXYZ(r+e,this.m_copyPositions[e].x,this.m_copyPositions[e].y,t.copyIndex),this.m_copyUVAttribute.setXY(r+e,t.sourceTextureCoordinates[e].x,t.sourceTextureCoordinates[e].y);this.m_copyGeometry.index.setX(s,r),this.m_copyGeometry.index.setX(s+1,r+1),this.m_copyGeometry.index.setX(s+2,r+2),this.m_copyGeometry.index.setX(s+3,r+2),this.m_copyGeometry.index.setX(s+4,r+1),this.m_copyGeometry.index.setX(s+5,r+3),++this.m_copyGeometryDrawCount;const o=this.m_copyPositions[0].x/this.m_textureSize.x,a=this.m_copyPositions[0].y/this.m_textureSize.y,l=this.m_copyPositions[3].x/this.m_textureSize.x,c=this.m_copyPositions[3].y/this.m_textureSize.y;t.dynamicTextureCoordinates[0].set(o,a),t.dynamicTextureCoordinates[1].set(l,a),t.dynamicTextureCoordinates[2].set(o,c),t.dynamicTextureCoordinates[3].set(l,c),t.isInCache=!0,this.m_entryCache.set(e,{glyphData:t,location:i})}clearCacheEntry(e){if(e.glyphData.isInCache=!1,this.m_copyPositions[0].set(e.location.x*this.entryWidth,e.location.y*this.entryHeight),this.m_copyPositions[1].set((e.location.x+1)*this.entryWidth,e.location.y*this.entryHeight),this.m_copyPositions[2].set(e.location.x*this.entryWidth,(e.location.y+1)*this.entryHeight),this.m_copyPositions[3].set((e.location.x+1)*this.entryWidth,(e.location.y+1)*this.entryHeight),this.m_clearGeometryDrawCount>=this.capacity)return;const t=4*this.m_clearGeometryDrawCount,i=6*this.m_clearGeometryDrawCount;for(let e=0;e<4;++e)this.m_clearPositionAttribute.setXY(t+e,this.m_copyPositions[e].x,this.m_copyPositions[e].y);this.m_clearGeometry.index.setX(i,t),this.m_clearGeometry.index.setX(i+1,t+1),this.m_clearGeometry.index.setX(i+2,t+2),this.m_clearGeometry.index.setX(i+3,t+2),this.m_clearGeometry.index.setX(i+4,t+1),this.m_clearGeometry.index.setX(i+5,t+3),++this.m_clearGeometryDrawCount}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1);class r{constructor(e,t,i,n,r){this.key=e,this.value=t,this.size=i,this.newer=n,this.older=r}}t.Entry=r;t.LRUCache=class{constructor(e,t=(()=>1)){this.m_size=0,this.m_map=new Map,this.m_newest=null,this.m_oldest=null,this.m_capacity=e,this.m_sizeFunction=t}forEach(e,t){let i=this.m_newest;for(;null!==i;)e.call(t,i.value,i.key,this),i=i.older}get size(){return this.m_size}get capacity(){return this.m_capacity}get map(){return this.m_map}get newest(){return this.m_newest}get oldest(){return this.m_oldest}setCapacity(e){this.m_capacity=e,this.evict()}shrinkToCapacity(){let e=0;const t=this.m_sizeFunction;let i=this.m_newest;for(;null!==i;){const n=t(i.value);i.size=n,e+=n,i=i.older}this.m_size=e,this.evict()}set(e,t){const i=this.m_sizeFunction(t);let s=this.m_map.get(e);if(void 0!==s)this.m_size=this.m_size-s.size+i,s.value=t,s.size=i,this.promote(s),this.evict();else{if(i>this.m_capacity)return;if(s=new r(e,t,i,null,null),0===this.m_map.size)this.m_newest=this.m_oldest=s;else{n.assert(null!==this.m_newest);const e=this.m_newest;s.older=this.m_newest,e.newer=s,this.m_newest=s}this.m_map.set(e,s),this.m_size+=i,this.evict()}}get(e){const t=this.m_map.get(e);if(void 0!==t)return this.promote(t),t.value}has(e){return this.m_map.has(e)}clear(){this.m_newest=this.m_oldest=null,this.m_size=0,this.m_map.clear()}evictAll(){const e=this.evictionCallback;void 0!==e&&this.forEach((t,i)=>e(i,t)),this.clear()}delete(e){const t=this.m_map.get(e);return void 0!==t&&(t===this.m_newest?this.m_newest=t.older:t.newer?t.newer.older=t.older:n.assert(!1),t===this.m_oldest?this.m_oldest=t.newer:t.older?t.older.newer=t.newer:n.assert(!1),this.m_size-=t.size,this.m_map.delete(e))}evict(){for(;null!==this.m_oldest&&this.m_size>this.m_capacity;){if(void 0===this.evictOldest())return}}evictOldest(){n.assert(null!==this.m_oldest);const e=this.m_oldest;n.assert(null===e.older);let t=e;if(void 0!==this.canEvict)for(;!this.canEvict(t.key,t.value);){if(null===t.newer)return;t=t.newer}if(t===e)this.m_oldest=t.newer,null!==t.newer&&(n.assert(t.newer.older===t),t.newer.older=null);else{if(null===t.newer)return;n.assert(t.newer.older===t),t.newer.older=t.older,null!==t.older&&(t.older.newer=t.newer)}const i=this.m_map.delete(t.key);return n.assert(!0===i),i&&void 0!==this.evictionCallback&&this.evictionCallback(t.key,t.value),this.m_size-=t.size,t}promote(e){if(e===this.m_newest)return;e.newer&&(n.assert(e.newer.older===e),e.newer.older=e.older),e.older&&(n.assert(e.older.newer===e),e.older.newer=e.newer),e===this.m_oldest&&(this.m_oldest=e.newer),e.newer=null,e.older=this.m_newest,n.assert(null!==this.m_newest);const t=this.m_newest;n.assert(null===t.newer),t.newer=e,this.m_newest=e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(61),s=i(34),o=i(9),a=i(134),l=i(135),c=i(62),h=new n.Vector3,d={array:[new n.Box2],offset:0};let u=new Float32Array;t.DEFAULT_TEXT_CANVAS_LAYER=0;t.TextCanvas=class{constructor(e){this.m_renderer=e.renderer,this.m_fontCatalog=e.fontCatalog,this.minGlyphCount=e.minGlyphCount,this.maxGlyphCount=e.maxGlyphCount,void 0===e.material?(this.m_ownsMaterial=!0,this.m_material=c.createSdfTextMaterial({fontCatalog:e.fontCatalog})):(this.m_ownsMaterial=!1,this.m_material=e.material),void 0===e.backgroundMaterial?(this.m_ownsBgMaterial=!0,this.m_bgMaterial=c.createSdfTextMaterial({fontCatalog:e.fontCatalog,isBackground:!0})):(this.m_ownsBgMaterial=!1,this.m_bgMaterial=e.backgroundMaterial),this.m_defaultLayer={id:t.DEFAULT_TEXT_CANVAS_LAYER,storage:new s.TextGeometry(new n.Scene,this.m_material,this.m_bgMaterial,this.minGlyphCount,this.maxGlyphCount)},this.m_layers=[this.m_defaultLayer],this.m_defaultTextRenderStyle=new o.TextRenderStyle,this.m_currentTextRenderStyle=this.m_defaultTextRenderStyle,this.m_defaultTextLayoutStyle=new o.TextLayoutStyle,this.m_currentTextLayoutStyle=this.m_defaultTextLayoutStyle,this.m_lineTypesetter=new a.LineTypesetter,this.m_pathTypesetter=new l.PathTypesetter}get fontCatalog(){return this.m_fontCatalog}set fontCatalog(e){this.m_fontCatalog=e;const t=this.m_material;t.uniforms.sdfTexture.value=this.m_fontCatalog.texture,t.uniforms.sdfParams.value=new n.Vector4(this.m_fontCatalog.textureSize.x,this.m_fontCatalog.textureSize.y,this.m_fontCatalog.size,this.m_fontCatalog.distanceRange),t.defines.MSDF="msdf"===this.m_fontCatalog.type?1:0;const i=this.m_bgMaterial;i.uniforms.sdfTexture.value=this.m_fontCatalog.texture,i.uniforms.sdfParams.value=new n.Vector4(this.m_fontCatalog.textureSize.x,this.m_fontCatalog.textureSize.y,this.m_fontCatalog.size,this.m_fontCatalog.distanceRange),i.defines.MSDF="msdf"===this.m_fontCatalog.type?1:0}get material(){return this.m_material}set material(e){this.m_ownsMaterial&&(this.m_material.dispose(),this.m_ownsMaterial=!1),this.m_material=e;for(const e of this.m_layers)e.storage.mesh.material=this.m_material}get backgroundMaterial(){return this.m_bgMaterial}set backgroundMaterial(e){this.m_ownsBgMaterial&&(this.m_bgMaterial.dispose(),this.m_ownsBgMaterial=!1),this.m_bgMaterial=e;for(const e of this.m_layers)e.storage.backgroundMesh.material=this.m_bgMaterial}get textRenderStyle(){return this.m_currentTextRenderStyle}set textRenderStyle(e){this.m_currentTextRenderStyle=e}get textLayoutStyle(){return this.m_currentTextLayoutStyle}set textLayoutStyle(e){this.m_currentTextLayoutStyle=e}clear(){for(const e of this.m_layers)e.storage.clear();this.m_currentTextRenderStyle=this.m_defaultTextRenderStyle}render(e,t,i){this.m_fontCatalog.update(this.m_renderer);let n=null;void 0!==t&&(n=this.m_renderer.getRenderTarget(),this.m_renderer.setRenderTarget(t)),!0===i&&this.m_renderer.clear(!0);for(const t of this.m_layers)t.storage.update(),this.m_renderer.clear(!1,!0),this.m_renderer.render(t.storage.scene,e);void 0!==t&&this.m_renderer.setRenderTarget(n)}addLayer(e){let t=this.getLayer(e);return void 0===t&&(t={id:e,storage:new s.TextGeometry(new n.Scene,this.m_material,this.m_bgMaterial,this.minGlyphCount,this.maxGlyphCount)},this.m_layers.push(t),this.m_layers.sort((e,t)=>e.id-t.id)),t}getLayer(e){return this.m_layers.find(t=>t.id===e)}getAllLayers(){return this.m_layers}measureText(e,t,i){let n,r,s,o;if(h.set(0,0,0),void 0!==i){if(n=i.path,r=i.pathOverflow,o=i.outputCharacterBounds,void 0!==i.path){const e=i.path.getPoint(0);if(null===e)return!1;h.set(e.x,e.y,0)}i.letterCaseArray&&(s=i.letterCaseArray)}return this.placeText({input:e,layer:this.m_defaultLayer,textPath:n,textPathOverflow:r,bounds:t,individualBounds:o,letterCaseArray:s})}addText(e,t,i){let n,r,s;h.copy(t);let o=this.m_defaultLayer;if(void 0!==i){if(n=i.path,r=i.pathOverflow,void 0!==i.layer){let e=this.getLayer(i.layer);void 0===e&&(e=this.addLayer(i.layer)),o=e}void 0!==i.path&&h.set(0,0,h.z),i.letterCaseArray&&(s=i.letterCaseArray)}const a=o.storage.drawCount,l=this.placeText({input:e,textPath:n,textPathOverflow:r,layer:o,letterCaseArray:s});return l&&void 0!==i?(!0===i.updatePosition&&t.copy(h),void 0!==i.pickingData&&o.storage.addPickingData(a,o.storage.drawCount,i.pickingData)):l||(o.storage.m_drawCount=a),l}createTextBufferObject(e,t){let i,s;h.set(0,0,0);const a=this.m_currentTextRenderStyle.fontVariant===o.FontVariant.SmallCaps;if("string"!=typeof e)i=e,void 0!==t&&t.letterCaseArray&&(s=t.letterCaseArray);else if(s=[],i=this.m_fontCatalog.getGlyphs(e,this.m_currentTextRenderStyle,a?s:void 0),void 0===i)return;let l,c,d,m,p,f;return void 0!==t&&(l=t.path,c=t.pathOverflow,!0===t.outputBounds&&(d=new n.Box2),!0===t.outputCharacterBounds&&(m=[]),!0===t.storeStyles&&(p=this.m_currentTextRenderStyle,f=this.m_currentTextLayoutStyle)),this.placeText({input:e,layer:this.m_defaultLayer,computeTextBuffer:!0,textPath:l,textPathOverflow:c,bounds:d,individualBounds:m,letterCaseArray:s}),new r.TextBufferObject(i,new Float32Array(u),d,m,p,f)}addTextBufferObject(e,t){let i,n,r,s,o,a,l,c=this.m_defaultLayer;if(void 0!==t){if(void 0!==t.layer){let e=this.getLayer(t.layer);void 0===e&&(e=this.addLayer(t.layer)),c=e}i=t.position,n=t.scale,r=t.rotation,s=t.color,o=t.opacity,a=t.backgroundColor,l=t.backgroundOpacity}const h=c.storage.drawCount,d=c.storage.addTextBufferObject(e,i,n,r,s,o,a,l);return d&&void 0!==t?void 0!==t.pickingData&&c.storage.addPickingData(h,c.storage.drawCount,t.pickingData):d||(c.storage.m_drawCount=h),d}pickText(e,t){for(const i of this.m_layers)i.storage.pick(e,t)}getMemoryUsage(e){this.m_fontCatalog.updateMemoryUsage(e);for(const t of this.m_layers)t.storage.updateMemoryUsage(e)}placeText(e){if(0===e.input.length||0===this.m_currentTextLayoutStyle.maxLines)return void 0!==e.bounds&&(e.bounds.min.set(0,0),e.bounds.max.set(0,0)),void 0!==e.individualBounds&&(e.individualBounds.length=0),!0;let t,i;const n=this.m_currentTextRenderStyle.fontVariant===o.FontVariant.SmallCaps;if("string"!=typeof e.input)t=e.input,e.letterCaseArray&&(i=e.letterCaseArray);else if(i=[],t=this.m_fontCatalog.getGlyphs(e.input,this.m_currentTextRenderStyle,n?i:void 0),void 0===t)return!1;let r;void 0!==e.individualBounds&&(d.array=e.individualBounds,d.offset=0,r=d),void 0!==e.bounds&&(e.bounds.min.set(1/0,1/0),e.bounds.max.set(-1/0,-1/0)),!0===e.computeTextBuffer&&(u=new Float32Array(t.length*s.QUAD_VERTEX_MEMORY_FOOTPRINT));const a=void 0!==e.textPath,l={glyphs:t,fontCatalog:this.m_fontCatalog,textRenderStyle:this.m_currentTextRenderStyle,textLayoutStyle:this.m_currentTextLayoutStyle,position:h,geometry:e.layer.storage,smallCapsArray:n?i:void 0,globalBounds:e.bounds,individualBounds:r,vertexBuffer:!0===e.computeTextBuffer?u:void 0};let c=!0;return a?(Object.assign(l,{path:e.textPath,pathOverflow:!0===e.textPathOverflow}),c=this.m_pathTypesetter.arrangeGlyphs(l)):c=this.m_lineTypesetter.arrangeGlyphs(l),void 0!==r&&(r.array.length=r.offset),c}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(34),s=i(9),o=i(35),a=i(18);t.LineTypesetter=class{constructor(){this.m_tempTransform=new n.Matrix3,this.m_tempCorners=[new n.Vector3,new n.Vector3,new n.Vector3,new n.Vector3],this.m_tempLineDirection=a.UnicodeUtils.Direction.LTR,this.m_tempRunDirection=a.UnicodeUtils.Direction.LTR,this.m_tempPixelSize=1,this.m_tempPixelBgSize=1,this.m_tempScale=1,this.m_tempSmallCaps=!1}arrangeGlyphs(e){this.m_currentParams=e,this.m_tempLineDirection=o.TypesettingUtils.getDirection(this.m_currentParams.glyphs,0),this.m_tempRunDirection=this.m_tempLineDirection,this.m_tempPixelSize=o.TypesettingUtils.getPixelSize(this.m_currentParams.textRenderStyle.fontSize.size,this.m_currentParams.textRenderStyle.fontSize.unit,this.m_currentParams.fontCatalog.size),this.m_tempScale=this.m_tempPixelSize/this.m_currentParams.fontCatalog.size,this.m_tempPixelBgSize=Math.min(o.TypesettingUtils.getPixelSize(this.m_currentParams.textRenderStyle.fontSize.backgroundSize,this.m_currentParams.textRenderStyle.fontSize.unit,this.m_currentParams.fontCatalog.size),this.m_currentParams.fontCatalog.distanceRange*this.m_tempScale),this.m_tempSmallCaps=void 0!==this.m_currentParams.smallCapsArray,this.m_currentParams.position.y+=this.m_currentParams.textLayoutStyle.verticalAlignment*this.m_currentParams.glyphs[0].font.metrics.capHeight*this.m_tempScale;const t=void 0!==this.m_currentParams.globalBounds&&void 0===this.m_currentParams.vertexBuffer,i=this.m_currentParams.position.x,n=this.m_currentParams.glyphs[0].font.metrics.lineHeight+this.m_currentParams.textLayoutStyle.leading;let r=0,l=0,c=0,h=0,d=0,u=0,m=0,p=0,f=!1;for(let e=0;e<this.m_currentParams.glyphs.length&&!(p>this.m_currentParams.textLayoutStyle.maxLines-1);++e){const g=this.m_currentParams.glyphs[e];if(!g.isInCache&&!t)return!1;const _=a.UnicodeUtils.isNewLine(g.codePoint),v=a.UnicodeUtils.isWhiteSpace(g.codePoint);if(f||g.direction!==-this.m_tempLineDirection||(f=!0),a.UnicodeUtils.isPrintable(g.codePoint)&&(d+=(g.advanceX+this.m_currentParams.textLayoutStyle.tracking)*this.m_tempScale*(this.m_tempSmallCaps?o.TypesettingUtils.getSmallCapsScale(this.m_currentParams.glyphs,this.m_currentParams.smallCapsArray,e,this.m_currentParams.textRenderStyle.fontVariant):1)),e===r&&(h=d,u=d,m=d),_||this.m_currentParams.textLayoutStyle.wrappingMode!==s.WrappingMode.None&&d>this.m_currentParams.textLayoutStyle.lineWidth){if(this.m_currentParams.textLayoutStyle.wrappingMode!==s.WrappingMode.None){let t=l,i=u;this.m_currentParams.textLayoutStyle.wrappingMode===s.WrappingMode.Word&&m!==h&&(t=c,i=m),d=i,e=Math.min(_?r===e?t:e:t,this.m_currentParams.glyphs.length-1)}const t=this.m_tempLineDirection===a.UnicodeUtils.Direction.RTL&&f?1+this.m_currentParams.textLayoutStyle.horizontalAlignment:this.m_currentParams.textLayoutStyle.horizontalAlignment;if(this.m_currentParams.position.x=this.m_currentParams.position.x+d*t,!this.placeLine(r,e,this.m_tempLineDirection,f))return!1;for(this.m_currentParams.position.y-=n*this.m_tempScale,this.m_currentParams.position.x=i;e!==r&&e+1<this.m_currentParams.glyphs.length&&a.UnicodeUtils.isWhiteSpace(this.m_currentParams.glyphs[e+1].codePoint);)++e;if(r=e+1,r===this.m_currentParams.glyphs.length)break;_&&(this.m_tempLineDirection=o.TypesettingUtils.getDirection(this.m_currentParams.glyphs,r),this.m_tempRunDirection=this.m_tempLineDirection),h=0,d=0,l=r,u=0,c=r,m=0,f=!1,p++}else this.m_currentParams.textLayoutStyle.wrappingMode===s.WrappingMode.None||v||(l=e,u=d,this.m_currentParams.textLayoutStyle.wrappingMode===s.WrappingMode.Word&&e+1<this.m_currentParams.glyphs.length&&(a.UnicodeUtils.isWhiteSpace(this.m_currentParams.glyphs[e+1].codePoint)||a.UnicodeUtils.isNewLine(this.m_currentParams.glyphs[e+1].codePoint))&&(c=e,m=d))}if(p<=this.m_currentParams.textLayoutStyle.maxLines-1&&r<=this.m_currentParams.glyphs.length-1){const e=this.m_tempLineDirection===a.UnicodeUtils.Direction.RTL&&f?1+this.m_currentParams.textLayoutStyle.horizontalAlignment:this.m_currentParams.textLayoutStyle.horizontalAlignment;if(this.m_currentParams.position.setX(this.m_currentParams.position.x+d*e),!this.placeLine(r,this.m_currentParams.glyphs.length-1,this.m_tempLineDirection,f))return!1}return!0}placeLine(e,t,i,n){if(!n)return this.placeRun(e,t,i);const r=this.m_currentParams.glyphs,s=this.m_currentParams.smallCapsArray,l=this.m_currentParams.textRenderStyle,c=this.m_currentParams.textLayoutStyle,h=this.m_currentParams.position,d=i===a.UnicodeUtils.Direction.RTL,u=h.x;let m=0,p=e;for(let n=e;n<=t;++n){const e=r[n];if(e.direction===-this.m_tempRunDirection){if(d&&(h.x=u+m),!this.placeRun(p,n-1,this.m_tempRunDirection))return!1;d||(h.x=u+m),p=n,this.m_tempRunDirection*=-1}else if(e.direction===a.UnicodeUtils.Direction.Neutral&&this.m_tempRunDirection===-i){let e=n;for(;e+1<r.length&&1!==Math.abs(r[e].direction);)++e;if(r[e].direction!==this.m_tempRunDirection){if(d&&(h.x=u+m),!this.placeRun(p,n-1,this.m_tempRunDirection))return!1;d||(h.x=u+m),p=n,this.m_tempRunDirection*=-1}}m+=(e.advanceX+c.tracking)*this.m_tempScale*(this.m_tempSmallCaps?o.TypesettingUtils.getSmallCapsScale(r,s,n,l.fontVariant):1)*i}if(p<=t){if(d&&(h.x=u+m),!this.placeRun(p,t,this.m_tempRunDirection))return!1;d||(h.x=u+m)}return!0}placeRun(e,t,i){const n=this.m_currentParams.glyphs,l=this.m_currentParams.smallCapsArray,c=this.m_currentParams.fontCatalog,h=this.m_currentParams.textRenderStyle,d=this.m_currentParams.textLayoutStyle,u=this.m_currentParams.position,m=this.m_currentParams.geometry,p=this.m_currentParams.globalBounds,f=this.m_currentParams.individualBounds,g=this.m_currentParams.vertexBuffer,_=i===a.UnicodeUtils.Direction.LTR?e:t,v=i===a.UnicodeUtils.Direction.LTR?t:e;for(let y=_;i===a.UnicodeUtils.Direction.RTL?y>=v:y<=v;y+=i){const _=n[y];if(!a.UnicodeUtils.isPrintable(_.codePoint))continue;if(e!==t&&0!==y&&i===a.UnicodeUtils.Direction.RTL&&_.direction===a.UnicodeUtils.Direction.Weak){let t=y,i=n[t-1];for(;t!==e&&(i.direction===a.UnicodeUtils.Direction.Weak||i.direction===a.UnicodeUtils.Direction.Neutral&&!a.UnicodeUtils.isWhiteSpace(i.codePoint));)--t,i=n[t-1];this.placeRun(Math.max(t,e),y,a.UnicodeUtils.Direction.LTR),y=t;continue}const v=_.font,x=v.metrics,w=h.fontStyle,b=w===s.FontStyle.Bold&&void 0===v.bold||w===s.FontStyle.BoldItalic&&void 0===v.bold&&void 0===v.boldItalic,T=w===s.FontStyle.Italic&&void 0===v.italic||w===s.FontStyle.BoldItalic&&void 0===v.italic&&void 0===v.boldItalic,S=!!this.m_tempSmallCaps&&(l[y]&&h.fontVariant===s.FontVariant.SmallCaps),C=S?x.xHeight/x.capHeight:1,E=this.m_tempScale*C,M=((b?.02:0)+(S?.01:0))*(c.size/c.distanceRange),A=.5*this.m_tempPixelBgSize/(c.distanceRange*Math.max(E,1)),P=a.UnicodeUtils.isRtlMirrored(_.codePoint)&&i===a.UnicodeUtils.Direction.RTL,L=x.lineHeight-x.base-.5*x.distanceRange;o.TypesettingUtils.computeGlyphTransform(this.m_tempTransform,u,E,d.lineRotation,h.rotation);for(let e=0;e<4;++e){const t=_.positions[e],i=T&&e>1?o.TypesettingUtils.OBLIQUE_OFFSET*x.size:0;this.m_tempCorners[e].set(t.x+i,t.y-L,t.z),this.m_tempCorners[e].applyMatrix3(this.m_tempTransform)}if(void 0===p&&void 0===g){if(!m.add(_,this.m_tempCorners,M,M+A,P,h))return!1}else void 0!==p&&o.TypesettingUtils.updateBounds(this.m_tempCorners,p,f),void 0!==g&&m.addToBuffer(g,y*r.QUAD_VERTEX_MEMORY_FOOTPRINT,_,this.m_tempCorners,M,M+A,P,h);u.x+=(_.advanceX+d.tracking)*E}return!0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(34),s=i(9),o=i(35),a=i(18);t.PathTypesetter=class{constructor(){this.m_tempTransform=new n.Matrix3,this.m_tempCorners=[new n.Vector3,new n.Vector3,new n.Vector3,new n.Vector3],this.m_tempLineDirection=a.UnicodeUtils.Direction.LTR,this.m_tempRunDirection=a.UnicodeUtils.Direction.LTR,this.m_tempPixelSize=1,this.m_tempPixelBgSize=1,this.m_tempScale=1,this.m_tempSmallCaps=!1,this.m_tempPathPosition=new n.Vector3,this.m_tempPathLength=0,this.m_tempPathOffset=0}arrangeGlyphs(e){this.m_currentParams=e,this.m_tempLineDirection=o.TypesettingUtils.getDirection(this.m_currentParams.glyphs,0),this.m_tempRunDirection=this.m_tempLineDirection,this.m_tempPixelSize=o.TypesettingUtils.getPixelSize(this.m_currentParams.textRenderStyle.fontSize.size,this.m_currentParams.textRenderStyle.fontSize.unit,this.m_currentParams.fontCatalog.size),this.m_tempScale=this.m_tempPixelSize/this.m_currentParams.fontCatalog.size,this.m_tempPixelBgSize=Math.min(o.TypesettingUtils.getPixelSize(this.m_currentParams.textRenderStyle.fontSize.backgroundSize,this.m_currentParams.textRenderStyle.fontSize.unit,this.m_currentParams.fontCatalog.size),this.m_currentParams.fontCatalog.distanceRange*this.m_tempScale),this.m_tempSmallCaps=void 0!==this.m_currentParams.smallCapsArray,this.m_tempPathLength=this.m_currentParams.path.getLength(),this.m_tempPathOffset=0;const t=void 0!==this.m_currentParams.globalBounds&&void 0===this.m_currentParams.vertexBuffer;let i=!1,n=0;for(let e=0;e<this.m_currentParams.glyphs.length;++e){const r=this.m_currentParams.glyphs[e];if(!r.isInCache&&!t)return!1;a.UnicodeUtils.isPrintable(r.codePoint)&&(i||r.direction!==-this.m_tempLineDirection||(i=!0),n+=(r.advanceX+this.m_currentParams.textLayoutStyle.tracking)*this.m_tempScale*(this.m_tempSmallCaps?o.TypesettingUtils.getSmallCapsScale(this.m_currentParams.glyphs,this.m_currentParams.smallCapsArray,e,this.m_currentParams.textRenderStyle.fontVariant):1))}return this.m_tempPathOffset=Math.min(Math.max(-this.m_currentParams.textLayoutStyle.horizontalAlignment+this.m_currentParams.textLayoutStyle.horizontalAlignment*n/this.m_tempPathLength,0),1),this.placeLine(this.m_tempLineDirection,i)}placeLine(e,t){if(!t)return this.placeRun(0,this.m_currentParams.glyphs.length-1,e);const i=this.m_currentParams.glyphs;let n=0;for(let t=n;t<i.length;++t){const r=i[t];if(r.direction===-this.m_tempRunDirection){if(!this.placeRun(n,t-1,this.m_tempRunDirection))return!1;n=t,this.m_tempRunDirection*=-1}else if(r.direction===a.UnicodeUtils.Direction.Neutral&&this.m_tempRunDirection===-e){let e=t;for(;e+1<i.length&&1!==Math.abs(i[e].direction);)++e;if(i[e].direction!==this.m_tempRunDirection){if(!this.placeRun(n,t-1,this.m_tempRunDirection))return!1;n=t,this.m_tempRunDirection*=-1}}}return!(n<i.length&&!this.placeRun(n,i.length-1,this.m_tempRunDirection))}placeRun(e,t,i){const l=this.m_currentParams.glyphs,c=this.m_currentParams.smallCapsArray,h=this.m_currentParams.fontCatalog,d=this.m_currentParams.textRenderStyle,u=this.m_currentParams.textLayoutStyle,m=this.m_currentParams.position,p=this.m_currentParams.geometry,f=this.m_currentParams.globalBounds,g=this.m_currentParams.individualBounds,_=this.m_currentParams.vertexBuffer,v=this.m_currentParams.path,y=d.rotation,x=u.verticalAlignment*l[0].font.metrics.capHeight*this.m_tempScale,w=i===a.UnicodeUtils.Direction.LTR?e:t,b=i===a.UnicodeUtils.Direction.LTR?t:e;for(let T=w;i===a.UnicodeUtils.Direction.RTL?T>=b:T<=b;T+=i){const w=l[T];if(!a.UnicodeUtils.isPrintable(w.codePoint))continue;if(e!==t&&0!==T&&i===a.UnicodeUtils.Direction.RTL&&w.direction===a.UnicodeUtils.Direction.Weak){let t=T,i=l[t-1];for(;t!==e&&(i.direction===a.UnicodeUtils.Direction.Weak||i.direction===a.UnicodeUtils.Direction.Neutral&&!a.UnicodeUtils.isWhiteSpace(i.codePoint));)--t,i=l[t-1];this.placeRun(Math.max(t,e),T,a.UnicodeUtils.Direction.LTR),T=t;continue}const b=w.font,S=b.metrics,C=d.fontStyle,E=C===s.FontStyle.Bold&&void 0===b.bold||C===s.FontStyle.BoldItalic&&void 0===b.bold&&void 0===b.boldItalic,M=C===s.FontStyle.Italic&&void 0===b.italic||C===s.FontStyle.BoldItalic&&void 0===b.italic&&void 0===b.boldItalic,A=!!this.m_tempSmallCaps&&(c[T]&&d.fontVariant===s.FontVariant.SmallCaps),P=A?S.xHeight/S.capHeight:1,L=this.m_tempScale*P,R=((E?.02:0)+(A?.01:0))*(h.size/h.distanceRange),I=.5*this.m_tempPixelBgSize/(h.distanceRange*Math.max(L,1)),O=a.UnicodeUtils.isRtlMirrored(w.codePoint)&&i===a.UnicodeUtils.Direction.RTL,F=S.lineHeight-S.base-.5*S.distanceRange,D=v.getPoint(this.m_tempPathOffset);if(null===D)return this.m_currentParams.pathOverflow;const V=v.getTangent(this.m_tempPathOffset),U=new n.Vector2(-V.y,V.x).multiplyScalar(x),k=Math.atan2(V.y,V.x);this.m_tempPathPosition.set(U.x+D.x,U.y+D.y,m.z),d.rotation=y+k,o.TypesettingUtils.computeGlyphTransform(this.m_tempTransform,this.m_tempPathPosition,L,u.lineRotation,d.rotation);for(let e=0;e<4;++e){const t=w.positions[e],i=M&&e>1?o.TypesettingUtils.OBLIQUE_OFFSET*S.size:0;this.m_tempCorners[e].set(t.x+i,t.y-F,t.z),this.m_tempCorners[e].applyMatrix3(this.m_tempTransform),this.m_tempCorners[e].x-=m.x,this.m_tempCorners[e].y-=m.y}if(void 0===f&&void 0===_){if(!p.add(w,this.m_tempCorners,R,R+I,O,d))return!1}else void 0!==f&&o.TypesettingUtils.updateBounds(this.m_tempCorners,f,g),void 0!==_&&p.addToBuffer(_,T*r.QUAD_VERTEX_MEMORY_FOOTPRINT,w,this.m_tempCorners,R,R+I,O,d);d.rotation=y,this.m_tempPathOffset+=(w.advanceX+u.tracking)*L/this.m_tempPathLength}return!0}}},function(e,t,i){"use strict";var n,r;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Initial=0]="Initial",e[e.Medial=1]="Medial",e[e.Final=2]="Final"}(n||(n={})),function(e){e[e.Isolated=0]="Isolated",e[e.Connected=1]="Connected"}(r||(r={}));class s{constructor(){this.m_singleCharactersMap=new Map,this.m_combinedCharactersMap=new Map,this.m_singleCharactersMap.set(1569,[void 0,void 0,void 0]),this.m_singleCharactersMap.set(1570,[void 0,void 0,65154]),this.m_singleCharactersMap.set(1571,[void 0,void 0,65156]),this.m_singleCharactersMap.set(1572,[void 0,void 0,65158]),this.m_singleCharactersMap.set(1573,[void 0,void 0,65160]),this.m_singleCharactersMap.set(1574,[65163,65164,65162]),this.m_singleCharactersMap.set(1575,[void 0,void 0,65166]),this.m_singleCharactersMap.set(1576,[65169,65170,65168]),this.m_singleCharactersMap.set(1577,[void 0,void 0,65172]),this.m_singleCharactersMap.set(1578,[65175,65176,65174]),this.m_singleCharactersMap.set(1579,[65179,65180,65178]),this.m_singleCharactersMap.set(1580,[65183,65184,65182]),this.m_singleCharactersMap.set(1581,[65187,65188,65186]),this.m_singleCharactersMap.set(1582,[65191,65192,65190]),this.m_singleCharactersMap.set(1583,[void 0,void 0,65194]),this.m_singleCharactersMap.set(1584,[void 0,void 0,65196]),this.m_singleCharactersMap.set(1585,[void 0,void 0,65198]),this.m_singleCharactersMap.set(1586,[void 0,void 0,65200]),this.m_singleCharactersMap.set(1587,[65203,65204,65202]),this.m_singleCharactersMap.set(1588,[65207,65208,65206]),this.m_singleCharactersMap.set(1589,[65211,65212,65210]),this.m_singleCharactersMap.set(1590,[65215,65216,65214]),this.m_singleCharactersMap.set(1591,[65219,65220,65218]),this.m_singleCharactersMap.set(1592,[65223,65224,65222]),this.m_singleCharactersMap.set(1593,[65227,65228,65226]),this.m_singleCharactersMap.set(1594,[65231,65232,65230]),this.m_singleCharactersMap.set(1600,[1600,1600,1600]),this.m_singleCharactersMap.set(1601,[65235,65236,65234]),this.m_singleCharactersMap.set(1602,[65239,65240,65238]),this.m_singleCharactersMap.set(1603,[65243,65244,65242]),this.m_singleCharactersMap.set(1604,[65247,65248,65246]),this.m_singleCharactersMap.set(1605,[65251,65252,65250]),this.m_singleCharactersMap.set(1606,[65255,65256,65254]),this.m_singleCharactersMap.set(1607,[65259,65260,65258]),this.m_singleCharactersMap.set(1608,[void 0,void 0,65262]),this.m_singleCharactersMap.set(1609,[void 0,void 0,65264]),this.m_singleCharactersMap.set(1610,[65267,65268,65266]),this.m_singleCharactersMap.set(1662,[64344,64345,64343]),this.m_singleCharactersMap.set(1740,[64510,64511,64509]),this.m_singleCharactersMap.set(1670,[64380,64381,64379]),this.m_singleCharactersMap.set(1705,[64400,64401,64399]),this.m_singleCharactersMap.set(1711,[64404,64405,64403]),this.m_singleCharactersMap.set(1688,[void 0,void 0,64395]),this.m_combinedCharactersMap.set(1604,new Map),this.m_combinedCharactersMap.get(1604).set(1570,[65269,65270]),this.m_combinedCharactersMap.get(1604).set(1571,[65271,65272]),this.m_combinedCharactersMap.get(1604).set(1573,[65273,65274]),this.m_combinedCharactersMap.get(1604).set(1575,[65275,65276]),this.m_neutralCharacters=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773]}static get instance(){return void 0===this.m_instance&&(this.m_instance=new s),this.m_instance}convert(e){let t="";for(let i=0;i<e.length;++i){const s=e.charCodeAt(i);if(this.isArabicCharacter(s)){let o=i-1;for(;o>=0&&this.isNeutral(e.charCodeAt(o));--o);let a=o>=0?e.charCodeAt(o):void 0;if(void 0!==a){const e=this.getCharacterMap(a);(void 0===e||void 0===e[n.Initial]&&void 0===e[n.Medial])&&(a=void 0)}let l=i+1;for(;l<e.length&&this.isNeutral(e.charCodeAt(l));++l);let c=l<e.length?e.charCodeAt(l):void 0;if(void 0!==c){const e=this.getCharacterMap(c);(void 0===e||void 0===e[n.Medial]&&void 0===e[n.Final])&&(c=void 0)}if(1604===s&&void 0!==c&&(1570===c||1571===c||1573===c||1575===c)){const e=this.getCombinedCharacterMap(s,c);t+=void 0!==a?String.fromCharCode(e[r.Connected]):String.fromCharCode(e[r.Isolated]),++i;continue}const h=this.getCharacterMap(s);void 0!==a&&void 0!==c&&void 0!==h[n.Medial]?t+=String.fromCharCode(h[n.Medial]):void 0!==a&&void 0!==h[n.Final]?t+=String.fromCharCode(h[n.Final]):void 0!==c&&void 0!==h[n.Initial]?t+=String.fromCharCode(h[n.Initial]):t+=String.fromCharCode(s)}else t+=String.fromCharCode(s)}return t}isArabicCharacter(e){return this.m_singleCharactersMap.has(e)}getCharacterMap(e){return this.m_singleCharactersMap.get(e)}getCombinedCharacterMap(e,t){const i=this.m_combinedCharactersMap.get(e);if(void 0!==i)return i.get(t)}isNeutral(e){for(const t of this.m_neutralCharacters)if(t===e)return!0;return!1}}t.ContextualArabicConverter=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);class r extends n.Raycaster{constructor(e){super(),this.mapView=e}}t.PickingRaycaster=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),r=i(1),s=i(0),o=i(10),a=i(139),l=i(68),c=r.LoggerManager.instance.create("PoiRenderer"),h=new s.Vector3(0);class d{constructor(e,t,i,n){this.mapView=e,this.scene=t,this.imageItem=i,this.renderOrder=n,this.color=o.ColorCache.instance.getColor("#000000")}init(){void 0===this.boxBuffer&&this.setup()}reset(){void 0===this.boxBuffer&&this.init(),this.boxBuffer.reset()}update(){void 0===this.boxBuffer&&this.init(),this.boxBuffer.updateBufferGeometry()}updateMemoryUsage(e){void 0!==this.boxBuffer&&this.boxBuffer.updateMemoryUsage(e)}setup(){const e=new l.IconTexture(this.imageItem),t=new s.Texture(e.image.imageData,s.UVMapping,void 0,void 0,s.LinearFilter,s.LinearFilter,s.RGBAFormat);t.needsUpdate=!0,t.premultiplyAlpha=!0,t.generateMipmaps=!1,this.m_material=new n.IconMaterial({map:t}),this.boxBuffer=new a.BoxBuffer(this.m_material,this.renderOrder);const i=this.boxBuffer.mesh;i.frustumCulled=!1,this.scene.add(i),this.mapView.update()}}class u{constructor(e,t){this.mapView=e,this.textCanvas=t,this.batches=[],this.m_batchMap=new Map}registerPoi(e){const{imageItem:t,imageTexture:i,imageTextureName:n}=e;if(void 0===t||void 0===n||void 0===i)return-1;const r=e.renderOrder,s=i.image;let o,a,l=this.m_batchMap.get(s);if(void 0===l&&(l=new Map,this.m_batchMap.set(s,l)),o=l.get(r),void 0!==o)return o;o=this.batches.length;let c=this.textCanvas.getLayer(r);return void 0===c&&(this.textCanvas.addText("",h,{layer:r}),c=this.textCanvas.getLayer(r)),a=new d(this.mapView,c.storage.scene,t,r),a.init(),l.set(r,o),this.batches.push(a),o}addPoi(e,t,i){const n=this.registerPoi(e);return r.assert(n>=0),n<0?-1:(r.assert(void 0!==e.uvBox),void 0===this.batches[n].boxBuffer&&this.batches[n].init(),this.batches[n].boxBuffer.addBox(t,e.uvBox,this.batches[n].color,i,e.textElement.renderDistance,e.textElement),n)}getBatch(e){if(e>=0)return r.assert(e<this.batches.length),this.batches[e]}reset(){for(const e of this.batches)e.reset()}update(){for(const e of this.batches)e.update()}pickTextElements(e,t){for(const i of this.batches)void 0===i.boxBuffer&&i.init(),i.boxBuffer.pickBoxes(e,t,i.imageItem.imageData)}updateMemoryUsage(e){for(const t of this.batches){if(void 0!==t.imageItem.imageData){const i=t.imageItem.imageData.width*t.imageItem.imageData.height*4;e.heapSize+=i,e.gpuSize+=i}void 0!==t.boxBuffer&&t.boxBuffer.updateMemoryUsage(e)}}}class m{constructor(e,t){this.mapView=e,this.textCanvas=t,this.m_tempScreenBox=new r.Math2D.Box,this.m_renderBuffer=new u(e,t)}prepareRender(e){const t=e.poiInfo;return void 0!==t&&(void 0===t.poiRenderBatch&&this.preparePoi(e),void 0!==t.poiRenderBatch)}computeScreenBox(e,t,i,n,r){return!!this.computeIconScreenBox(e,t,i,r)&&n.isVisible(r)}isSpaceAvailable(e,t){return!e.isAllocated(t)}reset(){this.m_renderBuffer.reset()}renderPoi(e,t,i,n,s,o){r.assert(void 0!==e.poiRenderBatch),this.computeIconScreenBox(e,t,n,this.m_tempScreenBox)&&(s&&i.allocate(this.m_tempScreenBox),this.m_renderBuffer.addPoi(e,this.m_tempScreenBox,o))}poiIsRenderable(e){return void 0!==e.poiRenderBatch}update(){this.m_renderBuffer.update()}pickTextElements(e,t){this.m_renderBuffer.pickTextElements(e,t)}getMemoryUsage(e){this.m_renderBuffer.updateMemoryUsage(e)}computeIconScreenBox(e,t,i,n){if(r.assert(void 0!==e.poiRenderBatch),void 0===this.m_renderBuffer.getBatch(e.poiRenderBatch))return!1;const s=e.computedWidth*i,o=e.computedHeight*i,a=e.technique,l=t.x+(void 0!==a.iconXOffset?a.iconXOffset:0),c=t.y+(void 0!==a.iconYOffset?a.iconYOffset:0);return n.x=l-s/2,n.y=c-o/2,n.w=s,n.h=o,!0}preparePoi(e){const t=e.poiInfo;if(void 0===t||!e.visible)return;if(void 0!==t.poiRenderBatch||!1===t.isValid)return;if(void 0!==t.poiTableName){if(!this.mapView.poiManager.updatePoiFromPoiTable(e))return;if(t.poiTableName=void 0,!e.visible)return}const i=t.imageTextureName,n=this.mapView.poiManager.getImageTexture(i);if(void 0===n)return void 0===m.m_missingTextureName.get(i)&&(m.m_missingTextureName.set(i,!0),c.error(`preparePoi: No imageTexture with name '${i}' found`)),void(t.isValid=!1);const r=n.image;let s=this.mapView.imageCache.findImageByName(r);if(void 0===s)return c.error(`init: No imageItem found with name '${r}'`),void(t.isValid=!1);if(!s.loaded){if(void 0!==s.loadingPromise)return;const e=s.url,i=this.mapView.imageCache.loadImage(s);if(i instanceof Promise)return void i.then(i=>{void 0!==i?this.setupPoiInfo(t,n,i):c.error("preparePoi: Failed to load imageItem: '"+e)}).catch(i=>{c.error("preparePoi: Failed to load imageItem: '"+e,i),t.isValid=!1});s=i}this.setupPoiInfo(t,n,s)}setupPoiInfo(e,t,i){if(r.assert(void 0===e.uvBox),void 0===i||void 0===i.imageData)return c.error("setupPoiInfo: No imageItem/imageData found"),e.poiRenderBatch=-1,void(e.isValid=!1);const n=e.technique,s=i.imageData.width,o=i.imageData.height,a=void 0!==t.width?t.width:s,l=void 0!==t.height?t.height:o;let h=0,d=1,u=0,m=1,p=void 0!==n.iconScale?n.iconScale:1,f=void 0!==n.iconScale?n.iconScale:1;const g=void 0!==t.width?t.width:s,_=void 0!==t.height?t.height:o,v=void 0!==t.xOffset?t.xOffset:0,y=void 0!==t.yOffset?t.yOffset:0;h=v/s,d=(v+g)/s;u=(o-y)/o,m=(o-y-_)/o,void 0!==n.screenWidth&&(f=p=n.screenWidth/s),void 0!==n.screenHeight&&(f=n.screenHeight/o,void 0===n.screenWidth&&(p=f)),e.computedWidth=a*p,e.computedHeight=l*f,e.uvBox={s0:h,t0:m,s1:d,t1:u},e.imageItem=i,e.imageTexture=t,e.poiRenderBatch=this.m_renderBuffer.registerPoi(e),e.isValid=!0,r.assert(void 0!==e.poiRenderBatch)}}m.m_missingTextureName=new Map,t.PoiRenderer=m},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(0),s=i(140);class o extends r.Mesh{constructor(e,t){super(e,t),this.type="BoxBufferMesh"}get isEmpty(){return void 0===this.geometry||0===this.geometry.index.count}}t.BoxBufferMesh=o;class a{constructor(e,t=0,i=0,n=32768){this.material=e,this.renderOrder=t,this.startElementCount=i,this.maxElementCount=n,this.m_size=0,this.resizeBuffer(i),this.pickInfos=new Array}clone(){return new a(this.material,this.renderOrder)}dispose(){void 0!==this.geometry&&(this.geometry.dispose(),this.geometry=void 0),this.internalMesh=void 0}get size(){return this.m_size}reset(){void 0!==this.positionAttribute&&(this.positionAttribute.count=0,this.colorAttribute.count=0,this.uvAttribute.count=0,this.indexAttribute.count=0,this.pickInfos.length=0)}canAddElements(e=1){const t=this.indexAttribute;if(t.count+6*e>=t.array.length){if(t.array.length>=6*this.maxElementCount)return!1;const e=Math.min(this.maxElementCount,0===this.size?256:2*this.size);this.resize(e)}return!0}saveState(){return{positionAttributeCount:this.positionAttribute.count,colorAttributeCount:this.colorAttribute.count,uvAttributeCount:this.uvAttribute.count,indexAttributeCount:this.indexAttribute.count,pickInfoCount:this.pickInfos.length}}restoreState(e){this.positionAttribute.count=e.positionAttributeCount,this.colorAttribute.count=e.colorAttributeCount,this.uvAttribute.count=e.uvAttributeCount,this.indexAttribute.count=e.indexAttributeCount,this.pickInfos.length=e.pickInfoCount}addBox(e,t,i,n,r,s){if(!this.canAddElements())return!1;const{s0:o,t0:a,s1:l,t1:c}=t,{x:h,y:d,w:u,h:m}=e,p=Math.round(255*i.r),f=Math.round(255*i.g),g=Math.round(255*i.b),_=Math.round(255*n),v=this.positionAttribute,y=this.colorAttribute,x=this.uvAttribute,w=this.indexAttribute,b=v.count,T=w.count;return v.setXYZ(b,h,d,r),v.setXYZ(b+1,h+u,d,r),v.setXYZ(b+2,h,d+m,r),v.setXYZ(b+3,h+u,d+m,r),y.setXYZW(b,p,f,g,_),y.setXYZW(b+1,p,f,g,_),y.setXYZW(b+2,p,f,g,_),y.setXYZW(b+3,p,f,g,_),x.setXY(b,o,a),x.setXY(b+1,l,a),x.setXY(b+2,o,c),x.setXY(b+3,l,c),w.setX(T,b),w.setX(T+1,b+1),w.setX(T+2,b+2),w.setX(T+3,b+2),w.setX(T+4,b+1),w.setX(T+5,b+3),v.count+=4,y.count+=4,x.count+=4,w.count+=6,this.pickInfos.push(s),!0}updateBufferGeometry(){const e=this.positionAttribute,t=this.colorAttribute,i=this.uvAttribute,n=this.indexAttribute;e.count>0&&(e.needsUpdate=!0,e.updateRange.offset=0,e.updateRange.count=4*e.count),t.count>0&&(t.needsUpdate=!0,t.updateRange.offset=0,t.updateRange.count=4*t.count),i.count>0&&(i.needsUpdate=!0,i.updateRange.offset=0,i.updateRange.count=4*i.count),n.count>0&&(n.needsUpdate=!0,n.updateRange.offset=0,n.updateRange.count=n.count),void 0!==this.geometry&&(this.geometry.clearGroups(),this.geometry.addGroup(0,this.indexAttribute.count))}cleanUp(){0===this.indexAttribute.count&&this.size>0&&this.clearAttributes()}get isEmpty(){return this.internalMesh.isEmpty}get mesh(){return void 0===this.internalMesh&&this.resize(),this.internalMesh}pickBoxes(e,t,i){const r=this.pickInfos.length,s=this.pickInfos,o=this.positionAttribute,a=e.x,l=e.y,c=document.createElement("canvas");for(let e=0;e<r;e++){const r=4*e,h=o.getX(r);if(a<h)continue;const d=o.getX(r+1);if(a>d)continue;const u=o.getY(r);if(l<u)continue;const m=o.getY(r+2);if(l>m)continue;const p=new n.Math2D.Box(h,u,d-h,m-u);void 0!==i&&void 0!==s[e].poiInfo&&void 0!==s[e].poiInfo.uvBox&&this.isPixelTransparent(i,a,l,p,s[e].poiInfo.uvBox,c)||void 0!==s[e]&&t(s[e])}}resize(e,t){return void 0!==this.geometry&&this.geometry.dispose(),this.geometry=new r.BufferGeometry,void 0!==e&&(!0===t||e>this.size)&&this.resizeBuffer(e),this.geometry.addAttribute("position",this.positionAttribute),this.geometry.addAttribute("color",this.colorAttribute),this.geometry.addAttribute("uv",this.uvAttribute),this.geometry.setIndex(this.indexAttribute),this.geometry.addGroup(0,this.indexAttribute.count),void 0===this.internalMesh?(this.internalMesh=new o(this.geometry,this.material),this.internalMesh.renderOrder=this.renderOrder):this.internalMesh.geometry=this.geometry,this.internalMesh}updateMemoryUsage(e){const t=3*this.positionAttribute.count*4+4*this.colorAttribute.count+4*this.uvAttribute.count*4+4*this.indexAttribute.count;e.heapSize+=t,e.gpuSize+=t}isPixelTransparent(e,t,i,n,r,o){let a=!1;const{u:l,v:c}=s.screenToUvCoordinates(t,i,n,r),h=e.width*l,d=e.height*c,u=s.getPixelFromImage(h,d,e,o);return void 0!==u&&0===u[3]&&(a=!0),a}clearAttributes(){this.positionAttribute=void 0,this.colorAttribute=void 0,this.uvAttribute=void 0,this.indexAttribute=void 0,this.resize(0,!0)}resizeBuffer(e){const t=new Float32Array(4*e*3);if(void 0!==this.positionAttribute&&this.positionAttribute.array.length>0){const e=this.positionAttribute.count;t.set(this.positionAttribute.array),this.positionAttribute.setArray(t),this.positionAttribute.count=e}else this.positionAttribute=new r.BufferAttribute(t,3),this.positionAttribute.count=0,this.positionAttribute.setDynamic(!0);const i=new Uint8Array(4*e*4);if(void 0!==this.colorAttribute){const e=this.colorAttribute.count;i.set(this.colorAttribute.array),this.colorAttribute.setArray(i),this.colorAttribute.count=e}else this.colorAttribute=new r.BufferAttribute(i,4,!0),this.colorAttribute.count=0,this.colorAttribute.setDynamic(!0);const n=new Float32Array(4*e*4);if(void 0!==this.uvAttribute){const e=this.uvAttribute.count;n.set(this.uvAttribute.array),this.uvAttribute.setArray(n),this.uvAttribute.count=e}else this.uvAttribute=new r.BufferAttribute(n,4),this.uvAttribute.count=0,this.uvAttribute.setDynamic(!0);const s=6*e*1,o=s>65535?new Uint32Array(s):new Uint16Array(s);if(void 0!==this.indexAttribute){const e=this.indexAttribute.count;o.set(this.indexAttribute.array),this.indexAttribute.setArray(o),this.indexAttribute.count=e}else this.indexAttribute=new r.BufferAttribute(o,1),this.indexAttribute.count=0,this.indexAttribute.setDynamic(!0);this.m_size=e}}t.BoxBuffer=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1);function r(e,t,i,n){if(t>e.width||t<0||i>e.height||i<0)return;let r;n.width=e.width,n.height=e.height;const s=n.getContext("2d");return null!==s&&(s.drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height),r=s.getImageData(t,i,1,1).data),r}function s(e,t,i,n){if(!(t>e.width||t<0||i>e.height||i<0))return((e,t,i)=>{const n=t*i,r=e.data,s=new Uint8ClampedArray(i);for(let e=0;e<i;e++)s[0]=r[n+e];return s})(e,i*e.width+t,n)}t.getPixelFromImage=function(e,t,i,n){let o;if(void 0!==i.close)void 0===n&&(n=document.createElement("canvas")),o=r(i,e,t,n);else{const n=i;o=s(n,e,t,n.data.length/(n.height*n.width))}return o},t.screenToUvCoordinates=function(e,t,i,r){const s=i.x,o=i.x+i.w,a=i.y,l=i.y+i.h;return{u:n.MathUtils.lerp(e,s,o,r.s0,r.s1),v:n.MathUtils.lerp(t,a,l,r.t0,r.t1)}},t.getPixelFromImageBitmap=r,t.getPixelFromImageData=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);class r extends n.LineCurve{constructor(e,t){super(e,t)}getLengths(){return void 0===this.m_lengths&&(this.m_lengths=[0,this.v2.distanceTo(this.v1)]),this.m_lengths}}t.SimpleLineCurve=r;class s{constructor(e,t,i){this.path=e,this.index=t,this.t=i}get curve(){return this.path.curves[this.index]}get point(){return void 0===this.m_point&&(this.m_point=this.curve.getPoint(this.t)),this.m_point}}t.PathParam=s;class o extends n.Path{constructor(){super()}getLengths(){if(this.m_cache)return this.m_cache;let e=0;const t=new Array;return t.push(0),this.curves.forEach(i=>{const n=i;e+=n.v1.distanceTo(n.v2),t.push(e)}),this.m_cache=t,t}getParamAt(e){const t=e*this.getLength(),i=this.getCurveLengths();for(let e=0;e<i.length;++e){if(i[e]<t)continue;const n=i[e]-t,r=this.curves[e].getLength();return new s(this,e,0===r?0:1-n/r)}return null}}t.SimplePath=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(143),s=i(70),o=s.MSAASampling.Level_1,a=s.MSAASampling.Level_4;t.MapRenderingManager=class{constructor(e,t,i,l={msaaEnabled:!1}){this.m_readBuffer=new n.WebGLRenderTarget(e,t),this.m_msaaPass=new s.MSAARenderPass,this.m_msaaPass.enabled=void 0!==l&&!0===l.msaaEnabled,this.m_dynamicMsaaSamplingLevel=void 0===l.dynamicMsaaSamplingLevel?o:l.dynamicMsaaSamplingLevel,this.m_staticMsaaSamplingLevel=void 0===l.staticMsaaSamplingLevel?a:l.staticMsaaSamplingLevel,this.m_lowResPass=new r.LowResRenderPass(i),this.m_lowResPass.enabled=void 0!==i}render(e,t,i,n){if(!n&&void 0!==this.m_lowResPass.pixelRatio){const n=null;return this.m_lowResPass.renderToScreen=!0,void this.m_lowResPass.render(e,t,i,n,this.m_readBuffer)}if(e.getPixelRatio()>1.1)e.render(t,i);else{const r=null;this.m_msaaPass.enabled?(this.m_msaaPass.samplingLevel=n?this.m_staticMsaaSamplingLevel:this.m_dynamicMsaaSamplingLevel,this.m_msaaPass.renderToScreen=!0,this.m_msaaPass.render(e,t,i,r,this.m_readBuffer)):e.render(t,i)}}setSize(e,t){this.m_readBuffer.setSize(e,t),this.m_msaaPass.setSize(e,t),this.m_lowResPass.setSize(e,t)}get lowResPixelRatio(){return this.m_lowResPass.pixelRatio}set lowResPixelRatio(e){this.m_lowResPass.pixelRatio=e,this.m_lowResPass.enabled=void 0!==e}set dynamicMsaaSamplingLevel(e){this.m_dynamicMsaaSamplingLevel=e}get dynamicMsaaSamplingLevel(){return this.m_dynamicMsaaSamplingLevel}set msaaEnabled(e){this.m_msaaPass.enabled=e}get msaaEnabled(){return this.m_msaaPass.enabled}set staticMsaaSamplingLevel(e){this.m_staticMsaaSamplingLevel=e}get staticMsaaSamplingLevel(){return this.m_staticMsaaSamplingLevel}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(4),r=i(0),s=i(38);class o extends s.Pass{constructor(e){super(),this.lowResPixelRatio=e,this.m_renderTarget=null,this.m_localCamera=new r.OrthographicCamera(-1,1,1,-1,0,1),this.m_quadScene=new r.Scene,this.m_quadUniforms=n.CopyShader.uniforms,this.m_quadMaterial=new n.CopyMaterial(this.m_quadUniforms),this.m_quad=new r.Mesh(new r.PlaneBufferGeometry(2,2),this.m_quadMaterial),this.m_savedWidth=0,this.m_savedHeight=0,this.m_quad.frustumCulled=!1,this.m_quadScene.add(this.m_quad),this.m_pixelRatio=e}dispose(){this.m_quadMaterial.dispose(),this.m_quad.geometry.dispose(),null!==this.m_renderTarget&&(this.m_renderTarget.dispose(),this.m_renderTarget=null)}set pixelRatio(e){this.m_pixelRatio=e,this.m_renderTarget&&void 0!==this.pixelRatio&&this.m_renderTarget.setSize(Math.floor(this.m_savedWidth*this.pixelRatio),Math.floor(this.m_savedHeight*this.pixelRatio))}get pixelRatio(){return this.m_pixelRatio}render(e,t,i,n,s){if(!this.enabled||void 0===this.pixelRatio)return;null===this.m_renderTarget&&(this.m_savedWidth=s.width,this.m_savedHeight=s.height,this.m_renderTarget=new r.WebGLRenderTarget(Math.floor(this.m_savedWidth*this.pixelRatio),Math.floor(this.m_savedHeight*this.pixelRatio),{minFilter:r.LinearFilter,magFilter:r.LinearFilter,format:r.RGBAFormat,depthBuffer:!0,stencilBuffer:!0}),this.m_renderTarget.texture.name="LowResRenderPass.sample"),this.m_quadUniforms.tDiffuse.value=this.m_renderTarget.texture,this.m_quadUniforms.opacity.value=1;const o=e.getRenderTarget();e.setRenderTarget(this.m_renderTarget),e.clear(),e.render(t,i),e.setRenderTarget(this.renderToScreen?null:n),e.clear(),e.render(this.m_quadScene,this.m_localCamera),e.setRenderTarget(o)}setSize(e,t){this.m_savedWidth=e,this.m_savedHeight=t,this.m_renderTarget&&void 0!==this.pixelRatio&&this.m_renderTarget.setSize(Math.floor(e*this.pixelRatio),Math.floor(t*this.pixelRatio))}}t.LowResRenderPass=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(39);const n=i(1).LoggerManager.instance.create("WorkerLoader");class r{static startWorker(e){return e.startsWith("blob:")?this.startWorkerImmediately(e):this.directlyFallbackToBlobBasedLoading?this.startWorkerBlob(e):this.startWorkerImmediately(e).catch(t=>(n.log("#startWorker: worker construction failed, attempting load with blob"),this.directlyFallbackToBlobBasedLoading=!0,r.startWorkerBlob(e)))}static startWorkerImmediately(e){try{const t=new Worker(e);return this.waitWorkerInitialized(t)}catch(e){return Promise.reject(e)}}static startWorkerBlob(e){return this.fetchScriptSourceToBlobUrl(e).then(e=>this.startWorkerImmediately(e))}static fetchScriptSourceToBlobUrl(e){let t=this.sourceLoaderCache.get(e);return void 0!==t||(t=fetch(e).then(e=>e.text()).catch(e=>{throw new Error("WorkerLoader#fetchScriptSourceToBlob: failed to load worker script: "+e)}).then(t=>{this.sourceLoaderCache.delete(e);const i=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(i)}),this.sourceLoaderCache.set(e,t)),t}static waitWorkerInitialized(e){return new Promise((t,i)=>{const n=i=>{e.removeEventListener("message",n),e.removeEventListener("error",r),t(e),setTimeout(()=>{e.dispatchEvent(i)},0)},r=t=>{e.removeEventListener("message",n),e.removeEventListener("error",r),i(new Error("#waitWorkerInitialized: Error event before first message."))};e.addEventListener("message",n),e.addEventListener("error",r)})}}r.directlyFallbackToBlobBasedLoading=!1,r.sourceLoaderCache=new Map,t.WorkerLoader=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(66),s=i(146),o=n.LoggerManager.instance.create("ScreenCollissions");class a{constructor(){this.screenBounds=new n.Math2D.Box,this.rtree=new s,this.m_returnArray=[]}static toBox2D(e,t){t.x=e.min.x,t.y=e.min.y,t.w=e.max.x-e.min.x,t.h=e.max.y-e.min.y}reset(){this.rtree=new s}update(e,t){this.screenBounds.set(e/-2,t/-2,e,t),this.reset()}allocate(e){this.rtree.insert(e,null)}isAllocated(e){return this.m_returnArray.length=0,this.m_returnArray=this.rtree.search(e,void 0,this.m_returnArray),0!==this.m_returnArray.length}isVisible(e){return this.screenBounds.intersects(e)}}t.ScreenCollisions=a;t.ScreenCollisionsDebug=class extends a{constructor(e){super(),this.m_renderContext=null,this.m_renderingEnabled=!1,this.m_numAllocations=0,this.m_numSuccessfulTests=0,this.m_numFailedTests=0,this.m_numSuccessfulVisibilityTests=0,this.m_numFailedVisibilityTests=0,null!=e&&(this.m_renderContext=e.getContext("2d"))}reset(){super.reset(),this.m_numAllocations=0,this.m_numSuccessfulTests=0,this.m_numFailedTests=0,this.m_numSuccessfulVisibilityTests=0,this.m_numFailedVisibilityTests=0}update(e,t){this.m_renderingEnabled&&o.log(`Allocations: ${this.m_numAllocations} Successful Tests: ${this.m_numSuccessfulTests} Failed Tests: ${this.m_numFailedTests}  Successful Visibility Tests: ${this.m_numSuccessfulVisibilityTests}  Failed Visibility Tests: ${this.m_numFailedVisibilityTests} `),super.update(e,t),null!==this.m_renderContext&&(this.m_renderContext.canvas.width=e,this.m_renderContext.canvas.height=t),this.m_renderingEnabled=r.debugContext.getValue("DEBUG_SCREEN_COLLISIONS")}allocate(e){super.allocate(e),this.m_numAllocations++,this.m_renderingEnabled&&null!==this.m_renderContext&&(this.m_renderContext.strokeStyle="#6666ff",this.m_renderContext.strokeRect(e.x-this.screenBounds.x,this.screenBounds.y+this.screenBounds.h-e.y-1,e.w,-e.h))}isAllocated(e){const t=super.isAllocated(e);if(this.m_renderingEnabled&&null!==this.m_renderContext){const i=t?2:0;this.m_renderContext.strokeStyle=t?"#FF0000":"#00ff00",this.m_renderContext.strokeRect(e.x-this.screenBounds.x-i,this.screenBounds.y+this.screenBounds.h-e.y-1+i,e.w+2*i,-e.h-2*i)}return t?this.m_numFailedTests++:this.m_numSuccessfulTests++,t}isVisible(e){const t=super.isVisible(e);return t?this.m_numSuccessfulVisibilityTests++:this.m_numFailedVisibilityTests++,t}}},function(e,t,i){"use strict";var n=i(147),r=i(148);n.prototype.bbox=r.bbox,n.prototype.geoJSON=r.geoJSON,n.Rectangle=i(41),e.exports=n},function(e,t,i){"use strict";var n=i(41);function r(e){if(!(this instanceof r))return new r(e);var t=3,i=6;isNaN(e)||(t=Math.floor(e/2),i=e);var s={x:0,y:0,w:0,h:0,id:"root",nodes:[]};this.root=s;var o=function(e){for(var t,i=e.slice(),n=[];i.length;)(t=i.pop()).nodes?i=i.concat(t.nodes):t.leaf&&n.push(t);return n},a=function(e,i,r){var s,a,l,c=[],h=[],m=[];if(!e||!n.overlapRectangle(e,r))return m;var p={x:e.x,y:e.y,w:e.w,h:e.h,target:i};for(h.push(r.nodes.length),c.push(r);c.length>0;){if(s=c.pop(),a=h.pop()-1,"target"in p)for(;a>=0;){if(l=s.nodes[a],n.overlapRectangle(p,l)){if(p.target&&"leaf"in l&&l.leaf===p.target||!p.target&&("leaf"in l||n.containsRectangle(l,p))){m="nodes"in l?o(s.nodes.splice(a,1)):s.nodes.splice(a,1),n.makeMBR(s.nodes,s),delete p.target;break}"nodes"in l&&(h.push(a),c.push(s),s=l,a=l.nodes.length)}a--}else if("nodes"in p){s.nodes.splice(a+1,1),s.nodes.length>0&&n.makeMBR(s.nodes,s);for(var f=0;f<p.nodes.length;f++)u(p.nodes[f],s);p.nodes=[],0===c.length&&s.nodes.length<=1?(p.nodes=d(s,!0,p.nodes,s),s.nodes=[],c.push(s),h.push(1)):c.length>0&&s.nodes.length<t?(p.nodes=d(s,!0,p.nodes,s),s.nodes=[]):delete p.nodes}else n.makeMBR(s.nodes,s);1}return m},l=function(e){for(var t=h(e);e.length>0;)c(e,t[0],t[1]);return t},c=function(e,i,r){for(var s,o,a,l=n.squarifiedRatio(i.w,i.h,i.nodes.length+1),c=n.squarifiedRatio(r.w,r.h,r.nodes.length+1),h=e.length-1;h>=0;h--){var d=e[h],u={};u.x=Math.min(i.x,d.x),u.y=Math.min(i.y,d.y),u.w=Math.max(i.x+i.w,d.x+d.w)-u.x,u.h=Math.max(i.y+i.h,d.y+d.h)-u.y;var m=Math.abs(n.squarifiedRatio(u.w,u.h,i.nodes.length+2)-l),p={};p.x=Math.min(r.x,d.x),p.y=Math.min(r.y,d.y),p.w=Math.max(r.x+r.w,d.x+d.w)-p.x,p.h=Math.max(r.y+r.h,d.y+d.h)-p.y;var f=Math.abs(n.squarifiedRatio(p.w,p.h,r.nodes.length+2)-c);(!o||!s||Math.abs(f-m)<s)&&(o=h,s=Math.abs(f-m),a=f<m?r:i)}var g=e.splice(o,1)[0];i.nodes.length+e.length+1<=t?(i.nodes.push(g),n.expandRectangle(i,g)):r.nodes.length+e.length+1<=t?(r.nodes.push(g),n.expandRectangle(r,g)):(a.nodes.push(g),n.expandRectangle(a,g))},h=function(e){for(var t,i,n=e.length-1,r=0,s=e.length-1,o=0,a=e.length-2;a>=0;a--){var l=e[a];l.x>e[r].x?r=a:l.x+l.w<e[n].x+e[n].w&&(n=a),l.y>e[o].y?o=a:l.y+l.h<e[s].y+e[s].h&&(s=a)}return Math.abs(e[n].x+e[n].w-e[r].x)>Math.abs(e[s].y+e[s].h-e[o].y)?n>r?(t=e.splice(n,1)[0],i=e.splice(r,1)[0]):(i=e.splice(r,1)[0],t=e.splice(n,1)[0]):s>o?(t=e.splice(s,1)[0],i=e.splice(o,1)[0]):(i=e.splice(o,1)[0],t=e.splice(s,1)[0]),[{x:t.x,y:t.y,w:t.w,h:t.h,nodes:[t]},{x:i.x,y:i.y,w:i.w,h:i.h,nodes:[i]}]},d=function(e,t,i,r){var s=[];if(!n.overlapRectangle(e,r))return i;for(s.push(r.nodes);s.length>0;)for(var o=s.pop(),a=o.length-1;a>=0;a--){var l=o[a];n.overlapRectangle(e,l)&&("nodes"in l?s.push(l.nodes):"leaf"in l&&(t?i.push(l):i.push(l.leaf)))}return i},u=function(e,t){var r;if(0===t.nodes.length)return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,void t.nodes.push(e);for(var s,o=function(e,t){var i,r=-1,s=[],o=!0;s.push(t);for(var a=t.nodes;o||-1!==r;){o?o=!1:(s.push(a[r]),a=a[r].nodes,r=-1);for(var l=a.length-1;l>=0;l--){var c=a[l];if("leaf"in c){r=-1;break}var h=n.squarifiedRatio(c.w,c.h,c.nodes.length+1),d=Math.max(c.x+c.w,e.x+e.w)-Math.min(c.x,e.x),u=Math.max(c.y+c.h,e.y+e.h)-Math.min(c.y,e.y),m=n.squarifiedRatio(d,u,c.nodes.length+2);(r<0||Math.abs(m-h)<i)&&(i=Math.abs(m-h),r=l)}}return s}(e,t),a=e;o.length>0;){if(r&&"nodes"in r&&0===r.nodes.length){s=r,r=o.pop();for(var c=0;c<r.nodes.length;c++)if(r.nodes[c]===s||0===r.nodes[c].nodes.length){r.nodes.splice(c,1);break}}else r=o.pop();if("leaf"in a||"nodes"in a||Array.isArray(a)){if(Array.isArray(a)){for(var h=0;h<a.length;h++)n.expandRectangle(r,a[h]);r.nodes=r.nodes.concat(a)}else n.expandRectangle(r,a),r.nodes.push(a);if(r.nodes.length<=i)a={x:r.x,y:r.y,w:r.w,h:r.h};else{var d=l(r.nodes);a=d,o.length<1&&(r.nodes.push(d[0]),o.push(r),a=d[1])}}else n.expandRectangle(r,a),a={x:r.x,y:r.y,w:r.w,h:r.h}}};this.insertSubtree=u,this.getTree=function(){return s},this.setTree=function(e,t){return t||(t=s),n=e,(i=t).nodes=n.nodes,i.x=n.x,i.y=n.y,i.w=n.w,i.h=n.h,i;var i,n},this.search=function(e,t,i){return d(e,t,i=i||[],s)};this.remove=function(e,t){return t&&"function"!=typeof t?function(e,t){return a(e,t,s)}(e,t):function(e){for(var t,i=1,n=[];i>0;)i=(t=a(e,!1,s)).length,n=n.concat(t);return n}(e)},this.insert=function(e,t){return u({x:e.x,y:e.y,w:e.w,h:e.h,leaf:t},s)}}r.prototype.toJSON=function(e){return JSON.stringify(this.root,!1,e)},r.fromJSON=function(e){var t=new r;return t.setTree(JSON.parse(e)),t},e.exports=r,"function"!=typeof Array.isArray&&(Array.isArray=function(e){return"object"==typeof e&&"[object Array]"==={}.toString.call(e)})},function(e,t,i){"use strict";var n=i(41),r=function(e,t){if(t&&t.bbox)return{leaf:t,x:t.bbox[0],y:t.bbox[1],w:t.bbox[2]-t.bbox[0],h:t.bbox[3]-t.bbox[1]};for(var i=e.length,n=0,r=new Array(i);n<i;)r[n]=[e[n][0],e[n][1]],n++;var s=r[0];i=r.length,n=1;for(var o={min:[].concat(s),max:[].concat(s)};n<i;)r[n][0]<o.min[0]?o.min[0]=r[n][0]:r[n][0]>o.max[0]&&(o.max[0]=r[n][0]),r[n][1]<o.min[1]?o.min[1]=r[n][1]:r[n][1]>o.max[1]&&(o.max[1]=r[n][1]),n++;var a={x:o.min[0],y:o.min[1],w:o.max[0]-o.min[0],h:o.max[1]-o.min[1]};return t&&(a.leaf=t),a},s={point:function(e,t){return t.insertSubtree({x:e.geometry.coordinates[0],y:e.geometry.coordinates[1],w:0,h:0,leaf:e},t.root)},multiPointLineString:function(e,t){return t.insertSubtree(r(e.geometry.coordinates,e),t.root)},multiLineStringPolygon:function(e,t){return t.insertSubtree(r(Array.prototype.concat.apply([],e.geometry.coordinates),e),t.root)},multiPolygon:function(e,t){return t.insertSubtree(r(Array.prototype.concat.apply([],Array.prototype.concat.apply([],e.geometry.coordinates)),e),t.root)},makeRec:function(e){return n(e.x,e.y,e.w,e.h)},geometryCollection:function(e,t){if(e.bbox)return t.insertSubtree({leaf:e,x:e.bbox[0],y:e.bbox[1],w:e.bbox[2]-e.bbox[0],h:e.bbox[3]-e.bbox[1]},t.root);for(var i,n=e.geometry.geometries,o=0,a=n.length,l=[];o<a;){switch((i=n[o]).type){case"Point":l.push(s.makeRec({x:i.coordinates[0],y:i.coordinates[1],w:0,h:0}));break;case"MultiPoint":case"LineString":l.push(s.makeRec(r(i.coordinates)));break;case"MultiLineString":case"Polygon":l.push(s.makeRec(r(Array.prototype.concat.apply([],i.coordinates))));break;case"MultiPolygon":l.push(s.makeRec(r(Array.prototype.concat.apply([],Array.prototype.concat.apply([],i.coordinates)))));break;case"GeometryCollection":a=(n=n.concat(i.geometries)).length}o++}var c=l[0];for(o=1,a=l.length;o<a;)c.expand(l[o]),o++;return t.insertSubtree({leaf:e,x:c.x(),y:c.y(),h:c.h(),w:c.w()},t.root)}};t.geoJSON=function(e){var t,i;if(Array.isArray(e))t=e.slice();else if(e.features&&Array.isArray(e.features))t=e.features.slice();else{if(!(e instanceof Object))throw"this isn't what we're looking for";t=[e]}for(var n=t.length,r=0;r<n;){if("Feature"===(i=t[r]).type)switch(i.geometry.type){case"Point":s.point(i,this);break;case"MultiPoint":case"LineString":s.multiPointLineString(i,this);break;case"MultiLineString":case"Polygon":s.multiLineStringPolygon(i,this);break;case"MultiPolygon":s.multiPolygon(i,this);break;case"GeometryCollection":s.geometryCollection(i,this)}r++}},t.bbox=function(){var e,t,i,n;switch(arguments.length){case 1:e=arguments[0][0][0],t=arguments[0][0][1],i=arguments[0][1][0],n=arguments[0][1][1];break;case 2:e=arguments[0][0],t=arguments[0][1],i=arguments[1][0],n=arguments[1][1];break;case 4:e=arguments[0],t=arguments[1],i=arguments[2],n=arguments[3]}return this.search({x:e,y:t,w:i-e,h:n-t})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);class r{constructor(){this.m_projectionViewMatrix=new n.Matrix4,this.m_viewMatrix=new n.Matrix4,this.m_cameraPosition=new n.Vector3,this.m_center=new n.Vector3,this.m_width=0,this.m_height=0,this.m_nearClipPlane=0,this.m_farClipPlane=0}get width(){return this.m_width}get height(){return this.m_height}project(e,t=new n.Vector2){const i=this.projectVector(e,r.tempV3);if(i.z>0&&i.z<1)return t.set(i.x*this.m_width/2,i.y*this.m_height/2),t}projectVector(e,t){return t.x=e.x-this.m_center.x-this.m_cameraPosition.x,t.y=e.y-this.m_center.y-this.m_cameraPosition.y,t.z=e.z-this.m_center.z-this.m_cameraPosition.z,t.applyMatrix4(this.m_projectionViewMatrix),t}projectInPlace(e,t){const i=this.projectVector(e,r.tempV3);if(i.z>0&&i.z<1)return t.set(i.x*this.m_width/2,i.y*this.m_height/2),t}onScreen(e){const t=this.projectVector(e,r.tempV3);return t.z>0&&t.z<1&&(t.x>=-1&&t.x<=1&&t.y>=-1&&t.y<=1)}update(e,t,i,r){this.m_width=i,this.m_height=r,e instanceof n.PerspectiveCamera&&(this.m_nearClipPlane=e.near,this.m_farClipPlane=e.far),this.m_center.copy(t),this.m_viewMatrix.makeRotationFromQuaternion(e.quaternion),this.m_viewMatrix.transpose(),this.m_cameraPosition.copy(e.position),this.m_projectionViewMatrix.multiplyMatrices(e.projectionMatrix,this.m_viewMatrix)}}r.tempV2=new n.Vector2,r.tempV3=new n.Vector3,t.ScreenProjector=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(151);t.SkyBackground=class{constructor(e,t,i,s,o=r.DEFAULT_MONOMIAL_POWER){this.m_topColor=e,this.m_bottomColor=t,this.m_groundColor=i,this.m_monomialPower=o,this.m_gradient=new r.SkyGradientTexture(e,t,i,o),this.m_farClipPlaneDividedVertically=new n.Line3,this.m_groundPlane=new n.Plane(new n.Vector3(0,0,1)),this.m_bottomMidFarPoint=new n.Vector3,this.m_topMidFarPoint=new n.Vector3,this.m_horizonPosition=new n.Vector3,this.m_farClipPlaneCorners=[new n.Vector3,new n.Vector3,new n.Vector3,new n.Vector3],this.update(s)}get topColor(){return this.m_topColor}get bottomColor(){return this.m_bottomColor}get groundColor(){return this.m_groundColor}get monomialPower(){return this.m_monomialPower}get texture(){return this.m_gradient.texture}get horizon(){return this.m_horizonPosition}update(e){this.setHorizonPosition(e),this.updateTexturePosition()}updateColors(e,t,i){this.m_topColor=e,this.m_bottomColor=t,this.m_groundColor=i,this.m_gradient.update(e,t,i)}setHorizonPosition(e){this.setFarPlaneCornersFromCamera(e,this.m_farClipPlaneCorners);const t=this.m_farClipPlaneCorners[0],i=this.m_farClipPlaneCorners[1],n=this.m_farClipPlaneCorners[2],r=this.m_farClipPlaneCorners[3];this.setMidPoint(t,i,this.m_bottomMidFarPoint),this.setMidPoint(n,r,this.m_topMidFarPoint),this.m_farClipPlaneDividedVertically.set(this.m_bottomMidFarPoint,this.m_topMidFarPoint),this.m_groundPlane.intersectLine(this.m_farClipPlaneDividedVertically,this.m_horizonPosition)||this.m_horizonPosition.set(0,0,0)}updateTexturePosition(){const e=this.m_bottomMidFarPoint.distanceTo(this.m_horizonPosition)/this.m_farClipPlaneDividedVertically.distance();let t;if(0===this.m_horizonPosition.length())t=1;else{t=e-1/this.m_gradient.texture.image.height}this.m_bottomMidFarPoint.z<=0?this.m_gradient.updateYOffset(-t):this.m_gradient.updateYOffset(e)}setMidPoint(e,t,i){i.set((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2)}setFarPlaneCornersFromCamera(e,t){let i=0;function n(n,r,s){t[i++].set(n,r,s).unproject(e)}n(-1,-1,1),n(1,-1,1),n(-1,1,1),n(1,1,1)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);t.DEFAULT_TEXTURE_HEIGHT=512;t.DEFAULT_MONOMIAL_POWER=1;t.SkyGradientTexture=class{constructor(e,i,n,r,s=t.DEFAULT_TEXTURE_HEIGHT){this.m_topColor=e,this.m_bottomColor=i,this.m_groundColor=n,this.m_monomialPower=r,this.m_height=s,this.m_texture=this.createTexture()}get texture(){return this.m_texture}updateYOffset(e){e<=0&&this.m_texture.offset.set(0,e)}update(e,i,n,r=t.DEFAULT_TEXTURE_HEIGHT){this.m_topColor=e,this.m_bottomColor=i,this.m_groundColor=n,this.updateTextureColors()}updateTextureColors(){const e=this.m_texture.image.data;this.fillTextureData(e),this.m_texture.needsUpdate=!0}createTexture(){const e=1*this.m_height,t=new Uint8Array(3*e);this.fillTextureData(t);const i=new n.DataTexture(t,1,this.m_height,n.RGBFormat);return i.needsUpdate=!0,i.unpackAlignment=1,i}fillTextureData(e){const t=1*this.m_height,i=this.m_topColor,r=this.m_bottomColor,s=this.m_groundColor;e[0]=255*s.r,e[1]=255*s.g,e[2]=255*s.b;const o=new n.Color;for(let n=1;n<t;n++){const{r:s,g:a,b:l}=o.copy(r).lerp(i,Math.pow(n/t,this.m_monomialPower)).multiplyScalar(255),c=3*n;e[c]=s,e[c+1]=a,e[c+2]=l}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0);t.MapTileCuller=class{constructor(e){this.m_camera=e,this.m_globalFrustumMin=new n.Vector3,this.m_globalFrustumMax=new n.Vector3,this.m_frustumCorners=[new n.Vector3,new n.Vector3,new n.Vector3,new n.Vector3,new n.Vector3,new n.Vector3,new n.Vector3,new n.Vector3]}setup(){const e=this.getFrustumCorners(),t=this.m_camera.matrixWorld;this.m_globalFrustumMin.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.m_globalFrustumMax.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(const i of e)i.applyMatrix4(t),this.m_globalFrustumMin.x=Math.min(this.m_globalFrustumMin.x,i.x),this.m_globalFrustumMin.y=Math.min(this.m_globalFrustumMin.y,i.y),this.m_globalFrustumMin.z=Math.min(this.m_globalFrustumMin.z,i.z),this.m_globalFrustumMax.x=Math.max(this.m_globalFrustumMax.x,i.x),this.m_globalFrustumMax.y=Math.max(this.m_globalFrustumMax.y,i.y),this.m_globalFrustumMax.z=Math.max(this.m_globalFrustumMax.z,i.z)}frustumIntersectsTileBox(e){const t=this.m_globalFrustumMin,i=this.m_globalFrustumMax;return!(i.x<e.min.x||i.y<e.min.y||i.z<e.min.z||t.x>e.max.x||t.y>e.max.y||t.z>e.max.z)}getFrustumCorners(){const e=this.m_frustumCorners,t=this.m_camera.projectionMatrixInverse;let i=0;function n(n,r,s){e[i++].set(n,r,s).applyMatrix4(t)}return n(-1,-1,-1),n(1,-1,-1),n(-1,1,-1),n(1,1,-1),n(-1,-1,1),n(1,-1,1),n(-1,1,1),n(1,1,1),e}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(1),s=i(0),o={type:"update"};class a extends s.EventDispatcher{constructor(e,t,i,n,r){super(),this.enabled=!0,this.cacheable=!1,this.addTileBackground=!0,this.tileBackgroundColor=void 0,this.tileBackgroundIsVisible=!1,this.m_minZoomLevel=1,this.m_maxZoomLevel=20,this.m_storageLevelOffset=0,void 0!==e&&0!==e.length||(e="anonymous-datasource#"+ ++a.uniqueNameCounter),this.name=e,this.styleSetName=t,void 0!==i&&(this.m_minZoomLevel=i),void 0!==n&&(this.m_maxZoomLevel=n),void 0!==r&&(this.m_storageLevelOffset=r)}get styleSetName(){return this.m_styleSetName}set styleSetName(e){this.m_styleSetName=e,void 0!==this.m_mapView&&void 0!==e&&void 0!==this.m_mapView.theme.styles&&this.setStyleSet(this.m_mapView.theme.styles[e])}dispose(){}ready(){return!0}get mapView(){if(void 0===this.m_mapView)throw new Error("This DataSource was not added to MapView");return this.m_mapView}get projection(){return this.mapView.projection}connect(){return n(this,void 0,void 0,(function*(){}))}getElevationRangeSource(){}attach(e){this.m_mapView=e}detach(e){r.assert(this.m_mapView===e),this.m_mapView=void 0}setStyleSet(e,t){}setLanguages(e){}updateTile(e){}shouldPreloadTiles(){return!1}get minZoomLevel(){return this.m_minZoomLevel}set minZoomLevel(e){this.m_minZoomLevel=e}get maxZoomLevel(){return this.m_maxZoomLevel}set maxZoomLevel(e){this.m_maxZoomLevel=e}get storageLevelOffset(){return this.m_storageLevelOffset}set storageLevelOffset(e){this.m_storageLevelOffset=e}getDisplayZoomLevel(e){return s.Math.clamp(e+this.m_storageLevelOffset,this.m_minZoomLevel,this.m_maxZoomLevel)}shouldRender(e,t){return t.level===e}shouldRenderText(e,t){return!0}requestUpdate(){this.dispatchEvent(o)}}a.uniqueNameCounter=0,t.DataSource=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.isLoading=function(e){return void 0!==e.loadingPromise}}(t.ImageItem||(t.ImageItem={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(72),r=i(82);class s{static getTiler(e,t){const i=this.getWorkerSet(t);return new r.WorkerBasedTiler(i,e)}static getWorkerSet(e){void 0===e&&(e=this.defaultScriptUrl);let t=this.workerSets[e];return void 0===t&&(t=new n.ConcurrentWorkerSet({scriptUrl:e,workerCount:this.defaultWorkerCount}),this.workerSets[e]=t),t}static destroyWorkerSet(e){const t=this.workerSets[e];void 0!==t&&(t.destroy(),delete this.workerSets[e])}static destroy(){Object.keys(this.workerSets).forEach(e=>{this.workerSets[e].destroy()}),this.workerSets={}}}s.defaultScriptUrl="./decoder.bundle.js",s.defaultWorkerCount=1,s.workerSets={},t.ConcurrentTilerFacade=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(3),r=i(1),s=i(83),o=r.LoggerManager.instance.create("TileDataAccessor");t.TileDataAccessor=class{constructor(e,t,i){this.tile=e,this.visitor=t,this.m_wantsPoints=!0,this.m_wantsLines=!0,this.m_wantsAreas=!0,this.m_wantsObject3D=!0;const n=!0===i.wantsAll;this.m_wantsPoints=n||!(!1===i.wantsPoints),this.m_wantsLines=n||!(!1===i.wantsLines),this.m_wantsAreas=n||!(!1===i.wantsAreas),this.m_wantsObject3D=n||!(!1===i.wantsObject3D)}visitAll(){const e=this.tile.objects;for(const t of e)this.visitObject(t)}visitObject(e){const t=void 0!==e.userData?e.userData.feature:void 0;if(void 0===t||void 0!==t.ids&&1===t.ids.length&&!this.visitor.wantsFeature(t.ids[0]))return;const i=t.geometryType;if(void 0===i)return void o.warn("#visitObject: visiting object failed, no geometryType",e);switch(r.assert(void 0!==t.ids,"featureData.ids missing"),r.assert(Array.isArray(t.ids),"featureData.ids is not an array"),r.assert(void 0!==t.starts,"featureData.starts missing"),r.assert(Array.isArray(t.starts),"featureData.starts is not an array"),void 0!==t.ids&&void 0!==t.starts&&r.assert(t.ids.length===t.starts.length,"featureData.ids and featureData.starts have unequal length"),i){case n.GeometryType.Point:case n.GeometryType.Text:if(!this.m_wantsPoints)return;break;case n.GeometryType.SolidLine:case n.GeometryType.ExtrudedLine:case n.GeometryType.TextPath:if(!this.m_wantsLines)return;break;case n.GeometryType.Polygon:case n.GeometryType.ExtrudedPolygon:if(!this.m_wantsAreas)return;break;case n.GeometryType.Object3D:if(!this.m_wantsObject3D)return;break;default:o.warn("#visitObject: invalid geometryType")}if("Mesh"!==e.type)return void o.warn("#visitObject: visiting object failed, not of type 'Mesh'",e);const s=e;this.visitMesh(s,t)}getBufferGeometry(e){const t=e.geometry;if("BufferGeometry"!==t.type)return void o.warn("#visitObject: object does not have BufferGeometry");const i=t;if(i.getAttribute("position"))return i;o.warn("#visitLines: BufferGeometry has no position attribute")}getGeometryAccessor(e,t,i){switch(e){case n.GeometryType.Point:case n.GeometryType.Text:return;case n.GeometryType.SolidLine:case n.GeometryType.ExtrudedLine:case n.GeometryType.TextPath:return new s.BufferedGeometryLineAccessor(t,e,i);case n.GeometryType.Polygon:case n.GeometryType.ExtrudedPolygon:return;case n.GeometryType.Object3D:return new s.BufferedGeometryObject3dAccessor(t,e,i);default:o.warn("#getGeometryAccessor: invalid geometryType")}}getIndexedGeometryAccessor(e,t,i){switch(e){case n.GeometryType.Point:case n.GeometryType.Text:return;case n.GeometryType.SolidLine:case n.GeometryType.ExtrudedLine:case n.GeometryType.TextPath:return new s.IndexedBufferedGeometryLineAccessor(t,e,i);case n.GeometryType.Polygon:case n.GeometryType.ExtrudedPolygon:case n.GeometryType.Object3D:return;default:o.warn("#getIndexedGeometryAccessor: invalid geometryType")}}visitMesh(e,t){const{ids:i,starts:a}=t,l=t.geometryType;if(void 0===i||void 0===a||void 0===l)return;let c;for(let t=0;t<i.length;t++){const h=i[t];if(!this.visitor.wantsFeature(h))continue;const d=a[t];let u=-1;if(void 0===c){const t=this.getBufferGeometry(e);if(void 0===t)continue;if(c=null!==t.index?this.getIndexedGeometryAccessor(l,e,t):this.getGeometryAccessor(l,e,t),void 0===c){o.warn("#visitObject: no accessor geometryType",l);continue}}switch(u=t<a.length-1?a[t+1]:c.getCount(),c.setRange(d,u),l){case n.GeometryType.Point:case n.GeometryType.Text:this.visitor.visitPoint(h);break;case n.GeometryType.SolidLine:case n.GeometryType.ExtrudedLine:case n.GeometryType.TextPath:r.assert(s.isLineAccessor(c)),this.visitor.visitLine(h,c);break;case n.GeometryType.Polygon:case n.GeometryType.ExtrudedPolygon:this.visitor.visitArea(h);break;case n.GeometryType.Object3D:r.assert(s.isObject3dAccessor(c)),this.visitor.visitObject3D(h,c);break;default:o.warn("#visitObject: invalid geometryType")}}}}},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(158)),n(i(84)),n(i(85)),n(i(42))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=new n.Vector3,s=new n.Vector3,o=new n.Vector3,a=new n.Vector3,l=new n.Vector3,c=[{name:"texcoord",itemSize:2,offset:0},{name:"position",itemSize:3,offset:2},{name:"tangent",itemSize:3,offset:5},{name:"bitangent",itemSize:4,offset:8}],h=[{name:"texcoord",itemSize:2,offset:0},{name:"position",itemSize:3,offset:2},{name:"positionLow",itemSize:3,offset:5},{name:"tangent",itemSize:3,offset:8},{name:"bitangent",itemSize:4,offset:11}];class d{constructor(){this.vertices=[],this.indices=[]}}function u(e,t,i=new d,n=!1){if(0===e.length)return i;const r=n?15:12,c=e.length/3,h=new Array(c),u=new Array(e.length-3),m=i.vertices.length/r;let p=.1;h[0]=p;let g=!0;for(let t=0;t<c-1;++t){let i=0;for(let n=0;n<3;++n){const r=e[3*(t+1)+n]-e[3*t+n];u[3*t+n]=r,i+=r*r,g=2===n?g&&0===e[3*(t+1)+n]:g}p+=Math.sqrt(i),h[t+1]=p}let _=!0;for(let t=0;t<3;++t)_=_&&e[t]===e[e.length-3+t];for(let r=0;r<c;++r){const d=_&&0===r?u.length-3:3*Math.max(0,r-1),m=_&&r===c-1?0:Math.min(3*r,u.length-3);if(r>0)for(let c=-1;c<=1;c+=2){i.vertices.push(h[r-1],h[r]*c);for(let t=0;t<3;++t){if(n){const n=Math.fround(e[3*r+t]),s=e[3*r+t]-n;i.vertices.push(n,s)}else i.vertices.push(e[3*r+t]);s.setComponent(t,e[3*r+t])}for(let e=0;e<3;++e)o.setComponent(e,u[d+e]),a.setComponent(e,u[m+e]);i.vertices.push(...o.normalize().toArray());const p=f(g?s.set(0,0,1):s.add(t).normalize(),o.normalize(),a.normalize(),l);i.vertices.push(...l.toArray(),p)}if(r+1<c)for(let c=-1;c<=1;c+=2){i.vertices.push(-1*h[Math.min(r,h.length-1)],h[Math.min(r+1,h.length-1)]*c);for(let t=0;t<3;++t){if(n){const n=Math.fround(e[3*r+t]),s=e[3*r+t]-n;i.vertices.push(n,s)}else i.vertices.push(e[3*r+t]);s.setComponent(t,e[3*r+t])}for(let e=0;e<3;++e)o.setComponent(e,u[d+e]),a.setComponent(e,u[m+e]);i.vertices.push(...o.normalize().toArray());const p=f(g?s.set(0,0,1):s.add(t).normalize(),o.normalize(),a.normalize(),l);i.vertices.push(...l.toArray(),p)}}for(let e=0;e<c-1;++e){const t=m+4*e;i.indices.push(t,t+1,t+2,t+2,t+1,t+3)}return i}function m(e,t=new d){if(0===e.length)return t;const i=e.length/3;let n=t.vertices.length/3;for(let r=0;r<i;++r,n++){r>0&&t.indices.push(n),r<i-1&&t.indices.push(n);for(let i=0;i<3;++i)t.vertices.push(e[3*r+i])}return t}t.LineGeometry=d,t.createLineGeometry=u,t.createSimpleLineGeometry=m;class p{constructor(e=!1,t=!1){this.highPrecision=e,this.isSimple=t,this.m_origin=new n.Vector3,this.m_geometry=new d}static createGeometry(e,t,i,r=!1,s=!1){if(s)return i.addAttribute("position",new n.BufferAttribute(new Float32Array(e),3)),i.setIndex(new n.BufferAttribute(new Uint32Array(t),1)),i;{const s=r?15:12,o=r?h:c,a=new n.InterleavedBuffer(new Float32Array(e),s);return o.forEach(e=>{const t=new n.InterleavedBufferAttribute(a,e.itemSize,e.offset,!1);i.addAttribute(e.name,t)}),i.setIndex(new n.BufferAttribute(new Uint32Array(t),1)),i}}clear(){this.m_geometry.vertices=[],this.m_geometry.indices=[]}add(e,t=this.m_origin){return this.isSimple?m(e,this.m_geometry):u(e,t,this.m_geometry,this.highPrecision),this}get vertices(){return this.m_geometry.vertices}get indices(){return this.m_geometry.indices}get vertexAttributes(){return this.highPrecision?h:c}get stride(){return this.highPrecision?15:12}createGeometry(e){return void 0===e&&(e=new n.BufferGeometry),p.createGeometry(this.m_geometry.vertices,this.m_geometry.indices,e,this.highPrecision)}}function f(e,t,i,n){let s=0;return t.equals(i)||(s=Math.acos(t.dot(i))*Math.sign(e.dot(r.copy(t).cross(i))),Number.isNaN(s)&&(s=0)),n.copy(t).add(i).normalize().cross(e).normalize(),s}t.LineGroup=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=i(4),s=i(42);class o extends n.Points{constructor(e,t,i,s,o){void 0===t&&(t=new r.HighPrecisionPointMaterial({color:s||r.HighPrecisionPointMaterial.DEFAULT_COLOR,opacity:void 0!==o?o:1})),super(void 0===e?new n.BufferGeometry:e,t),this.matrixWorldInverse=new n.Matrix4,i&&this.setPositions(i)}get bufferGeometry(){return this.geometry}clearGeometry(){return this.geometry=new n.BufferGeometry}get shaderMaterial(){return this.material}setPositions(e){s.HighPrecisionUtils.setPositions(this,e)}setupForRendering(){this.material.isHighPrecisionPointsMaterial&&void 0!==this.dimensionality&&this.material.setDimensionality(this.dimensionality),this.onBeforeRender=(e,t,i,n,r,o)=>{s.HighPrecisionUtils.updateHpUniforms(this,i,this.shaderMaterial)}}updateMatrixWorld(e){const t=this.matrixWorldNeedsUpdate||e;super.updateMatrixWorld(e),t&&this.matrixWorldInverse.getInverse(this.matrixWorld)}}t.HighPrecisionPoints=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(40),s=i(29);class o{constructor(e,t){if(this.m_defaults=new Map,this.m_mapViews=[],this.update=()=>{const e=this.m_mapViews.map(e=>e.copyrightInfo).reduce(r.CopyrightInfo.mergeArrays,this.staticInfo||[]);if(0===e.length)return void(this.m_element.style.display="none");if(this.m_element.style.display="block",0!==this.m_defaults.size)for(const t of e){const e=this.m_defaults.get(t.id);void 0!==e&&(t.year=n.getOptionValue(t.year,e.year),t.label=n.getOptionValue(t.label,e.label),t.link=n.getOptionValue(t.link,e.link))}const t=r.CopyrightInfo.mergeArrays(e);this.m_element.innerHTML=r.CopyrightInfo.formatAsHtml(t)},"string"==typeof e){if(this.m_element=document.getElementById(e),!this.m_element)throw new Error("CopyrightElementHandler: unable to find DOM element "+e)}else this.m_element=e;void 0!==t&&this.attach(t)}static install(e,t){return new o(e,t)}destroy(){for(const e of this.m_mapViews)e.removeEventListener(s.MapViewEventNames.CopyrightChanged,this.update)}attach(e){return this.m_mapViews.push(e),e.addEventListener(s.MapViewEventNames.CopyrightChanged,this.update),this.update(),this}detach(e){return e.removeEventListener(s.MapViewEventNames.CopyrightChanged,this.update),this.m_mapViews=this.m_mapViews.filter(t=>t!==e),this.update(),this}setDefaults(e){if(this.m_defaults.clear(),void 0!==e)for(const t of e)this.m_defaults.set(t.id,t);return this}setStaticCopyightInfo(e){return this.staticInfo=e,this}}t.CopyrightElementHandler=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(6);t.MapControlsUI=class{constructor(e,t={}){this.controls=e,this.domElement=document.createElement("div");const i=document.createElement("button");i.innerText="+";const r=document.createElement("button");r.innerText="-";const s=document.createElement("button");s.innerText="3D";let o=null;if("show"===t.zoomLevel){const t=document.createElement("div");e.mapView.addEventListener(n.MapViewEventNames.Render,()=>{t.innerText=e.zoomLevelTargetted.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}),o=t}else if("input"===t.zoomLevel){const t=document.createElement("input");t.type="number",e.mapView.addEventListener(n.MapViewEventNames.Render,()=>{t.value=e.zoomLevelTargetted.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})});const i=i=>{e.setZoomLevel(parseFloat(t.value)),i.preventDefault()};t.addEventListener("blur",i),t.addEventListener("keypress",e=>{"Enter"===e.key&&i(e)}),window.addEventListener("click",e=>{e&&e.target&&e.target.contains&&e.target!==t&&!e.target.contains(t)&&t.blur()}),o=t}return this.domElement.appendChild(i),this.domElement.appendChild(s),null!==o&&this.domElement.appendChild(o),this.domElement.appendChild(r),i.addEventListener("click",t=>{const i=e.zoomLevelTargetted+e.zoomLevelDeltaOnControl;e.setZoomLevel(i)}),r.addEventListener("click",t=>{const i=e.zoomLevelTargetted-e.zoomLevelDeltaOnControl;e.setZoomLevel(i)}),s.addEventListener("click",t=>{e.toggleTilt()}),this.domElement.className="harp-gl_controls",i.className=r.className=s.className="harp-gl_controls-button",null!==o&&(o.className="harp-gl_controls-zoom"),!0!==t.disableDefaultStyle&&(this.initStyle(),this.domElement.style.cssText="position: absolute; right: 10px; top: 50%; margin-top: -70px;"),this}initStyle(){if(null!==document.getElementById("here-harp-controls.map-controls-ui-styles"))return;const e=document.createElement("style");e.id="here-harp-controls.map-controls-ui-styles",e.appendChild(document.createTextNode("\n            .harp-gl_controls-button {\n                display: block;\n                background-color: #fff;\n                width: 40px;\n                height: 40px;\n                font-size: 22px;\n                font-weight: bold;\n                outline: none;\n                margin: 5px;\n                border: none;\n                color: #555;\n                opacity: 0.87;\n                cursor: pointer;\n                border-radius: 4px;\n                box-shadow: 0px 0px 4px #aaa;\n                transition: all 0.1s;\n                padding: 0 0 1px 1px;\n                user-select: none;\n            }\n            .harp-gl_controls-button:active {\n                background-color: #37afaa;\n                color: #eee;\n            }\n            .harp-gl_controls-zoom {\n                display: block;\n                background-color: #fff;\n                width: 40px;\n                height: 20px;\n                font-size: 12px;\n                font-weight: bold;\n                outline: none;\n                margin: 5px;\n                border: none;\n                color: #555;\n                opacity: 0.87;\n                border-radius: 4px;\n                box-shadow: 0px 0px 4px #aaa;\n                padding: 2px 0 0;\n                text-align: center;\n                user-select: text;\n            }\n            input.harp-gl_controls-zoom::-webkit-outer-spin-button,\n            input.harp-gl_controls-zoom::-webkit-inner-spin-button {\n                /* display: none; <- Crashes Chrome on hover */\n                -webkit-appearance: none;\n                margin: 0; /* <-- Apparently some margin are still there even though it's hidden */\n            }\n            input.harp-gl_controls-zoom[type=number] {\n                -moz-appearance:textfield; /* Firefox */\n            }")),document.head.appendChild(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.LongPressHandler=class{constructor(e,t){this.element=e,this.onLongPress=t,this.timeout=500,this.moveThreshold=5,this.buttonId=0,this.m_mouseDownEvent=void 0,this.m_timerId=void 0,this.m_moveHandlerRegistered=!1,this.m_boundMouseMoveHandler=this.onMouseMove.bind(this),this.m_boundMouseDownHandler=this.onMousedown.bind(this),this.m_boundMouseUpHandler=this.onMouseup.bind(this),this.element.addEventListener("mousedown",this.m_boundMouseDownHandler),this.element.addEventListener("mouseup",this.m_boundMouseUpHandler)}dispose(){this.cancel(),this.element.removeEventListener("mousedown",this.m_boundMouseDownHandler),this.element.removeEventListener("mouseup",this.m_boundMouseUpHandler)}onMousedown(e){e.button===this.buttonId&&(this.cancelTimer(),this.m_mouseDownEvent=e,this.m_timerId=setTimeout(()=>this.onTimeout(),this.timeout),this.addMouseMoveHandler())}onMouseup(e){e.button===this.buttonId&&this.cancel()}onMouseMove(e){if(void 0===this.m_mouseDownEvent)return;Math.abs(e.clientX-this.m_mouseDownEvent.clientX)+Math.abs(e.clientY-this.m_mouseDownEvent.clientY)>=this.moveThreshold&&this.cancel()}cancel(){this.m_mouseDownEvent=void 0,this.cancelTimer(),this.removeMouseMoveHandler()}cancelTimer(){void 0!==this.m_timerId&&(clearTimeout(this.m_timerId),this.m_timerId=void 0)}addMouseMoveHandler(){this.m_moveHandlerRegistered||(this.element.addEventListener("mousemove",this.m_boundMouseMoveHandler),this.m_moveHandlerRegistered=!0)}removeMouseMoveHandler(){this.m_moveHandlerRegistered&&(this.element.removeEventListener("mousemove",this.m_boundMouseMoveHandler),this.m_moveHandlerRegistered=!1)}onTimeout(){const e=this.m_mouseDownEvent;this.m_timerId=void 0,this.cancel(),void 0!==e&&this.onLongPress(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(2),r=i(86),s=i(1),o=i(164),a=i(0);var l,c;!function(e){e[e.Linear=0]="Linear",e[e.QuadraticIn=1]="QuadraticIn",e[e.QuadraticOut=2]="QuadraticOut",e[e.QuadraticInOut=3]="QuadraticInOut",e[e.CubicIn=4]="CubicIn",e[e.CubicOut=5]="CubicOut",e[e.CubicInOut=6]="CubicInOut",e[e.QuarticIn=7]="QuarticIn",e[e.QuarticOut=8]="QuarticOut",e[e.QuarticInOut=9]="QuarticInOut",e[e.QuinticIn=10]="QuinticIn",e[e.QuinticOut=11]="QuinticOut",e[e.QuinticInOut=12]="QuinticInOut",e[e.SinusoidalIn=13]="SinusoidalIn",e[e.SinusoidalOut=14]="SinusoidalOut",e[e.SinusoidalInOut=15]="SinusoidalInOut",e[e.ExponentialIn=16]="ExponentialIn",e[e.ExponentialOut=17]="ExponentialOut",e[e.ExponentialInOut=18]="ExponentialInOut",e[e.CircularIn=19]="CircularIn",e[e.CircularOut=20]="CircularOut",e[e.CircularInOut=21]="CircularInOut",e[e.ElasticIn=22]="ElasticIn",e[e.ElasticOut=23]="ElasticOut",e[e.ElasticInOut=24]="ElasticInOut",e[e.BackIn=25]="BackIn",e[e.BackOut=26]="BackOut",e[e.BackInOut=27]="BackInOut",e[e.BounceIn=28]="BounceIn",e[e.BounceOut=29]="BounceOut",e[e.BounceInOut=30]="BounceInOut"}(l=t.EasingFunction||(t.EasingFunction={})),function(e){e[e.Linear=0]="Linear",e[e.Bezier=1]="Bezier",e[e.CatmullRom=2]="CatmullRom"}(c=t.InterpolationFunction||(t.InterpolationFunction={}));class h{constructor(e,t){this.mapView=e,this.name=t,this.running=!1,this.stopped=!1,this.duration=1e4,this.repeat=0,this.easing=o.Easing.Linear.None,function(){if(void 0!==d)return;d=new Map,u=new Map,d.set(l.Linear,o.Easing.Linear.None),d.set(l.QuadraticIn,o.Easing.Quadratic.In),d.set(l.QuadraticOut,o.Easing.Quadratic.Out),d.set(l.QuadraticInOut,o.Easing.Quadratic.InOut),d.set(l.CubicIn,o.Easing.Cubic.In),d.set(l.CubicOut,o.Easing.Cubic.Out),d.set(l.CubicInOut,o.Easing.Cubic.InOut),d.set(l.QuarticIn,o.Easing.Quartic.In),d.set(l.QuarticOut,o.Easing.Quartic.Out),d.set(l.QuarticInOut,o.Easing.Quartic.InOut),d.set(l.QuinticIn,o.Easing.Quintic.In),d.set(l.QuinticOut,o.Easing.Quintic.Out),d.set(l.QuinticInOut,o.Easing.Quintic.InOut),d.set(l.SinusoidalIn,o.Easing.Sinusoidal.In),d.set(l.SinusoidalOut,o.Easing.Sinusoidal.Out),d.set(l.SinusoidalInOut,o.Easing.Sinusoidal.InOut),d.set(l.ExponentialIn,o.Easing.Exponential.In),d.set(l.ExponentialOut,o.Easing.Exponential.Out),d.set(l.ExponentialInOut,o.Easing.Exponential.InOut),d.set(l.CircularIn,o.Easing.Circular.In),d.set(l.CircularOut,o.Easing.Circular.Out),d.set(l.CircularOut,o.Easing.Circular.InOut),d.set(l.ElasticIn,o.Easing.Elastic.In),d.set(l.ElasticOut,o.Easing.Elastic.Out),d.set(l.ElasticInOut,o.Easing.Elastic.InOut),d.set(l.BackIn,o.Easing.Back.In),d.set(l.BackOut,o.Easing.Back.Out),d.set(l.BackInOut,o.Easing.Back.InOut),d.set(l.BounceIn,o.Easing.Bounce.In),d.set(l.BounceOut,o.Easing.Bounce.Out),d.set(l.BounceInOut,o.Easing.Bounce.InOut),u.set(c.Linear,o.Interpolation.Linear),u.set(c.Bezier,o.Interpolation.Bezier),u.set(c.CatmullRom,o.Interpolation.CatmullRom)}()}update(e){return!!this.tween&&this.tween.update(e||s.PerformanceTimer.now())}get isRunning(){return this.running}}t.CameraAnimation=h;t.CameraRotationAnimation=class extends h{constructor(e,t,i,n){super(e,n),this.m_mapControls=t,this.startAngle=0,this.endAngle=360,this.m_axis=new a.Vector3(0,0,1),this.beginInteractionListener=()=>{this.stopped||this.stopTween()},this.endInteractionListener=()=>{this.stopped||this.startTween()},void 0!==i.axis&&(this.m_axis=i.axis),void 0!==i.startAngle&&(this.startAngle=i.startAngle),void 0!==i.endAngle&&(this.endAngle=i.endAngle),void 0!==i.duration&&(this.duration=i.duration),void 0!==i.repeat&&(this.repeat=i.repeat),void 0!==i.easing&&(this.easing="function"==typeof i.easing?i.easing:d.get(i.easing)||o.Easing.Linear.None),this.m_lastRotationValue=this.startAngle}start(e,t){if(this.running)throw new Error("Animation already running"+this.name!==void 0?this.name:"");this.running=!0,this.onFinished=t,this.stopped=!1,this.m_mapControls&&(this.m_mapControls.addEventListener(r.EventNames.BeginInteraction,this.beginInteractionListener),this.m_mapControls.addEventListener(r.EventNames.EndInteraction,this.endInteractionListener)),this.startTween(e),this.mapView.beginAnimation()}stop(){if(!this.running)throw new Error("Animation not running"+this.name!==void 0?this.name:"");this.running=!1,this.stopped=!0,this.mapView.endAnimation(),this.tween&&this.tween.stop(),this.m_mapControls&&(this.m_mapControls.removeEventListener(r.EventNames.BeginInteraction,this.beginInteractionListener),this.m_mapControls.removeEventListener(r.EventNames.EndInteraction,this.endInteractionListener))}startTween(e){const t=new a.Quaternion;this.m_userCamerRotation=new a.Quaternion,this.mapView.camera.getWorldQuaternion(this.m_userCamerRotation),this.tween=new o.Tween({rotation:0}).to({rotation:this.endAngle-this.m_lastRotationValue},this.duration).onComplete(()=>{this.stop(),this.onFinished&&this.onFinished()}).onUpdate(({rotation:e})=>{this.m_lastRotationValue=e,t.setFromEuler(new a.Euler(0,0,n.MathUtils.degToRad(e))),void 0!==this.m_userCamerRotation&&t.multiply(this.m_userCamerRotation),this.mapView.camera.quaternion.copy(t)}),this.tween.repeat(this.repeat),this.tween.easing(this.easing),this.tween.start(e)}stopTween(){this.tween&&this.tween.stop()}};let d,u;t.CameraPanAnimation=class extends h{constructor(e,t,i){super(e,i),this.name=i,this.interpolation=o.Interpolation.CatmullRom,void 0!==t.duration&&(this.duration=t.duration),void 0!==t.repeat&&(this.repeat=t.repeat),void 0!==t.easing&&(this.easing="function"==typeof t.easing?t.easing:d.get(t.easing)||o.Easing.Linear.None),void 0!==t.interpolation&&(this.interpolation="function"==typeof t.interpolation?t.interpolation:u.get(t.interpolation)||o.Interpolation.Linear),this.m_geoCoordinates=void 0!==t.geoCoordinates?t.geoCoordinates:[]}addPosition(e){this.m_geoCoordinates.push(e)}start(e,t){if(this.running)throw new Error("Animation already running"+this.name!==void 0?this.name:"");this.onFinished=t,this.running=!0;const i=new n.GeoCoordinates(this.mapView.geoCenter.latitude,this.mapView.geoCenter.longitude,this.mapView.camera.position.z),r={latitude:new Array,longitude:new Array,altitude:new Array};for(const e of this.m_geoCoordinates)r.latitude.push(e.latitude),r.longitude.push(e.longitude),r.altitude.push(e.altitude||this.mapView.camera.position.z);this.tween=new o.Tween(i).to(r,this.duration).onComplete(()=>{this.stop(),this.onFinished&&this.onFinished()}).onUpdate(({latitude:e,longitude:t,altitude:i})=>{this.mapView.geoCenter=new n.GeoCoordinates(e,t,i),this.mapView.camera.position.z=i}),this.tween.repeat(this.repeat),this.tween.easing(this.easing),this.tween.interpolation(this.interpolation),this.tween.start(e),this.mapView.beginAnimation()}stop(){if(!this.running)throw new Error("Animation not running"+this.name!==void 0?this.name:"");this.running=!1,this.mapView.endAnimation(),this.tween&&this.tween.stop()}get isRunning(){return this.running}}},function(e,t,i){(function(i){var n,r=function(){this._tweens={},this._tweensAddedDuringUpdate={}};r.prototype={getAll:function(){return Object.keys(this._tweens).map(function(e){return this._tweens[e]}.bind(this))},removeAll:function(){this._tweens={}},add:function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},remove:function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},update:function(e,t){var i=Object.keys(this._tweens);if(0===i.length)return!1;for(e=void 0!==e?e:o.now();i.length>0;){this._tweensAddedDuringUpdate={};for(var n=0;n<i.length;n++){var r=this._tweens[i[n]];r&&!1===r.update(e)&&(r._isPlaying=!1,t||delete this._tweens[i[n]])}i=Object.keys(this._tweensAddedDuringUpdate)}return!0}};var s,o=new r;o.Group=r,o._nextId=0,o.nextId=function(){return o._nextId++},"undefined"==typeof self&&void 0!==i&&i.hrtime?o.now=function(){var e=i.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof self&&void 0!==self.performance&&void 0!==self.performance.now?o.now=self.performance.now.bind(self.performance):void 0!==Date.now?o.now=Date.now:o.now=function(){return(new Date).getTime()},o.Tween=function(e,t){this._object=e,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._repeat=0,this._repeatDelayTime=void 0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=null,this._easingFunction=o.Easing.Linear.None,this._interpolationFunction=o.Interpolation.Linear,this._chainedTweens=[],this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onRepeatCallback=null,this._onCompleteCallback=null,this._onStopCallback=null,this._group=t||o,this._id=o.nextId()},o.Tween.prototype={getId:function(){return this._id},isPlaying:function(){return this._isPlaying},to:function(e,t){return this._valuesEnd=Object.create(e),void 0!==t&&(this._duration=t),this},duration:function(e){return this._duration=e,this},start:function(e){for(var t in this._group.add(this),this._isPlaying=!0,this._onStartCallbackFired=!1,this._startTime=void 0!==e?"string"==typeof e?o.now()+parseFloat(e):e:o.now(),this._startTime+=this._delayTime,this._valuesEnd){if(this._valuesEnd[t]instanceof Array){if(0===this._valuesEnd[t].length)continue;this._valuesEnd[t]=[this._object[t]].concat(this._valuesEnd[t])}void 0!==this._object[t]&&(this._valuesStart[t]=this._object[t],this._valuesStart[t]instanceof Array==!1&&(this._valuesStart[t]*=1),this._valuesStartRepeat[t]=this._valuesStart[t]||0)}return this},stop:function(){return this._isPlaying?(this._group.remove(this),this._isPlaying=!1,null!==this._onStopCallback&&this._onStopCallback(this._object),this.stopChainedTweens(),this):this},end:function(){return this.update(1/0),this},stopChainedTweens:function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop()},group:function(e){return this._group=e,this},delay:function(e){return this._delayTime=e,this},repeat:function(e){return this._repeat=e,this},repeatDelay:function(e){return this._repeatDelayTime=e,this},yoyo:function(e){return this._yoyo=e,this},easing:function(e){return this._easingFunction=e,this},interpolation:function(e){return this._interpolationFunction=e,this},chain:function(){return this._chainedTweens=arguments,this},onStart:function(e){return this._onStartCallback=e,this},onUpdate:function(e){return this._onUpdateCallback=e,this},onRepeat:function(e){return this._onRepeatCallback=e,this},onComplete:function(e){return this._onCompleteCallback=e,this},onStop:function(e){return this._onStopCallback=e,this},update:function(e){var t,i,n;if(e<this._startTime)return!0;for(t in!1===this._onStartCallbackFired&&(null!==this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),i=(e-this._startTime)/this._duration,i=0===this._duration||i>1?1:i,n=this._easingFunction(i),this._valuesEnd)if(void 0!==this._valuesStart[t]){var r=this._valuesStart[t]||0,s=this._valuesEnd[t];s instanceof Array?this._object[t]=this._interpolationFunction(s,n):("string"==typeof s&&(s="+"===s.charAt(0)||"-"===s.charAt(0)?r+parseFloat(s):parseFloat(s)),"number"==typeof s&&(this._object[t]=r+(s-r)*n))}if(null!==this._onUpdateCallback&&this._onUpdateCallback(this._object,i),1===i){if(this._repeat>0){for(t in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat){if("string"==typeof this._valuesEnd[t]&&(this._valuesStartRepeat[t]=this._valuesStartRepeat[t]+parseFloat(this._valuesEnd[t])),this._yoyo){var o=this._valuesStartRepeat[t];this._valuesStartRepeat[t]=this._valuesEnd[t],this._valuesEnd[t]=o}this._valuesStart[t]=this._valuesStartRepeat[t]}return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=e+this._repeatDelayTime:this._startTime=e+this._delayTime,null!==this._onRepeatCallback&&this._onRepeatCallback(this._object),!0}null!==this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var a=0,l=this._chainedTweens.length;a<l;a++)this._chainedTweens[a].start(this._startTime+this._duration);return!1}return!0}},o.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-o.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*o.Easing.Bounce.In(2*e):.5*o.Easing.Bounce.Out(2*e-1)+.5}}},o.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),s=o.Interpolation.Utils.Linear;return t<0?s(e[0],e[1],n):t>1?s(e[i],e[i-1],i-n):s(e[r],e[r+1>i?i:r+1],n-r)},Bezier:function(e,t){for(var i=0,n=e.length-1,r=Math.pow,s=o.Interpolation.Utils.Bernstein,a=0;a<=n;a++)i+=r(1-t,n-a)*r(t,a)*e[a]*s(n,a);return i},CatmullRom:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),s=o.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(r=Math.floor(n=i*(1+t))),s(e[(r-1+i)%i],e[r],e[(r+1)%i],e[(r+2)%i],n-r)):t<0?e[0]-(s(e[0],e[0],e[1],e[1],-n)-e[0]):t>1?e[i]-(s(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):s(e[r?r-1:0],e[r],e[i<r+1?i:r+1],e[i<r+2?i:r+2],n-r)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=o.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:(s=[1],function(e){var t=1;if(s[e])return s[e];for(var i=e;i>1;i--)t*=i;return s[e]=t,t}),CatmullRom:function(e,t,i,n,r){var s=.5*(i-e),o=.5*(n-t),a=r*r;return(2*t-2*i+s+o)*(r*a)+(-3*t+3*i-2*s-o)*a+s*r+t}}},void 0===(n=function(){return o}.apply(t,[]))||(e.exports=n)}).call(this,i(165))},function(e,t){var i,n,r=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function a(e){if(i===setTimeout)return setTimeout(e,0);if((i===s||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:s}catch(e){i=s}try{n="function"==typeof clearTimeout?clearTimeout:o}catch(e){n=o}}();var l,c=[],h=!1,d=-1;function u(){h&&l&&(h=!1,l.length?c=l.concat(c):d=-1,c.length&&m())}function m(){if(!h){var e=a(u);h=!0;for(var t=c.length;t;){for(l=c,c=[];++d<t;)l&&l[d].run();d=-1,t=c.length}l=null,h=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===o||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function f(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.push(new p(e,t)),1!==c.length||h||a(m)},p.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=f,r.addListener=f,r.once=f,r.off=f,r.removeListener=f,r.removeAllListeners=f,r.emit=f,r.prependListener=f,r.prependOnceListener=f,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(6),s=i(33),o=i(1),a=i(88);t.TileFactory=class{constructor(e){this.m_modelConstructor=e}create(e,t){return new this.m_modelConstructor(e,t)}};class l extends r.DataSource{constructor(e,t){if(super(t.name,t.styleSetName,t.minZoomLevel,t.maxZoomLevel,t.storageLevelOffset),this.m_tileFactory=e,this.m_options=t,this.logger=o.LoggerManager.instance.create("TileDataSource"),this.m_isReady=!1,t.decoder)this.m_decoder=t.decoder;else{if(!t.concurrentDecoderServiceName)throw new Error(`TileDataSource[${this.name}]: unable to create, missing decoder or concurrentDecoderServiceName`);this.m_decoder=r.ConcurrentDecoderFacade.getTileDecoder(t.concurrentDecoderServiceName,t.concurrentDecoderScriptUrl)}this.m_decoder.configure(void 0,void 0,{storageLevelOffset:this.m_options.storageLevelOffset}),this.cacheable=!0,this.m_tileLoaderCache=new s.LRUCache(this.getCacheCount())}dispose(){this.decoder.dispose()}ready(){return this.m_isReady&&this.m_options.dataProvider.ready()}get decoder(){return this.m_decoder}connect(){return n(this,void 0,void 0,(function*(){yield Promise.all([this.m_options.dataProvider.connect(),this.m_decoder.connect()]),this.m_isReady=!0}))}setStyleSet(e,t){this.m_decoder.configure(e,t),this.mapView.markTilesDirty(this)}dataProvider(){return this.m_options.dataProvider}getTilingScheme(){return this.m_options.tilingScheme}getTile(e){const t=this.m_tileFactory.create(this,e),i=e.mortonCode(),n=this.m_tileLoaderCache.get(i);if(void 0!==n)t.tileLoader=n;else{const n=new a.TileLoader(this,e,this.m_options.dataProvider,this.decoder,0);t.tileLoader=n,e.level<=3&&this.m_tileLoaderCache.set(i,n)}return this.updateTile(t),t}updateTile(e){const t=e.tileLoader;void 0!==t&&(void 0!==t.decodedTile?this.setDecodedTileOnTile(t.decodedTile,e):t.loadAndDecode().then(i=>{o.assert(i===r.TileLoaderState.Ready);const n=t.decodedTile;this.setDecodedTileOnTile(n,e)}).catch(e=>{e!==r.TileLoaderState.Canceled&&e!==r.TileLoaderState.Failed&&this.logger.error("Unknown error"+e)}))}getTileInfo(e){return new Promise((t,i)=>{const n=new a.TileInfoLoader(this,e,this.m_options.dataProvider,this.decoder,0);n.loadAndDecode().then(e=>{e===r.TileLoaderState.Ready?t(n.tileInfo):i(new Error("TileDataSource#getInfoTile wrong final state: "+e))})})}decodedTileHasGeometry(e){return e.geometries.length||void 0!==e.poiGeometries&&e.poiGeometries.length||void 0!==e.textGeometries&&e.textGeometries.length||void 0!==e.textPathGeometries&&e.textPathGeometries.length}getCacheCount(){return 2*Math.pow(2,3)}setDecodedTileOnTile(e,t){e&&this.decodedTileHasGeometry(e)?(t.copyrightInfo=void 0!==e.copyrightHolderIds?e.copyrightHolderIds.map(e=>({id:e})):this.m_options.copyrightInfo,t.setDecodedTile(e)):t.forceHasGeometry(!0),this.requestUpdate()}}t.TileDataSource=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(168);t.ThemedTileDecoder=class{constructor(){this.m_storageLevelOffset=0}dispose(){}decodeTile(e,t,i){return void 0===this.m_styleSetEvaluator?Promise.reject(new Error("No style is defined")):this.decodeThemedTile(e,t,this.m_styleSetEvaluator,i)}getTileInfo(e,t,i){return Promise.resolve(void 0)}configure(e,t,i){void 0!==e&&(this.m_styleSetEvaluator=new n.StyleSetEvaluator(e)),void 0!==t&&(this.languages=t),void 0!==i&&void 0!==i.storageLevelOffset&&(this.m_storageLevelOffset=i.storageLevelOffset)}}},function(e,t,i){"use strict";function n(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),n(i(169)),n(i(170)),n(i(171)),n(i(89))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(1),r=i(89),s=i(58),o=i(59);t.logger=n.LoggerManager.instance.create("StyleSetEvaluator");function a(e){!function(e){for(let t=0;t<e.values.length;++t){e.zoomLevels.findIndex(i=>i===e.zoomLevels[t])!==t&&(e.zoomLevels.splice(--t,1),e.values.splice(--t,1))}}(e);const t=new Float32Array(e.zoomLevels);let i;switch(typeof e.values[0]){default:case"number":return i=new Float32Array(e.values),{interpolationMode:void 0!==e.interpolation?o.InterpolationMode[e.interpolation]:o.InterpolationMode.Discrete,zoomLevels:t,values:i};case"boolean":i=new Float32Array(e.values.length);for(let t=0;t<e.values.length;++t)i[t]=e.values[t]?1:0;return{interpolationMode:o.InterpolationMode.Discrete,zoomLevels:t,values:i};case"string":i=new Float32Array(3*e.values.length);for(let t=0;t<e.values.length;++t){const n=+e.values[t].replace("#","0x"),r=[(n>>16&255)/255,(n>>8&255)/255,(n>>0&255)/255];for(let n=0;n<3*e.values.length;++n)i[3*t+n]=r[n]}return{interpolationMode:void 0!==e.interpolation?o.InterpolationMode[e.interpolation]:o.InterpolationMode.Discrete,zoomLevels:t,values:i}}}t.StyleSetEvaluator=class{constructor(e){this.m_renderOrderBiasGroups=new Map,this.m_techniques=[];let i=0;const n=e=>Object.assign({},e,{styles:void 0!==e.styles?e.styles.map(e=>n(e)):void 0});this.styleSet=e.map(e=>n(e));const r=e=>{if(void 0!==e.renderOrderBiasGroup){const n=e.renderOrderBiasGroup?this.m_renderOrderBiasGroups.get(e.renderOrderBiasGroup):void 0;if(void 0!==e.renderOrderBiasRange&&void 0===n){void 0!==e.renderOrder&&t.logger.warn("WARN: style.renderOrder will be overridden if renderOrderBiasGroup is set:",e);const[n,r]=e.renderOrderBiasRange;e.renderOrder=n<0?i+Math.abs(n):i,i+=Math.abs(n)+r,e.renderOrderBiasGroup&&this.m_renderOrderBiasGroups.set(e.renderOrderBiasGroup,e.renderOrder),i++}else n&&(void 0!==e.renderOrder&&t.logger.warn("WARN: style.renderOrder will be overridden if renderOrderBiasGroup is set:",e),e.renderOrder=n)}if(void 0!==e.styles)for(const t of e.styles)r(t);else void 0!==e.technique&&void 0===e.renderOrder&&(e.renderOrder=i++)};for(const e of this.styleSet)r(e)}getMatchingTechniques(e){const t=[],i=new Array;for(const n of this.styleSet){if(0!==i.length)throw new Error("Internal error: style stack cleanup failed");if(this.processStyle(e,i,n,t))break}return t}addTechniqueToIndex(e){const t=this.m_techniques.length;return e._index=t,this.m_techniques.push(e),t}get techniques(){return this.m_techniques}cleanupStyle(e,t){return"styles"===e?"[...]":e.startsWith("_")?void 0:t}processStyle(e,i,n,s){if(void 0!==n.when&&(void 0===n._whenExpr&&(n._whenExpr=r.Expr.parse(n.when)),!n._whenExpr.evaluate(e)))return!1;if(void 0!==n.styles){n.debug&&t.logger.log("\n======== style group =========\nenv:",JSON.stringify(e.unmap(),void 0,2),"\nstyle group:",JSON.stringify(n,this.cleanupStyle,2)),i.push(n);for(const t of n.styles)if(this.processStyle(e,i,t,s))return i.pop(),!0;i.pop()}else if(void 0!==n.technique){if("none"!==n.technique)if(void 0===n._index){const r=this.createTechnique(n,i);s.push(r),n.debug&&t.logger.log("\n======== style w/ technique =========\nenv:",JSON.stringify(e.unmap(),void 0,2),"\nstyle:",JSON.stringify(n,this.cleanupStyle,2),"\ntechnique:",JSON.stringify(r,this.cleanupStyle,2))}else s.push(this.m_techniques[n._index]);return!0===n.final}return!1}createTechnique(e,t){const i={};i.name=e.technique;const n=e=>{void 0!==e.renderOrder&&(i.renderOrder=e.renderOrder),void 0!==e.transient&&(i.transient=e.transient),void 0!==e.renderOrderBiasProperty&&(i.renderOrderBiasProperty=e.renderOrderBiasProperty),void 0!==e.labelProperty&&(i.label=e.labelProperty),void 0!==e.renderOrderBiasRange&&(i.renderOrderBiasRange=e.renderOrderBiasRange),void 0!==e.renderOrderBiasGroup&&(i.renderOrderBiasGroup=e.renderOrderBiasGroup),void 0!==e.secondaryRenderOrder&&(i.secondaryRenderOrder=e.secondaryRenderOrder),void 0!==e.attr&&Object.getOwnPropertyNames(e.attr).forEach(t=>{const n=e.attr[t];if(s.isInterpolatedPropertyDefinition(n))switch(typeof n.values[0]){default:case"number":case"boolean":case"string":i[t]=a(n)}else i[t]=n})};for(const e of t)n(e);return n(e),e._index=this.addTechniqueToIndex(i),i}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addExtrudedWalls=function(e,t,i,n,r,s){const o=n.length/i;for(let i=0;i<o;++i){const n=t+2*i,a=n+1,l=t+(i+1)%o*2,c=l+1;(!1!==s||void 0===r||r[i])&&e.push(n,a,c,c,l,n)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(0),r=new n.Vector2,s=new n.Vector2,o=new n.Vector2,a=new n.Vector2;t.addPolygonEdges=function(e,t,i,n,l,c,h,d){for(let u=0;u<l.length;++u)if(l[u])if(!0===c){const c=t+2*u,m=c+1,p=t+(u+1)%l.length*2,f=p+1;!0===h&&e.push(c,p),e.push(m,f);const g=(0===u?l.length:u)-1;if(l[g])if(void 0!==d){const t=n[u*i],h=n[u*i+1],p=n[(u+1)%l.length*i],f=n[(u+1)%l.length*i+1];r.set(t,h),s.set(p,f),o.set(n[g*i],n[g*i+1]),a.set(r.x,r.y),a.sub(o).normalize().dot(s.sub(r).normalize())<=d&&e.push(c,m)}else e.push(c,m)}else{const i=t+u,n=t+(u+1)%l.length;e.push(i,n)}}},function(e,t,i){"use strict";function n(e,t){var i=e.__state.conversionName.toString(),n=Math.round(e.r),r=Math.round(e.g),s=Math.round(e.b),o=e.a,a=Math.round(e.h),l=e.s.toFixed(1),c=e.v.toFixed(1);if(t||"THREE_CHAR_HEX"===i||"SIX_CHAR_HEX"===i){for(var h=e.hex.toString(16);h.length<6;)h="0"+h;return"#"+h}return"CSS_RGB"===i?"rgb("+n+","+r+","+s+")":"CSS_RGBA"===i?"rgba("+n+","+r+","+s+","+o+")":"HEX"===i?"0x"+e.hex.toString(16):"RGB_ARRAY"===i?"["+n+","+r+","+s+"]":"RGBA_ARRAY"===i?"["+n+","+r+","+s+","+o+"]":"RGB_OBJ"===i?"{r:"+n+",g:"+r+",b:"+s+"}":"RGBA_OBJ"===i?"{r:"+n+",g:"+r+",b:"+s+",a:"+o+"}":"HSV_OBJ"===i?"{h:"+a+",s:"+l+",v:"+c+"}":"HSVA_OBJ"===i?"{h:"+a+",s:"+l+",v:"+c+",a:"+o+"}":"unknown format"}i.r(t);var r=Array.prototype.forEach,s=Array.prototype.slice,o={BREAK:{},extend:function(e){return this.each(s.call(arguments,1),(function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(i){this.isUndefined(t[i])||(e[i]=t[i])}.bind(this))}),this),e},defaults:function(e){return this.each(s.call(arguments,1),(function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(i){this.isUndefined(e[i])&&(e[i]=t[i])}.bind(this))}),this),e},compose:function(){var e=s.call(arguments);return function(){for(var t=s.call(arguments),i=e.length-1;i>=0;i--)t=[e[i].apply(this,t)];return t[0]}},each:function(e,t,i){if(e)if(r&&e.forEach&&e.forEach===r)e.forEach(t,i);else if(e.length===e.length+0){var n,s=void 0;for(s=0,n=e.length;s<n;s++)if(s in e&&t.call(i,e[s],s)===this.BREAK)return}else for(var o in e)if(t.call(i,e[o],o)===this.BREAK)return},defer:function(e){setTimeout(e,0)},debounce:function(e,t,i){var n=void 0;return function(){var r=this,s=arguments;function o(){n=null,i||e.apply(r,s)}var a=i||!n;clearTimeout(n),n=setTimeout(o,t),a&&e.apply(r,s)}},toArray:function(e){return e.toArray?e.toArray():s.call(e)},isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isNaN:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return isNaN(e)})),isArray:Array.isArray||function(e){return e.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return!1===e||!0===e},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)}},a=[{litmus:o.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString()+t[1].toString()+t[2].toString()+t[2].toString()+t[3].toString()+t[3].toString(),0)}},write:n},SIX_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9]{6})$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString(),0)}},write:n},CSS_RGB:{read:function(e){var t=e.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3])}},write:n},CSS_RGBA:{read:function(e){var t=e.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3]),a:parseFloat(t[4])}},write:n}}},{litmus:o.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:o.isArray,conversions:{RGB_ARRAY:{read:function(e){return 3===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return 4===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:o.isObject,conversions:{RGBA_OBJ:{read:function(e){return!!(o.isNumber(e.r)&&o.isNumber(e.g)&&o.isNumber(e.b)&&o.isNumber(e.a))&&{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return!!(o.isNumber(e.r)&&o.isNumber(e.g)&&o.isNumber(e.b))&&{space:"RGB",r:e.r,g:e.g,b:e.b}},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return!!(o.isNumber(e.h)&&o.isNumber(e.s)&&o.isNumber(e.v)&&o.isNumber(e.a))&&{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return!!(o.isNumber(e.h)&&o.isNumber(e.s)&&o.isNumber(e.v))&&{space:"HSV",h:e.h,s:e.s,v:e.v}},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],l=void 0,c=void 0,h=function(){c=!1;var e=arguments.length>1?o.toArray(arguments):arguments[0];return o.each(a,(function(t){if(t.litmus(e))return o.each(t.conversions,(function(t,i){if(l=t.read(e),!1===c&&!1!==l)return c=l,l.conversionName=i,l.conversion=t,o.BREAK})),o.BREAK})),c},d=void 0,u={hsv_to_rgb:function(e,t,i){var n=Math.floor(e/60)%6,r=e/60-Math.floor(e/60),s=i*(1-t),o=i*(1-r*t),a=i*(1-(1-r)*t),l=[[i,a,s],[o,i,s],[s,i,a],[s,o,i],[a,s,i],[i,s,o]][n];return{r:255*l[0],g:255*l[1],b:255*l[2]}},rgb_to_hsv:function(e,t,i){var n=Math.min(e,t,i),r=Math.max(e,t,i),s=r-n,o=void 0;return 0===r?{h:NaN,s:0,v:0}:(o=e===r?(t-i)/s:t===r?2+(i-e)/s:4+(e-t)/s,(o/=6)<0&&(o+=1),{h:360*o,s:s/r,v:r/255})},rgb_to_hex:function(e,t,i){var n=this.hex_with_component(0,2,e);return n=this.hex_with_component(n,1,t),n=this.hex_with_component(n,0,i)},component_from_hex:function(e,t){return e>>8*t&255},hex_with_component:function(e,t,i){return i<<(d=8*t)|e&~(255<<d)}},m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},p=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},f=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),g=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,i,n)}if("value"in r)return r.value;var o=r.get;return void 0!==o?o.call(n):void 0},_=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},v=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},y=function(){function e(){if(p(this,e),this.__state=h.apply(this,arguments),!1===this.__state)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return f(e,[{key:"toString",value:function(){return n(this)}},{key:"toHexString",value:function(){return n(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),e}();function x(e,t,i){Object.defineProperty(e,t,{get:function(){return"RGB"===this.__state.space||y.recalculateRGB(this,t,i),this.__state[t]},set:function(e){"RGB"!==this.__state.space&&(y.recalculateRGB(this,t,i),this.__state.space="RGB"),this.__state[t]=e}})}function w(e,t){Object.defineProperty(e,t,{get:function(){return"HSV"===this.__state.space||y.recalculateHSV(this),this.__state[t]},set:function(e){"HSV"!==this.__state.space&&(y.recalculateHSV(this),this.__state.space="HSV"),this.__state[t]=e}})}y.recalculateRGB=function(e,t,i){if("HEX"===e.__state.space)e.__state[t]=u.component_from_hex(e.__state.hex,i);else{if("HSV"!==e.__state.space)throw new Error("Corrupted color state");o.extend(e.__state,u.hsv_to_rgb(e.__state.h,e.__state.s,e.__state.v))}},y.recalculateHSV=function(e){var t=u.rgb_to_hsv(e.r,e.g,e.b);o.extend(e.__state,{s:t.s,v:t.v}),o.isNaN(t.h)?o.isUndefined(e.__state.h)&&(e.__state.h=0):e.__state.h=t.h},y.COMPONENTS=["r","g","b","h","s","v","hex","a"],x(y.prototype,"r",2),x(y.prototype,"g",1),x(y.prototype,"b",0),w(y.prototype,"h"),w(y.prototype,"s"),w(y.prototype,"v"),Object.defineProperty(y.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}}),Object.defineProperty(y.prototype,"hex",{get:function(){return"HEX"!==!this.__state.space&&(this.__state.hex=u.rgb_to_hex(this.r,this.g,this.b)),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var b=function(){function e(t,i){p(this,e),this.initialValue=t[i],this.domElement=document.createElement("div"),this.object=t,this.property=i,this.__onChange=void 0,this.__onFinishChange=void 0}return f(e,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),e}(),T={};o.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},(function(e,t){o.each(e,(function(e){T[e]=t}))}));var S=/(\d+(\.\d+)?)px/;function C(e){if("0"===e||o.isUndefined(e))return 0;var t=e.match(S);return o.isNull(t)?0:parseFloat(t[1])}var E={makeSelectable:function(e,t){void 0!==e&&void 0!==e.style&&(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(e,t,i){var n=i,r=t;o.isUndefined(r)&&(r=!0),o.isUndefined(n)&&(n=!0),e.style.position="absolute",r&&(e.style.left=0,e.style.right=0),n&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,t,i,n){var r=i||{},s=T[t];if(!s)throw new Error("Event type "+t+" not supported.");var a=document.createEvent(s);switch(s){case"MouseEvents":var l=r.x||r.clientX||0,c=r.y||r.clientY||0;a.initMouseEvent(t,r.bubbles||!1,r.cancelable||!0,window,r.clickCount||1,0,0,l,c,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var h=a.initKeyboardEvent||a.initKeyEvent;o.defaults(r,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),h(t,r.bubbles||!1,r.cancelable,window,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,r.keyCode,r.charCode);break;default:a.initEvent(t,r.bubbles||!1,r.cancelable||!0)}o.defaults(a,n),e.dispatchEvent(a)},bind:function(e,t,i,n){var r=n||!1;return e.addEventListener?e.addEventListener(t,i,r):e.attachEvent&&e.attachEvent("on"+t,i),E},unbind:function(e,t,i,n){var r=n||!1;return e.removeEventListener?e.removeEventListener(t,i,r):e.detachEvent&&e.detachEvent("on"+t,i),E},addClass:function(e,t){if(void 0===e.className)e.className=t;else if(e.className!==t){var i=e.className.split(/ +/);-1===i.indexOf(t)&&(i.push(t),e.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return E},removeClass:function(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{var i=e.className.split(/ +/),n=i.indexOf(t);-1!==n&&(i.splice(n,1),e.className=i.join(" "))}else e.className=void 0;return E},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var t=getComputedStyle(e);return C(t["border-left-width"])+C(t["border-right-width"])+C(t["padding-left"])+C(t["padding-right"])+C(t.width)},getHeight:function(e){var t=getComputedStyle(e);return C(t["border-top-width"])+C(t["border-bottom-width"])+C(t["padding-top"])+C(t["padding-bottom"])+C(t.height)},getOffset:function(e){var t=e,i={left:0,top:0};if(t.offsetParent)do{i.left+=t.offsetLeft,i.top+=t.offsetTop,t=t.offsetParent}while(t);return i},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},M=function(e){function t(e,i){p(this,t);var n=v(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),r=n;return n.__prev=n.getValue(),n.__checkbox=document.createElement("input"),n.__checkbox.setAttribute("type","checkbox"),E.bind(n.__checkbox,"change",(function(){r.setValue(!r.__prev)}),!1),n.domElement.appendChild(n.__checkbox),n.updateDisplay(),n}return _(t,e),f(t,[{key:"setValue",value:function(e){var i=g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),i}},{key:"updateDisplay",value:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(b),A=function(e){function t(e,i,n){p(this,t);var r=v(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),s=n,a=r;if(r.__select=document.createElement("select"),o.isArray(s)){var l={};o.each(s,(function(e){l[e]=e})),s=l}return o.each(s,(function(e,t){var i=document.createElement("option");i.innerHTML=t,i.setAttribute("value",e),a.__select.appendChild(i)})),r.updateDisplay(),E.bind(r.__select,"change",(function(){var e=this.options[this.selectedIndex].value;a.setValue(e)})),r.domElement.appendChild(r.__select),r}return _(t,e),f(t,[{key:"setValue",value:function(e){var i=g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),i}},{key:"updateDisplay",value:function(){return E.isActive(this.__select)?this:(this.__select.value=this.getValue(),g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this))}}]),t}(b),P=function(e){function t(e,i){p(this,t);var n=v(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),r=n;function s(){r.setValue(r.__input.value)}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),E.bind(n.__input,"keyup",s),E.bind(n.__input,"change",s),E.bind(n.__input,"blur",(function(){r.__onFinishChange&&r.__onFinishChange.call(r,r.getValue())})),E.bind(n.__input,"keydown",(function(e){13===e.keyCode&&this.blur()})),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return _(t,e),f(t,[{key:"updateDisplay",value:function(){return E.isActive(this.__input)||(this.__input.value=this.getValue()),g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(b);function L(e){var t=e.toString();return t.indexOf(".")>-1?t.length-t.indexOf(".")-1:0}var R=function(e){function t(e,i,n){p(this,t);var r=v(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),s=n||{};return r.__min=s.min,r.__max=s.max,r.__step=s.step,o.isUndefined(r.__step)?0===r.initialValue?r.__impliedStep=1:r.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(r.initialValue))/Math.LN10))/10:r.__impliedStep=r.__step,r.__precision=L(r.__impliedStep),r}return _(t,e),f(t,[{key:"setValue",value:function(e){var i=e;return void 0!==this.__min&&i<this.__min?i=this.__min:void 0!==this.__max&&i>this.__max&&(i=this.__max),void 0!==this.__step&&i%this.__step!=0&&(i=Math.round(i/this.__step)*this.__step),g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,i)}},{key:"min",value:function(e){return this.__min=e,this}},{key:"max",value:function(e){return this.__max=e,this}},{key:"step",value:function(e){return this.__step=e,this.__impliedStep=e,this.__precision=L(e),this}}]),t}(b);var I=function(e){function t(e,i,n){p(this,t);var r=v(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,n));r.__truncationSuspended=!1;var s=r,a=void 0;function l(){s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}function c(e){var t=a-e.clientY;s.setValue(s.getValue()+t*s.__impliedStep),a=e.clientY}function h(){E.unbind(window,"mousemove",c),E.unbind(window,"mouseup",h),l()}return r.__input=document.createElement("input"),r.__input.setAttribute("type","text"),E.bind(r.__input,"change",(function(){var e=parseFloat(s.__input.value);o.isNaN(e)||s.setValue(e)})),E.bind(r.__input,"blur",(function(){l()})),E.bind(r.__input,"mousedown",(function(e){E.bind(window,"mousemove",c),E.bind(window,"mouseup",h),a=e.clientY})),E.bind(r.__input,"keydown",(function(e){13===e.keyCode&&(s.__truncationSuspended=!0,this.blur(),s.__truncationSuspended=!1,l())})),r.updateDisplay(),r.domElement.appendChild(r.__input),r}return _(t,e),f(t,[{key:"updateDisplay",value:function(){var e,i,n;return this.__input.value=this.__truncationSuspended?this.getValue():(e=this.getValue(),i=this.__precision,n=Math.pow(10,i),Math.round(e*n)/n),g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(R);function O(e,t,i,n,r){return n+(e-t)/(i-t)*(r-n)}var F=function(e){function t(e,i,n,r,s){p(this,t);var o=v(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,{min:n,max:r,step:s})),a=o;function l(e){e.preventDefault();var t=a.__background.getBoundingClientRect();return a.setValue(O(e.clientX,t.left,t.right,a.__min,a.__max)),!1}function c(){E.unbind(window,"mousemove",l),E.unbind(window,"mouseup",c),a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}function h(e){var t=e.touches[0].clientX,i=a.__background.getBoundingClientRect();a.setValue(O(t,i.left,i.right,a.__min,a.__max))}function d(){E.unbind(window,"touchmove",h),E.unbind(window,"touchend",d),a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}return o.__background=document.createElement("div"),o.__foreground=document.createElement("div"),E.bind(o.__background,"mousedown",(function(e){document.activeElement.blur(),E.bind(window,"mousemove",l),E.bind(window,"mouseup",c),l(e)})),E.bind(o.__background,"touchstart",(function(e){if(1!==e.touches.length)return;E.bind(window,"touchmove",h),E.bind(window,"touchend",d),h(e)})),E.addClass(o.__background,"slider"),E.addClass(o.__foreground,"slider-fg"),o.updateDisplay(),o.__background.appendChild(o.__foreground),o.domElement.appendChild(o.__background),o}return _(t,e),f(t,[{key:"updateDisplay",value:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(R),D=function(e){function t(e,i,n){p(this,t);var r=v(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),s=r;return r.__button=document.createElement("div"),r.__button.innerHTML=void 0===n?"Fire":n,E.bind(r.__button,"click",(function(e){return e.preventDefault(),s.fire(),!1})),E.addClass(r.__button,"button"),r.domElement.appendChild(r.__button),r}return _(t,e),f(t,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),t}(b),V=function(e){function t(e,i){p(this,t);var n=v(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));n.__color=new y(n.getValue()),n.__temp=new y(0);var r=n;n.domElement=document.createElement("div"),E.makeSelectable(n.domElement,!1),n.__selector=document.createElement("div"),n.__selector.className="selector",n.__saturation_field=document.createElement("div"),n.__saturation_field.className="saturation-field",n.__field_knob=document.createElement("div"),n.__field_knob.className="field-knob",n.__field_knob_border="2px solid ",n.__hue_knob=document.createElement("div"),n.__hue_knob.className="hue-knob",n.__hue_field=document.createElement("div"),n.__hue_field.className="hue-field",n.__input=document.createElement("input"),n.__input.type="text",n.__input_textShadow="0 1px 1px ",E.bind(n.__input,"keydown",(function(e){13===e.keyCode&&m.call(this)})),E.bind(n.__input,"blur",m),E.bind(n.__selector,"mousedown",(function(){E.addClass(this,"drag").bind(window,"mouseup",(function(){E.removeClass(r.__selector,"drag")}))})),E.bind(n.__selector,"touchstart",(function(){E.addClass(this,"drag").bind(window,"touchend",(function(){E.removeClass(r.__selector,"drag")}))}));var s,a=document.createElement("div");function l(e){g(e),E.bind(window,"mousemove",g),E.bind(window,"touchmove",g),E.bind(window,"mouseup",d),E.bind(window,"touchend",d)}function c(e){_(e),E.bind(window,"mousemove",_),E.bind(window,"touchmove",_),E.bind(window,"mouseup",u),E.bind(window,"touchend",u)}function d(){E.unbind(window,"mousemove",g),E.unbind(window,"touchmove",g),E.unbind(window,"mouseup",d),E.unbind(window,"touchend",d),f()}function u(){E.unbind(window,"mousemove",_),E.unbind(window,"touchmove",_),E.unbind(window,"mouseup",u),E.unbind(window,"touchend",u),f()}function m(){var e=h(this.value);!1!==e?(r.__color.__state=e,r.setValue(r.__color.toOriginal())):this.value=r.__color.toString()}function f(){r.__onFinishChange&&r.__onFinishChange.call(r,r.__color.toOriginal())}function g(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=r.__saturation_field.getBoundingClientRect(),i=e.touches&&e.touches[0]||e,n=i.clientX,s=i.clientY,o=(n-t.left)/(t.right-t.left),a=1-(s-t.top)/(t.bottom-t.top);return a>1?a=1:a<0&&(a=0),o>1?o=1:o<0&&(o=0),r.__color.v=a,r.__color.s=o,r.setValue(r.__color.toOriginal()),!1}function _(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=r.__hue_field.getBoundingClientRect(),i=1-((e.touches&&e.touches[0]||e).clientY-t.top)/(t.bottom-t.top);return i>1?i=1:i<0&&(i=0),r.__color.h=360*i,r.setValue(r.__color.toOriginal()),!1}return o.extend(n.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),o.extend(n.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:n.__field_knob_border+(n.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),o.extend(n.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),o.extend(n.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),o.extend(a.style,{width:"100%",height:"100%",background:"none"}),k(a,"top","rgba(0,0,0,0)","#000"),o.extend(n.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),(s=n.__hue_field).style.background="",s.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",s.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",s.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",s.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",s.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",o.extend(n.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:n.__input_textShadow+"rgba(0,0,0,0.7)"}),E.bind(n.__saturation_field,"mousedown",l),E.bind(n.__saturation_field,"touchstart",l),E.bind(n.__field_knob,"mousedown",l),E.bind(n.__field_knob,"touchstart",l),E.bind(n.__hue_field,"mousedown",c),E.bind(n.__hue_field,"touchstart",c),n.__saturation_field.appendChild(a),n.__selector.appendChild(n.__field_knob),n.__selector.appendChild(n.__saturation_field),n.__selector.appendChild(n.__hue_field),n.__hue_field.appendChild(n.__hue_knob),n.domElement.appendChild(n.__input),n.domElement.appendChild(n.__selector),n.updateDisplay(),n}return _(t,e),f(t,[{key:"updateDisplay",value:function(){var e=h(this.getValue());if(!1!==e){var t=!1;o.each(y.COMPONENTS,(function(i){if(!o.isUndefined(e[i])&&!o.isUndefined(this.__color.__state[i])&&e[i]!==this.__color.__state[i])return t=!0,{}}),this),t&&o.extend(this.__color.__state,e)}o.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var i=this.__color.v<.5||this.__color.s>.5?255:0,n=255-i;o.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+i+","+i+","+i+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,k(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),o.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+i+","+i+","+i+")",textShadow:this.__input_textShadow+"rgba("+n+","+n+","+n+",.7)"})}}]),t}(b),U=["-moz-","-o-","-webkit-","-ms-",""];function k(e,t,i,n){e.style.background="",o.each(U,(function(r){e.style.cssText+="background: "+r+"linear-gradient("+t+", "+i+" 0%, "+n+" 100%); "}))}var z=function(e,t){var i=t||document,n=document.createElement("style");n.type="text/css",n.innerHTML=e;var r=i.getElementsByTagName("head")[0];try{r.appendChild(n)}catch(e){}},B='<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n\n    </div>\n\n  </div>\n\n</div>',N=function(e,t){var i=e[t];return o.isArray(arguments[2])||o.isObject(arguments[2])?new A(e,t,arguments[2]):o.isNumber(i)?o.isNumber(arguments[2])&&o.isNumber(arguments[3])?o.isNumber(arguments[4])?new F(e,t,arguments[2],arguments[3],arguments[4]):new F(e,t,arguments[2],arguments[3]):o.isNumber(arguments[4])?new I(e,t,{min:arguments[2],max:arguments[3],step:arguments[4]}):new I(e,t,{min:arguments[2],max:arguments[3]}):o.isString(i)?new P(e,t):o.isFunction(i)?new D(e,t,""):o.isBoolean(i)?new M(e,t):null};var j=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},G=function(){function e(){p(this,e),this.backgroundElement=document.createElement("div"),o.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),E.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),o.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var t=this;E.bind(this.backgroundElement,"click",(function(){t.hide()}))}return f(e,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),o.defer((function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"}))}},{key:"hide",value:function(){var e=this,t=function t(){e.domElement.style.display="none",e.backgroundElement.style.display="none",E.unbind(e.domElement,"webkitTransitionEnd",t),E.unbind(e.domElement,"transitionend",t),E.unbind(e.domElement,"oTransitionEnd",t)};E.bind(this.domElement,"webkitTransitionEnd",t),E.bind(this.domElement,"transitionend",t),E.bind(this.domElement,"oTransitionEnd",t),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-E.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-E.getHeight(this.domElement)/2+"px"}}]),e}();z(function(e){if(e&&"undefined"!=typeof window){var t=document.createElement("style");return t.setAttribute("type","text/css"),t.innerHTML=e,document.head.appendChild(t),e}}(".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n"));var W=function(){try{return!!window.localStorage}catch(e){return!1}}(),q=void 0,H=!0,X=void 0,Z=!1,Y=[],K=function e(t){var i=this,n=t||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),E.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],n=o.defaults(n,{closeOnTop:!1,autoPlace:!0,width:e.DEFAULT_WIDTH}),n=o.defaults(n,{resizable:n.autoPlace,hideable:n.autoPlace}),o.isUndefined(n.load)?n.load={preset:"Default"}:n.preset&&(n.load.preset=n.preset),o.isUndefined(n.parent)&&n.hideable&&Y.push(this),n.resizable=o.isUndefined(n.parent)&&n.resizable,n.autoPlace&&o.isUndefined(n.scrollable)&&(n.scrollable=!0);var r,s=W&&"true"===localStorage.getItem(ie(this,"isLocal")),a=void 0,l=void 0;if(Object.defineProperties(this,{parent:{get:function(){return n.parent}},scrollable:{get:function(){return n.scrollable}},autoPlace:{get:function(){return n.autoPlace}},closeOnTop:{get:function(){return n.closeOnTop}},preset:{get:function(){return i.parent?i.getRoot().preset:n.load.preset},set:function(e){i.parent?i.getRoot().preset=e:n.load.preset=e,function(e){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].value===e.preset&&(e.__preset_select.selectedIndex=t)}(this),i.revert()}},width:{get:function(){return n.width},set:function(e){n.width=e,ae(i,e)}},name:{get:function(){return n.name},set:function(e){n.name=e,l&&(l.innerHTML=n.name)}},closed:{get:function(){return n.closed},set:function(t){n.closed=t,n.closed?E.addClass(i.__ul,e.CLASS_CLOSED):E.removeClass(i.__ul,e.CLASS_CLOSED),this.onResize(),i.__closeButton&&(i.__closeButton.innerHTML=t?e.TEXT_OPEN:e.TEXT_CLOSED)}},load:{get:function(){return n.load}},useLocalStorage:{get:function(){return s},set:function(e){W&&(s=e,e?E.bind(window,"unload",a):E.unbind(window,"unload",a),localStorage.setItem(ie(i,"isLocal"),e))}}}),o.isUndefined(n.parent)){if(this.closed=n.closed||!1,E.addClass(this.domElement,e.CLASS_MAIN),E.makeSelectable(this.domElement,!1),W&&s){i.useLocalStorage=!0;var c=localStorage.getItem(ie(this,"gui"));c&&(n.load=JSON.parse(c))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=e.TEXT_CLOSED,E.addClass(this.__closeButton,e.CLASS_CLOSE_BUTTON),n.closeOnTop?(E.addClass(this.__closeButton,e.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(E.addClass(this.__closeButton,e.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),E.bind(this.__closeButton,"click",(function(){i.closed=!i.closed}))}else{void 0===n.closed&&(n.closed=!0);var h=document.createTextNode(n.name);E.addClass(h,"controller-name"),l=Q(i,h);E.addClass(this.__ul,e.CLASS_CLOSED),E.addClass(l,"title"),E.bind(l,"click",(function(e){return e.preventDefault(),i.closed=!i.closed,!1})),n.closed||(this.closed=!1)}n.autoPlace&&(o.isUndefined(n.parent)&&(H&&(X=document.createElement("div"),E.addClass(X,"dg"),E.addClass(X,e.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(X),H=!1),X.appendChild(this.domElement),E.addClass(this.domElement,e.CLASS_AUTO_PLACE)),this.parent||ae(i,n.width)),this.__resizeHandler=function(){i.onResizeDebounced()},E.bind(window,"resize",this.__resizeHandler),E.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),E.bind(this.__ul,"transitionend",this.__resizeHandler),E.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),n.resizable&&oe(this),a=function(){W&&"true"===localStorage.getItem(ie(i,"isLocal"))&&localStorage.setItem(ie(i,"gui"),JSON.stringify(i.getSaveObject()))},this.saveToLocalStorageIfPossible=a,n.parent||((r=i.getRoot()).width+=1,o.defer((function(){r.width-=1})))};function Q(e,t,i){var n=document.createElement("li");return t&&n.appendChild(t),i?e.__ul.insertBefore(n,i):e.__ul.appendChild(n),e.onResize(),n}function $(e){E.unbind(window,"resize",e.__resizeHandler),e.saveToLocalStorageIfPossible&&E.unbind(window,"unload",e.saveToLocalStorageIfPossible)}function J(e,t){var i=e.__preset_select[e.__preset_select.selectedIndex];i.innerHTML=t?i.value+"*":i.value}function ee(e,t){var i=e.getRoot(),n=i.__rememberedObjects.indexOf(t.object);if(-1!==n){var r=i.__rememberedObjectIndecesToControllers[n];if(void 0===r&&(r={},i.__rememberedObjectIndecesToControllers[n]=r),r[t.property]=t,i.load&&i.load.remembered){var s=i.load.remembered,o=void 0;if(s[e.preset])o=s[e.preset];else{if(!s.Default)return;o=s.Default}if(o[n]&&void 0!==o[n][t.property]){var a=o[n][t.property];t.initialValue=a,t.setValue(a)}}}}function te(e,t,i,n){if(void 0===t[i])throw new Error('Object "'+t+'" has no property "'+i+'"');var r=void 0;if(n.color)r=new V(t,i);else{var s=[t,i].concat(n.factoryArgs);r=N.apply(e,s)}n.before instanceof b&&(n.before=n.before.__li),ee(e,r),E.addClass(r.domElement,"c");var a=document.createElement("span");E.addClass(a,"property-name"),a.innerHTML=r.property;var l=document.createElement("div");l.appendChild(a),l.appendChild(r.domElement);var c=Q(e,l,n.before);return E.addClass(c,K.CLASS_CONTROLLER_ROW),r instanceof V?E.addClass(c,"color"):E.addClass(c,m(r.getValue())),function(e,t,i){if(i.__li=t,i.__gui=e,o.extend(i,{options:function(t){if(arguments.length>1){var n=i.__li.nextElementSibling;return i.remove(),te(e,i.object,i.property,{before:n,factoryArgs:[o.toArray(arguments)]})}if(o.isArray(t)||o.isObject(t)){var r=i.__li.nextElementSibling;return i.remove(),te(e,i.object,i.property,{before:r,factoryArgs:[t]})}},name:function(e){return i.__li.firstElementChild.firstElementChild.innerHTML=e,i},listen:function(){return i.__gui.listen(i),i},remove:function(){return i.__gui.remove(i),i}}),i instanceof F){var n=new I(i.object,i.property,{min:i.__min,max:i.__max,step:i.__step});o.each(["updateDisplay","onChange","onFinishChange","step","min","max"],(function(e){var t=i[e],r=n[e];i[e]=n[e]=function(){var e=Array.prototype.slice.call(arguments);return r.apply(n,e),t.apply(i,e)}})),E.addClass(t,"has-slider"),i.domElement.insertBefore(n.domElement,i.domElement.firstElementChild)}else if(i instanceof I){var r=function(t){if(o.isNumber(i.__min)&&o.isNumber(i.__max)){var n=i.__li.firstElementChild.firstElementChild.innerHTML,r=i.__gui.__listening.indexOf(i)>-1;i.remove();var s=te(e,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[i.__min,i.__max,i.__step]});return s.name(n),r&&s.listen(),s}return t};i.min=o.compose(r,i.min),i.max=o.compose(r,i.max)}else i instanceof M?(E.bind(t,"click",(function(){E.fakeEvent(i.__checkbox,"click")})),E.bind(i.__checkbox,"click",(function(e){e.stopPropagation()}))):i instanceof D?(E.bind(t,"click",(function(){E.fakeEvent(i.__button,"click")})),E.bind(t,"mouseover",(function(){E.addClass(i.__button,"hover")})),E.bind(t,"mouseout",(function(){E.removeClass(i.__button,"hover")}))):i instanceof V&&(E.addClass(t,"color"),i.updateDisplay=o.compose((function(e){return t.style.borderLeftColor=i.__color.toString(),e}),i.updateDisplay),i.updateDisplay());i.setValue=o.compose((function(t){return e.getRoot().__preset_select&&i.isModified()&&J(e.getRoot(),!0),t}),i.setValue)}(e,c,r),e.__controllers.push(r),r}function ie(e,t){return document.location.href+"."+t}function ne(e,t,i){var n=document.createElement("option");n.innerHTML=t,n.value=t,e.__preset_select.appendChild(n),i&&(e.__preset_select.selectedIndex=e.__preset_select.length-1)}function re(e,t){t.style.display=e.useLocalStorage?"block":"none"}function se(e){var t=e.__save_row=document.createElement("li");E.addClass(e.domElement,"has-save"),e.__ul.insertBefore(t,e.__ul.firstChild),E.addClass(t,"save-row");var i=document.createElement("span");i.innerHTML="&nbsp;",E.addClass(i,"button gears");var n=document.createElement("span");n.innerHTML="Save",E.addClass(n,"button"),E.addClass(n,"save");var r=document.createElement("span");r.innerHTML="New",E.addClass(r,"button"),E.addClass(r,"save-as");var s=document.createElement("span");s.innerHTML="Revert",E.addClass(s,"button"),E.addClass(s,"revert");var a=e.__preset_select=document.createElement("select");if(e.load&&e.load.remembered?o.each(e.load.remembered,(function(t,i){ne(e,i,i===e.preset)})):ne(e,"Default",!1),E.bind(a,"change",(function(){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].innerHTML=e.__preset_select[t].value;e.preset=this.value})),t.appendChild(a),t.appendChild(i),t.appendChild(n),t.appendChild(r),t.appendChild(s),W){var l=document.getElementById("dg-local-explain"),c=document.getElementById("dg-local-storage");document.getElementById("dg-save-locally").style.display="block","true"===localStorage.getItem(ie(0,"isLocal"))&&c.setAttribute("checked","checked"),re(e,l),E.bind(c,"change",(function(){e.useLocalStorage=!e.useLocalStorage,re(e,l)}))}var h=document.getElementById("dg-new-constructor");E.bind(h,"keydown",(function(e){!e.metaKey||67!==e.which&&67!==e.keyCode||q.hide()})),E.bind(i,"click",(function(){h.innerHTML=JSON.stringify(e.getSaveObject(),void 0,2),q.show(),h.focus(),h.select()})),E.bind(n,"click",(function(){e.save()})),E.bind(r,"click",(function(){var t=prompt("Enter a new preset name.");t&&e.saveAs(t)})),E.bind(s,"click",(function(){e.revert()}))}function oe(e){var t=void 0;function i(i){return i.preventDefault(),e.width+=t-i.clientX,e.onResize(),t=i.clientX,!1}function n(){E.removeClass(e.__closeButton,K.CLASS_DRAG),E.unbind(window,"mousemove",i),E.unbind(window,"mouseup",n)}function r(r){return r.preventDefault(),t=r.clientX,E.addClass(e.__closeButton,K.CLASS_DRAG),E.bind(window,"mousemove",i),E.bind(window,"mouseup",n),!1}e.__resize_handle=document.createElement("div"),o.extend(e.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"}),E.bind(e.__resize_handle,"mousedown",r),E.bind(e.__closeButton,"mousedown",r),e.domElement.insertBefore(e.__resize_handle,e.domElement.firstElementChild)}function ae(e,t){e.domElement.style.width=t+"px",e.__save_row&&e.autoPlace&&(e.__save_row.style.width=t+"px"),e.__closeButton&&(e.__closeButton.style.width=t+"px")}function le(e,t){var i={};return o.each(e.__rememberedObjects,(function(n,r){var s={},a=e.__rememberedObjectIndecesToControllers[r];o.each(a,(function(e,i){s[i]=t?e.initialValue:e.getValue()})),i[r]=s})),i}K.toggleHide=function(){Z=!Z,o.each(Y,(function(e){e.domElement.style.display=Z?"none":""}))},K.CLASS_AUTO_PLACE="a",K.CLASS_AUTO_PLACE_CONTAINER="ac",K.CLASS_MAIN="main",K.CLASS_CONTROLLER_ROW="cr",K.CLASS_TOO_TALL="taller-than-window",K.CLASS_CLOSED="closed",K.CLASS_CLOSE_BUTTON="close-button",K.CLASS_CLOSE_TOP="close-top",K.CLASS_CLOSE_BOTTOM="close-bottom",K.CLASS_DRAG="drag",K.DEFAULT_WIDTH=245,K.TEXT_CLOSED="Close Controls",K.TEXT_OPEN="Open Controls",K._keydownHandler=function(e){"text"===document.activeElement.type||72!==e.which&&72!==e.keyCode||K.toggleHide()},E.bind(window,"keydown",K._keydownHandler,!1),o.extend(K.prototype,{add:function(e,t){return te(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return te(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;o.defer((function(){t.onResize()}))},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&X.removeChild(this.domElement);var e=this;o.each(this.__folders,(function(t){e.removeFolder(t)})),E.unbind(window,"keydown",K._keydownHandler,!1),$(this)},addFolder:function(e){if(void 0!==this.__folders[e])throw new Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]);var i=new K(t);this.__folders[e]=i;var n=Q(this,i.domElement);return E.addClass(n,"folder"),i},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],$(e);var t=this;o.each(e.__folders,(function(t){e.removeFolder(t)})),o.defer((function(){t.onResize()}))},open:function(){this.closed=!1},close:function(){this.closed=!0},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=E.getOffset(e.__ul).top,i=0;o.each(e.__ul.childNodes,(function(t){e.autoPlace&&t===e.__save_row||(i+=E.getHeight(t))})),window.innerHeight-t-20<i?(E.addClass(e.domElement,K.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-20+"px"):(E.removeClass(e.domElement,K.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&o.defer((function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"})),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:o.debounce((function(){this.onResize()}),50),remember:function(){if(o.isUndefined(q)&&((q=new G).domElement.innerHTML=B),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;o.each(Array.prototype.slice.call(arguments),(function(t){0===e.__rememberedObjects.length&&se(e),-1===e.__rememberedObjects.indexOf(t)&&e.__rememberedObjects.push(t)})),this.autoPlace&&ae(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=le(this)),e.folders={},o.each(this.__folders,(function(t,i){e.folders[i]=t.getSaveObject()})),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=le(this),J(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered.Default=le(this,!0)),this.load.remembered[e]=le(this),this.preset=e,ne(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){o.each(this.__controllers,(function(t){this.getRoot().load.remembered?ee(e||this.getRoot(),t):t.setValue(t.initialValue),t.__onFinishChange&&t.__onFinishChange.call(t,t.getValue())}),this),o.each(this.__folders,(function(e){e.revert(e)})),e||J(this.getRoot(),!1)},listen:function(e){var t=0===this.__listening.length;this.__listening.push(e),t&&function e(t){0!==t.length&&j.call(window,(function(){e(t)}));o.each(t,(function(e){e.updateDisplay()}))}(this.__listening)},updateDisplay:function(){o.each(this.__controllers,(function(e){e.updateDisplay()})),o.each(this.__folders,(function(e){e.updateDisplay()}))}});var ce=K,he=i(0),de=i(6),ue=i(2),me=i(90),pe=i(25);var fe=()=>"\nvarying float vAltitude;\nvarying vec3 vNormal;\nvarying vec2 vUv;\n\nattribute vec2 octNormal;\n\nuniform bool useOctNormal;\n\n#include <fog_pars_vertex>\n\nvec2 signNotZero(vec2 v) {\n  return vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\n\nvec3 oct_to_float32x3(vec2 e) {\n  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\n  if (v.z < 0.0) {\n    v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\n  }\n  return normalize(v);\n}\n\nvec2 snorm_to_float32x2(vec2 s) {\n  vec2 v = ((s / 255.0) * 2.0) - 1.0;\n  return v;\n}\n\nvoid main() {\n  vAltitude = position[2]; // z value\n\n  if (useOctNormal) {\n    vec2 floatOctNormal = snorm_to_float32x2(octNormal);\n    vec3 decNormal = oct_to_float32x3(floatOctNormal);\n    vNormal = decNormal;\n  } else {\n    vNormal = normal;\n  }\n\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  \n  #include <begin_vertex>\n  #include <project_vertex>\n  #include <fog_vertex>\n}\n";var ge=e=>`\n#define COLOR_STEPS_COUNT ${e.COLOR_STEPS_COUNT}\n\nvarying float vAltitude;\nvarying vec2 vUv;\nvarying vec3 vNormal;\n\nuniform vec3 colorSteps[COLOR_STEPS_COUNT];\nuniform float altitudeSteps[COLOR_STEPS_COUNT];\n\nuniform sampler2D texture;\nuniform int hasTexture;\nuniform float textureIntensity;\nuniform vec3 lightVector;\nuniform float opacity;\n\n#include <fog_pars_fragment>\n\nvoid main() {\n  vec3 altitudeColor;\n  float lowestAltitude = altitudeSteps[0];\n  float highestAlttitude = altitudeSteps[COLOR_STEPS_COUNT - 1];\n  vec3 lowestAltitudeColor = colorSteps[0];\n  vec3 highestAltitudeColor = colorSteps[COLOR_STEPS_COUNT - 1];\n\n  if (vAltitude < lowestAltitude) {\n    altitudeColor = lowestAltitudeColor;\n  }\n\n  if (vAltitude > highestAlttitude) {\n    altitudeColor = highestAltitudeColor;\n  }\n\n  for(int i = 0; i < COLOR_STEPS_COUNT - 1; i++) {\n    if (vAltitude > altitudeSteps[i] && vAltitude <= altitudeSteps[i + 1]) {\n      altitudeColor = mix(\n        colorSteps[i],\n        colorSteps[i + 1],\n        (vAltitude - altitudeSteps[i]) / (altitudeSteps[i + 1] - altitudeSteps[i])\n      );\n    }\n  }\n\n  if (hasTexture == 1) {\n    vec4 texColor = texture2D(texture, vUv);\n\n    gl_FragColor = vec4(mix(altitudeColor.xyz, texColor.xyz, textureIntensity), 1.0);\n  } else {\n    vec3 color = altitudeColor * clamp(dot(vNormal, normalize(lightVector)), 0.3, 1.0); \n  \n    gl_FragColor = vec4(color, opacity);\n  }\n  \n  #include <fog_fragment>\n}\n`;const _e={colorSteps:[{color:new he.Vector3(0,0,0),altitude:-300},{color:new he.Vector3(1,1,1),altitude:8848}],texture:null,textureIntensity:.4,lightVector:new he.Vector3(1,0,.5),opacity:1};class ve extends he.ShaderMaterial{constructor(e,t){const i=Object.assign({},_e,t),n=i.colorSteps.slice().sort((e,t)=>e.altitude>=t.altitude),r=n.map(e=>e.color),s=n.map(e=>e.altitude),o=he.UniformsUtils.merge([{useOctNormal:{value:ve.containsOctNormals(e)},colorSteps:{value:r},altitudeSteps:{value:s},textureIntensity:{value:i.textureIntensity},hasTexture:{value:null===i.texture?0:1},texture:{value:i.texture},lightVector:{value:i.lightVector},opacity:{value:i.opacity}},he.UniformsLib.fog]);super({vertexShader:fe(),fragmentShader:ge({COLOR_STEPS_COUNT:n.length}),uniforms:o})}static containsOctNormals(e){return void 0!==e.geometries[0].vertexAttributes.find(this.isOctNormalAttribute)}static isOctNormalAttribute(e){return"octNormal"===e.name}}class ye extends pe.TileFactory{constructor(e){super(xe),this.options=e}create(e,t){return new xe(e,t,this.options)}}class xe extends de.Tile{constructor(e,t,i){super(e,t),this.getTileMaterial=i.getTileMaterial,this.getCustomObjects=i.getCustomObjects,this.decodedTileGeometry=null,this.scaledPositionArray=null,this.tileSize=this.getTileSize(this.tileKey,this.projection,this.dataSource.getTilingScheme())}generateTileMaterial(e){return this.getTileMaterial?this.getTileMaterial(this,e):Promise.resolve(new ve(e))}getTileSize(e,t,i){const n=new he.Box3,r=new he.Vector3,s=i.getGeoBox(e);return t.projectBox(s,n),n.getSize(r),r}scaleVertices(e,t,i){const n=i.x,r=i.y,s=t.maxHeight-t.minHeight,o=new Float32Array(e.length);for(let a=0;a<e.length;a+=3)o[a]=e[a]*n-i.x/2,o[a+1]=e[a+1]*r-i.y/2,o[a+2]=e[a+2]*s+t.minHeight;return o}findVertexAttribute(e,t){return e.find(e=>e.name===t)}createObjects(e,t){this.decodedTileGeometry=e.geometries[0];const i=this.findVertexAttribute(this.decodedTileGeometry.vertexAttributes,"position"),n=i.buffer,r=i.metadata;this.scaledPositionArray=this.scaleVertices(n,r,this.tileSize),this.generateTileMaterial(e).then(i=>this.createTileObjects(i,e.geometries[0],t)),this.getCustomObjects&&Promise.resolve(this.getCustomObjects(this)).then(()=>this.dataSource.requestUpdate())}createTileObjects(e,t,i){const n=new he.BufferGeometry,r=new he.Mesh(n,e);t.vertexAttributes.forEach(e=>{const t="position"===e.name?this.scaledPositionArray:e.buffer;n.addAttribute(e.name,new he.BufferAttribute(t,e.itemCount))}),void 0!==t.index&&n.setIndex(new he.BufferAttribute(t.index.buffer,1)),n.attributes.normal||n.attributes.octNormal||n.computeVertexNormals(),this.registerTileObject(r),i.push(r),this.dataSource.requestUpdate()}calculateLocalDisplacement(e){const t=this.projection.projectPoint(e,new he.Vector3).sub(this.center),i=this.decodedTileGeometry.index.buffer,n=this.scaledPositionArray,r=new he.Vector3(0,0,0);for(let e=0;e<i.length;e+=3){const s=3*i[e],o=3*i[e+1],a=3*i[e+2],l=new he.Vector3(n[s],n[s+1],n[s+2]),c=new he.Vector3(n[o],n[o+1],n[o+2]),h=new he.Vector3(n[a],n[a+1],n[a+2]),d=new he.Triangle(l,c,h),u=new he.Triangle(l.clone().setZ(0),c.clone().setZ(0),h.clone().setZ(0));if(u.containsPoint(t)){const e=u.getBarycoord(t,new he.Vector3),i=e.x*d.a.z+e.y*d.b.z+e.z*d.c.z;r.set(t.x,t.y,i);break}}return r}addObject(e,t){this.geoBox.contains(e)&&(t.displacement=this.calculateLocalDisplacement(e),this.registerTileObject(t),this.objects.push(t))}}class we{constructor(e){if(void 0===e)throw new Error('"fetchTile()" method was not provided');this.fetchTile=e}connect(){return Promise.resolve()}ready(){return!0}getTile(e){return this.fetchTile(e)}}class be extends pe.TileDataSource{constructor(e){if(void 0===e.tilingScheme)throw new Error('No "tilingScheme" option provided.');if(void 0===e.concurrentDecoderServiceName)throw new Error('No "concurrentDecoderServiceName" option provided. It should be an ID of one of the supported decoders.');if(void 0===e.concurrentDecoderScriptUrl)throw new Error('No "concurrentDecoderScriptUrl" option provided. It should be URL of a decoder worker used to decode tiles.');super(new ye(e),{id:"terrain",tilingScheme:e.tilingScheme,dataProvider:new we(e.fetchTile),useWorker:!0,concurrentDecoderServiceName:e.concurrentDecoderServiceName,concurrentDecoderScriptUrl:e.concurrentDecoderScriptUrl}),this.options=e,void 0!==e.decoderOptions&&this.decoder.connect().then(()=>{this.decoder.configure(e.decoderOptions)})}connect(){return this.decoder.connect()}ready(){return!0}shouldPreloadTiles(){return!0}getDisplayZoomLevel(e){return void 0!==this.options.getDisplayZoomLevel?this.options.getDisplayZoomLevel(e):e}}new Map([["centerX",Float64Array.BYTES_PER_ELEMENT],["centerY",Float64Array.BYTES_PER_ELEMENT],["centerZ",Float64Array.BYTES_PER_ELEMENT],["minHeight",Float32Array.BYTES_PER_ELEMENT],["maxHeight",Float32Array.BYTES_PER_ELEMENT],["boundingSphereCenterX",Float64Array.BYTES_PER_ELEMENT],["boundingSphereCenterY",Float64Array.BYTES_PER_ELEMENT],["boundingSphereCenterZ",Float64Array.BYTES_PER_ELEMENT],["boundingSphereRadius",Float64Array.BYTES_PER_ELEMENT],["horizonOcclusionPointX",Float64Array.BYTES_PER_ELEMENT],["horizonOcclusionPointY",Float64Array.BYTES_PER_ELEMENT],["horizonOcclusionPointZ",Float64Array.BYTES_PER_ELEMENT]]);var Te="cJ7gyg679deVM55KumC5",Se="tJ69vQOiDh26e1R_esdVaA",Ce="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjNTJiNGQ3Ny05N2EzLTRiOTQtYWFiYS05NmE3MzAxN2FmODciLCJpZCI6MjgxOCwic2NvcGVzIjpbImFzciJdLCJhc3NldHMiOlsxXSwiaWF0IjoxNTQ3MjA2NjM5fQ.cFwN3KPr0VmuVEvak282nc9L-eG8SylHJCkqUFNOpN4";const Ee=["Grand Teton National Park (Quantized Mesh)","Cesium World Terrain (Quantized Mesh)"],Me=["Elevation Styling","Texture","Wireframe"];const Ae=new he.TextureLoader;function Pe(e){const t=function(e){const t=ue.mercatorTilingScheme.getTileKey(e.geoBox.center,e.tileKey.level);return`https://${Math.round(3*Math.random())+1}.aerial.maps.api.here.com/maptile/2.1/basetile/newest/satellite.day/${t.level}/${t.column}/${t.rowCount()-t.row-1}/512/png?app_id=${Te}&app_code=${Se}`}(e);return new Promise((e,i)=>{Ae.load(t,e,void 0,i)})}Ae.crossOrigin="";const Le=[{color:new he.Vector3(.670588235,.850980392,.91372549),altitude:700},{color:new he.Vector3(.109803922,.564705882,.6),altitude:1500},{color:new he.Vector3(.403921569,.662745098,.811764706),altitude:2e3},{color:new he.Vector3(.741176471,.788235294,.882352941),altitude:2800},{color:new he.Vector3(1,1,1),altitude:3e3}],Re=new he.Vector3(.7,0,.5),Ie=new he.Vector3(0,-1,0);function Oe(e,t,i){switch(i.style){case Me[0]:return Promise.resolve(new ve(t,{colorSteps:Le,lightVector:i.dataset===Ee[1]?Ie:Re}));case Me[1]:return Pe(e).then(e=>(e.minFilter=he.LinearFilter,e.magFilter=he.LinearFilter,e.generateMipmaps=!1,e.wrapS=e.wrapT=he.ClampToEdgeWrapping,new he.MeshBasicMaterial({map:e})));case Me[2]:return Promise.resolve(new he.MeshBasicMaterial({color:0,wireframe:!0}))}}const Fe={currentDataset:Ee[0],isAttributionPopupVisible:!1},De=document.querySelector(".attribution-trigger"),Ve=document.querySelector(".attribution-popup"),Ue=document.querySelector(".cesium-attribution"),ke=document.querySelector(".sample-attribution"),ze=document.querySelector(".cesium-ion-logo");function Be(e){De.classList.toggle("active",e.isAttributionPopupVisible),Ve.style.display=e.isAttributionPopupVisible?"block":"none",ke.style.display=e.currentDataset===Ee[0]?"block":"none",Ue.style.display=e.currentDataset===Ee[1]?"block":"none",ze.style.display=e.currentDataset===Ee[1]?"block":"none"}De.addEventListener("click",(function(){Fe.isAttributionPopupVisible=!Fe.isAttributionPopupVisible,Be(Fe)})),window.addEventListener("message",(function(e){if("object"!=typeof e.data||"dataset-change"!==e.data.type)return;Fe.currentDataset=e.data.dataset,Be(Fe)})),Be(Fe);function Ne(e,t){return new be({concurrentDecoderServiceName:"quantized-mesh-tile-decoder",concurrentDecoderScriptUrl:"./dist/quantized-mesh-decoder.bundle.js",tilingScheme:ue.hereTilingScheme,fetchTile:t=>function(e,t){const i=e.column,n=e.row,r=`https://assets.cesium.com/1/${e.level-1}/${i}/${n}.terrain?extensions=octvertexnormals&v=1.1.0`;return window.fetch(r,{headers:{Accept:`application/vnd.quantized-mesh,application/octet-stream;q=0.9;access_token=${t};`}}).then(e=>{if(200!==e.status)throw new Error("Unable to load tile "+r);return e.arrayBuffer()}).catch(e=>{console.log(e)})}(t,e),getTileMaterial:(e,i)=>Oe(e,i,t)})}function je(e){return new be({concurrentDecoderServiceName:"quantized-mesh-tile-decoder",concurrentDecoderScriptUrl:"./dist/quantized-mesh-decoder.bundle.js",tilingScheme:ue.webMercatorTilingScheme,fetchTile:e=>function(e){const t=e.column,i=e.rowCount()-e.row-1,n=`https://mykolaharmash.github.io/grand-teton-tiles/tiles/${e.level}/${t}/${i}.terrain`;return window.fetch(n).then(e=>{if(200!==e.status)throw new Error("Unable to load tile "+n);return e.arrayBuffer()}).catch(e=>{console.log(e)})}(e),getTileMaterial:(t,i)=>Oe(t,i,e),getDisplayZoomLevel:e=>he.Math.clamp(e+2,8,14)})}(function(){const e="https://api.cesium.com/v1/assets/1/endpoint?access_token="+Ce;return window.fetch(e).then(e=>e.json()).then(e=>e.accessToken).catch(e=>console.log(e))})().then(e=>{const t={dataset:Ee[0],style:Me[0]},i=function(e){const t=new de.MapView({minZoomLevel:8,maxZoomLevel:14,canvas:e,maxVisibleDataSourceTiles:300,tileCacheSize:1e3});return new me.MapControls(t),t.resize(window.innerWidth,window.innerHeight),t.zoomLevelBias=.5,window.addEventListener("resize",()=>{t.resize(window.innerWidth,window.innerHeight)}),t}(document.getElementById("map")),n=Ne(e,t),r=je(t);i.addDataSource(n),i.addDataSource(r),r.enabled=t.dataset===Ee[0],n.enabled=t.dataset===Ee[1],i.setCameraGeolocationAndZoom(new ue.GeoCoordinates(43.7519975195926,-110.73214288570348),12),i.camera.rotateX(he.Math.degToRad(35));const s=new ce({width:300}),o=s.add(t,"dataset",Ee),a=s.add(t,"style",Me);function l(){i.clearTileCache(),i.update()}o.onChange(e=>{r.enabled=e===Ee[0],n.enabled=e===Ee[1],a.setValue(Me[0]),a.updateDisplay(),a.domElement.querySelectorAll("option[value*=Texture]").forEach(t=>{t.disabled=e===Ee[1]}),l(),window.postMessage({type:"dataset-change",dataset:e},"*")}),a.onChange(l)})}]);
//# sourceMappingURL=app.bundle.js.map